<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>六. Nacos 注册中心底层原理 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="六. Nacos 注册中心底层原理" />
<meta property="og:description" content="目录 一. Nacos 注册中心使用注意点二. NacosNamingService1. EventDispatcher2. NamingProxy3. BeatReactor4. HostReactor 三. 服务注册1. registerInstance()---&gt;BeatReactor下的addBeatInfo()方法实现心跳的建立2. registerInstance()---&gt;NamingProxy下的registerService()方法实现服务注册3. nacos注册中心对注册请求的处理AP 与 CP1. 对应AP模式的EphemeralConsistencyService2. 对应CP模式的RaftConsistencyServiceImpl service内部健康检测任务久化实例是如何检测 4. nacos注册中心接收到心跳后的处理5. nacos注册中心与连接服务间的UDP通信6. nacos注册中心处理注销服务请求 四. 服务发现相关1. 服务Client心跳检测2. 服务Client的UDP端口上报和接收nacos注册中心的UDP更新3. nacos注册中心对订阅请求的处理4. 订阅 五 Nacos与Eureka 一. Nacos 注册中心使用注意点 在使用Nacos作为注册中心时,首先要引入nacos相关依赖,并使用@EnableNacosDiscovery或@EnableDiscoveryClient注解配置开启nacos注册中心功能 @EnableNacosDiscovery是nacos提供的专属注解，用于开启nacos的服务注册和发现功能，它只适用于nacos作为注册中心的场景@EnableDiscoveryClient是spring cloud提供的通用注解，用于开启服务注册和发现功能，它可以适配不同的注册中心，如eureka、consul、zookeeper等，只要引入相应的依赖即可。@EnableNacosDiscovery和@EnableDiscoveryClient都可以实现nacos的服务注册和发现功能，但是@EnableNacosDiscovery更加简洁和直观，而@EnableDiscoveryClient更加通用和灵活 &lt;!-- 二选一: nacos-discovery-spring-boot-starter与spring-cloud-starter-alibaba-nacos-discovery的区别： 1.nacos-discovery-spring-boot-starter是nacos官方提供的spring boot starter，用于在spring boot项目中集成nacos的服务注册和发现功能，它只依赖于nacos-client和spring-boot-starter-web，不依赖于spring cloud相关的组件 2. spring-cloud-starter-alibaba-nacos-discovery是spring cloud alibaba项目提供的spring cloud starter，用于在spring cloud项目中集成nacos的服务注册和发现功能，它依赖于nacos-client、spring-cloud-commons、spring-cloud-context等spring cloud相关的组件，可以与其他spring cloud组件如ribbon、feign、hystrix等进行协作 3. nacos-discovery-spring-boot-starter和spring-cloud-starter-alibaba-nacos-discovery都可以实现nacos的服务注册和发现功能，但是nacos-discovery-spring-boot-starter更加轻量级和简单，而spring-cloud-starter-alibaba-nacos-discovery更加完善和强大, 4. 实现方式不同：nacos-discovery-spring-boot-starter 是基于 Spring Boot 的SPI自动配置机制实现的，而 spring-cloud-starter-alibaba-nacos-discovery 则是基于 Spring Cloud 的编程模型实现的。 5. 依赖范围不同：nacos-discovery-spring-boot-starter 是一个 Spring Boot Starter，可以直接引入到 Spring Boot 项目中，而 spring-cloud-starter-alibaba-nacos-discovery 是一个 Spring Cloud Starter，需要与其他的 Spring Cloud 相关依赖一起使用--&gt; &lt;!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/3f7d7548afc6d614822daefab670f486/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-02T10:04:09+08:00" />
<meta property="article:modified_time" content="2023-08-02T10:04:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">六. Nacos 注册中心底层原理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_Nacos__1" rel="nofollow">一. Nacos 注册中心使用注意点</a></li><li><a href="#_NacosNamingService_33" rel="nofollow">二. NacosNamingService</a></li><li><ul><li><a href="#1_EventDispatcher_67" rel="nofollow">1. EventDispatcher</a></li><li><a href="#2_NamingProxy_69" rel="nofollow">2. NamingProxy</a></li><li><a href="#3_BeatReactor_71" rel="nofollow">3. BeatReactor</a></li><li><a href="#4_HostReactor_73" rel="nofollow">4. HostReactor</a></li></ul> 
  </li><li><a href="#__78" rel="nofollow">三. 服务注册</a></li><li><ul><li><a href="#1_registerInstanceBeatReactoraddBeatInfo_231" rel="nofollow">1. registerInstance()---&gt;BeatReactor下的addBeatInfo()方法实现心跳的建立</a></li><li><a href="#2_registerInstanceNamingProxyregisterService_305" rel="nofollow">2. registerInstance()---&gt;NamingProxy下的registerService()方法实现服务注册</a></li><li><a href="#3_nacos_327" rel="nofollow">3. nacos注册中心对注册请求的处理</a></li><li><ul><li><a href="#AP__CP_502" rel="nofollow">AP 与 CP</a></li><li><ul><li><a href="#1_APEphemeralConsistencyService_582" rel="nofollow">1. 对应AP模式的EphemeralConsistencyService</a></li><li><a href="#2_CPRaftConsistencyServiceImpl_653" rel="nofollow">2. 对应CP模式的RaftConsistencyServiceImpl</a></li></ul> 
    </li><li><a href="#service_776" rel="nofollow">service内部健康检测任务</a></li><li><a href="#_949" rel="nofollow">久化实例是如何检测</a></li></ul> 
   </li><li><a href="#4_nacos_1065" rel="nofollow">4. nacos注册中心接收到心跳后的处理</a></li><li><a href="#5_nacosUDP_1222" rel="nofollow">5. nacos注册中心与连接服务间的UDP通信</a></li><li><a href="#6_nacos_1355" rel="nofollow">6. nacos注册中心处理注销服务请求</a></li></ul> 
  </li><li><a href="#__1376" rel="nofollow">四. 服务发现相关</a></li><li><ul><li><a href="#1_Client_1556" rel="nofollow">1. 服务Client心跳检测</a></li><li><a href="#2_ClientUDPnacosUDP_1632" rel="nofollow">2. 服务Client的UDP端口上报和接收nacos注册中心的UDP更新</a></li><li><a href="#3_nacos_1739" rel="nofollow">3. nacos注册中心对订阅请求的处理</a></li><li><a href="#4__1966" rel="nofollow">4. 订阅</a></li></ul> 
  </li><li><a href="#_NacosEureka_2002" rel="nofollow">五 Nacos与Eureka</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_Nacos__1"></a>一. Nacos 注册中心使用注意点</h2> 
<ol><li>在使用Nacos作为注册中心时,首先要引入nacos相关依赖,并使用@EnableNacosDiscovery或@EnableDiscoveryClient注解配置开启nacos注册中心功能</li></ol> 
<blockquote> 
 <ol><li>@EnableNacosDiscovery是nacos提供的专属注解，用于开启nacos的服务注册和发现功能，它只适用于nacos作为注册中心的场景</li><li>@EnableDiscoveryClient是spring cloud提供的通用注解，用于开启服务注册和发现功能，它可以适配不同的注册中心，如eureka、consul、zookeeper等，只要引入相应的依赖即可。</li><li>@EnableNacosDiscovery和@EnableDiscoveryClient都可以实现nacos的服务注册和发现功能，但是@EnableNacosDiscovery更加简洁和直观，而@EnableDiscoveryClient更加通用和灵活</li></ol> 
</blockquote> 
<pre><code class="prism language-xml">		<span class="token comment">&lt;!-- 二选一: nacos-discovery-spring-boot-starter与spring-cloud-starter-alibaba-nacos-discovery的区别：
		1.nacos-discovery-spring-boot-starter是nacos官方提供的spring boot starter，用于在spring boot项目中集成nacos的服务注册和发现功能，它只依赖于nacos-client和spring-boot-starter-web，不依赖于spring cloud相关的组件
		2. spring-cloud-starter-alibaba-nacos-discovery是spring cloud alibaba项目提供的spring cloud starter，用于在spring cloud项目中集成nacos的服务注册和发现功能，它依赖于nacos-client、spring-cloud-commons、spring-cloud-context等spring cloud相关的组件，可以与其他spring cloud组件如ribbon、feign、hystrix等进行协作
		3. nacos-discovery-spring-boot-starter和spring-cloud-starter-alibaba-nacos-discovery都可以实现nacos的服务注册和发现功能，但是nacos-discovery-spring-boot-starter更加轻量级和简单，而spring-cloud-starter-alibaba-nacos-discovery更加完善和强大,
		4. 实现方式不同：nacos-discovery-spring-boot-starter 是基于 Spring Boot 的SPI自动配置机制实现的，而 spring-cloud-starter-alibaba-nacos-discovery 则是基于 Spring Cloud 的编程模型实现的。
		5. 依赖范围不同：nacos-discovery-spring-boot-starter 是一个 Spring Boot Starter，可以直接引入到 Spring Boot 项目中，而 spring-cloud-starter-alibaba-nacos-discovery 是一个 Spring Cloud Starter，需要与其他的 Spring Cloud 相关依赖一起使用--&gt;</span>
		<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.boot/nacos-discovery-spring-boot-starter --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>nacos-discovery-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.2.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-discovery --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2021.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="2"><li>然后在服务yml中配置注册中心相关信息,在配置时有一个ephemeral属性,默认为true表示当前服务是临时实例,false表示为持久实例,两种不同实例的健康监测机制不同</li></ol> 
<blockquote> 
 <ol><li>临时实例: 默认情况下该类型实例仅会注册在Nacos内存,不会持久化到磁盘,其健康检测机制为Client模式,也就是Client主动向Server上报健康状态类似于推模式,默认心跳间隔为5秒,在15秒内Server未收到Client心跳,则会将其标记为“不健康”状态,在30秒内若收到了Client心跳，则重新恢复“健康”状态，否则该实例将从Server端内存清除,即不健康的实例Server会自动清除</li><li>持久实例: 服务实例不仅会注册到Nacos内存,同时也会持久化到磁盘,此时健康检测机制为Server模式,也就是nacos注册中心主动去检测Client的健康状态类似于拉模式,默认每20秒检测一次,健康检测失败后服务实例会被标记为“不健康”状态,因为其是持久化在磁盘的所以不会被清除,需要专门处理</li></ol> 
</blockquote> 
<ol start="3"><li>nacos的健康检查机制分客户端主动上报和服务端主动探测两种,客户端主动上报是指客户端定时向服务端发送心跳请求,表明自己的存活状态就想上面说的默认间隔时间为5秒可以通过配置项naming.client.beat.interval来修改。服务端主动探测是指服务端定时向客户端发送请求或者心跳包，检查客户端的存活状态,默认间隔时间为10秒,可以通过配置项naming.healthCheckTaskInterval来修改</li><li>服务提供方启动时会获取当前服务信息,包括服务名,服务ip,端口号等,向nacos发送注册请求,同时启动定时任务定时上报心跳,nacos注册中心接收到注册请求后,会解析获取到服务信息,封装成一个Instance类对象保存到一个ConcurrentHashMap类型的serviceMap中,这就是服务注册表,这是一个双层map,外层map的key为namespaceId,valve为内层map,内层map key为 group::serviceName,valve为Service实例也就是Instance对象</li><li>健康保护机制: 在Nacos注册中心的service中存在一个protectThreshold属性,代表保护阈值,针对的是当前某一个Service中的服务实例的,是默认值是 0.85。如果健康实例的占比小于 85%，那么就会触发保护阈值，消费者会从所有实例中进行选择调用,可能会调用到不健康实例</li></ol> 
<h2><a id="_NacosNamingService_33"></a>二. NacosNamingService</h2> 
<ol><li>了解nacos注册中心首先要了解内部一个比较重要的核心接口NamingService,提供了服务的上下线,服务实例查询,根据健康状态查询实例列表,根据随机权重算法查询单个健康实例,服务监听器订阅\取消订阅,分页查询服务列表等众多能力。整合了nacos注册中心的服务在启动时首先会解析yaml中的nacos相关配置,执行NamingFactory下的createNamingService()方法创建NamingService,默认情况下返回的是NacosNamingService</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            namingService <span class="token operator">=</span> <span class="token class-name">NamingFactory</span><span class="token punctuation">.</span><span class="token function">createNamingService</span><span class="token punctuation">(</span><span class="token constant">SERVER_ADDR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"连接到Nacos时有错误发生: "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token class-name">RpcError</span><span class="token punctuation">.</span><span class="token constant">FAILED_TO_CONNECT_TO_SERVICE_REGISTRY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>查看NacosNamingService内部重写了init()方法,通过该方法初始化创建了几个核心类： 客户端心跳管理类BeatReactor、本地服务列表管理类HostReactor、服务事件管理类EventDispatcher、NacosServer 通信代理类NamingProxy</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ValidatorUtils</span><span class="token punctuation">.</span><span class="token function">checkInitParam</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>namespace <span class="token operator">=</span> <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initNamespaceForNaming</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initSerialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initServerAddr</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initWebRootContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLogName</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 事件调度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 服务代理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namespace<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverList<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 心跳</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beatReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeatReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy<span class="token punctuation">,</span> <span class="token function">initClientBeatThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 主机服务</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventDispatcher<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy<span class="token punctuation">,</span> beatReactor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheDir<span class="token punctuation">,</span>
            <span class="token function">isLoadCacheAtStart</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">initPollingThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="1_EventDispatcher_67"></a>1. EventDispatcher</h3> 
<ol><li>查看EventDispatcher源码,内部创建了SingleThreadExecutor,通过这个线程池执行Notifier任务,任务执行方法中开启了一个无限循环,一直从阻塞队列changedServices中获取数据,发送NamingEvent事件通知</li></ol> 
<h3><a id="2_NamingProxy_69"></a>2. NamingProxy</h3> 
<ol><li>负责与 Nacos 服务器进行通信</li></ol> 
<h3><a id="3_BeatReactor_71"></a>3. BeatReactor</h3> 
<ol><li>负责处理心跳任务,下面有讲解</li></ol> 
<h3><a id="4_HostReactor_73"></a>4. HostReactor</h3> 
<ol><li>HostReactor 负责与nacos注册中心的udp通信实现的服务更新,下方有讲解</li></ol> 
<h2><a id="__78"></a>三. 服务注册</h2> 
<ol><li>在通过nacos-discovery-spring-boot-starter依赖整合nacos注册中心时,查看META-INF下的spring.factories文件,根据SpringBoot SPI自动装配原理,通过这个文件向容器中注入了一个NacosDiscoveryAutoConfiguration对象<br> <img src="https://images2.imgbox.com/9a/f9/pcE0kIpj_o.png" alt="在这里插入图片描述"></li><li>查看 NacosDiscoveryAutoConfiguration,该类中提供了一个被@Bean修饰的discoveryAutoRegister(),会向容器中创建一个NacosDiscoveryAutoRegister</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">NacosDiscoveryProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableNacosDiscovery</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnMissingBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnProperty</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">EnableConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>
    name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"nacos.discovery.enabled"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>
    name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"globalNacosProperties$discovery"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token comment">//这个类已经添加了这个注解,是不是就不需要手动添加了???</span>
<span class="token annotation punctuation">@EnableNacosDiscovery</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">NacosDiscoveryProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span>
    name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"org.springframework.boot.context.properties.bind.Binder"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosDiscoveryAutoConfiguration</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">NacosDiscoveryAutoConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NacosDiscoveryAutoRegister</span> <span class="token function">discoveryAutoRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosDiscoveryAutoRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>查看NacosDiscoveryAutoRegister 继承自ApplicationListener,了解Spring事件驱动开发原理知道,当 Spring 容器刷新完成后，会触发该事件,事件执行NacosDiscoveryAutoRegister 会调用 onApplicationEvent 方法，实现服务注册(当Spring核心逻辑执行完成刷新（finishRefresh()）时，会发布WebServerInitializedEvent事件。此事件由AbstractAutoServiceRegistration的onApplicationEvent方法响应，从而启动服务的自动注册流程)</li></ol> 
<blockquote> 
 <ol><li>Spring启动时底层会调用refresh()方法初始化容器,创建bean进行ioc注册,当前只考虑事件驱动,在refresh()方法中会先调用initApplicationEventMulticaster() 初始化事件派发器,多播器,</li><li>创建完成后,调用registerListeners() 获取所有ApplicationListener注册监听器,这时候就能注册NacosDiscoveryAutoRegister 因为它继承了ApplicationListener用来监听WebServerInitializedEvent事件,并且在容器创建时调用的registerListeners()方法中还会获取之前注册的事件earlyApplicationEvents,如果不为空遍历这些事件调用applicationEventMulticaster事件派发器的广播事件方法multicastEvent()将这些事件广播出去,</li><li>在refresh()方法最后会执行finishRefresh() 完成ben的创建初始化工作,完成 IOC 容器的创建,发布容器刷新完成事件,在该方法中会获取所有类型为ApplicationEvent的事件调用publishEvent()发布事件,而当前WebServerInitializedEvent是在webServer初始话完成后进行发布,最终触发NacosDiscoveryAutoRegister 的onApplicationEvent()方法的执行</li></ol> 
</blockquote> 
<ol start="4"><li>事件执行时会调用NacosDiscoveryAutoRegister的onApplicationEvent()方法,该方法内部重点关注调用了NacosNamingService下的registerInstance()方法</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">NacosDiscoveryProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">Register</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>api<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NacosInjected</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>api<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">NacosException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>api<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>client<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">NetUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">WebServerInitializedEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">//1.NacosDiscoveryAutoRegister 继承了ApplicationListener是一个事件监听器,用来监听WebServerInitializedEvent事件</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosDiscoveryAutoRegister</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebServerInitializedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">NacosDiscoveryAutoRegister</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@NacosInjected</span>
    <span class="token keyword">private</span> <span class="token class-name">NamingService</span> namingService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">NacosDiscoveryProperties</span> discoveryProperties<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.application.name:}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> applicationName<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NacosDiscoveryAutoRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
	
	<span class="token comment">//当发布WebServerInitializedEvent事件时,会触发onApplicationEvent()这个监听方法的执行</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">WebServerInitializedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discoveryProperties<span class="token punctuation">.</span><span class="token function">isAutoRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Register</span> register <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discoveryProperties<span class="token punctuation">.</span><span class="token function">getRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>register<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                register<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>register<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                register<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            register<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"preserved.register.source"</span><span class="token punctuation">,</span> <span class="token string">"SPRING_BOOT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            register<span class="token punctuation">.</span><span class="token function">setInstanceId</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> serviceName <span class="token operator">=</span> register<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AutoRegisterException</span><span class="token punctuation">(</span><span class="token string">"serviceName notNull"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                serviceName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//重点registerInstance()</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>namingService<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> register<span class="token punctuation">.</span><span class="token function">getGroupName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> register<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Finished auto register service : {}, ip : {}, port : {}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>serviceName<span class="token punctuation">,</span> register<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> register<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AutoRegisterException</span><span class="token punctuation">(</span>var5<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>查看NacosNamingService中的registerInstance()方法:</li></ol> 
<blockquote> 
 <ol><li>默认创建的都是临时节点,会创建一个beatInfo对象设置当前服务的ip端口号等信息,设置心跳间隔为5秒,最终调用BeatReactor下的addBeatInfo()方法与Nacos Server服务实现心跳</li><li>然后调用NamingProxy下的registerService()方法,内部通过调用Nacos的open API实现服务注册</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosNamingService</span> <span class="token keyword">implements</span> <span class="token class-name">NamingService</span> <span class="token punctuation">{<!-- --></span>
     <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断是否为临时节点，默认情况下都是临时节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当前节点为临时节点</span>
            <span class="token comment">// 新建一个BeatInfo对象，存储心跳检测需要的基本信息</span>
            <span class="token class-name">BeatInfo</span> beatInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeatInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setServiceName</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setCluster</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setScheduled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置心跳检测的时间周期，默认是5s</span>
            <span class="token comment">// 可以通过属性spring.cloud.nacos.discovery.heartBeatInterval配置</span>
            beatInfo<span class="token punctuation">.</span><span class="token function">setPeriod</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getInstanceHeartBeatInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 新增一个心跳检测的基本信息，心跳检测时需要用到这些基本信息</span>
            beatReactor<span class="token punctuation">.</span><span class="token function">addBeatInfo</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> beatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 往注册中心进行注册</span>
        serverProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>并且在NacosNamingService中重写了init()方法,在通过init()方法初始化创建这个类的时候一块初始化创建了几个属性对象,在后续与nacos建立心跳,服务注册是会用到,比如内部创建的 BeatReactor 对象(在与nacos建立心跳时会用到这个对象,该对象内部封装了一个线程池)</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        namespace <span class="token operator">=</span> <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initNamespaceForNaming</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initServerAddr</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initWebRootContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initLogName</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        eventDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> serverList<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//比如 BeatReactor 对象(在与nacos建立心跳时会用到这个对象,内部封装了一个线程池)</span>
        beatReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeatReactor</span><span class="token punctuation">(</span>serverProxy<span class="token punctuation">,</span> <span class="token function">initClientBeatThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
        hostReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostReactor</span><span class="token punctuation">(</span>eventDispatcher<span class="token punctuation">,</span> serverProxy<span class="token punctuation">,</span> cacheDir<span class="token punctuation">,</span> <span class="token function">isLoadCacheAtStart</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">initPollingThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="1_registerInstanceBeatReactoraddBeatInfo_231"></a>1. registerInstance()—&gt;BeatReactor下的addBeatInfo()方法实现心跳的建立</h3> 
<ol><li>在registerInstance()方法中,首先会判断节点的类型,默认创建的都是临时节点,会创建一个beatInfo对象设置当前服务的ip端口号等信息,设置心跳间隔为5秒,最终调用BeatReactor下的addBeatInfo()方法与Nacos Server服务实现心跳,查看addBeatInfo()方法,重点通过executorService.schedule(BeatTask beatTask)定时线程定时执行BeatTask任务,向nacos发送心跳</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addBeatInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">BeatInfo</span> beatInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[BEAT] adding beat: {} to beat map."</span><span class="token punctuation">,</span> beatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> beatInfo<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beatInfo<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeatInfo</span> existBeat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>existBeat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeatInfo</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom2Beat<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            existBeat<span class="token punctuation">.</span><span class="token function">setStopped</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>dom2Beat<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> beatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送心跳的具体逻辑在 BeatTask 中</span>
        <span class="token comment">// 这里会生成一个延时任务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeatReactor<span class="token punctuation">.</span>BeatTask</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> beatInfo<span class="token punctuation">.</span><span class="token function">getPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getDom2BeatSizeMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom2Beat<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>查看BeatTask任务类中执行任务的run()方法源码,</li></ol> 
<blockquote> 
 <ol><li>会调用NamingProxy下的sendBeat()方法—&gt;nacos api方法请求nacos的"/nacos/v1/ns/instance/beat"地址进行上报</li><li>如果上报返回的code码为异常,会调用registerService()重新注册</li><li>如果上报成功会继续调用 executorService的schedule()方法继续定时执行BeatTask任务,定时上报心跳</li><li>并且在上报心跳时分为服务启动第一次上报携带beatInfo对象的重量级上报与后续普通不携带beatInfo的轻量级上报</li></ol> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> nextTime <span class="token operator">=</span> beatInfo<span class="token punctuation">.</span><span class="token function">getPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 向服务端发送请求（首次注册为注册时心跳，会将整个beatInfo对象发送给服务端），api地址：/nacos/v1/ns/instance/beat</span>
                <span class="token comment">// nacos的心跳分为两种，第一种是注册时心跳，目的是为了首次注册进行上报，第二种为轻量级心跳，目的是为了保持连接</span>
                <span class="token class-name">JSONObject</span> result <span class="token operator">=</span> serverProxy<span class="token punctuation">.</span><span class="token function">sendBeat</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">,</span> <span class="token class-name">BeatReactor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lightBeatEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> interval <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getIntValue</span><span class="token punctuation">(</span><span class="token string">"clientBeatInterval"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> lightBeatEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">LIGHT_BEAT_ENABLED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lightBeatEnabled <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getBooleanValue</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">LIGHT_BEAT_ENABLED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 首次注册时心跳，服务端会返回lightBeatEnabled=true，标注下次心跳为轻量级心跳</span>
                <span class="token class-name">BeatReactor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lightBeatEnabled <span class="token operator">=</span> lightBeatEnabled<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    nextTime <span class="token operator">=</span> interval<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> code <span class="token operator">=</span> <span class="token class-name">NamingResponseCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">CODE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    code <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getIntValue</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 找不到资源时会重新注册</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token class-name">NamingResponseCode</span><span class="token punctuation">.</span><span class="token constant">RESOURCE_NOT_FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Instance</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setClusterName</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setServiceName</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setInstanceId</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setEphemeral</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        serverProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupName</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> ne<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[CLIENT-BEAT] failed to send beat: {}, code: {}, msg: {}"</span><span class="token punctuation">,</span>
                    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> ne<span class="token punctuation">.</span><span class="token function">getErrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ne<span class="token punctuation">.</span><span class="token function">getErrMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token punctuation">}</span>
            <span class="token comment">// 周期进行心跳包发送（默认5s）</span>
            executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeatTask</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> nextTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_registerInstanceNamingProxyregisterService_305"></a>2. registerInstance()—&gt;NamingProxy下的registerService()方法实现服务注册</h3> 
<ol><li>registerInstance()中通过NamingProxy下的registerService()方法实现服务注册的方法比较简单,获取当前服务信息,比如ip, 多核等等,封装为一个map,直接通过 NamingProxy调用nacos api进行服务注册</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[REGISTER-SERVICE] {} registering service {} with instance: {}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"namespaceId"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serviceName"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"groupName"</span><span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clusterName"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enable"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"healthy"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ephemeral"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过 NamingProxy调用nacos api进行服务注册</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reqAPI</span><span class="token punctuation">(</span><span class="token class-name">UtilAndComs</span><span class="token punctuation">.</span><span class="token constant">NACOS_URL_INSTANCE</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_nacos_327"></a>3. nacos注册中心对注册请求的处理</h3> 
<ol><li>请求首先到达nacos注册中心的controller层,查看注册中心接收到注册请求的源码InstanceController的register()方法</li></ol> 
<blockquote> 
 <ol><li>首先会解析获取注册请求中的请求数据</li><li>调用parseInstance()封装代表当前服务实例的Instance对象</li><li>调用ServiceManager下的registerInstance()方法,将服务实例保存到注册表中</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@CanDistro</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>parser <span class="token operator">=</span> <span class="token class-name">NamingResourceParser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token class-name">ActionTypes</span><span class="token punctuation">.</span><span class="token constant">WRITE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//1.获取请求数据</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_ID</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_NAMESPACE_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">SERVICE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkServiceNameFormat</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.封装代表当前服务的instance对象</span>
        <span class="token keyword">final</span> <span class="token class-name">Instance</span> instance <span class="token operator">=</span> <span class="token function">parseInstance</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.将instance写入到注册表</span>
        serviceManager<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>此时请求到达Manager层,重点在ServiceManager的registerInstance()中,查看源码</li></ol> 
<blockquote> 
 <ol><li>有个主意点,会获取Ephemeral属性,如果为true则表示当前注册的是临时实例</li><li>首先会调用createEmptyService()创建一个空的service临时实例,并将这个空的service保存到注册表</li><li>调用addInstance()给上面刚创建的空的service添加当前注册的instance实例</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//1.创建service,并将service写入到注册表,该方法内部重点调用了一个createServiceIfAbsent()方法</span>
        <span class="token function">createEmptyService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.从注册表中再获取到service</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span><span class="token constant">INVALID_PARAM</span><span class="token punctuation">,</span>
                    <span class="token string">"service not found, namespace: "</span> <span class="token operator">+</span> namespaceId <span class="token operator">+</span> <span class="token string">", service: "</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3.将当前封装的instance写入到service,完成注册表</span>
        <span class="token function">addInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>查看createEmptyService()创建一个空的service临时实例,并将这个空的service保存到注册表源码,内部重点调用了createServiceIfAbsent()</li></ol> 
<blockquote> 
 <ol><li>首先在请求中获取当前注册服务的namespaceId,通过这个namespaceId查询注册表中是否已经存在了该服务对应的service,存在直接返回</li><li>如果不存在,创建Service对象,调用putServiceAndInit()将当代表当注册服务的Service添加到注册表中</li><li>调用addOrReplaceService()持久实例到其他Nacos</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createServiceIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> local<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从注册表中获取service</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 若当前注册instance是其提供服务的第一个实例，则注册表中是没有该service的，</span>
        <span class="token comment">// 此时会创建一个service实例</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"creating empty service {}:{}"</span><span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">setNamespaceId</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// now validate the service. if failed, exception will be thrown</span>
            service<span class="token punctuation">.</span><span class="token function">setLastModifiedMillis</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 重新计算校验和</span>
            service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// cluster与service建立联系</span>
                <span class="token comment">// n:1</span>
                cluster<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            service<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将service写入到注册表</span>
            <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 对持久实例的操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addOrReplaceService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 从服务端的注册表中获取Service</span>
    <span class="token keyword">public</span> <span class="token class-name">Service</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">chooseServiceMap</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Service</span><span class="token punctuation">&gt;</span></span> <span class="token function">chooseServiceMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> serviceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>查看createEmptyService()创建service,并将service添加到注册表方法中有一个重点调用了一个recalculateChecksum()方法重写计算校验和</li></ol> 
<blockquote> 
 <ol><li>遍历当前服务下的所有实例,按照 IP，端口，权重，健康状态等属性进行排序,生成一个实例列表的字符串。</li><li>执行MD5Utils.md5Hex()使用 MD5 算法对该字符串进行哈希,得到一个 16 进制的校验和, 将该校验和存储在服务的元数据中，作为服务的唯一标识</li><li>当服务下的实例发生增加,删除,修改等操作时,重新调用该方法计算新的校验和,并与旧的校验和进行比较。</li><li>如果校验和不同,说明服务发生了变化,需要通知客户端进行同步</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取当前service所包含的所有instance列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> ips <span class="token operator">=</span> <span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StringBuilder</span> ipsString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将service所数据追加到ipsString</span>
        ipsString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getServiceString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"service to json: "</span> <span class="token operator">+</span> <span class="token function">getServiceString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>ips<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>ips<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 遍历所有instances，将它们的数据进行追加</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> ip <span class="token operator">:</span> ips<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> string <span class="token operator">=</span> ip<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> ip
                    <span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipsString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipsString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 最终获取到当前service的所有数据，经MD5加密后赋值给checksum</span>
        checksum <span class="token operator">=</span> <span class="token class-name">MD5Utils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>ipsString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ENCODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// Service.java</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历当前service所包含的所有cluster</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Cluster</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> clusterMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将当前遍历cluster中包含的所有instance添加到result</span>
            result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// Cluster.java</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> allInstances <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加持久实例</span>
        allInstances<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>persistentInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加临时实例</span>
        allInstances<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ephemeralInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> allInstances<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>我们继续看一下创建service后,执行ServiceManager的putServiceAndInit()将service写入到注册表源码,该方法中重点做了三个动作</li></ol> 
<blockquote> 
 <ol><li>调用putService()方法最终将当前注册的服务的service添加到注册表serviceMap中</li><li>调用Service下的init()方法,初始化service内部健康检测任务(<strong>重点这个就是service内部健康检测任务</strong>)</li><li>通过consistencyService.listen()给nacos集合中的当前服务的持久实例、临时实例添加监听</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//将service写入注册表</span>
        <span class="token function">putservice</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化service内部健康检测任务</span>
        service<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//给nacos集合中的当前服务的持久实例、临时实例添加监听</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[NEW-SERVICE]"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	
	<span class="token comment">//ServiceManager下的putService(): 将service写入注册表serviceMap</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putService</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 双重检测锁机制  Double Check Lock，DCL</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>putServiceLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    serviceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 写入到注册表map</span>
        serviceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="AP__CP_502"></a>AP 与 CP</h4> 
<ol><li>查看服务注册nacos处理流程,可以用mvc的架构去理解</li></ol> 
<blockquote> 
 <ol><li>在服务注册时,请求首先到达nacos注册中心controller层InstanceController的register()解析http请求,</li><li>有controller层调用ServiceManager的registerInstance(),获取注册中心服务列表中该服务信息,如果不存在说明第一次注册,创建当前服务的service,添加到serviceMap服务列表中,封装Instance实例,调用addInstance()将实例添加到service,实现服务注册,并添加监控检查的定时任务等</li><li>接下来重点查看一下addInstance()重点关注nacos如何处理AP或CP的,这里就来到的nacos的service层</li></ol> 
</blockquote> 
<ol start="2"><li>nacos的AP或CP是根据临时实例或持久化实例来区分的,通过spring.cloud.nacos.discovery.ephemeral配置,默认true为临时实例<br> false为永久实例,临时使用AP,持久使用CP</li><li>查看addInstance()添加实例到指定的服务中的源码,内部会调用DelegateConsistencyServiceImpl的put(key, instances)将实例列表放入一致性服务中,以确保实例信息在集群中保持一致</li></ol> 
<pre><code class="prism language-java"> 	<span class="token comment">/**
     *
     * @param namespaceId 命名空间ID
     * @param serviceName 服务名
     * @param ephemeral   实例是否为临时性实例
     * @param ips          需要添加的实例列表
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ips<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构建用于选择CP模式或者AP模式一致性服务的键值</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> ephemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
​
        <span class="token comment">// 获取指定服务的信息</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
​
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 添加IP地址到指定服务，并得到更新后的实例列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> instanceList <span class="token operator">=</span> <span class="token function">addIpAddresses</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> ephemeral<span class="token punctuation">,</span> ips<span class="token punctuation">)</span><span class="token punctuation">;</span>
​
            <span class="token comment">// 创建一个包含更新后实例列表的Instances对象</span>
            <span class="token class-name">Instances</span> instances <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instances<span class="token punctuation">.</span><span class="token function">setInstanceList</span><span class="token punctuation">(</span>instanceList<span class="token punctuation">)</span><span class="token punctuation">;</span>
​
            <span class="token comment">//DelegateConsistencyServiceImpl下的put()将实例列表放入一致性服务中,确保实例信息在集群中保持一致</span>
            consistencyService<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>DelegateConsistencyServiceImpl中有一个代表AP的ephemeralConsistencyService<br> ,代表CP的persistentConsistencyService,使用哪种模式put方法中就获取对应的service执行对应的put方法</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">"ProtocolManager"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"consistencyDelegate"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelegateConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ConsistencyService</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// CP模式一致性服务，用于处理持久性数据</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PersistentConsistencyService</span> persistentConsistencyService<span class="token punctuation">;</span>
    <span class="token comment">// AP模式一致性服务，用于处理临时性数据</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EphemeralConsistencyService</span> ephemeralConsistencyService<span class="token punctuation">;</span>
​
    <span class="token comment">/**
     * 初始化委托一致性服务实例。
     *
     * @param persistentConsistencyService CP模式一致性服务实例
     * @param ephemeralConsistencyService  AP模式一致性服务实例
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">DelegateConsistencyServiceImpl</span><span class="token punctuation">(</span>
            <span class="token class-name">PersistentConsistencyService</span> persistentConsistencyService<span class="token punctuation">,</span>
            <span class="token class-name">EphemeralConsistencyService</span> ephemeralConsistencyService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>persistentConsistencyService <span class="token operator">=</span> persistentConsistencyService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ephemeralConsistencyService <span class="token operator">=</span> ephemeralConsistencyService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//...省略</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//选择AP模式或者CP模式服务</span>
        <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token comment">/**
     * 根据给定的键值选择对应的一致性服务。
     *
     * @return 选择的一致性服务，如果是临时性实例则返回ephemeralConsistencyService，否则返回persistentConsistencyService
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ConsistencyService</span> <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断给定的键值是否匹配临时性实例的键模式，根据结果选择对应的一致性服务</span>
        <span class="token keyword">return</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchEphemeralKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> ephemeralConsistencyService <span class="token operator">:</span> persistentConsistencyService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1_APEphemeralConsistencyService_582"></a>1. 对应AP模式的EphemeralConsistencyService</h5> 
<ol><li>重点关注EphemeralConsistencyService 中实现注册服务信息同步的put方法,内部:</li></ol> 
<blockquote> 
 <ol><li>执行onPut(key, value)注册实例,状态为ApplyAction.CHANGE 投递 notifier</li><li>执行taskDispatcher.addTask(key)同步服务实例给其他集群节点</li><li>在onPut方法中,首先通过KeyBuilder.matchEphemeralInstanceListKey(key)判断key是否匹配临时性实例列表的key模式，如果匹配，则将实例信息封装成Datum&lt; Instances &gt;对象，并异步地通过Notifier线程处理，将数据记录存储到数据存储器中（dataStore.put(key, datum)）。这样异步处理避免了阻塞主线程，提高了处理效率</li><li>在数据处理完成后，Nacos通过发布ServiceChangeEvent事件，触发UDP推送服务，将服务实例变动通知给订阅的客户端。这种方式相对于ZooKeeper的TCP长连接模式，确实节约了很多资源，尤其在大量节点更新时不会出现性能瓶颈。虽然UDP推送不能保证数据可靠性，但Nacos客户端通过定时任务轮询(每隔1秒)进行服务发现的方式做兜底，可以保证数据的最终一致性和可靠性。这种 服务端UDP推送+客户端定时轮询的方式在很多实际场景中能够有效平衡实时性和数据可靠性的需求</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
*   AP模式-distro协议
**/</span>
<span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">"ProtocolManager"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@org.springframework.stereotype.Service</span><span class="token punctuation">(</span><span class="token string">"distroConsistencyService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistroConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EphemeralConsistencyService</span> <span class="token punctuation">{<!-- --></span>
​
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DistroMapper</span> distroMapper<span class="token punctuation">;</span> <span class="token comment">// 数据分发映射器，用于在集群中分发数据。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataStore</span> dataStore<span class="token punctuation">;</span> <span class="token comment">// 数据存储器，用于持久化和管理分布式数据。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TaskDispatcher</span> taskDispatcher<span class="token punctuation">;</span> <span class="token comment">// 任务调度器，用于处理与数据一致性相关的任务。</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerMemberManager</span> memberManager<span class="token punctuation">;</span> <span class="token comment">// 服务器成员管理器，用于管理集群中的服务器成员。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GlobalConfig</span> globalConfig<span class="token punctuation">;</span> <span class="token comment">// 全局配置。</span>
    
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Notifier</span> notifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于通知数据更新的通知器。</span>
    
    <span class="token comment">// 监听器映射，用于存储不同Key的监听器队列。</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordListener</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 同步校验和任务映射，用于存储待同步校验和的任务。</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> syncChecksumTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
    <span class="token keyword">public</span> <span class="token class-name">DistroConsistencyServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">DistroMapper</span> distroMapper<span class="token punctuation">,</span> <span class="token class-name">DataStore</span> dataStore<span class="token punctuation">,</span>
                                        <span class="token class-name">TaskDispatcher</span> taskDispatcher<span class="token punctuation">,</span> <span class="token class-name">Serializer</span> serializer<span class="token punctuation">,</span>
                                        <span class="token class-name">ServerMemberManager</span> memberManager<span class="token punctuation">,</span> <span class="token class-name">SwitchDomain</span> switchDomain<span class="token punctuation">,</span>
                                        <span class="token class-name">GlobalConfig</span> globalConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//数据分发映射器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>distroMapper <span class="token operator">=</span> distroMapper<span class="token punctuation">;</span>
        <span class="token comment">//数据存储器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore <span class="token operator">=</span> dataStore<span class="token punctuation">;</span>
        <span class="token comment">//任务调度器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskDispatcher <span class="token operator">=</span> taskDispatcher<span class="token punctuation">;</span>
        <span class="token comment">//序列化器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serializer <span class="token operator">=</span> serializer<span class="token punctuation">;</span>
        <span class="token comment">//集群管理</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>memberManager <span class="token operator">=</span> memberManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>switchDomain <span class="token operator">=</span> switchDomain<span class="token punctuation">;</span>
        <span class="token comment">//全局配置</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>globalConfig <span class="token operator">=</span> globalConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
​
    <span class="token comment">/**
     * 初始化方法，在 PostConstruct 阶段执行。
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 开启加载数据的任务</span>
        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>loadDataTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启数据更新通知任务</span>
        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">submitDistroNotifyTask</span><span class="token punctuation">(</span>notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 添加给定的记录
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 将注册实例 状态为ApplyAction.CHANGE 投递 notifier</span>
        <span class="token function">onPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 服务实例 -&gt; 投递任务调度器 -&gt; 数据同步预处理 -&gt; 投递数据同步器 -&gt; 同步服务实例给其他集群节点</span>
        taskDispatcher<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="2_CPRaftConsistencyServiceImpl_653"></a>2. 对应CP模式的RaftConsistencyServiceImpl</h5> 
<ol><li>也是关注RaftConsistencyServiceImpl中用来同步服务信息的put()方法</li></ol> 
<blockquote> 
 <ol><li>内部封装了RaftCore一致性算法类,调用RaftCore的signalPublish()实现同步</li><li>查看signalPublish()方法,内部首先获取到majorityCount需要同步的nacos服务的节点数,利用CountDownLatch控制调用 HttpClient.asyncHttpPostLarge()向其他节点发送确认请求实现多数节点的确认</li><li>如果在规定的时间内没有得到majorityCount个节点的成功响应,则认为数据发布失败,并抛出异常</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">"ProtocolManager"</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Service</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">PersistentConsistencyService</span> <span class="token punctuation">{<!-- --></span>
​
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RaftCore</span> raftCore<span class="token punctuation">;</span> <span class="token comment">// Raft 协议的核心组件</span>
​
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RaftPeerSet</span> peers<span class="token punctuation">;</span> <span class="token comment">// Raft 协议中的节点集合</span>
​
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SwitchDomain</span> switchDomain<span class="token punctuation">;</span> <span class="token comment">// 包含各种开关配置</span>
​
    <span class="token comment">/**
     * 将给定的记录持久化到集群中，实现了 PersistentConsistencyService 接口的 put 方法。
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1. 调用 RaftCore#signalPublish 方法，将数据存入 Raft 日志，并发起 Raft 协议的数据复制与一致性处理</span>
            raftCore<span class="token punctuation">.</span><span class="token function">signalPublish</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 处理异常情况，记录错误日志，并抛出 NacosException</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">RAFT</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Raft put failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span><span class="token constant">SERVER_ERROR</span><span class="token punctuation">,</span> <span class="token string">"Raft put failed, key:"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">", value:"</span> <span class="token operator">+</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
​
<span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">"ProtocolManager"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>
   
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略
        
    <span class="token comment">/**
     * 发送数据变更信号，将指定的记录进行发布。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">signalPublish</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 如果当前节点不是 Leader 节点，则将数据变更信号发送给 Leader 节点处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ObjectNode</span> params <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">transferToJsonNode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
​
            <span class="token keyword">final</span> <span class="token class-name">RaftPeer</span> leader <span class="token operator">=</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用 Raft 代理方法将数据变更信号发送给 Leader 节点</span>
            raftProxy<span class="token punctuation">.</span><span class="token function">proxyPostLarge</span><span class="token punctuation">(</span>leader<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> <span class="token constant">API_PUB</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
​
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token constant">OPERATE_LOCK</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Datum</span> datum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Datum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token comment">// 获取记录的时间戳，并更新到当前记录的时间戳中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDatum</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                datum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                datum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getDatum</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
​
            <span class="token class-name">ObjectNode</span> json <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            json<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"datum"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">transferToJsonNode</span><span class="token punctuation">(</span>datum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            json<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"source"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">transferToJsonNode</span><span class="token punctuation">(</span>peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
            <span class="token comment">// 2. 数据持久化同步写入磁盘，并投递数据更新通知队列更新内存注册列表 </span>
            <span class="token function">onPublish</span><span class="token punctuation">(</span>datum<span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
            <span class="token keyword">final</span> <span class="token class-name">String</span> content <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
            <span class="token comment">//3. CountDownLatch 异步实现简单的Raft机制半数ack成功</span>
            <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>peers<span class="token punctuation">.</span><span class="token function">majorityCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 遍历所有节点，将数据更新通知发送给其他节点</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> server <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">allServersIncludeMyself</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLeader</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果当前节点是 Leader 节点，则不需要通知自己，直接跳过当前节点</span>
                    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">buildURL</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token constant">API_ON_PUB</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">asyncHttpPostLarge</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"key="</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span><span class="token constant">HTTP_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 如果数据更新通知发送失败，则记录警告日志，并返回 1</span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">RAFT</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[RAFT] failed to publish data to peer, datumId={}, peer={}, http code={}"</span><span class="token punctuation">,</span>
                                datum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> server<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
​
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">STATE</span> <span class="token function">onContentWriteCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token constant">STATE</span><span class="token punctuation">.</span><span class="token constant">CONTINUE</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token constant">RAFT_PUBLISH_TIMEOUT</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果在规定的时间内没有得到大多数节点的成功响应，则认为数据发布失败，记录错误日志，并抛出 IllegalStateException 异常</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">RAFT</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"data publish failed, caused failed to notify majority, key={}"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"data publish failed, caused failed to notify majority, key="</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token constant">OPERATE_LOCK</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="service_776"></a>service内部健康检测任务</h4> 
<ol><li>当客户端的心跳信息不发送给服务端，那么保存在服务端的Instance就会过期，这时候服务端需要进行清理这些过期的Instance</li><li>通过上面我们了解到在nacos注册中心接收到注册请求后,会解析注册请求数据封装Instance实例对象,封装Service对象,将当前注册的服务实例添加到注册表serviceMap中,在添加完成后会调用一个Service下的init()方法初始化service内部健康检测任务</li></ol> 
<blockquote> 
 <ol><li>通过HealthCheckReactor.scheduleCheck()执行ClientBeatCheckTask任务,延迟5秒执行,每5秒检查一次,开启定时清除过期instance任务</li><li>遍历当前service锁包含的所有cluster执行Cluster下的init()方法,初始Cluster内部健康检测任务,也可以看成是对持久化实例的监控检查</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.开启定时清除过期instance任务</span>
        <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>clientBeatCheckTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.开启了当前service所包含的所有cluster的健康检测任务</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Cluster</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> clusterMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用Cluster下的init()</span>
            <span class="token comment">// 开启当前遍历cluster的健康检测任务：</span>
            <span class="token comment">// 将当前cluster包含的所有instance的心跳检测任务定时添加到一个任务队列</span>
            <span class="token comment">// taskQueue，即将当前cluster所包含的持久实例的心跳任务添加到taskQueue</span>
            entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>我们先看一下通过HealthCheckReactor.scheduleCheck()延迟5秒执行,每5秒检查一次的ClientBeatCheckTask任务,查看run方法源码:</li></ol> 
<blockquote> 
 <ol><li>获取当前服务的所有临时实例, 如果是临时实例,并且心跳间隔距离上次超过了15s,将healthy状态设置为false</li><li>若当前时间与上次心跳时间间隔超过了30s,则调用deleteIp()将当前instance清除,如果是过期的是持久实例,则直接跳过</li></ol> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 若当前service不用当前Server负责，则直接结束</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getDistroMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">responsible</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 若当前服务没有开启检测检测功能，则直接结束</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getSwitchDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isHealthCheckEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取当前服务的所有临时实例</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// first set health status of instances:</span>
            <span class="token comment">// 遍历当前服务的所有临时实例</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 若当前时间距离上次心跳时间已经超过了15s，则将当前instance状态设置为不健康</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> instance<span class="token punctuation">.</span><span class="token function">getLastBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> instance<span class="token punctuation">.</span><span class="token function">getInstanceHeartBeatTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 若instance的marked属性不为true，则当前instance可能是临时实例</span>
                    <span class="token comment">// marked属性若为true，则instance一定为持久实例</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 将healthy状态设置为false</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            instance<span class="token punctuation">.</span><span class="token function">setHealthy</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span>
                                    <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{POS} {IP-DISABLED} valid: {}:{}@{}@{}, region: {}, msg: client timeout after {}, last beat: {}"</span><span class="token punctuation">,</span>
                                            instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token constant">LOCALHOST_SITE</span><span class="token punctuation">,</span>
                                            instance<span class="token punctuation">.</span><span class="token function">getInstanceHeartBeatTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getLastBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//发布状态变更事件</span>
                            <span class="token function">getPushService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//发布实例心跳超时事件</span>
                            <span class="token class-name">ApplicationUtils</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InstanceHeartbeatTimeoutEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getGlobalConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isExpireInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// then remove obsolete instances:</span>
            <span class="token comment">// 遍历所有临时实例</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token comment">// 若当前instance被标记了，说明其为过期的持久实例，直接跳过</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 若当前时间与上次心跳时间间隔超过了30s，则将当前instance清除</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> instance<span class="token punctuation">.</span><span class="token function">getLastBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> instance<span class="token punctuation">.</span><span class="token function">getIpDeleteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// delete instance</span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[AUTO-DELETE-IP] service: {}, ip: {}"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 清除</span>
                    <span class="token function">deleteIp</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception while processing client beat time out."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>查看 getPushService().serviceChanged(service) 发布服务变更事件源码</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serviceChanged</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// merge some change events to reduce the push frequency:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//插入了ServiceChangeEvent事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceChangeEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>PushService 类实现了 ApplicationListener&lt; ServiceChangeEvent &gt; 所以本身又会取监听该事件,监听服务状态变更事件,遍历所有的客户端,通过udp协议进行消息的广播通知</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ServiceChangeEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取到服务</span>
        <span class="token class-name">String</span> serviceName <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//服务名</span>
        <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//命名空间</span>
        <span class="token comment">//执行任务</span>
        <span class="token class-name">Future</span> future <span class="token operator">=</span> <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">scheduleUdpSender</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>serviceName <span class="token operator">+</span> <span class="token string">" is changed, add it to push queue."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PushClient</span><span class="token punctuation">&gt;</span></span> clients <span class="token operator">=</span> clientMap
                        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>clients<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> lastRefTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PushClient</span> client <span class="token operator">:</span> clients<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">zombie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"client is zombie: "</span> <span class="token operator">+</span> client<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"client is zombie: "</span> <span class="token operator">+</span> client<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    
                    <span class="token class-name">Receiver<span class="token punctuation">.</span>AckEntry</span> ackEntry<span class="token punctuation">;</span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"push serviceName: {} to client: {}"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">getPushCacheKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> compressData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">getDefaultPushCacheMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">20000</span> <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>javatuples<span class="token punctuation">.</span></span>Pair</span> pair <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>javatuples<span class="token punctuation">.</span></span>Pair</span><span class="token punctuation">)</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        compressData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getValue0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> pair<span class="token punctuation">.</span><span class="token function">getValue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[PUSH-CACHE] cache hit: {}:{}"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getAddrStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>compressData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ackEntry <span class="token operator">=</span> <span class="token function">prepareAckEntry</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> compressData<span class="token punctuation">,</span> data<span class="token punctuation">,</span> lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        ackEntry <span class="token operator">=</span> <span class="token function">prepareAckEntry</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token function">prepareHostsData</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>javatuples<span class="token punctuation">.</span></span>Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackEntry<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"serviceName: {} changed, schedule push for: {}, agent: {}, key: {}"</span><span class="token punctuation">,</span>
                            client<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getAddrStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span>ackEntry <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//执行 UDP  推送</span>
                    <span class="token function">udpPush</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-PUSH] failed to push serviceName: {} to client, error: {}"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                futureMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        futureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_949"></a>久化实例是如何检测</h4> 
<ol><li>那持久化实例是如何检测的,首先nacos的健康检查机制分客户端主动上报和服务端主动探测两种,持久化实例的健康检测就是通过nacos服务端定时向客户端发送请求或者心跳包,检查客户端的存活状态,默认间隔时间为10秒,可以通过配置项naming.healthCheckTaskInterval来修改,并且根据客户端选择的协议类型Nacos内置提供了 Http、TCP 以及 MySQL三种探测的协议,具体代码就是上方通过Service下的init()触发执行的Cluster的init()方法中</li></ol> 
<blockquote> 
 <ol><li>Http类型: 注册中心向客户端发送Http请求,如果返回码在200~400之间,则认为健康,否则不健康(SpringCloud默认环境采用的是Http协议),HttpHealthCheckProcessor</li><li>Tcp类型：注册中心向客户端发送Tcp连接请求,如果连接成功,认为实例健康，否则不健康,TcpHealthCheckProcessor</li><li>Mysql类型：注册中心客户端发送Mysql查询请求,如果查询成功,认为实例健康,否则不健康,MysqlHealthCheckProcessor</li><li>None类型：不进行任何探测,只依赖客户端的心跳上报来判断实例是否健康</li></ol> 
</blockquote> 
<ol start="5"><li>查看Cluster下的init()初始化Cluster内部健康检测任务源码,与临时实例的检查类似,内部通过HealthCheckReactor.scheduleCheck()执行HealthCheckTask任务</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建一个健康检测任务</span>
        checkTask <span class="token keyword">new</span> <span class="token class-name">HealthCheckTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开启定时任务</span>
        <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>checkTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inited <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>查看HealthCheckTask执行任务的run()方法源码,内部重点会调用healthCheckProcessor的process()方法,SpringCloud默认环境执行的是HttpHealthCheckProcessor</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断当前节点是否负责该服务的健康检查，以及该服务是否开启了健康检查功能</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distroMapper<span class="token punctuation">.</span><span class="token function">responsible</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> switchDomain
                <span class="token punctuation">.</span><span class="token function">isHealthCheckEnabled</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调用healthCheckProcessor.process(this)方法，进行健康检查的具体逻辑</span>
            healthCheckProcessor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果开启了调试日志，那么打印出任务的信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span>
                        <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[HEALTH-CHECK] schedule health check task: {}"</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果发生异常，那么打印出错误日志</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span>
                <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[HEALTH-CHECK] error while process health check for {}:{}"</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果任务没有被取消</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调用HealthCheckReactor.scheduleCheck(this)方法，重新安排下一次的健康检查任务</span>
            <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果任务已经执行过至少一次，并且该服务开启了健康检查功能，并且当前节点负责该服务的健康检查</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtWorst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> switchDomain<span class="token punctuation">.</span><span class="token function">isHealthCheckEnabled</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> distroMapper<span class="token punctuation">.</span><span class="token function">responsible</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 计算出本次检查和上次检查之间的时间差，并转换为long类型</span>
                <span class="token keyword">long</span> diff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtLastLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtLastLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 更新上次检查的时间为本次检查的时间</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCheckRtLastLast</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 获取当前任务对应的集群对象</span>
                <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果开启了调试日志，那么打印出检查时间相关的信息</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CHECK_RT</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CHECK_RT</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{}:{}@{}-&gt;normalized: {}, worst: {}, best: {}, last: {}, diff: {}"</span><span class="token punctuation">,</span>
                            cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getHealthChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtNormalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtWorst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtBest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCheckRtLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>查看HttpHealthCheckProcessor的process()方法(默认情况下临时实例是通过定时上报的方式进行健康检测的,如果想让临时实例也使用HttpHealthCheckProcessor进行健康检查,可以在服务实例的元数据中配置health-checker-type属性为HTTP，或者在nacos-server.properties文件中配置naming.default.health-checker.type属性为HTTP)</li></ol> 
<blockquote> 
 <ol><li>首先调用getCluster()获取所有的持久化实例,</li><li>遍历实例,判断当前实例如果被标记为过期直接跳过等等经历一系列校验后</li><li>创建Beat健康检测任务对象, 调用taskQueue.add()将健康检测任务放入一个阻塞队列,采用异步执行的策略,检测</li><li>后续会通过taskQueue这个队列获取到任务,nacos注册中心执行这个任务访问客户端判断客户端是否存活</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">HealthCheckTask</span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用task.getCluster().allIPs(false)方法，获取当前任务对应的集群中的所有持久实例，并赋值给ips列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> ips <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>ips<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 如果为空，直接返回</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 遍历所有持久实例</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> ip <span class="token operator">:</span> ips<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调用ip.isMarked()方法，判断该实例是否已经被标记为过期</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 判断如果开启了调试模式，打印出跳过健康检查的实例的信息</span>
                    <span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"http check, ip is marked as to skip health check, ip:"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 跳过该实例，继续下一次循环</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 调用ip.markChecking()方法，判断该实例是否已经被标记为正在检查</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ip<span class="token punctuation">.</span><span class="token function">markChecking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//上一次的检查还没有完成，打印出警告日志</span>
                <span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"http check started before last one finished, service: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//调用healthCheckCommon.reEvaluateCheckRT方法，根据配置的参数，重新评估下一次检查的时间</span>
                healthCheckCommon<span class="token punctuation">.</span><span class="token function">reEvaluateCheckRT</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getCheckRtNormalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> task<span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">getHttpHealthParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// 跳过该实例，继续下一次循环</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 创建一个Beat心跳实例</span>
            <span class="token class-name">Beat</span> beat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Beat</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用taskQueue.add方法，将beat对象加入到一个队列中，等待被消费者线程处理</span>
            taskQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beat<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用MetricsMonitor.getHttpHealthCheckMonitor().incrementAndGet()方法，增加一个健康检查的计数器</span>
            <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getHttpHealthCheckMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="8"><li>后续会通过taskQueue这个队列获取到任务,nacos注册中心执行这个任务访问客户端判断客户端是否存活(没找到相关代码,相关博客)</li></ol> 
<h3><a id="4_nacos_1065"></a>4. nacos注册中心接收到心跳后的处理</h3> 
<ol><li>前面说过,在服务提供方启动时,会请求nacos的"/nacos/v1/ns/instance/beat"接口,向nacos发送代表当前服务存活的心跳,并且在发送时分当前服务首次启动携带beatInfo对象的重量级上报与后续普通不携带beatInfo的轻量级上报</li><li>查看nacos注册中心/beat接口源码</li></ol> 
<blockquote> 
 <ol><li>首先会解析请求数据,获取到当前发送心跳的服务唯一标识,通过这个唯一标识判断这个服务是否已经注册</li><li>并且会解析请求数据,判断当前心跳请求是否携带了beatInfo,如果携带了说明是首次注册发送的心跳,否则表示注册成功后用来标识服务存活的普通心跳</li><li>如果判断当前服务未注册,但是心跳请求中也没有携带beatInfo则报错返回NamingResponseCode.RESOURCE_NOT_FOUND</li><li>如果当前服务未注册,但是心跳请求中携带了表示第一次注册心跳的beatInfo,这种情况可能是服务注册请求由于网络抖动没有成功发送到nacos注册中心,而表示第一次注册的心跳早一步到达了,此时nacos注册中心会获取beatInfo中的服务信息进行服务注册,将服务ip,端口号等信息封装到Instance中代表一个服务实例,最终将服务信息保存到一个serviceMap中,当前服务的namespaceId为key</li><li>如果当前服务已注册,但是心跳请求中没有携带beatInfo,只是一次普通的心跳请求,则会执行一个processclientBeat()方法去处理此次心跳</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@CanDistro</span>
    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/beat"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>parser <span class="token operator">=</span> <span class="token class-name">NamingResourceParser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token class-name">ActionTypes</span><span class="token punctuation">.</span><span class="token constant">WRITE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ObjectNode</span> <span class="token function">beat</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建一个JSON Node，该方法的返回值就是它，后面的代码就是对这个Node进行各种初始化</span>
        <span class="token class-name">ObjectNode</span> result <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SwitchEntry</span><span class="token punctuation">.</span><span class="token constant">CLIENT_BEAT_INTERVAL</span><span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">getClientBeatInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 从请求中获取到beat，即client端的beatInfo</span>
        <span class="token class-name">String</span> beat <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"beat"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RsInfo</span> clientBeat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 将beat构建为clientBeat</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>beat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            clientBeat <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>beat<span class="token punctuation">,</span> <span class="token class-name">RsInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> clusterName <span class="token operator">=</span> <span class="token class-name">WebUtils</span>
                <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">CLUSTER_NAME</span><span class="token punctuation">,</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CLUSTER_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"ip"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取到客户端传递来的client的port，其将来用于UDP通信</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientBeat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                clusterName <span class="token operator">=</span> clientBeat<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// fix #2533</span>
                clientBeat<span class="token punctuation">.</span><span class="token function">setCluster</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ip <span class="token operator">=</span> clientBeat<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            port <span class="token operator">=</span> clientBeat<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_ID</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_NAMESPACE_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">SERVICE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkServiceNameFormat</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[CLIENT-BEAT] full arguments: beat: {}, serviceName: {}"</span><span class="token punctuation">,</span> clientBeat<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 从注册表中获取当前发送请求的client对应的instance,Ip port对应</span>
        <span class="token class-name">Instance</span> instance <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 处理注册表中不存在该client的instance的情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 若请求中没有携带心跳数据，则直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientBeat <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">CODE</span><span class="token punctuation">,</span> <span class="token class-name">NamingResponseCode</span><span class="token punctuation">.</span><span class="token constant">RESOURCE_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[CLIENT-BEAT] The instance has been removed for health mechanism, "</span>
                    <span class="token operator">+</span> <span class="token string">"perform data compensation operations, beat: {}, serviceName: {}"</span><span class="token punctuation">,</span> clientBeat<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 下面处理的情况是，注册表中没有该client的instance，但其发送的请求中具有心跳数据。</span>
            <span class="token comment">// 在client的注册请求还未到达时（网络抖动等原因），第一次心跳请求先到达了server，会出现这种情况</span>
            <span class="token comment">// 处理方式是，使用心跳数据构建出一个instance，注册到注册表</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setClusterName</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setServiceName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setInstanceId</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            instance<span class="token punctuation">.</span><span class="token function">setEphemeral</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 注册</span>
            serviceManager<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 从注册表中获取service</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span><span class="token constant">SERVER_ERROR</span><span class="token punctuation">,</span>
                    <span class="token string">"service not found: "</span> <span class="token operator">+</span> serviceName <span class="token operator">+</span> <span class="token string">"@"</span> <span class="token operator">+</span> namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 从请求中获取到beat为null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientBeat <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            clientBeat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RsInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientBeat<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientBeat<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientBeat<span class="token punctuation">.</span><span class="token function">setCluster</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 处理本次心跳</span>
        service<span class="token punctuation">.</span><span class="token function">processClientBeat</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">)</span><span class="token punctuation">;</span>

        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">CODE</span><span class="token punctuation">,</span> <span class="token class-name">NamingResponseCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">containsMetadata</span><span class="token punctuation">(</span><span class="token class-name">PreservedMetadataKeys</span><span class="token punctuation">.</span><span class="token constant">HEART_BEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SwitchEntry</span><span class="token punctuation">.</span><span class="token constant">CLIENT_BEAT_INTERVAL</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getInstanceHeartBeatInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SwitchEntry</span><span class="token punctuation">.</span><span class="token constant">LIGHT_BEAT_ENABLED</span><span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">isLightBeatEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>查看处理心跳的processclientBeat()方法源码,通过HealthCheckReactor的scheduleNow()立即执行了ClientBeatProcessor 下的任务run()</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processclientBeat</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RsInfo</span> rsInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建一个处理器，其是一个任务</span>
        <span class="token class-name">ClientBeatProcessor</span> clientBeatProcessor<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientBeatProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientBeatProcessor<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientBeatProcessor<span class="token punctuation">.</span><span class="token function">setRsInfo</span><span class="token punctuation">(</span>rsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开启一个立即执行的任务，即执行clientBeatProcessor任务的run()</span>
        <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleNow</span><span class="token punctuation">(</span>clientBeatProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>查看ClientBeatProcessor中的任务方法run()</li></ol> 
<blockquote> 
 <ol><li>获取当前发送心跳的服务的所有的临时实例,只有临时实例才会有心跳</li><li>遍历所有这些临时实例,从中查找当前发送心跳的instance,判断原instance与当前心跳接收到的ip,端口号是否相同,如果相同更新心跳时间即可</li><li>若当前instance健康状态为false，但本次是其发送的心跳,则更新为健康,并且执行getPushService().serviceChanged(service)发布服务变更事件通知服务消费方更新其本地缓存的信息</li></ol> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[CLIENT-BEAT] processing beat: {}"</span><span class="token punctuation">,</span> rsInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> ip <span class="token operator">=</span> rsInfo<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> clusterName <span class="token operator">=</span> rsInfo<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> rsInfo<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前服务的所有临时实例</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历所有这些临时实例，从中查找当前发送心跳的instance</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 只要ip与port与当前心跳的instance的相同，就是了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[CLIENT-BEAT] refresh beat: {}"</span><span class="token punctuation">,</span> rsInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 修改最后心跳时间戳</span>
                instance<span class="token punctuation">.</span><span class="token function">setLastBeat</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 修改该instance的健康状态</span>
                <span class="token comment">// 当instance被标记时，即其marked为true时，其是一个持久实例</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// instance的healthy才是临时实例健康状态的表示</span>
                    <span class="token comment">// 若当前instance健康状态为false，但本次是其发送的心跳，说明这个instance“起死回生”了，</span>
                    <span class="token comment">// 我们需要将其health变为true</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        instance<span class="token punctuation">.</span><span class="token function">setHealthy</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">EVT_LOG</span>
                                <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"service: {} {POS} {IP-ENABLED} valid: {}:{}@{}, region: {}, msg: client beat ok"</span><span class="token punctuation">,</span>
                                        cluster<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token constant">LOCALHOST_SITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 发布服务变更事件(其对后续我们要分析的UDP通信非常重要)</span>
                        <span class="token function">getPushService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5_nacosUDP_1222"></a>5. nacos注册中心与连接服务间的UDP通信</h3> 
<ol><li>查看上面,nacos注册中心在通过beat()接口处理心跳逻辑,获取到当前发起心跳的服务ip,端口号等信息,与注册中心serviceMap注册列表中保存的对应的instance是否相同,如果相同更新心跳时间返回,如果不同,或者第一次接受到心跳,或者当前instance实例健康状态发生改变时,会执行 “getPushService().serviceChanged(service);” 发布服务变更事件,查看serviceChanged()源码,内部通过applicationContext.publishEvent()插入了一个ServiceChangeEvent事件最终事件监听执行触发调用PushService的onApplicationEvent()方法</li></ol> 
<blockquote> 
 <ol><li>nacos注册中心服务通过一个PushService的类实现服务向连接client的信息推送,支持TCP和UDP两种推送方式,TCP方式是通过建立长连接来推送服务信息,UDP方式是通过发送UDP包来推送服务信息</li><li>TCP方式比较稳定,但是会占用更多的资源和端口,而UDP方式比较轻量,但是不能保证数据的可靠性。因此nacos默认使用UDP方式来推送服务信息时为了提高数据的可靠性使用了一种ACK机制,指NacosServer发送一个UDP包给NacosClient时,会等待NacosClient回复一个ACK来确认收到数据,如果NacosServer在一定时间内没有收到ACK会认为数据丢失,进行重试,<strong>如果重试次数达到最大值(默认为3次)则放弃发送,并记录失败日志</strong></li></ol> 
</blockquote> 
<ol start="2"><li>查看PushService的onApplicationEvent()方法源码:</li></ol> 
<blockquote> 
 <ol><li>首先会通过当前变更服务的namespaceId和serviceName,在clientMap中获取到订阅该服务的所有客户端(clientMap保存了服务订阅者)</li><li>遍历获取到的这些客户端,如果客户端存活,执行udpPush()与客户端进行UDP通信,将变更消息推送给订阅客户端</li></ol> 
</blockquote> 
<ol start="3"><li>查看PushService下的udpPush()方法:</li></ol> 
<blockquote> 
 <ol><li>内部有一个failedPush失败计数器,如果通信失败,会累计加1, 还有一个RetryTimes发送次数属性,</li><li>在发送请求前首先会将此次请求缓存到ackMap和udpSendTimeMap中,</li><li>然后调用udpSocket.send()发送udp请求到客户端,增加RetryTimes发送次数</li><li>当前这个发送是基于ack模式来确认是否发送成功的, 在udpSocket.send()发送请求后,会调用GlobalExecutor.scheduleRetransmitter()插入定时任务,<strong>10秒后执行:处理ack超时问题,通过ackMap判断是否还有缓存的没有收到ack的任务ackentry.key,如果有重试发送</strong></li><li>在重试时也是调用当前的udpPush(),<strong>首先判断RetryTimes发送次数是否超过了MAX_RETRY_TIMES最大重试次数(默认3次)</strong>,如果超过了则删除ackMap和udpSendTimeMap中缓存的任务信息,记录日志,取消发送</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Receiver<span class="token punctuation">.</span>AckEntry</span> <span class="token function">udpPush</span><span class="token punctuation">(</span><span class="token class-name">Receiver<span class="token punctuation">.</span>AckEntry</span> ackEntry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-PUSH] ackEntry is null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 到达最大重试次数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span><span class="token function">getRetryTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_RETRY_TIMES</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"max re-push times reached, retry times {}, key: {}"</span><span class="token punctuation">,</span> ackEntry<span class="token punctuation">.</span>retryTimes<span class="token punctuation">,</span> ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ackMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            failedPush <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ackEntry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ackMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                totalPush<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 保存到ackMap中</span>
            ackMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> ackEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存到udpSendTimeMap中</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"send udp packet: "</span> <span class="token operator">+</span> ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发生udp数据包</span>
            udpSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 增加发送次数</span>
            ackEntry<span class="token punctuation">.</span><span class="token function">increaseRetryTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">// 10s后，如果ackMap中，还有ackentry.key, 就重试发送,也就是ack超时</span>
            <span class="token comment">//(具体处理逻辑在Retransmitter的run方法中,内部还是调用了当前的udpPush()方法,达到定时重试效果)</span>
            <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">scheduleRetransmitter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Retransmitter</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token constant">ACK_TIMEOUT_NANOS</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token keyword">return</span> ackEntry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-PUSH] failed to push data: {} to client: {}, error: {}"</span><span class="token punctuation">,</span> ackEntry<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                    ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ackMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            failedPush <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>继续查看PushService, 内部存在一个静态代码块,通过定时任务定时执行removeClientIfZombie()方法,默认每20秒执行一次,移除超过10秒没有更新的pushClient</li></ol> 
<pre><code class="prism language-go">static <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 构建udpsocket</span>
            udpSocket <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">DatagramSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 构造receiver线程</span>
            Receiver receiver <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">Receiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            Thread inThread <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"com.alibaba.nacos.naming.push.receiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 启动定时任务，定时清理长时间未更新的pushClient,</span>
            <span class="token comment">// 默认20s执行一次，超过10s就会认为超时，pushClient会被移除</span>
            GlobalExecutor<span class="token punctuation">.</span><span class="token function">scheduleRetransmitter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                try <span class="token punctuation">{<!-- --></span>
                    <span class="token function">removeClientIfZombie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Throwable e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Loggers<span class="token punctuation">.</span>PUSH<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[NACOS-PUSH] failed to remove client zombie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>SocketException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Loggers<span class="token punctuation">.</span>SRV_LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-PUSH] failed to init push service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>PushService实现了Runnable接口,是一个任务类,当向客户端发送完udp服务变更通知后,会定时执行这个任务,处理来自客户端的ack响应,内部开启了一个无限循环接收来自客户端的ack响应,当接收到响应后,会删除ackMap中的ackKey</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">DatagramPacket</span> packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 接收消息</span>
                    udpSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 转成ackPacket</span>
                    <span class="token class-name">AckPacket</span> ackPacket <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">AckPacket</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                    <span class="token class-name">InetSocketAddress</span> socketAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">)</span> packet<span class="token punctuation">.</span><span class="token function">getSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> ip <span class="token operator">=</span> socketAddress<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> port <span class="token operator">=</span> socketAddress<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 是否超时</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ackPacket<span class="token punctuation">.</span>lastRefTime <span class="token operator">&gt;</span> <span class="token constant">ACK_TIMEOUT_NANOS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"ack takes too long from {} ack json: {}"</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
 
                    <span class="token class-name">String</span> ackKey <span class="token operator">=</span> <span class="token function">getAckKey</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> ackPacket<span class="token punctuation">.</span>lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 从待ackmap中删除</span>
                    <span class="token class-name">AckEntry</span> ackEntry <span class="token operator">=</span> ackMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                                <span class="token string">"unable to find ackEntry for key: "</span> <span class="token operator">+</span> ackKey <span class="token operator">+</span> <span class="token string">", ack json: "</span> <span class="token operator">+</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
 
                    <span class="token keyword">long</span> pushCost <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> udpSendTimeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ackKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span>
                            <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"received ack: {} from: {}:{}, cost: {} ms, unacked: {}, total push: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> ip<span class="token punctuation">,</span>
                                    port<span class="token punctuation">,</span> pushCost<span class="token punctuation">,</span> ackMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalPush<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 保存push到ack的耗时</span>
                    pushCostMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackKey<span class="token punctuation">,</span> pushCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 发送时间map中删除</span>
                    udpSendTimeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">PUSH</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-PUSH] error while receiving ack data"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_nacos_1355"></a>6. nacos注册中心处理注销服务请求</h3> 
<ol><li>nacos接收到服务注销请求后处理比较简单,请求会到达nacos的deregister()接口或deregisterInstance()接口,大致流程为:</li></ol> 
<blockquote> 
 <ol><li>解析请求获取到需要下线的服务的Instance实例</li><li>获取到对应的service</li><li>将当前服务实例在nacos中删除</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@CanDistro</span>
    <span class="token annotation punctuation">@DeleteMapping</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>parser <span class="token operator">=</span> <span class="token class-name">NamingResourceParser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token class-name">ActionTypes</span><span class="token punctuation">.</span><span class="token constant">WRITE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deregister</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.从请求中获取要操作的instance</span>
        <span class="token class-name">Instance</span> instance <span class="token operator">=</span> <span class="token function">getIpAddress</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//......</span>
        <span class="token comment">//2.从注册表中获取service</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getservice</span><span class="token punctuation">(</span>namespaceld<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//......</span>
        <span class="token comment">//3.删除instance</span>
        serviceManager<span class="token punctuation">.</span><span class="token function">removeInstance</span><span class="token punctuation">(</span>namespaceld<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//......</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="__1376"></a>四. 服务发现相关</h2> 
<ol><li>服务消费方启动时持有服务提供方名称,连接注册中心通过服务提供方名称获取调用列表,在请求时本地负载均衡选择指定地址发起调用,那么是如何获取的,如何保存的,又是如何更新的</li><li>服务消费方在通过nacos注册中心获取目标服务时,首先要引入nacos依赖,使用@EnableDiscoveryClient开启服务发现功能,yaml中进行相关设置,当前以spring-cloud-starter-alibaba-nacos-discovery依赖为例</li></ol> 
<pre><code class="prism language-xml"> 		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2021.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="3"><li>在整合了spring-cloud-starter-alibaba-nacos-discovery以后,根据SpringBoot SPI机制读取META-INF/spring.factories,查看该文件,发现创建了NacosDiscoveryAutoConfiguration与NacosDiscoveryClientConfiguration几个比较重要的类<br> <img src="https://images2.imgbox.com/9c/78/usgNPvEL_o.png" alt="在这里插入图片描述"></li><li>查看NacosDiscoveryClientConfiguration ,通过这个类向容器中注入了一个NacosDiscoveryClient,这是服务消费方获取目标服务的入口</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>
    proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnDiscoveryEnabled</span>
<span class="token annotation punctuation">@ConditionalOnBlockingDiscoveryEnabled</span>
<span class="token annotation punctuation">@ConditionalOnNacosDiscoveryEnabled</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">SimpleDiscoveryClientAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CommonsClientAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">NacosDiscoveryAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosDiscoveryClientConfiguration</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">NacosDiscoveryClientConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DiscoveryClient</span> <span class="token function">nacosDiscoveryClient</span><span class="token punctuation">(</span><span class="token class-name">NacosServiceDiscovery</span> nacosServiceDiscovery<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosDiscoveryClient</span><span class="token punctuation">(</span>nacosServiceDiscovery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>
        value <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"spring.cloud.nacos.discovery.watch.enabled"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">NacosWatch</span> <span class="token function">nacosWatch</span><span class="token punctuation">(</span><span class="token class-name">NacosServiceManager</span> nacosServiceManager<span class="token punctuation">,</span> <span class="token class-name">NacosDiscoveryProperties</span> nacosDiscoveryProperties<span class="token punctuation">,</span> <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadPoolTaskScheduler</span><span class="token punctuation">&gt;</span></span> taskExecutorObjectProvider<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosWatch</span><span class="token punctuation">(</span>nacosServiceManager<span class="token punctuation">,</span> nacosDiscoveryProperties<span class="token punctuation">,</span> taskExecutorObjectProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>查看NacosDiscoveryClient源码,内部提供了一个getServices()方法和getInstances()方法,是获取目标服务信息的入口在服务消费方启动时会调用这个getServices()方法获取目标服务列表,在服务接口调用时会通过getInstances()方法获取目标服务</li></ol> 
<pre><code class="prism language-go">public class NacosDiscoveryClient implements DiscoveryClient <span class="token punctuation">{<!-- --></span>
    private static final Logger log <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>NacosDiscoveryClient<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    public static final String DESCRIPTION <span class="token operator">=</span> <span class="token string">"Spring Cloud Nacos Discovery Client"</span><span class="token punctuation">;</span>
    private NacosServiceDiscovery serviceDiscovery<span class="token punctuation">;</span>

    public <span class="token function">NacosDiscoveryClient</span><span class="token punctuation">(</span>NacosServiceDiscovery nacosServiceDiscovery<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this<span class="token punctuation">.</span>serviceDiscovery <span class="token operator">=</span> nacosServiceDiscovery<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public String <span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"Spring Cloud Nacos Discovery Client"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public List<span class="token operator">&lt;</span>ServiceInstance<span class="token operator">&gt;</span> <span class="token function">getInstances</span><span class="token punctuation">(</span>String serviceId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> this<span class="token punctuation">.</span>serviceDiscovery<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw <span class="token builtin">new</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Can not get hosts from nacos server. serviceId: "</span> <span class="token operator">+</span> serviceId<span class="token punctuation">,</span> var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    public List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> this<span class="token punctuation">.</span>serviceDiscovery<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception var2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"get service name from nacos server fail,"</span><span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>查看NacosDiscoveryClient的getInstances()方法源码,内部会调用NacosServiceDiscovery下的getInstances(),该方法中会获取到NacosNamingService对象,调用它的selectInstances()方法,最终会调用到HostReactor下的getServiceInfo()</li></ol> 
<pre><code class="prism language-java">	<span class="token comment">//NacosServiceDiscovery类下的</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//1.</span>
        <span class="token class-name">String</span> group <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discoveryProperties<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.this.namingService():获取到NacosNamingService对象,调用它的selectInstances()</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">namingService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">hostToServiceInstanceList</span><span class="token punctuation">(</span>instances<span class="token punctuation">,</span> serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//NacosNamingService类下的</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectInstances</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clusters<span class="token punctuation">,</span> <span class="token keyword">boolean</span> healthy<span class="token punctuation">,</span> <span class="token keyword">boolean</span> subscribe<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServiceInfo</span> serviceInfo<span class="token punctuation">;</span>
        <span class="token comment">//否订阅服务地址的变化,默认为true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            serviceInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfo</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            serviceInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfoDirectlyFromServer</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectInstances</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">,</span> healthy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="7"><li>查看HostReactor下的getServiceInfo()源码</li></ol> 
<blockquote> 
 <ol><li>会调用getSerivceInfo0()通过目标服务的serviceName查询本地是否已经存在</li><li>如果不存在则<strong>调用updateServiceNow()请求nacos注册中心获取目标服务保存到serviceInfoMap</strong>,中间为了防止并发安全问题,在获取目标服务时首先会将当前获取的服务信息缓存到一个updatingMap中,当获取完毕后在updatingMap中删除这个服务信息,<strong>后续再获取时,如果updatingMap中存在说明当前获取的服务正在更新,加锁等待UPDATE_HOLD_INTERVAL默认为1000毫秒后再去获取</strong></li><li>目标服务获取成功,或者目标服务存在,则会<strong>调用scheduleUpdateIfAbsent()方法,创建UpdateTask任务,开启延时任务默认10s后想NacosServer发送请求</strong>去查询一次服务地址进行更新</li><li>最后将获取的目标服务返回</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">ServiceInfo</span> <span class="token function">getServiceInfo</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> clusters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 

        <span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"failover-mode: "</span> <span class="token operator">+</span> failoverReactor<span class="token punctuation">.</span><span class="token function">isFailoverSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">//拼接服务名称+集群名称（默认为空）</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否开启了故障转移模式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failoverReactor<span class="token punctuation">.</span><span class="token function">isFailoverSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果开启了故障转移模式，就从failoverReactor对象中获取对应key的服务信息，并返回</span>
            <span class="token keyword">return</span> failoverReactor<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//从ServiceInfoMap中根据key来查找服务提供者列表，客户端获取到目标服务列表后会缓存到一个serviceInfoMap中</span>
        <span class="token class-name">ServiceInfo</span> serviceObj <span class="token operator">=</span> <span class="token function">getSerivceInfo0</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果为空，表示本地缓存不存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> serviceObj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//创建一个新的ServiceInfo对象,放入serviceInfoMap</span>
            serviceObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将服务名作为键，新建一个Object对象作为值，表示该服务正在更新中,存入updatingMap</span>
            updatingMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用updateServiceNow方法，立即向Nacos Server发送请求，获取最新的服务地址信息，并更新到本地缓存中</span>
            <span class="token function">updateServiceNow</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用updatingMap的remove方法，将服务名从键值对中移除，表示该服务已经更新完毕</span>
            updatingMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updatingMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//判断updatingMap是否包含该服务名</span>
            <span class="token comment">//如果从serviceInfoMap找出来的serviceObj在updatingMap中则等待UPDATE_HOLD_INTERVAL,默认为1000毫秒</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateHoldInterval <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>serviceObj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//对serviceObj对象加锁，防止并发修改</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    	<span class="token comment">//调用serviceObj的wait方法，让当前线程等待updateHoldInterval毫秒或者被其他线程唤醒</span>
                        serviceObj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>updateHoldInterval<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[getServiceInfo] serviceName:"</span> <span class="token operator">+</span> serviceName <span class="token operator">+</span> <span class="token string">", clusters:"</span> <span class="token operator">+</span> clusters<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//如果本地缓存中存在，则通过scheduleUpdateIfAbsent开启定时任务,再从serviceInfoMap取出serviceInfo</span>
        <span class="token comment">//根据配置项naming.healthCheckTaskInterval默认每10s向NacosServer发送请求去查询一次服务地址进行更新</span>
        <span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用serviceInfoMap的get方法，根据serviceObj的key，获取最新的服务信息，并返回</span>
        <span class="token keyword">return</span> serviceInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="8"><li>查看获取目标服务信息的updateServiceNow()方法源码,</li></ol> 
<blockquote> 
 <ol><li>先执行了一个"pushReceiver.getUDPPort() "比较重要,获取当前服务UDP端口号,前面在服务注册时提到,NacosServer会主动向客户端发送UDP请求进行探测,探测的UDP端口就是通过这里传给NacosServer的</li><li>最终会封装请求数据,请求nacso注册中心的/list接口获取服务信息</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateServiceNow</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> clusters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServiceInfo</span> oldService <span class="token operator">=</span> <span class="token function">getSerivceInfo0</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//向server提交一个GTE请求，获取服务ServiceInfo</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> serverProxy<span class="token punctuation">.</span><span class="token function">queryList</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> pushReceiver<span class="token punctuation">.</span><span class="token function">getUDPPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//将获取到的ServiceInfo更新到本地注册表</span>
                <span class="token function">processServiceJSON</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
　　　　<span class="token comment">// .......</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryList</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> clusters<span class="token punctuation">,</span> <span class="token keyword">int</span> udpPort<span class="token punctuation">,</span> <span class="token keyword">boolean</span> healthyOnly<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 组装请求参数</span>
        <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_ID</span><span class="token punctuation">,</span> namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">SERVICE_NAME</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clusters"</span><span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"udpPort"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>udpPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clientIP"</span><span class="token punctuation">,</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"healthyOnly"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>healthyOnly<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过HttpClient 发送请求</span>
        <span class="token keyword">return</span> <span class="token function">reqAPI</span><span class="token punctuation">(</span><span class="token class-name">UtilAndComs</span><span class="token punctuation">.</span><span class="token constant">NACOS_URL_BASE</span> <span class="token operator">+</span> <span class="token string">"/instance/list"</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="1_Client_1556"></a>1. 服务Client心跳检测</h3> 
<ol><li>上面说到服务消费方启动时会触发获取目标服务信息的动作,在获取到目标服务后,调用scheduleUpdateIfAbsent()方法延时任务,查看该方法源码: 会创建一个UpdateTask任务类,通过executor.schedule()执行这个任务,最终做到根据naming.healthCheckTaskInterval配置项默认10s后向NacosServer发送请求去查询一次服务地址进行更新,更新执行后会执行executor.schedule()插入以一次的任务(可以理解为定时任务)下无异常情况下调度时间为6秒,最长为1分钟执行一次心跳检测</li></ol> 
<pre><code class="prism language-java"><span class="token comment">// ServiceInfoUpdateService</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">String</span> clusters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> serviceKey <span class="token operator">=</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 构建UpdateTask</span>
        <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdateTask</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        futureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ServiceInfoUpdateService</span>
<span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token class-name">UpdateTask</span> task<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token constant">DEFAULT_DELAY</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>查看UpdateTask任务类中向NacosServer发送请求查询服务信息的run()方法源码:</li></ol> 
<blockquote> 
 <ol><li>获取本地缓存的目标服务,如果目标服务更新时间小于等于缓存刷新时间请求nacos注册中心获取目标服务信息更新本地</li><li>更新完毕后,同步记录更新时间</li><li>最后执行executor.schedule()根据服务健康情况计算failCount,计算任务下次执行时间,无异常情况下也就是failCount等于0缓存实例的刷新时间是6秒,最长为1分钟</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> delayTime <span class="token operator">=</span> <span class="token constant">DEFAULT_DELAY</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断该注册的Service是否被订阅，如果没有订阅则不再执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>changeNotifier<span class="token punctuation">.</span><span class="token function">isSubscribed</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>futureMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token constant">NAMING_LOGGER</span>
                    <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"update task is stopped, service:"</span> <span class="token operator">+</span> groupedServiceName <span class="token operator">+</span> <span class="token string">", clusters:"</span> <span class="token operator">+</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取缓存的service信息</span>
        <span class="token class-name">ServiceInfo</span> serviceObj <span class="token operator">=</span> serviceInfoHolder<span class="token punctuation">.</span><span class="token function">getServiceInfoMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceObj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 根据serviceName从注册中心服务端获取Service信息</span>
            serviceObj <span class="token operator">=</span> namingClientProxy<span class="token punctuation">.</span><span class="token function">queryInstancesOfService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serviceInfoHolder<span class="token punctuation">.</span><span class="token function">processServiceInfo</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastRefTime <span class="token operator">=</span> serviceObj<span class="token punctuation">.</span><span class="token function">getLastRefTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 过期服务（服务的最新更新时间小于等于缓存刷新时间），从注册中心重新查询</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getLastRefTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> lastRefTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            serviceObj <span class="token operator">=</span> namingClientProxy<span class="token punctuation">.</span><span class="token function">queryInstancesOfService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理Service消息</span>
            serviceInfoHolder<span class="token punctuation">.</span><span class="token function">processServiceInfo</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 刷新更新时间</span>
        lastRefTime <span class="token operator">=</span> serviceObj<span class="token punctuation">.</span><span class="token function">getLastRefTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">incFailCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 下次更新缓存时间设置，默认为6秒</span>
        <span class="token comment">// TODO multiple time can be configured.</span>
        delayTime <span class="token operator">=</span> serviceObj<span class="token punctuation">.</span><span class="token function">getCacheMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">DEFAULT_UPDATE_CACHE_TIME_MULTIPLE</span><span class="token punctuation">;</span>
        <span class="token comment">// 重置失败数量为0</span>
        <span class="token function">resetFailCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">incFailCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[NA] failed to update serviceName: "</span> <span class="token operator">+</span> groupedServiceName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 下次调度刷新时间，下次执行的时间与failCount有关</span>
        <span class="token comment">// failCount=0，则下次调度时间为6秒，最长为1分钟</span>
        <span class="token comment">// 即当无异常情况下缓存实例的刷新时间是6秒</span>
        executor<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>delayTime <span class="token operator">&lt;&lt;</span> failCount<span class="token punctuation">,</span> <span class="token constant">DEFAULT_DELAY</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_ClientUDPnacosUDP_1632"></a>2. 服务Client的UDP端口上报和接收nacos注册中心的UDP更新</h3> 
<ol><li>我们再回到服务注册的逻辑,在服务注册成功后开启定时任务默认每5秒执行一次请求nacos的beat接口保持心跳,nacos注册中心在通过beat()接口接收到心跳请求后,获取到当前发起心跳的服务ip,端口号等信息,与serviceMap注册列表中保存的对应的instance是否相同,如果相同更新心跳时间返回,如果不同,或者第一次接受到心跳,或者当前instance实例健康状态发生改变时,会执行**"getPushService().serviceChanged(service);"发布服务变更事件,默认使用UDP+ACK机制来推送服务信息时给当前服务的订阅者实现信息同步(因为UDP方式比较轻量,但是不能保证数据可靠性,所以引入ack机制也是定时任务默认10后执行进行ack确认,如果重试次数达到最大值(默认为3次)则放弃发送,并记录失败日志),那么nacos注册中心是如何找到对应客户端的</li><li>在服务client启动后会请求nacos注册中心获取目标服务,在请求nacos注册中心时会调用"pushReceiver.getUDPPort()"获取到自己的udp端口号一块上报给注册中心,此时注册中心就能拿到对应客户端地址了, 那当前服务的这个地址是怎么分配的,后续客户端又是如何接收处理nacos服务通过udp推送过来的变更请求的</li><li>这里再回到整合nacos注册中心的服务启动,整合了nacos注册中心的服务在启动时首先会解析yaml中的nacos相关配置,执行NamingFactory下的createNamingService()方法创建NamingService,默认情况下返回的是NacosNamingService,这个类重写了init()方法又初始化创建了几个核心类,其中有一个HostReactor用来处理与nacos服务的udp通信,查看HostReactor构造器源码,当前终点关注创建了PushReceiver</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">HostReactor</span><span class="token punctuation">(</span><span class="token class-name">NamingProxy</span> serverProxy<span class="token punctuation">,</span> <span class="token class-name">BeatReactor</span> beatReactor<span class="token punctuation">,</span> <span class="token class-name">String</span> cacheDir<span class="token punctuation">,</span> <span class="token keyword">boolean</span> loadCacheAtStart<span class="token punctuation">,</span> <span class="token keyword">boolean</span> pushEmptyProtection<span class="token punctuation">,</span> <span class="token keyword">int</span> pollingThreadCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>futureMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>pollingThreadCount<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"com.alibaba.nacos.client.naming.updater"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beatReactor <span class="token operator">=</span> beatReactor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy <span class="token operator">=</span> serverProxy<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cacheDir <span class="token operator">=</span> cacheDir<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadCacheAtStart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceInfoMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token class-name">DiskCache</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceInfoMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>pushEmptyProtection <span class="token operator">=</span> pushEmptyProtection<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>updatingMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failoverReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FailoverReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当前终点</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pushReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PushReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstancesChangeNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">registerToPublisher</span><span class="token punctuation">(</span><span class="token class-name">InstancesChangeEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">registerSubscriber</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>PushReceiver,该类本身就实现了Runnable接口,是一个任务类,查看构造器源码</li></ol> 
<blockquote> 
 <ol><li>分配udp端口号</li><li>创建了一个ScheduledThreadPoolExecutor线程池,将自身作为任务类执行</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">PushReceiver</span><span class="token punctuation">(</span><span class="token class-name">HostReactor</span> hostReactor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor <span class="token operator">=</span> hostReactor<span class="token punctuation">;</span>
            <span class="token comment">//1.分配udp端口号</span>
            <span class="token class-name">String</span> udpPort <span class="token operator">=</span> <span class="token function">getPushReceiverUdpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 没有配置，就使用随机的端口号</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>udpPort<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>udpSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>udpSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>udpPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 			<span class="token comment">//2.创建线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"com.alibaba.nacos.naming.push.receiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.将自己提交到线程池执行</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NA] init udp socket failed"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>查看PushReceiver用来处理任务的run()方法</li></ol> 
<blockquote> 
 <ol><li>内部开启了一个无限循环,通过udpSocket.receive(packet)来接收来自nacos注册中心发来的服务信息变更请求</li><li>调用HostReactor下的processServiceJson()处理接收到的变更,同步本地</li><li>执行udpSocket.send() ack响应nacos注册中心</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//开启无限循环</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">DatagramPacket</span> packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//1.接收来自注册中心的udp服务变更通知</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>udpSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">tryDecompress</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"received push data: "</span> <span class="token operator">+</span> json <span class="token operator">+</span> <span class="token string">" from "</span> <span class="token operator">+</span> packet<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PushReceiver<span class="token punctuation">.</span>PushPacket</span> pushPacket <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PushReceiver<span class="token punctuation">.</span>PushPacket</span><span class="token punctuation">)</span><span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">PushReceiver<span class="token punctuation">.</span>PushPacket</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> ack<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"dom"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"service"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dump"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        ack <span class="token operator">=</span> <span class="token string">"{\"type\": \"dump-ack\", \"lastRefTime\": \""</span> <span class="token operator">+</span> pushPacket<span class="token punctuation">.</span>lastRefTime <span class="token operator">+</span> <span class="token string">"\", \"data\":\""</span> <span class="token operator">+</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">escapeJavaScript</span><span class="token punctuation">(</span><span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfoMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\"}"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        ack <span class="token operator">=</span> <span class="token string">"{\"type\": \"unknown-ack\", \"lastRefTime\":\""</span> <span class="token operator">+</span> pushPacket<span class="token punctuation">.</span>lastRefTime <span class="token operator">+</span> <span class="token string">"\", \"data\":\"\"}"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">//2.处理变更</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor<span class="token punctuation">.</span><span class="token function">processServiceJson</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ack <span class="token operator">=</span> <span class="token string">"{\"type\": \"push-ack\", \"lastRefTime\":\""</span> <span class="token operator">+</span> pushPacket<span class="token punctuation">.</span>lastRefTime <span class="token operator">+</span> <span class="token string">"\", \"data\":\"\"}"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">//3.ack响应nacos注册中心</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>udpSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>ack<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ack<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var6<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">LogUtils</span><span class="token punctuation">.</span><span class="token constant">NAMING_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NA] error while receiving push data"</span><span class="token punctuation">,</span> var6<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_nacos_1739"></a>3. nacos注册中心对订阅请求的处理</h3> 
<ol><li>nacos注册中心通过InstanceController下的/list接收订阅请求,查看该接口源码</li></ol> 
<blockquote> 
 <ol><li>解析获取请求数据,比如namespceId、serviceName、agent(指定提交请求的客户端是哪种类型)、clusters、clusterIP、udpPort(后续UDP通信会使用)、app、tenant 等</li><li>重点都在最后调用的doSrvIpxt()方法中,根据agent创建对应的ClientInfo,然后进行订阅处理</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>parser <span class="token operator">=</span> <span class="token class-name">NamingResourceParser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token class-name">ActionTypes</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ObjectNode</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token comment">// 获取命名空间id</span>
    <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_ID</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_NAMESPACE_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取服务名称</span>
    <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span><span class="token constant">SERVICE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检验服务名称是否合法</span>
    <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">checkServiceNameFormat</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 获取请求域中的User-Agent参数</span>
    <span class="token class-name">String</span> agent <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取集群名称</span>
    <span class="token class-name">String</span> clusters <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"clusters"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取客户端ip</span>
    <span class="token class-name">String</span> clientIP <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"clientIP"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取udp绑定的端口</span>
    <span class="token keyword">int</span> udpPort <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"udpPort"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 获取指定的环境</span>
    <span class="token class-name">String</span> env <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"env"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isCheck <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span><span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"isCheck"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> app <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> tenant <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"tid"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">boolean</span> healthyOnly <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span><span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">"healthyOnly"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//对请求进行详细处理</span>
    <span class="token keyword">return</span> <span class="token function">doSrvIpxt</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> udpPort<span class="token punctuation">,</span> env<span class="token punctuation">,</span> isCheck<span class="token punctuation">,</span> app<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span>
            healthyOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>查看doSrvIpxt()源码,内部:</li></ol> 
<blockquote> 
 <ol><li>首先根据不同的agent创建对应的ClientInfo,比如有对应 java、c、c++、go、nginx、dnsf等类型的</li><li>然后判断是否拿到了当前客户端的udp端口号udpPort,如果拿到了执行pushService.addClient()将当前客户端封装为PushClient最终添加到nacos注册中心的clientMap列表中</li><li>其实就是往clientMap集合中添加PushClient对象,而每一个PushClient对象里面都封装了拉取的客户端的信息,</li><li>服务提供方启动后会发送心跳给注册中心,并且注册中心内部有自己的健康检查,当发现服务注册方存在变化时调用PushService的serviceChanged(service)方法插入事件,事件执行通过udp+ack的方式通知订阅当前服务的客户端,客户端信息就是通过这个clientMap获取到的</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ObjectNode</span> <span class="token function">doSrvIpxt</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> agent<span class="token punctuation">,</span> <span class="token class-name">String</span> clusters<span class="token punctuation">,</span> <span class="token class-name">String</span> clientIP<span class="token punctuation">,</span>
        <span class="token keyword">int</span> udpPort<span class="token punctuation">,</span> <span class="token class-name">String</span> env<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isCheck<span class="token punctuation">,</span> <span class="token class-name">String</span> app<span class="token punctuation">,</span> <span class="token class-name">String</span> tid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> healthyOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token class-name">ClientInfo</span> clientInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientInfo</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ObjectNode</span> result <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 根据命名空间id和服务名称获取对应的服务对象</span>
    <span class="token class-name">Service</span> service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">long</span> cacheMillis <span class="token operator">=</span> switchDomain<span class="token punctuation">.</span><span class="token function">getDefaultCacheMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// now try to enable the push</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意这里，如果udpPort &gt; 0才会成立，只有客户端订阅了服务之后，这里的udp才会大于0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>udpPort <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pushService<span class="token punctuation">.</span><span class="token function">canEnablePush</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
            <span class="token comment">// 当客户端订阅了服务之后，就会作为可推送的目标客户端添加给推送服务组件</span>
            pushService
                    <span class="token punctuation">.</span><span class="token function">addClient</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">,</span> udpPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            pushDataSource<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cacheMillis <span class="token operator">=</span> switchDomain<span class="token punctuation">.</span><span class="token function">getPushCacheMillis</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span>
                <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-API] failed to added push client {}, {}:{}"</span><span class="token punctuation">,</span> clientInfo<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> udpPort<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cacheMillis <span class="token operator">=</span> switchDomain<span class="token punctuation">.</span><span class="token function">getDefaultCacheMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 条件成立：指定的服务并不存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"no instance to serve for service: {}"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clusters"</span><span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cacheMillis"</span><span class="token punctuation">,</span> cacheMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"hosts"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyArrayNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 简单封装下对象返回给客户端</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 校验该服务是否开启，如果没有开启则抛出异常</span>
    <span class="token function">checkIfDisabled</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> srvedIPs<span class="token punctuation">;</span>
 
    <span class="token comment">// 获取该服务指定集群下所有的实例</span>
    srvedIPs <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">srvIPs</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果要查询的服务有selector并且clientIp不为空，那么就需要经过selector对该客户端进行负载均衡去获取实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        srvedIPs <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">,</span> srvedIPs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 条件成立：该服务下没有实例，或者过滤之后没有实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>srvedIPs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"no instance to serve for service: {}"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientInfo<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token class-name">ClientInfo<span class="token punctuation">.</span>ClientType</span><span class="token punctuation">.</span><span class="token constant">JAVA</span>
                <span class="token operator">&amp;&amp;</span> clientInfo<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">VersionUtil</span><span class="token punctuation">.</span><span class="token function">parseVersion</span><span class="token punctuation">(</span><span class="token string">"1.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dom"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dom"</span><span class="token punctuation">,</span> <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cacheMillis"</span><span class="token punctuation">,</span> cacheMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"lastRefTime"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"checksum"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"useSpecifiedURL"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clusters"</span><span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"env"</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"hosts"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyArrayNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">transferToJsonNode</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 简单封装下对象返回给客户端</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 代码执行到这里说明获取到该服务下的实例</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ipMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ipMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ipMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 区分下健康实例与非健康实例</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> ip <span class="token operator">:</span> srvedIPs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ip<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 是否检查，默认是false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCheck<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"reachProtectThreshold"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 获取该服务指定的服务保护阈值</span>
    <span class="token keyword">double</span> threshold <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getProtectThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 条件成立：该服务下健康的实例占总实例数的百分比小于等于服务保护阈值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> srvedIPs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"protect threshold reached, return all ips, service: {}"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCheck<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"reachProtectThreshold"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// 开启服务保护机制，把非健康的实例也放到健康的实例集合下</span>
        ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCheck<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"protectThreshold"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getProtectThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"reachLocalSiteCallThreshold"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 代码执行到这里说明没有触发服务保护机制</span>
    <span class="token class-name">ArrayNode</span> hosts <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyArrayNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> ipMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> ips <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 如果客户端指定了只要获取健康的实例，那么就跳过非健康的实例</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>healthyOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> instance <span class="token operator">:</span> ips<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            
            <span class="token comment">// 过滤掉没开启的实例</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            <span class="token class-name">ObjectNode</span> ipObj <span class="token operator">=</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// deprecated since nacos 1.0.0:</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"valid"</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"healthy"</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"marked"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"instanceId"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">transferToJsonNode</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enabled"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clusterName"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientInfo<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token class-name">ClientInfo<span class="token punctuation">.</span>ClientType</span><span class="token punctuation">.</span><span class="token constant">JAVA</span>
                    <span class="token operator">&amp;&amp;</span> clientInfo<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">VersionUtil</span><span class="token punctuation">.</span><span class="token function">parseVersion</span><span class="token punctuation">(</span><span class="token string">"1.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serviceName"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serviceName"</span><span class="token punctuation">,</span> <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            ipObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ephemeral"</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ipObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 组装实例数据</span>
    result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"hosts"</span><span class="token punctuation">,</span> hosts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientInfo<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token class-name">ClientInfo<span class="token punctuation">.</span>ClientType</span><span class="token punctuation">.</span><span class="token constant">JAVA</span>
            <span class="token operator">&amp;&amp;</span> clientInfo<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">VersionUtil</span><span class="token punctuation">.</span><span class="token function">parseVersion</span><span class="token punctuation">(</span><span class="token string">"1.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dom"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dom"</span><span class="token punctuation">,</span> <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cacheMillis"</span><span class="token punctuation">,</span> cacheMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"lastRefTime"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"checksum"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"useSpecifiedURL"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"clusters"</span><span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"env"</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">transferToJsonNode</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4__1966"></a>4. 订阅</h3> 
<ol><li>这里记录的是在别人博客中看到的,我并没有找到相关源码,此处只是记录不一定正确</li><li>服务消费方在获取到目标服务后会执行NacosNamingService中的subscribe()开启对目标服务的订阅,实际底层还是跟上面一样请求nacos注册中心获取目标服务信息,缓存到本地serviceInfoMap中,并开启心跳任务</li></ol> 
<pre><code class="prism language-java"><span class="token comment">// NacosNamingService</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clusters<span class="token punctuation">,</span> <span class="token class-name">EventListener</span> listener<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> clusterString <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    changeNotifier<span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusterString<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用NamingClientProxyDelegate下的subscribe()</span>
    clientProxy<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> clusterString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>查看NamingClientProxyDelegate下的subscribe()获取本地缓存的目标服务如果为null则发送</li></ol> 
<pre><code class="prism language-java"><span class="token comment">// NamingClientProxyDelegate</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ServiceInfo</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">String</span> clusters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> serviceNameWithGroup <span class="token operator">=</span> <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> serviceKey <span class="token operator">=</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceNameWithGroup<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取缓存中的ServiceInfo</span>
    <span class="token class-name">ServiceInfo</span> result <span class="token operator">=</span> serviceInfoHolder<span class="token punctuation">.</span><span class="token function">getServiceInfoMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果为null，则进行订阅逻辑处理，基于gRPC协议</span>
        result <span class="token operator">=</span> grpcClientProxy<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 定时调度UpdateTask</span>
    serviceInfoUpdateService<span class="token punctuation">.</span><span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ServiceInfo本地缓存处理</span>
    serviceInfoHolder<span class="token punctuation">.</span><span class="token function">processServiceInfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_NacosEureka_2002"></a>五 Nacos与Eureka</h2> 
<ol><li>区别</li></ol> 
<blockquote> 
 <ol><li>功能范围：nacos不仅是一个注册中心，还是一个配置中心，它可以管理服务的配置信息，并支持在线编辑和动态刷新。eureka只是一个注册中心，它需要配合其他组件（如Config或Consul）来实现配置中心的功能，并且不提供管理界面和动态刷新机制</li><li>一致性协议：nacos支持AP和CP两种模式的切换，它可以根据不同的数据和场景选择不同的一致性机制。AP模式下，nacos只支持注册临时实例，并采用客户端心跳方式进行健康检查。CP模式下，nacos支持注册持久化实例，并采用服务端主动探测方式进行健康检查,eureka只支持AP模式，它采用客户端心跳方式进行健康检查，并在网络分区发生时开启自我保护机制，避免误删服务</li><li>服务推送：nacos支持服务列表变更的消息推送模式，它使用Netty保持TCP长连接，实时推送服务列表的更新给客户端。eureka使用短轮询的方式获取服务列表，它需要客户端定时向服务端发送请求，并缓存服务列表到本地内存中。</li><li>集群部署：nacos需要使用MySQL进行数据持久化，并配置集群IP再启动。eureka不需要使用MySQL或其他数据库，只需要配置Eureka Server之间的相互注册即可实现集群部署</li></ol> 
</blockquote> 
<ol start="2"><li>自己整理的在CAP角度,Nacos的AP或CP是根据临时实例或持久化实例来区分的,通过spring.cloud.nacos.discovery.ephemeral配置,默认true为临时实例,false为永久实例,临时使用AP,持久使用CP</li></ol> 
<blockquote> 
 <ol><li>对应AP模式提供了EphemeralConsistencyService</li><li>对应CP模式提供了RaftConsistencyServiceImpl,内部封装了RaftCore一致性算法类,调用RaftCore的signalPublish()实现同步,查看该方法源码首先获取到majorityCount需要同步的nacos服务的节点数,利用CountDownLatch控制调用 HttpClient.asyncHttpPostLarge()向其他节点发送确认请求实现多数节点的确认,如果在规定的时间内没有得到majorityCount个节点的成功响应,则认为数据发布失败,并抛出异常</li><li>而Eureka中只支持AP模式</li></ol> 
</blockquote> 
<ol start="3"><li>服务异常剔除方面</li></ol> 
<blockquote> 
 <ol><li>eureka: client在默认情况每隔30s向EurekaServer发送一次心跳,当EurekaServer在默认连续90s秒的情况下没有收到心跳, 会把client 从注册表中剔除,在由EurekaServer 60秒的清除间隔,把Eureka client 给下线</li><li>nacos: client 通过心跳上报方式告诉 nacos注册中心健康状态,默认心跳间隔5秒，nacos会在超过15秒未收到心跳后将实例设置为不健康状态，可以正常接收到请求,超过30秒nacos将实例删除,不会再接收请求</li></ol> 
</blockquote> 
<ol start="4"><li>自我保护机制方面</li></ol> 
<blockquote> 
 <ol><li>Eureka保护方式：当在短时间内，统计续约失败的比例，如果达到一定阈值，则会触发自我保护的机制,在该机制下不会剔除任何服务</li><li>Nacos保护方式：当域名健康实例 (Instance) 占总服务实例(Instance) 的比例小于阈值时，无论实例 (Instance) 是否健康，都会将这个实例 (Instance) 返回给客户端。这样做虽然损失了一部分流量，但是保证了集群的剩余健康实例 (Instance) 能正常工作,并且Nacos的自我保护的这个阈值是</li></ol> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa25f12fe68f7631cb2a3565fb22424f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">centos7下使用mycat实现mysql负载均衡和读写分离</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/40a54069538be7922502343a478e4859/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Centos7虚拟机 安装samba windows访问共享文件夹</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>