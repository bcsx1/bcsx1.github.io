<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android网络框架情景分析之NetworkManagementService和Netd交互深入分析一 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android网络框架情景分析之NetworkManagementService和Netd交互深入分析一" />
<meta property="og:description" content="Android以太网框架情景分析之NetworkManagementService和netd交互深入分析一 Android网络框架分析系列文章目录：
Android P适配以太网功能开发指南
Android以太网框架情景分析之启动简介
Android以太网框架情景分析之EthernetServiceImpl和NetworkManagementService交互深入分析
Android以太网框架情景分析之NetworkManagementService和netd交互深入分析二
Android以太网框架情景分析之NetworkManagementService和netd交互深入分析一
Android以太网框架情景分析之NetworkFactory与NetworkAgent深入分析
AsyncChannel原理分析以及实操演练
引言 在前面的篇章Android以太网框架情景分析之启动简介和Android以太网框架情景分析之NetworkFactory与NetworkAgent深入分析我们介绍了以太网的启动，NetworkFactory与NetworkAgent的注网以及关联。还记得我们最开始的关于以太网相关的时序图吗！其中涉及到了监听以太网状态变化的譬如网线的插拔，以太网络状态的变化等，这个就涉及到NetworkManagementService和netd和交互的过程了(当然关于两者之间的交互并不仅仅只有上述两点)。这个篇章就会带领大伙来理解NetworkManagementService和netd的交互，从而理解以太网框架怎么通过NetworkManagementService来设置IP，路由配置以及监听网络状态变化等。同时NetworkManagementService和netd交互不仅单单是为了以太网而设计的，WIFI，移动网络等网络环境也是借助上述两者来完成各种网络环境变化监控以及网络控制的。
本篇会从三个维度来讲解这个篇章，分别是：
Netd深入分析NetworkManagementService和Netd交互分析以太网络和NetworkManagementService及netd的交互 本篇章演示的源码是在Android 7.1 msm8953平台上，其中涉及的源码路径如下所示：
system/netd/server/ ---CommandListener.cpp ---CommandListener.h ---main.cpp ---NetlinkHandler.cpp ---netd.rc ---NetlinkManager.cpp ---DnsProxyListener.cpp ---MDnsSdListener.cpp ---FwmarkServer.cpp ...NetdNativeService.cpp ... system/core/libsysutils/src/ ---FrameworkListener.cpp ---NetlinkListener.cpp ---FrameworkCommand.cpp ---NetlinkEvent.cpp ---SocketListener.cpp ... frameworks/base/services/java/com/android/server/SystemServer.java frameworks/base/services/core/java/com/android/server/NetworkManagementService.java frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetNetworkFactory.java frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetService.java frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetServiceImpl.java frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetConfigStore.java frameworks/base/services//core/java/com/android/server/ConnectivityService.java 一.Netd深入分析 1.1 Netd概述以及前期知识准备 Netd (Network Daemon)是用于管理和控制Android平台网络的后台进程，如下所示：
XXX:/ # ps -t | grep netd root 785 1 29192 3468 binder_thr 7f951c39e0 S /system/bin/netd root 868 785 29192 3468 poll_sched 7f951c3a28 S netd root 1727 785 29192 3468 poll_sched 7f951c3a28 S netd root 1728 785 29192 3468 poll_sched 7f951c3a28 S netd root 1729 785 29192 3468 poll_sched 7f951c3a28 S netd root 1730 785 29192 3468 poll_sched 7f951c3a28 S netd root 1731 785 29192 3468 poll_sched 7f951c3a10 S netd root 1732 785 29192 3468 poll_sched 7f951c3a28 S netd root 1733 785 29192 3468 poll_sched 7f951c3a28 S netd 其按照工作逻辑可分为如下两部分：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/de7377da9fdccc6663bcf775a1ac1360/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-05T14:31:39+08:00" />
<meta property="article:modified_time" content="2020-08-05T14:31:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android网络框架情景分析之NetworkManagementService和Netd交互深入分析一</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="font_faceCourier_NewAndroidNetworkManagementServicenetd_0"></a><font face="Courier New">Android以太网框架情景分析之NetworkManagementService和netd交互深入分析一</font></h2> 
<br> 
<p><font face="Courier New">Android网络框架分析系列文章目录：</font></p> 
<blockquote> 
 <p><a href="https://editor.csdn.net/md/?articleId=105725133" rel="nofollow"><font face="Courier New" size="3">Android P适配以太网功能开发指南</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107209641"><font face="Courier New" size="3">Android以太网框架情景分析之启动简介</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107836221"><font face="Courier New" size="3">Android以太网框架情景分析之EthernetServiceImpl和NetworkManagementService交互深入分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107814419"><font face="Courier New" size="3">Android以太网框架情景分析之NetworkManagementService和netd交互深入分析二</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107762121"><font face="Courier New" size="3">Android以太网框架情景分析之NetworkManagementService和netd交互深入分析一</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107363504"><font face="Courier New" size="3">Android以太网框架情景分析之NetworkFactory与NetworkAgent深入分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107426006"><font face="Courier New" size="3">AsyncChannel原理分析以及实操演练</font></a></p> 
</blockquote> 
<hr> 
<br> 
<h3><a id="font_faceCourier_New__17"></a><font face="Courier New"> 引言</font></h3> 
<p><font face="Courier New">   在前面的篇章<a href="https://blog.csdn.net/tkwxty/article/details/107209641"><font face="Courier New">Android以太网框架情景分析之启动简介</font></a>和<a href="https://blog.csdn.net/tkwxty/article/details/107363504"><font face="Courier New">Android以太网框架情景分析之NetworkFactory与NetworkAgent深入分析</font></a>我们介绍了以太网的启动，NetworkFactory与NetworkAgent的注网以及关联。还记得我们最开始的关于以太网相关的时序图吗！其中涉及到了监听以太网状态变化的譬如网线的插拔，以太网络状态的变化等，这个就涉及到NetworkManagementService和netd和交互的过程了(当然关于两者之间的交互并不仅仅只有上述两点)。这个篇章就会带领大伙来理解NetworkManagementService和netd的交互，从而理解以太网框架怎么通过NetworkManagementService来设置IP，路由配置以及监听网络状态变化等。同时NetworkManagementService和netd交互不仅单单是为了以太网而设计的，WIFI，移动网络等网络环境也是借助上述两者来完成各种网络环境变化监控以及网络控制的。</font></p> 
<p><font face="Courier New"> 本篇会从三个维度来讲解这个篇章，分别是：</font></p> 
<ul><li><font face="Courier New">Netd深入分析</font></li><li><font face="Courier New">NetworkManagementService和Netd交互分析</font></li><li><font face="Courier New">以太网络和NetworkManagementService及netd的交互</font></li></ul> 
<p><font face="Courier New">本篇章演示的源码是在Android 7.1 msm8953平台上，其中涉及的源码路径如下所示：</font></p> 
<pre><code class="prism language-bash">system/netd/server/
	---CommandListener.cpp
	---CommandListener.h
	---main.cpp
	---NetlinkHandler.cpp
	---netd.rc
	---NetlinkManager.cpp
	---DnsProxyListener.cpp
	---MDnsSdListener.cpp
	---FwmarkServer.cpp
	<span class="token punctuation">..</span>.NetdNativeService.cpp
	<span class="token punctuation">..</span>.

system/core/libsysutils/src/
	---FrameworkListener.cpp  
	---NetlinkListener.cpp
	---FrameworkCommand.cpp  
	---NetlinkEvent.cpp
	---SocketListener.cpp
	<span class="token punctuation">..</span>.

frameworks/base/services/java/com/android/server/SystemServer.java
frameworks/base/services/core/java/com/android/server/NetworkManagementService.java
frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetNetworkFactory.java
frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetService.java
frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetServiceImpl.java
frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetConfigStore.java
frameworks/base/services//core/java/com/android/server/ConnectivityService.java
</code></pre> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_Netd_66"></a><font face="Courier New"> 一.Netd深入分析</font></h3> 
<br> 
<h4><a id="font_faceCourier_New_11__Netd_70"></a><font face="Courier New"> 1.1 Netd概述以及前期知识准备</font></h4> 
<p><font face="Courier New">   Netd (Network Daemon)是用于管理和控制Android平台网络的后台进程，如下所示：</font></p> 
<pre><code class="prism language-bash">XXX:/ <span class="token comment"># ps -t | grep netd</span>
root      785   1     29192  3468  binder_thr 7f951c39e0 S /system/bin/netd
root      868   785   29192  3468  poll_sched 7f951c3a28 S netd
root      1727  785   29192  3468  poll_sched 7f951c3a28 S netd
root      1728  785   29192  3468  poll_sched 7f951c3a28 S netd
root      1729  785   29192  3468  poll_sched 7f951c3a28 S netd
root      1730  785   29192  3468  poll_sched 7f951c3a28 S netd
root      1731  785   29192  3468  poll_sched 7f951c3a10 S netd
root      1732  785   29192  3468  poll_sched 7f951c3a28 S netd
root      1733  785   29192  3468  poll_sched 7f951c3a28 S netd
</code></pre> 
<p><font face="Courier New"> 其按照工作逻辑可分为如下两部分：</font></p> 
<ul><li><font face="Courier New">Netd接收并处理来自Framework层中NetworkManagementService或NsdService的命令。这些命令最终由Netd中对应的Command对象去处理。譬如我们对以太网进行相关设置(静态IP，动态IP，以太网代理等等，以太网的开启关闭等)。</font></li><li><font face="Courier New">Net接收并解析来自Kernel的UEvent消息，然后再转发给Framework层中对应Service去处理。譬如以太网相关服务监听以太网络状态的变化(网线的插拔，以台网的开启关闭ifconfig ethx up/down等)。</font></li></ul> 
<p><font face="Courier New">   通过上述简单的描述，我们应该知道了Netd位于Framework层和Kernel层之间，它是Android系统中网络相关消息和命令转发及处理的中枢模块起到了承上启下的作用。我们先来看看Netd的整体框架图，如下所示：</font></p> 
<p><img src="https://images2.imgbox.com/26/98/mZcyl0ml_o.png" alt="在这里插入图片描述"></p> 
<p><font face="Courier New">   好了，经过上述的描述我想小伙伴们对Netd应该已经有了一个概述了，下面章节我们将开始真正的分析。</font></p> 
<br> 
<h4><a id="font_faceCourier_New_12_Netd_105"></a><font face="Courier New"> 1.2 Netd的启动</font></h4> 
<p><font face="Courier New">   通过前面的章节我们知道Netd进程是一个可执行的bin文件程序，而通常它的启动方式一般都是init.xxx.rc进行启动的，但是在Android 5以及之后Android已经将rc权力下放到各个子模块中然后通过import导入了，Netd的启动也不例外下放到了netd.rc中，其配置如下所示：</font></p> 
<pre><code class="prism language-bash">//netd.rc
<span class="token function">service</span> netd /system/bin/netd
    class main
    socket netd stream 0660 root system
    socket dnsproxyd stream 0660 root inet
    socket mdns stream 0660 root system
    socket fwmarkd stream 0660 root inet

</code></pre> 
<p><font face="Courier New">   从上面的配置文件可以看出，Netd进程启动之后将会创建四个TCP的LocalSocket(至于什么是LocalSocket可以参见篇章<a href="https://blog.csdn.net/tkwxty/article/details/103086192"><font face="Courier New"> Android Framework层和Native层通过LocalSocket实现通信</font></a>，总之LocalSocket可以用一句话来概括就是Android定制版本的精简Socket)，这四个socket如下所示：<br> <img src="https://images2.imgbox.com/58/85/UVLDM5QP_o.png" alt="在这里插入图片描述"></font></p> 
<p><font face="Courier New"> 而Netd正是通过这四个创建的socket完成了承上启下的作用。通过后面的章节分析我们会看到：</font></p> 
<ul><li><font face="Courier New"> /dev/socket/netd将用于和Netd中的CommandListener进行双向通信，而CommandListener主要用来完成接收配置ip，路由，iptables的命令</font></li><li><font face="Courier New">dev/socket/dnsproxyd将用于和Netd中的DnsproxyListener来进行双向通信，而DnsproxyListener主要用来完成Dns的相关操作</font></li><li><font face="Courier New">/dev/socket/mdns将用于和Netd中的MdnsSdListener来进行双向通信，而MdnsSdListener主要用来完成mdnsd的操作</font></li><li><font face="Courier New">/dev/socket/fwmarkd将用于和Netd中的FwmarkServer来进行双向通信，而FwmarkServer用于对特定的socket设置mark值</font></li></ul> 
<br> 
<h4><a id="font_faceCourier_New_13_Netdmain_131"></a><font face="Courier New"> 1.3 Netd进程main函数分析</font></h4> 
<p><font face="Courier New">   对于native进程我们通常从main函数开始入手，对于Netd进程也不例外，其源码路径为system/netd/server/main.c，其代码逻辑如：</font></p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> android<span class="token operator">::</span>net<span class="token operator">::</span>gCtls<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">//为Netd进程屏蔽SIGPIPE信号</span>
    <span class="token function">blockSigpipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    NetlinkManager <span class="token operator">*</span>nm <span class="token operator">=</span> NetlinkManager<span class="token operator">::</span><span class="token function">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建NetlinkManager，详见章节1.4</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nm <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to create NetlinkManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    gCtls <span class="token operator">=</span> <span class="token keyword">new</span> android<span class="token operator">::</span>net<span class="token operator">::</span><span class="token function">Controllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化相关Controll</span>
    CommandListener cl<span class="token punctuation">;</span><span class="token comment">//初始化Command，它将创建名为"netd"的监听socket。注意c++中的初始化和Java中的区别，不一定要new才能初始化，这个会在章节1.7重点介绍</span>
    <span class="token comment">//设置NetlinkManager的消息发送者（Broadcaster）为CommandListener。</span>
    nm<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SocketListener <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//启动NetlinkManager ，详见章节1.4</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nm<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//它为本Netd设置环境变量ANDROID_DNS_MODE为"local"</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_DNS_MODE"</span><span class="token punctuation">,</span> <span class="token string">"local"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建DnsProxyListener，它将创建名为"dnsproxyd"的监听socket,这个不是本文关注的重点</span>
    DnsProxyListener <span class="token function">dpl</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>netCtrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dpl<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//创建MDnsSdListener并启动监听，它将创建名为"mdns"的监听socket,这个不是本文关注的重点</span>
    MDnsSdListener mdnsl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mdnsl<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//创建FwmarkServer并启动监听，它将创建“fwmarkd”的监听socket，这个不是本文关注重点</span>
    FwmarkServer <span class="token function">fwmarkServer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>netCtrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwmarkServer<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    status_t ret<span class="token punctuation">;</span>
    <span class="token comment">//启动Netd的Natvive Binder Service</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> NetdNativeService<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> android<span class="token operator">::</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//CommandListener 开始监听</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cl<span class="token punctuation">.</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//详见章节1.7.2</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">//开启Binder线程</span>
    IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">joinThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">   可以看到Netd进程的main函数非常精简，主要就是创建初始化关键的成员并启动相关的工作，其中涉及的重要成员如下：</font></p> 
<ul><li><font face="Courier New">NetlinkManager：它将接收并处理来自Kernel的UEvent消息。这些消息经NetlinkManager解析后将借助它的Broadcaster（也就是代码中为NetlinkManager设置的CommandListener）发送给Framework层的NetworkManagementService。</font></li><li><font face="Courier New">CommandListener、DnsProxyListener、MDnsSdListener，FwmarkServer：分别创建名为"netd"、“dnsproxyd”、“mdns”，"fwmarkd"的监听socket，并处理来客户端的命令，这里我们会重点讲解CommandListener。</font></li><li><font face="Courier New">创建NetdNativeService的Native Binder服务，关于该服务的作用暂时还没有研究。</font></li></ul> 
<br> 
<h4><a id="font_faceCourier_New_14_NetlinkManager_207"></a><font face="Courier New"> 1.4 NetlinkManager</font></h4> 
<p><font face="Courier New">   通过前面的章节我们可知，NetlinkManager主要用于接收并处理来自Kernel的UEvent消息，在NetlinkManager将会启动3个socket，用于监听3种不同的event：Uevent，RouteEvent，QuotaEvent。而对这种监听是通过SocketListener实现监听的，最终通过/dev/socket/netd送到NetworkManagementService(java代码)，分配到注册到它里面的各个观察者实例(Ethernet，WIFI等)。感觉用文字描述还是太抽象了，我们可以通过下面的NetlinkManager的架构图来概括上述之间的关系，如下所示：<br> <img src="https://images2.imgbox.com/4b/97/IEQ9pBmG_o.png" alt="在这里插入图片描述"></font></p> 
<p><font face="Courier New">   下面老规矩分析源码：</font></p> 
<pre><code class="prism language-cpp"><span class="token comment">//NetlinkManager.cpp</span>
<span class="token keyword">int</span> NetlinkManager<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//创建接收NETLINK_KOBJECT_UEVENT消息的socket，其值保存在mUeventSock中</span>
   	<span class="token comment">//其中，NETLINK_FORMAT_ASCII代表UEvent消息的内容为ASCII字符串</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mUeventHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mUeventSock<span class="token punctuation">,</span> NETLINK_KOBJECT_UEVENT<span class="token punctuation">,</span>
         <span class="token number">0xffffffff</span><span class="token punctuation">,</span> NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_ASCII<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// //创建接收RTMGPR_LINK消息的socket，其值保存在mRouteSock中</span>
   	<span class="token comment">//其中，NETLINK_FORMAT_BINARY代表UEvent消息的类型为结构体，故需要进行二进制解析</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mRouteHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mRouteSock<span class="token punctuation">,</span> NETLINK_ROUTE<span class="token punctuation">,</span>
                                     RTMGRP_LINK <span class="token operator">|</span>
                                     RTMGRP_IPV4_IFADDR <span class="token operator">|</span>
                                     RTMGRP_IPV6_IFADDR <span class="token operator">|</span>
                                     RTMGRP_IPV6_ROUTE <span class="token operator">|</span>
                                     <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>RTNLGRP_ND_USEROPT <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_BINARY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//创建接收NETLINK_NFLOG消息的socket，其值保存在mQuotaSock中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mQuotaHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mQuotaSock<span class="token punctuation">,</span> NETLINK_NFLOG<span class="token punctuation">,</span>
            NFLOG_QUOTA_GROUP<span class="token punctuation">,</span> NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_BINARY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Unable to open qlog quota socket, check if xt_quota2 can send via UeventHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO: return -1 once the emulator gets a new kernel.</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//创建接收NETLINK_NFLOG消息的socket，其值保存在mStrictHandler 中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mStrictHandler <span class="token operator">=</span> <span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mStrictSock<span class="token punctuation">,</span> NETLINK_NETFILTER<span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span> NetlinkListener<span class="token operator">::</span>NETLINK_FORMAT_BINARY_UNICAST<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to open strict socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO: return -1 once the emulator gets a new kernel.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New"> 通过源码我们看到NetlinkManager的start函数主要向内核注册了4个接收UEvent事件的socket，这4个socket分别对应于：</font></p> 
<ul><li><font face="Courier New"> NETLINK_KOBJECT_UEVENT：代表kobject事件，由于这些事件包含的信息由ASCII字符串表达，故上述代码中使用了NETLINK_FOMRAT_ASCII。它表示将采用字符串解析的方法去解析接收到的UEvent消息。kobject一般用来通知内核中某个模块的加载或卸载。对NetlinkManager来说，其关注的是/sys/class/net下相应模块的加载或卸载消息，譬如以太网模块的加载和卸载。</font></li><li><font face="Courier New"> NETLINK_ROUTE：代表kernel中routing或link改变时对应的消息。NETLINK_ROUTE包含很多子项，上述代码中使用了RTMGRP_LINK项。二者结合起来使用，表示NM希望收到网络链路断开或接通时对应的UEvent消息（当网卡上拔掉或插入网线时，会触发这些UEvent消息的发送）。由于对应UEvent消息内部封装了nlmsghdr等相关结构体，故上述代码使用了NETLINK_FORMAT_BINARY来指示解析UEvent消息时将使用二进制的解析方法。</font></li><li><font face="Courier New"> NETLINK_NFLOG：和带宽控制有关。Netd中的带宽控制可以设置一个预警值，当网络数据超过一定字节数就会触发kernel发送一个警告</font></li><li><font face="Courier New">NETLINK_NETFILTER:和网络过滤有关系。</font></li></ul> 
<p><font face="Courier New">   其中的重要的函数setupSocket我们还没有分析，让我们接着对该函数进行分析，其业务逻辑是什么：</font></p> 
<pre><code class="prism language-cpp"><span class="token comment">//NetlinkManager.cpp</span>
NetlinkHandler <span class="token operator">*</span>NetlinkManager<span class="token operator">::</span><span class="token function">setupSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">int</span> netlinkFamily<span class="token punctuation">,</span>
    <span class="token keyword">int</span> groups<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">bool</span> configNflog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">struct</span> sockaddr_nl nladdr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nladdr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nladdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nladdr<span class="token punctuation">.</span>nl_family <span class="token operator">=</span> AF_NETLINK<span class="token punctuation">;</span>
    nladdr<span class="token punctuation">.</span>nl_pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nladdr<span class="token punctuation">.</span>nl_groups <span class="token operator">=</span> groups<span class="token punctuation">;</span>
	<span class="token comment">//设置socket通信类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_NETLINK<span class="token punctuation">,</span> SOCK_DGRAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> netlinkFamily<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to create netlink socket: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//设置socket接收缓冲区大小</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_RCVBUFFORCE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to set uevent socket SO_RCVBUFFORCE option: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//设置socket认证</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_PASSCRED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>on<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to set uevent socket SO_PASSCRED option: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//对socket执行bind操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>nladdr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nladdr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to bind netlink socket: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">//将前面已经创建并设置好相关配置的socket参数形式传入创建NetlinkHandler，然后调用其start方法</span>
    NetlinkHandler <span class="token operator">*</span>handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">NetlinkHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//详见章节1.5</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to start NetlinkHandler: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span><span class="token operator">*</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New"> 这里我们可以看到setupSocket函数的逻辑处理比较简单，就是进行一些基本的socket配置操作，然后将配置好的socket作为参数创建用于接收UEvent消息的NetlinkHandler对象。</font></p> 
<br> 
<h4><a id="font_faceCourier_New_15_NetlinkHandler_318"></a><font face="Courier New"> 1.5 NetlinkHandler</font></h4> 
<p><font face="Courier New">   在正式开始NetlinkHandler这个类的分析前，我们还是先缓一缓，为了读者能更好的进行下面的代码阅读理解，还是先理理其类图关系，不然后续的分析中会被其中的继承关系绕晕的(虽然说这也是面向对象语言的优点，但是有时候也会搞得人稀里糊涂的)。NetlinkManager的类图关系如下所示，可以看出这里的SocketListener在该关系类图中的重要性,它几乎是该类图关系中最原始的起点。</font></p> 
<p><img src="https://images2.imgbox.com/0d/ee/E9yLyEYk_o.png" alt="在这里插入图片描述"><br> <font face="Courier New">   下面我们从整体上来分析分析该类图中牵涉到的各种关系如下所示：</font></p> 
<ul><li><font face="Courier New">NetlinkHandler和CommandListener均间接从SocketListener派生。其中，NetlinkHandler收到的socket消息将通过onEvent回调处理。</font></li><li><font face="Courier New">通过前面的章节我们可知NetlinkManager分别注册了四个用于接收UEvent的socket，其对应的NetlinkHandler分别是mUeventHandler、mRouteHandler和mQuotaHandler及StrictHandler。</font></li><li><font face="Courier New">NetlinkHandler将接收到的UEvent消息会转换成一个NetlinkEvent对象。NetlinkEvent对象封装了对UEvent消息的解析方法。对于NETLINK_FOMRAT_ASCII类型，其parseAsciiNetlinkMessage函数会被调用，而对于NETLINK_FORMAT_BINARY类型，其parseBinaryNetlinkMessage函数会被调用。</font></li><li><font face="Courier New">NetLinkManager处理流程的输入为一个解析后的NetlinkEvent对象。NetLinkManager完成相应工作后，其处理结果将经由mBroadcaster对象传递给Framework层的接收者，也就是NetworkManagementService。</font></li><li><font face="Courier New">CommandListener从FrameworkListener派生，而FrameworkListener内部有一个mCommands数组，它用来存储注册到FrameworkListener中的命令处理对象。</font></li></ul> 
<h5><a id="font_faceCourier_New_151_NetlinkHandlerstart_332"></a><font face="Courier New"> 1.5.1 NetlinkHandler::start</font></h5> 
<p><font face="Courier New">   好了，其中涉及的类图关系也分析清楚了，前进路上的路障也清除了，直接干代码了！我们从NetlinkHandler的start函数开始，代码如下：</font></p> 
<pre><code class="prism language-cpp"><span class="token comment">//NetlinkHandler.cpp</span>
<span class="token keyword">int</span> NetlinkHandler<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New"> 这里的start函数，最终调用的是NetlinkHandler的超类SocketListener中的startListener函数，还能干啥呢，接着继续干呗！SocketListener类在源码中的路径为system/core/libsysutils/src/SocketListener.cpp。</font></p> 
<pre><code class="prism language-cpp"><span class="token comment">//SocketListener.cpp</span>
<span class="token keyword">int</span> SocketListener<span class="token operator">::</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">startListener</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> SocketListener<span class="token operator">::</span><span class="token function">startListener</span><span class="token punctuation">(</span><span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSocketName <span class="token operator">&amp;&amp;</span> mSock <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Failed to start unbound listener"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mSocketName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//忽略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mSock <span class="token operator">=</span> <span class="token function">android_get_control_socket</span><span class="token punctuation">(</span>mSocketName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Obtaining file descriptor socket '%s' failed: %s"</span><span class="token punctuation">,</span>
                 mSocketName<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">SLOGV</span><span class="token punctuation">(</span><span class="token string">"got mSock = %d for %s"</span><span class="token punctuation">,</span> mSock<span class="token punctuation">,</span> mSocketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> FD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//如果设置了mListen则监听socket，如果没有设置则新建一个socketClient放入客户端集合，很显然mListen的值为false(通过NetlinkListener.cpp的构造函数传入)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mListen <span class="token operator">&amp;&amp;</span> <span class="token function">listen</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to listen on socket (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mListen<span class="token punctuation">)</span><span class="token comment">//以mSock作为参数构建SocketClient对象，并将创建的对象push_back到SocketClientCollection列表中</span>
        mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">SocketClient</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mUseCmdNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//调用pipe创建一个匿名管道，mCtrlPipe[0]和mCtrlPipe[1]分别代表管道的读写端，</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"pipe failed (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//创建线程threadStart监听socket，这里其实并没有所谓的“监听socket”，因为是NETLINK型的socket，从这里可以看出每个SocketListener都会开辟一个新的线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> SocketListener<span class="token operator">::</span>threadStart<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//详见章节1.5.2</span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"pthread_create (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="font_faceCourier_New_152_SocketListenerthreadStart_389"></a><font face="Courier New"> 1.5.2 SocketListener::threadStart</font></h5> 
<pre><code class="prism language-cpp"><span class="token comment">//SocketListener.cpp</span>
<span class="token keyword">void</span> <span class="token operator">*</span>SocketListener<span class="token operator">::</span><span class="token function">threadStart</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//这里的obj是创建线程时候传递过来的参数，可以看到它是SocketListener </span>
    SocketListener <span class="token operator">*</span>me <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>SocketListener <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    me<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">runListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用runListener，这个是关键</span>
    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> SocketListener<span class="token operator">::</span><span class="token function">runListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//创建SocketClientCollection列表pendingList</span>
    SocketClientCollection pendingList<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        SocketClientCollection<span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
        fd_set read_fds<span class="token punctuation">;</span><span class="token comment">//看到这个是不是很熟悉的感觉，肯定和多路复用有关系了</span>
        <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将指定的文件描述符集read_fds清空</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mListen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//通过前面的分析我们知道mListen为false，所以不会走这个分支</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token function">FD_SET</span><span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将前面创建的管道读通道，增加到文件描述符集合read_fds中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> max<span class="token punctuation">)</span>
            max <span class="token operator">=</span> mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历mClients，还记得我们每次startListener都会创建一个SocketClient然后放入列表mClients中吗</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取SocketClient通信相关的socket信息</span>
            <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加入到read_fds进行监听</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;</span> max<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                max <span class="token operator">=</span> fd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SLOGV</span><span class="token punctuation">(</span><span class="token string">"mListen=%d, max=%d, mSocketName=%s"</span><span class="token punctuation">,</span> mListen<span class="token punctuation">,</span> max<span class="token punctuation">,</span> mSocketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>max <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//重点，多路复用监听read_fds中相关的消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"select failed (%s) mListen=%d, max=%d"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> mListen<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rc<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//判断mCtrlPipe[0]文件描述符是否可以读写</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> CtrlPipe_Shutdown<span class="token punctuation">;</span>
            <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>mCtrlPipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取管道</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> CtrlPipe_Shutdown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//我们知道在该分支中mListen 为false，所以不会走入到这个里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mListen <span class="token operator">&amp;&amp;</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span>mSock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
       
        pendingList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历mClients，将所有活动的fd都放入pendingList</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            SocketClient<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
            
            <span class="token keyword">int</span> fd <span class="token operator">=</span> c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//判断是否可以读写</span>
                pendingList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//放入到pendingList中</span>
                c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">incRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//处理pendingList，次是此处表示内核有事件了比如网线的插拔，网络状态的变化等，需要上层处理</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingList<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            it <span class="token operator">=</span> pendingList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SocketClient<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
            pendingList<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">onDataAvailable</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//这个在其子类中被实现，即在NetlinkHandler中，详见章节1.5.3</span>
                <span class="token function">release</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">   通过代码分析我们看到runListener函数里面主要通过多路复用对三个类型的fd进行了相关的监听，这三个类型的fd分别是：</font></p> 
<ul><li><font face="Courier New">第一种类型就是监听类型socket，即通用型的socket</font></li><li><font face="Courier New">第二类是SocketClient类型socket，并且这类socket被封装成SocketClient集中在一个集合之内。</font></li><li><font face="Courier New">最后一类就是pipe类型的fd</font></li></ul> 
<p><font face="Courier New">而我们这里重点关注的是第二个类型SocketClient的socket，从前面分析可知在NetlinkManager.start()中已经启动了四个这样的SocketClient结构，这些socket都是PF_NETLINK类型的socket，并不是监听socket，具体一点就是他们对应的mListen均为false。最终这四个socket被当做SocketClient添加进了mClients中。</font></p> 
<p><font face="Courier New">   接着将上述的socket对应的fd句柄添加到多路复用监听文件描述符集合中，当检测到上述socket有可读事件发生时，也就是内核有上层感兴趣的事件发生时，对应SocketListen的onDataAvailable()被调用，可是很遗憾，该函数是一个纯虚函数，那么只能从其子类中寻找了，通过查找我们看到在其子类NetlinkListener中实现了onDataAvailable函数(注意SocketListen还有一个子类onDataAvailable也实现了onDataAvailable不要搞错了，至于为什么这里调用的是NetlinkListener大伙可以回忆一下this指针的传递是从NetlinkHandler传递过来的，然后再NetlinkHandler的构造过程中初始化了NetlinkListener)，我们接着继续分析。</font></p> 
<h5><a id="font_faceCourier_New_153_NetlinkListeneronDataAvailable_494"></a><font face="Courier New"> 1.5.3 NetlinkListener::onDataAvailable</font></h5> 
<pre><code class="prism language-cpp"><span class="token comment">//NetlinkListener.cpp</span>
<span class="token keyword">bool</span> NetlinkListener<span class="token operator">::</span><span class="token function">onDataAvailable</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> socket <span class="token operator">=</span> cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ssize_t count<span class="token punctuation">;</span>
    uid_t uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> require_group <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFormat <span class="token operator">==</span> NETLINK_FORMAT_BINARY_UNICAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        require_group <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//调用uevent_kernel_recv接收内核发送过来的消息，并将消息存放在mBuffer中</span>
    count <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">uevent_kernel_recv</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>
            mBuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> require_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">LOG_EVENT_INT</span><span class="token punctuation">(</span><span class="token number">65537</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"recvmsg failed (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    NetlinkEvent <span class="token operator">*</span>evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">NetlinkEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构建一个NetlinkEvent对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">decode</span><span class="token punctuation">(</span>mBuffer<span class="token punctuation">,</span> count<span class="token punctuation">,</span> mFormat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//调用NetlinkEvent对象evt的decode函数解析mBuffer</span>
        <span class="token function">onEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用onEvent函数,详见章节1.5.4</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mFormat <span class="token operator">!=</span> NETLINK_FORMAT_BINARY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Don't complain if parseBinaryNetlinkMessage returns false. That can</span>
        <span class="token comment">// just mean that the buffer contained no messages we're interested in.</span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Error decoding NetlinkEvent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">delete</span> evt<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">   这个函数真懒，通过调用uevent_kernel_recv接收内核发送来的消息并将消息封装在mBuffer中，然后构建一个NetlinkEvent对象evt 调用其函数decode解析相关数据，解析完成之后调用onEvent函数，一看又是一个纯虚函数，继续追查最后在其子类NetlinkHandler被实现。</font></p> 
<h5><a id="font_faceCourier_New_154_NetlinkHandleronEvent_536"></a><font face="Courier New"> 1.5.4 NetlinkHandler::onEvent</font></h5> 
<pre><code class="prism language-cpp"><span class="token comment">//NetlinkHandler.cpp</span>
<span class="token keyword">void</span> NetlinkHandler<span class="token operator">::</span><span class="token function">onEvent</span><span class="token punctuation">(</span>NetlinkEvent <span class="token operator">*</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>subsys <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSubsystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subsys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"No subsystem found in netlink event"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//处理对应NETLINK_KOBJECT_UEVENT和NETLINK_ROUTE的信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        NetlinkEvent<span class="token operator">::</span>Action action <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>iface <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"INTERFACE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查找消息中携带的网络设备名</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kAdd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">notifyInterfaceAdded</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我们关心的以太网络的添加</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kRemove<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">notifyInterfaceRemoved</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//移除</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kChange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notifyInterfaceChanged</span><span class="token punctuation">(</span><span class="token string">"nana"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//状态变化</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kLinkUp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//下面两个消息来自NETLINK_ROUTE</span>
            <span class="token function">notifyInterfaceLinkChanged</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">链路启用（类似插网线）</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kLinkDown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">notifyInterfaceLinkChanged</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">链路断开（类似拔网线）</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kAddressUpdated <span class="token operator">||</span>
                   action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kAddressRemoved<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>address <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"ADDRESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>flags <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"FLAGS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>scope <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"SCOPE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kAddressRemoved <span class="token operator">&amp;&amp;</span> iface <span class="token operator">&amp;&amp;</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Note: if this interface was deleted, iface is "" and we don't notify.</span>
                SockDiag sd<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sd<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">char</span> addrstr<span class="token punctuation">[</span>INET6_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">strncpy</span><span class="token punctuation">(</span>addrstr<span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrstr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">char</span> <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>addrstr<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>slash<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">int</span> ret <span class="token operator">=</span> sd<span class="token punctuation">.</span><span class="token function">destroySockets</span><span class="token punctuation">(</span>addrstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Error destroying sockets: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Error opening NETLINK_SOCK_DIAG socket: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iface <span class="token operator">&amp;&amp;</span> iface<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> address <span class="token operator">&amp;&amp;</span> flags <span class="token operator">&amp;&amp;</span> scope<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">notifyAddressChanged</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> address<span class="token punctuation">,</span> iface<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kRdnss<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>lifetime <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"LIFETIME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servers <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"SERVERS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lifetime <span class="token operator">&amp;&amp;</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">notifyInterfaceDnsServers</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> lifetime<span class="token punctuation">,</span> servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kRouteUpdated <span class="token operator">||</span>
                   action <span class="token operator">==</span> NetlinkEvent<span class="token operator">::</span>Action<span class="token operator">::</span>kRouteRemoved<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>route <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"ROUTE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>gateway <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"GATEWAY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>iface <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"INTERFACE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>route <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>gateway <span class="token operator">||</span> iface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">notifyRouteChange</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> route<span class="token punctuation">,</span> gateway<span class="token punctuation">,</span> iface<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"qlog"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"xt_quota2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//对应NETLINK_NFLOG</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>alertName <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"ALERT_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>iface <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"INTERFACE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifyQuotaLimitReached</span><span class="token punctuation">(</span>alertName<span class="token punctuation">,</span> iface<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"strict"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//不关心</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uid <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"UID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hex <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"HEX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifyStrictCleartext</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> hex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"xt_idletimer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//不关心</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"INTERFACE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>state <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"STATE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>timestamp <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"TIME_NS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uid <span class="token operator">=</span> evt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">findParam</span><span class="token punctuation">(</span><span class="token string">"UID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            <span class="token function">notifyInterfaceClassActivity</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"active"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                         timestamp<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> !LOG_NDEBUG</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"platform"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>subsys<span class="token punctuation">,</span> <span class="token string">"backlight"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* It is not a VSYNC or a backlight event */</span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"unexpected event from subsystem %s"</span><span class="token punctuation">,</span> subsys<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<p><font face="Courier New">   该函数有点多啊，我们得好好理一理其逻辑：</font></p> 
<ul><li> <p><font face="Courier New">首先调用NetlinkEvent的getSubsystem函数对内核上报的消息进行一次大的划分，这个划分也是有依据的，还记得我们大明湖畔的夏雨荷吗！错了，是在NetlinkManager中创建的四个NetlinkHandler，而这里的就是依据这个进行相关分支进行的。</font></p> </li><li> <p><font face="Courier New">大类划分完成以后，接着调用NetlinkEvent的getAction函数接收上述四个大类socket类型的具体数据，然后根据Action的不同调用不同的notifyxxx进行对应的处理。</font></p> </li></ul> 
<h5><a id="font_faceCourier_New_154_NetlinkHandlernotify_642"></a><font face="Courier New"> 1.5.4 NetlinkHandler::notify</font></h5> 
<pre><code class="prism language-cpp"><span class="token comment">//NetlinkHandler.cpp</span>
<span class="token keyword">void</span> NetlinkHandler<span class="token operator">::</span><span class="token function">notifyInterfaceAdded</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">notify</span><span class="token punctuation">(</span>ResponseCode<span class="token operator">::</span>InterfaceChange<span class="token punctuation">,</span> <span class="token string">"Iface added %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> NetlinkHandler<span class="token operator">::</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">;</span>
    va_list args<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mNm<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//最终调用CommandListener的sendBroadcast发送，详见章节1.7.4</span>
        <span class="token function">free</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Failed to send notification: vasprintf: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">   可以看到最后都是统一调用了NetlinkHandler的nofity将内核上报的消息，发送给上层。这里的mNm显而易见是NetlinkManager，而getBroadcaster获取的是CommandListener！什么，这里通过getBroadcaster获取到的是CommandListener，这个是什么逻辑，还记的Netd的main函数里面的nm-&gt;setBroadcaster吗，关键就在此处。至于CommandListener我们会在后续章节中继续分析！</font></p> 
<p><font face="Courier New">   这里可以看出最后Netd是借助CommandListener向NetworkManagementService发送消息的。当然这里的消息可能有两种：一种是底层主动上报的消息(即我们这里的这种)，另一种是上层请求的response(这个会在后续分析)。</font></p> 
<br> 
<h4><a id="font_faceCourier_New_16_NetlinkManagerNetlinkHandler_672"></a><font face="Courier New"> 1.6 NetlinkManager和NetlinkHandler小结</font></h4> 
<p><font face="Courier New">   NetlinkManager和NetlinkHandler通过前面的章节已经分析完毕，是不是感觉内容有点多啊。这里谈谈我的心得，一定抓住其中各种类的继承关系已经函数调用逻辑不然真的很容易搞糊涂。在开启CommandListener之前我们还是对前面的NetlinkManager和NetlinkHandler小结一下：</font></p> 
<ul><li> <p><font face="Courier New">NetlinkManager新建了四个个PF_NETLINK类型的socket,然后根据前面创建的socket作为参数创建对应的NetlinkHandler,并且调用start函数启动它</font></p> </li><li> <p><font face="Courier New">这里的NetlinkHandler继承 NetlinkListener 继承 SocketListener,最后start调用的是SocketListener的startListener</font></p> </li><li> <p><font face="Courier New">startListener将会启动一个单独线程，通过多路复用监听内核的消息，当内核有消息上报时调用onDataAvailable来处理, onDataAvailable方法在NetlinkListener实现</font></p> </li><li> <p><font face="Courier New">NetlinkListener的onDataAvailable将内核的uEvent消息转化为NetlinkEvent调用onEvent来处理消息，onEvent方法在NetlinkHandler实现</font></p> </li><li> <p><font face="Courier New">NetlinkHandler的onEvent方法中根据前面NetlinkManager创建的四个socket来进行大类划分，然后再小类划分，最后调用notify函数。而notify函数最终调用NetlinkManager的Broadcaster也就是CommandListener的sendBroadcast方法,发送消息给发送给Framework层的NetworkManagermentService。</font></p> </li></ul> 
<p><font face="Courier New">   好吗！NetlinkManager和NetlinkHandler到这里已经撸完了，如果还有不明白的，可以跟着下面的时序图再撸一把！<br> <img src="https://images2.imgbox.com/04/32/ynWPakhl_o.png" alt="在这里插入图片描述"></font></p> 
<br> 
<h4><a id="font_faceCourier_New_17_CommandListener_692"></a><font face="Courier New"> 1.7 CommandListener分析</font></h4> 
<p><font face="Courier New">   前面章节1.5后面还留了一个大尾巴就是关于CommandListener的，即Netd借助CommandListener向NetworkManagementService发送消息的。一种是前面分析的通过NetlinkManager接受底层驱动主动上报的消息(即我们这里的这种)，另一种是上层请求的respons消息，这个章节统统给你分析清楚！</font></p> 
<h5><a id="font_faceCourier_New_171_CommandListenerCommandListener_696"></a><font face="Courier New"> 1.7.1 CommandListener::CommandListener</font></h5> 
<p><font face="Courier New">   对于CommandListener我们还是从其构造函数开始来分析(面相对象语言吗，通常是这个套路!),在章节1.3中我们知道CommandListener是在Netd的main中被创建的，看招！</font></p> 
<pre><code class="prism language-cpp"><span class="token comment">//CommandListener.cpp</span>
<span class="token keyword">void</span> CommandListener<span class="token operator">::</span><span class="token function">registerLockingCmd</span><span class="token punctuation">(</span>FrameworkCommand <span class="token operator">*</span>cmd<span class="token punctuation">,</span> android<span class="token operator">::</span>RWLock<span class="token operator">&amp;</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">registerCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">LockingFrameworkCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
CommandListener<span class="token operator">::</span><span class="token function">CommandListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                 <span class="token function">FrameworkListener</span><span class="token punctuation">(</span><span class="token string">"netd"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">InterfaceCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建了14个命令类对象</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">IpFwdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TetherCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">NatCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ListTtysCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">PppdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">SoftapCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">BandwidthControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>bandwidthCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">IdletimerControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ResolverCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">FirewallCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>firewallCtrl<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ClatdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">NetworkCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">StrictCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span><span class="token function">getQtiConnectivityCmd</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//初始化对应的控制类对象，控制类对象的创建，其初始化是在Netd的main函数中</span>
    gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>firewallCtrl<span class="token punctuation">.</span><span class="token function">setupIptablesHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>natCtrl<span class="token punctuation">.</span><span class="token function">setupIptablesHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>bandwidthCtrl<span class="token punctuation">.</span><span class="token function">setupIptablesHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>idletimerCtrl<span class="token punctuation">.</span><span class="token function">setupIptablesHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gCtls<span class="token operator">-</span><span class="token operator">&gt;</span>bandwidthCtrl<span class="token punctuation">.</span><span class="token function">enableBandwidthControl</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">   通过源码我们看到CommandListener构造函数的逻辑可以分为如下两个部分：</font></p> 
<ul><li><font face="Courier New">的初始化时注册了15个命令类对象, 这些类的定义在CommandListener.h中，都从NetdCommand继承, NetdCommand从FrameworkCommand继承，如下所示：</font></li></ul> 
<pre><code class="prism language-cpp">CommandListener<span class="token punctuation">.</span>h
<span class="token keyword">class</span> <span class="token class-name">CommandListener</span> <span class="token operator">:</span> <span class="token keyword">public</span> FrameworkListener <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CommandListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">CommandListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span>FrameworkCommand <span class="token operator">*</span>cmd<span class="token punctuation">,</span> android<span class="token operator">::</span>RWLock<span class="token operator">&amp;</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span>FrameworkCommand <span class="token operator">*</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">registerLockingCmd</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> android<span class="token operator">::</span>net<span class="token operator">::</span>gBigNetdLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">SoftapCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">SoftapCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">SoftapCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">InterfaceCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">InterfaceCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">InterfaceCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">IpFwdCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">IpFwdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">IpFwdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">TetherCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">TetherCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">TetherCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">NatCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">NatCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">NatCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">ListTtysCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ListTtysCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">ListTtysCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">PppdCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">PppdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">PppdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">BandwidthControlCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">BandwidthControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">BandwidthControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">sendGenericOkFail</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">int</span> cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">sendGenericOpFailed</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">sendGenericSyntaxError</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>usageMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">IdletimerControlCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">IdletimerControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">IdletimerControlCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">ResolverCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ResolverCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">ResolverCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">bool</span> <span class="token function">parseAndExecuteSetNetDns</span><span class="token punctuation">(</span><span class="token keyword">int</span> netId<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">FirewallCmd</span><span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">FirewallCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">FirewallCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token keyword">int</span> <span class="token function">sendGenericOkFail</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">int</span> cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> FirewallRule <span class="token function">parseRule</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> FirewallType <span class="token function">parseFirewallType</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> ChildChain <span class="token function">parseChildChain</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">ClatdCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ClatdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">ClatdCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">StrictCmd</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">StrictCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">StrictCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token keyword">int</span> <span class="token function">sendGenericOkFail</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">int</span> cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> StrictPenalty <span class="token function">parsePenalty</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">NetworkCommand</span> <span class="token operator">:</span> <span class="token keyword">public</span> NetdCommand <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">NetworkCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">NetworkCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">int</span> <span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient<span class="token operator">*</span> client<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> <span class="token function">syntaxError</span><span class="token punctuation">(</span>SocketClient<span class="token operator">*</span> cli<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">operationError</span><span class="token punctuation">(</span>SocketClient<span class="token operator">*</span> cli<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">,</span> <span class="token keyword">int</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">success</span><span class="token punctuation">(</span>SocketClient<span class="token operator">*</span> cli<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><font face="Courier New">接着调用registerCmd函数，该函数的实现是在其父类FrameworkListener中实现，逻辑比较简单就是讲上述创建的命令类存放在列表mCommands中供后续使用。</font></li></ul> 
<pre><code class="prism language-cpp"><span class="token comment">//FrameworkListener.cpp</span>
<span class="token keyword">typedef</span> android<span class="token operator">::</span>sysutils<span class="token operator">::</span>List<span class="token operator">&lt;</span>FrameworkCommand <span class="token operator">*</span><span class="token operator">&gt;</span> FrameworkCommandCollection<span class="token punctuation">;</span>
FrameworkCommandCollection <span class="token operator">*</span>mCommands<span class="token punctuation">;</span>
<span class="token keyword">void</span> FrameworkListener<span class="token operator">::</span><span class="token function">registerCmd</span><span class="token punctuation">(</span>FrameworkCommand <span class="token operator">*</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mCommands<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><font face="Courier New">最后调用控制类进行相关的初始化，这些控制类将和命令类共同完成相应的命令处理工作。这里的gCtls的创建是在Netd的main函数中创建的。是不是对控制类和命令类之间的关系还是有点迷糊，好吗，翠花上图！<br> <img src="https://images2.imgbox.com/8d/d3/ixBR1s10_o.png" alt="在这里插入图片描述"></font></li></ul> 
<h5><a id="font_faceCourier_New_172_CommandListenerstartListener_886"></a><font face="Courier New"> 1.7.2 CommandListener::startListener</font></h5> 
<p><font face="Courier New">   在Netd中的main函数最后，CommandListener调用startListener启动监听流程, 它的启动逻辑和NetlinkHandler基本一样。这是因为CommandListener继承于FrameworkListener，FrameworkListener继承于SocketListene，从而和NetlinkHandler有相同的超类,。通过前面分析NetlinkHandler可知，在调用startListener最后会在SocketListener启动一个线程。执行runListener方法来处理接收到的消息。但是其和NetlinkHandler处理的逻辑有两个不同点：</font></p> 
<ul><li> <p><font face="Courier New"> CommandListener的构造函数中传入的参数有两个分别是”netd“和true，这样就使得SocketListener中的mListen的值被赋值为true，进而runListener函数中监听的是真正的socket(其节点路径为/dev/socket/netd)而不是PF_NETLINK类型的socket。</font></p> </li><li> <p><font face="Courier New">CommandListener最后的onDataAvailable方法是在FrameworkListener实现的,最后调用dispatchCommand处理命令,最后调用runCommand来处理，最后消息通过前面创建的不同类型的命令处理里执行对应的runCommand方法。</font></p> </li></ul> 
<h5><a id="font_faceCourier_New_173_FrameworkListeneronDataAvailable_896"></a><font face="Courier New"> 1.7.3 FrameworkListener::onDataAvailable</font></h5> 
<pre><code class="prism language-cpp"><span class="token comment">//FrameworkListener.cpp</span>
<span class="token keyword">bool</span> FrameworkListener<span class="token operator">::</span><span class="token function">onDataAvailable</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>CMD_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
	<span class="token comment">//读取远程客户端发送过来的消息</span>
    len <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"read() failed (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGW</span><span class="token punctuation">(</span><span class="token string">"String is not zero-terminated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">android_errorWriteLog</span><span class="token punctuation">(</span><span class="token number">0x534e4554</span><span class="token punctuation">,</span> <span class="token string">"29831647"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Command too large for buffer"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSkipToNextNullByte <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* IMPORTANT: dispatchCommand() expects a zero-terminated string */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSkipToNextNullByte<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mSkipToNextNullByte <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">dispatchCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> buffer <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用dispatchCommand</span>
            <span class="token punctuation">}</span>
            offset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mSkipToNextNullByte <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> FrameworkListener<span class="token operator">::</span><span class="token function">dispatchCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    FrameworkCommandCollection<span class="token operator">::</span>iterator i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span>FrameworkListener<span class="token operator">::</span>CMD_ARGS_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> tmp<span class="token punctuation">[</span>CMD_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>q <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>qlimit <span class="token operator">=</span> tmp <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> esc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> quote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> haveCmdNum <span class="token operator">=</span> <span class="token operator">!</span>mWithSeq<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>esc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&gt;=</span> qlimit<span class="token punctuation">)</span>
                    <span class="token keyword">goto</span> overflow<span class="token punctuation">;</span>
                <span class="token operator">*</span>q<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\\'</span><span class="token punctuation">;</span>
                esc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                esc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>esc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token string">'"'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&gt;=</span> qlimit<span class="token punctuation">)</span>
                    <span class="token keyword">goto</span> overflow<span class="token punctuation">;</span>
                <span class="token operator">*</span>q<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'"'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&gt;=</span> qlimit<span class="token punctuation">)</span>
                    <span class="token keyword">goto</span> overflow<span class="token punctuation">;</span>
                <span class="token operator">*</span>q<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'\\'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Unsupported escape sequence"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
            esc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token string">'"'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>quote<span class="token punctuation">)</span>
                quote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                quote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&gt;=</span> qlimit<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> overflow<span class="token punctuation">;</span>
        <span class="token operator">*</span>q <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>quote <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>q <span class="token operator">==</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>q <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>haveCmdNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">char</span> <span class="token operator">*</span>endptr<span class="token punctuation">;</span>
                <span class="token keyword">int</span> cmdNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strtol</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>endptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>endptr <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token operator">*</span>endptr <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Invalid sequence number"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCmdNum</span><span class="token punctuation">(</span>cmdNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                haveCmdNum <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;=</span> CMD_ARGS_MAX<span class="token punctuation">)</span>
                    <span class="token keyword">goto</span> overflow<span class="token punctuation">;</span>
                argv<span class="token punctuation">[</span>argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            q <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        q<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>q <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;=</span> CMD_ARGS_MAX<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> overflow<span class="token punctuation">;</span>
    argv<span class="token punctuation">[</span>argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SLOGD</span><span class="token punctuation">(</span><span class="token string">"arg[%d] = '%s'"</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>quote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Unclosed quotes error"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRate <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">++</span>mCommandCount <span class="token operator">%</span> errorRate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* ignore this command - let the timeout handler handle it */</span>
        <span class="token function">SLOGE</span><span class="token punctuation">(</span><span class="token string">"Faking a timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> mCommands<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> mCommands<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        FrameworkCommand <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span>
		<span class="token comment">//查找到匹配合适的命令类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">runCommand</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//通过命令类来处理，而runCommand的具体实现在CommandListener.cpp中</span>
                <span class="token function">SLOGW</span><span class="token punctuation">(</span><span class="token string">"Handler '%s' error (%s)"</span><span class="token punctuation">,</span> c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Command not recognized"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">free</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

overflow<span class="token operator">:</span>
    <span class="token function">LOG_EVENT_INT</span><span class="token punctuation">(</span><span class="token number">78001</span><span class="token punctuation">,</span> cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cli<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Command too long"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">   通过前面的源码我们可以看到在onDataAvailable函数中通过read读取远端socket客户端发送过来的消息，然后调用dispatchCommand函数匹配前面创建的合适命令类，然后调用命令类的runCommand函数处理客户端发送过来的请求。</font></p> 
<h5><a id="font_faceCourier_New_174_CommandListenersendBroadcast_1063"></a><font face="Courier New"> 1.7.4 CommandListener::sendBroadcast</font></h5> 
<p><font face="Courier New">   还记得前面章节中NetlinkHandler::notify最后调用mNm-&gt;getBroadcaster()-&gt;sendBroadcast将内核消息发送给客户端吗！通过前面的分析我们可知这里getBroadcaster获取的就是CommandListener，然后调用其sendBroadcast函数发送消息。个人觉得这个BroadCaster名字也容易让人产生误解，以为是通过Android中类似的广播或者UDP中的广播。而实际上这个socket是netd.rc中配置的名字为“netd”的socke所accept出来的SocketClient，是一个TCP socket。而我们知道TCP socket是无法广播的。这里其实最后sendBroadCast最后调用的sendMsg通过socket将消息传递到了客户端，这样就解释就比较好理解了。唠了这么多，还是来分析分析下源码逻辑！</font></p> 
<pre><code class="prism language-cpp"><span class="token comment">//SocketListener.cpp</span>
<span class="token keyword">void</span> SocketListener<span class="token operator">::</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">bool</span> addErrno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    SocketClientCollection safeList<span class="token punctuation">;</span>

    <span class="token comment">/* Add all active clients to the safe list first */</span>
    safeList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SocketClientCollection<span class="token operator">::</span>iterator i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> mClients<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        SocketClient<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span>
        c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">incRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        safeList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mClientsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>safeList<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Pop the first item from the list */</span>
        i <span class="token operator">=</span> safeList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SocketClient<span class="token operator">*</span> c <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span>
        safeList<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// broadcasts are unsolicited and should not include a cmd number</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> addErrno<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">SLOGW</span><span class="token punctuation">(</span><span class="token string">"Error sending broadcast (%s)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        c<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">   不难看出就是遍历已经和CommandListener建立连接的SocketClient，然后通过基本的socket通信操作将消息发送给socket客户端。</font></p> 
<br> 
<h4><a id="font_faceCourier_New_18_CommandListener_1100"></a><font face="Courier New"> 1.8 CommandListener小结</font></h4> 
<p><font face="Courier New">   CommandListener也分析完了，趁热打铁对其小结一把：</font></p> 
<ul><li> <p><font face="Courier New">CommandListener同样继承自SocketListener，与之前创建的四个个NetlinkManager socket所不同的是此类的mListen被设置为true，也就是“netd”为监听socket。</font></p> </li><li> <p><font face="Courier New">接着CommandListener在Netd中的main函数中调用startListener开启线程用来监听来自java层的连接。当上层有连接时，select返回，accpet得到一个SocketClient，之后将其封装成SocketClient添加到list列表中，并添加进select的监听队列。当java层下发命令，SocketClient的可读事件被检测到，然后调用onDataAvailable来处理,。</font></p> </li><li> <p><font face="Courier New">和NetlinkHandler不同的是其onDataAvailable方法在FrameworkListener实现的，FrameworkListener的onDataAvailable会调用dispatchCommand来处理消息，而该函数中会匹配前面创建的命令类，然后调用匹配到的命令类的runCommand函数处理</font></p> </li><li> <p><font face="Courier New">最后将底层处理结果response返回回上层</font></p> </li><li> <p><font face="Courier New">而内核主动上报的消息也是通过CommandListener中已经连接的SocketClient上发到上层的</font></p> </li></ul> 
<p><font face="Courier New">   好吗！CommandListener到这里已经撸完了，如果还有不明白的，可以跟着下面的时序图再撸一把！<br> <img src="https://images2.imgbox.com/5a/38/XQn15q2u_o.png" alt="在这里插入图片描述"></font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_1121"></a><font face="Courier New">小结</font></h3> 
<p><font face="Courier New">   本来是想通过一个篇章将该篇章搞定over，然后打卡走人的！但是一看整的有点多啊，这还是在很多内容没有讲述的基础之上，看来还是得另外开垦篇章才行不然就会是老太太的裹脚布又臭又长了！那就先将该篇章的Netd部分讲述完毕，接着后面的篇章接着讲述NetworkManagementService怎么和Netd交互以及以太网络怎么和二者交互的了。万分不舍，也只能是下期见了！希望各位能多多点赞，或者评论，拍砖亦可！关于NetworkManagementService怎么和Netd交互详见篇章<a href="https://blog.csdn.net/tkwxty/article/details/107814419"><font face="Courier New">Android以太网框架情景分析之NetworkManagementService和netd交互深入分析二</font></a>。</font></p> 
<p><font face="Courier New">最后特别鸣谢如下博哥：</font></p> 
<p><a href="https://www.kancloud.cn/alex_wsc/android-wifi-nfc-gps/414021" rel="nofollow"><font face="Courier New">https://www.kancloud.cn/alex_wsc/android-wifi-nfc-gps/414021</font></a><br> <a href="https://blog.csdn.net/yemin6666/article/details/82318441#Netd%E5%90%AF%E5%8A%A8"><font face="Courier New">https://blog.csdn.net/yemin6666/article/details/82318441#Netd%E5%90%AF%E5%8A%A8</font></a><br> <a href="https://blog.csdn.net/a34140974/article/details/50717629"><font face="Courier New">https://blog.csdn.net/a34140974/article/details/50717629</font></a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8a9c31c950ab7e765b6316d0b0f16759/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python全量校验数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be8d911bf9d7edeca246226ed8f92975/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">shadows built-in name 你取的函数名是内置函数名</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>