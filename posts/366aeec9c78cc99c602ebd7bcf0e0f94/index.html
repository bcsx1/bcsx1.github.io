<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ubuntu22.04下Ethercat IGH DC同步实现 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ubuntu22.04下Ethercat IGH DC同步实现" />
<meta property="og:description" content="一.系统环境说明 主站系统：ubuntu22.04Igh版本：gitlab上的最新版本1.6.0，https://gitlab.com/etherlab.org/ethercat系统的实时内核：preempt-rt
该内核安装非常方便， 注册https://ubuntu.com/账号在个人账号的订阅下可以看到Token, 可以免费安装5台设备
https://ubuntu.com/pro/dashboard ua attach &lt;免费的TOEKN&gt; 确保你在使用至少 27.8 版本的 ubuntu-advantage-tools 软件包，可通过此命令查看当前版本： ua version 要在 Ubuntu 22.04 (Jammy Jellyfish) 中升级 ubuntu-advantage-tools 到 27.8，请运行命令：
sudo apt install ubuntu-advantage-tools=27.8~22.04.1 要启用测试版实时内核，可运行：
ua enable realtime-kernel --beta 需要验证实时性能，可以使用cyclitest,主要看max的值，经过14个小时时间，其最大值的延迟在230us左右，满足8ms为周期的控制
# 结果 sudo cyclictest -p 99 -S -i 8000 -m [sudo] lm 的密码： /dev/cpu_dma_latency set to 0us policy: fifo: loadavg: 10.26 9.47 9.38 7/1308 105547 T: 0 (91316) P:99 I:8000 C:6638053 Min: 2 Act: 73 Avg: 30 Max: 193 T: 1 (91317) P:99 I:8500 C:6247579 Min: 2 Act: 72 Avg: 27 Max: 166 T: 2 (91318) P:99 I:9000 C:5900491 Min: 3 Act: 74 Avg: 29 Max: 230 T: 3 (91319) P:99 I:9500 C:5589938 Min: 3 Act: 6 Avg: 28 Max: 155 # 压力：4核满负荷 lm@lm-X550JK:~$ stress-ng -c 4 --cpu-method fft --timerfd-freq 1000000 -t 24h stress-ng: info: [92633] setting to a 86400 second (1 day, 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/366aeec9c78cc99c602ebd7bcf0e0f94/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-01T09:09:28+08:00" />
<meta property="article:modified_time" content="2022-11-01T09:09:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ubuntu22.04下Ethercat IGH DC同步实现</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一.系统环境说明</h3> 
<ol><li>主站系统：<code>ubuntu22.04</code></li><li>Igh版本：gitlab上的最新版本1.6.0，https://gitlab.com/etherlab.org/ethercat</li><li>系统的实时内核：<code>preempt-rt</code><br> 该内核安装非常方便，</li></ol> 
<ul><li>注册https://ubuntu.com/账号</li><li>在个人账号的订阅下可以看到Token, 可以免费安装5台设备<br> https://ubuntu.com/pro/dashboard</li><li> <pre><code class="prism language-bash">ua attach <span class="token operator">&lt;</span>免费的TOEKN<span class="token operator">&gt;</span>
</code></pre> </li><li>确保你在使用至少 27.8 版本的 ubuntu-advantage-tools 软件包，可通过此命令查看当前版本：</li></ul> 
<pre><code class="prism language-bash">ua version
</code></pre> 
<p>要在 Ubuntu 22.04 (Jammy Jellyfish) 中升级 ubuntu-advantage-tools 到 27.8，请运行命令：</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ubuntu-advantage-tools<span class="token operator">=</span><span class="token number">27.8</span>~22.04.1
</code></pre> 
<p>要启用测试版实时内核，可运行：</p> 
<pre><code class="prism language-bash">ua <span class="token builtin class-name">enable</span> realtime-kernel --beta
</code></pre> 
<p>需要验证实时性能，可以使用cyclitest,主要看max的值，经过14个小时时间，其最大值的延迟在230us左右，满足8ms为周期的控制</p> 
<pre><code class="prism language-bash"><span class="token comment"># 结果</span>
<span class="token function">sudo</span> cyclictest  -p <span class="token number">99</span> -S -i <span class="token number">8000</span> -m
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> lm 的密码： 
/dev/cpu_dma_latency <span class="token builtin class-name">set</span> to 0us
policy: fifo: loadavg: <span class="token number">10.26</span> <span class="token number">9.47</span> <span class="token number">9.38</span> <span class="token number">7</span>/1308 <span class="token number">105547</span>            

T: <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">91316</span><span class="token punctuation">)</span> P:99 I:8000 C:6638053 Min:      <span class="token number">2</span> Act:   <span class="token number">73</span> Avg:   <span class="token number">30</span> Max:     <span class="token number">193</span>
T: <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">91317</span><span class="token punctuation">)</span> P:99 I:8500 C:6247579 Min:      <span class="token number">2</span> Act:   <span class="token number">72</span> Avg:   <span class="token number">27</span> Max:     <span class="token number">166</span>
T: <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">91318</span><span class="token punctuation">)</span> P:99 I:9000 C:5900491 Min:      <span class="token number">3</span> Act:   <span class="token number">74</span> Avg:   <span class="token number">29</span> Max:     <span class="token number">230</span>
T: <span class="token number">3</span> <span class="token punctuation">(</span><span class="token number">91319</span><span class="token punctuation">)</span> P:99 I:9500 C:5589938 Min:      <span class="token number">3</span> Act:    <span class="token number">6</span> Avg:   <span class="token number">28</span> Max:     <span class="token number">155</span>

<span class="token comment"># 压力：4核满负荷</span>
lm@lm-X550JK:~$ stress-ng -c <span class="token number">4</span> --cpu-method fft --timerfd-freq <span class="token number">1000000</span> -t 24h
stress-ng: info:  <span class="token punctuation">[</span><span class="token number">92633</span><span class="token punctuation">]</span> setting to a <span class="token number">86400</span> second <span class="token punctuation">(</span><span class="token number">1</span> day, <span class="token number">0.00</span> secs<span class="token punctuation">)</span> run per stressor
stress-ng: info:  <span class="token punctuation">[</span><span class="token number">92633</span><span class="token punctuation">]</span> dispatching hogs: <span class="token number">4</span> cpu
^Cstress-ng: info:  <span class="token punctuation">[</span><span class="token number">92633</span><span class="token punctuation">]</span> successful run completed <span class="token keyword">in</span> <span class="token number">52186</span>.24s <span class="token punctuation">(</span><span class="token number">14</span> hours, <span class="token number">29</span> mins, <span class="token number">46.24</span> secs<span class="token punctuation">)</span>
</code></pre> 
<ol start="4"><li>控制对象：<code>7个支持DC模式的电机</code></li><li>参考代码：</li></ol> 
<ul><li>官方例程：dc_user，该例程以主站为参考时钟；</li><li>官方例程：rtai_rtdm_dc，该例程以从站为参考时钟，但其内核环境是RTAI</li></ul> 
<h3><a id="igh_50"></a>二.igh使用配置</h3> 
<pre><code class="prism language-cpp"><span class="token function">ecrt_request_master</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ecrt_master_create_domain</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ecrt_master_slave_config</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> VID_PID<span class="token punctuation">)</span>
<span class="token function">ecrt_slave_config_pdos</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> EC_END<span class="token punctuation">,</span> device_syncs<span class="token punctuation">)</span>
<span class="token function">ecrt_domain_reg_pdo_entry_list</span><span class="token punctuation">(</span>domain1<span class="token punctuation">,</span> domain1_regs<span class="token punctuation">)</span>
<span class="token function">ecrt_slave_config_sdo16</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x1c32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ecrt_slave_config_sdo16</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x1c33</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token function">ecrt_slave_config_dc</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0300</span><span class="token punctuation">,</span> cycle_ns<span class="token punctuation">,</span> cycle_ns<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//8ms</span>
<span class="token function">ecrt_master_activate</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span>
<span class="token function">ecrt_domain_data</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="ethercat_DC_63"></a>三.ethercat DC同步</h3> 
<h4><a id="31_dc_64"></a>3.1 dc同步原理</h4> 
<p>用EtherCAT的分布式时钟(DC)功能使从站设备同步指的是，总线中的第一个DC从站被定义为基准时钟，EtherCAT主站将基准时钟的时间分配至所有的从站。因此，EtherCAT主站周期性发送一个ARMW命令，以此读取存储在时钟主站的ESC（EtherCAT从站控制器）上适当的寄存器中的总线时间，并将这个值写入DC-从站相应的寄存器中。这些DC从站通过整合在ESC中的一个控制器来更新他们的本地时间。为保证请求的精度（可以接收低于1us的值），特殊从站之间的EtherCAT帧延迟必须得到额外的补偿。 对于每个从站来说，一个帧从发送到接受的这段时间将被测量。然后，根据总线拓扑结构，主站计算从站之间的延迟，并将相应延迟补偿值写入到ESC中的寄存器0x928里。</p> 
<p>ESC控制器的DC单元提供两个数字输出信号，SYNC0和SYNC1。频率一般对应于EtherCAT总线时钟的SYNC脉冲通常都是基于总线时间生成的。举个例子：如果EtherCAT主站用1ms发送周期性的I/O数据，SYNC脉冲频率通常也设置为1kHz。这些SYNC信号在从站一侧，一方面是可作为一个数字输出信号（例如要激活从站硬件组件），另一方面作为从站软件中断源。也就是说，很明显的要在SYNC脉冲被释放之前为所有从站提供新的信号。要实现这一目标，新的周期性I/O数据到达和SYNC脉冲之间的相隔时间的必须保证最小化。</p> 
<p>通常情况下，EtherCAT主站协议栈通过在其控制硬件（例如嵌入式x86PC中的8254计时器）中的硬件计时器来发送循环输出数据。如果系统运行周期为1kHz，那么8254计时器以及负责生成同步脉冲的从站计时器都应设置为1kHz。但8254计时器和从站计时器都不能准确的运行1kHz的周期率。实际上，这两个计时器之间有些偏差，因此，在主站里发送周期性I/O数据和从站中的一系列SYNC脉冲之间可以实现非恒定间隔。为了控制一个定义好的常量值的间隔，EtherCAT主站必须要与DC时钟主站同步（就是主站上的第一个DC从站）。这一机制被称为分布式时钟主站同步（DCM）。<br> 它可以以两种不同的方式实现：<br> 重新调整用来执行EtherCAT主站的硬件中所使用的物理计时器（例如8254定时器）（主站转换）；重新调整DC时钟主站的总线时间时间（总线转换）。<br> DCM控制器周期性计算EtherCAT主站时间和DC时钟主站时间之间的差异。根据设定值（即SYNC脉冲到主站中计时器中断的距离），PI控制器算法计算重新调整的值。当使用"主站转换"时，重新调整值会影响EtherCAT主站的物理计时器（例如8254)；而当使用的"总线转换"时，它则会影响DC时钟主站的寄存器0x920。<br> EtherCAT主站ClassA支持这两种方法（主站转换和总线转换)。<br> 主站与从站的同步是EtherCAT最具挑战性的特点之一。</p> 
<h4><a id="32__77"></a>3.2 同步模式</h4> 
<h5><a id="321_free_run_78"></a>3.2.1 free run</h5> 
<p>从站的过程数据处理，由内部事件触发，与主站循环无关</p> 
<p><img src="https://images2.imgbox.com/e8/b6/UEXubf24_o.png" alt="在这里插入图片描述"><br> 1、每个从站的定时周期都不一样<br> 2、每个定时周期到的时候，每个从站去执行自己的程序，&lt;比如检查通道上有没有合适的新的输入数据，有的话就令其输出有效(Output valid)或者检查有没有需要输入的数据，将其放到对应的同步管理器通道上(input prepare)让主站取走&gt;<br> 3、对于Free Run 模式而言，好比每个人都有自己的手表，但是如果没有一起对时的话。手表的本身的时间是不一样的(可能表和表之间存在时间差，一个8点一个10点)，那么在这种情况下，公司如果要求9点上班，那么每个人到公司的时间都是自己手表上的9点，但是不是统一的9点，他们到达公司的时间是不一样，所以Free Run模式没有任何的同步性可言</p> 
<h5><a id="322_SMSynchronous_85"></a>3.2.2 SM-Synchronous</h5> 
<p>从站的过程数据处理，由接收到携带过程数据的周期性数据帧时所产生的硬件中断触发</p> 
<p><img src="https://images2.imgbox.com/f5/06/wdhY1YqR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bb/17/UoClc0Iy_o.png" alt="在这里插入图片描述"><br> 1、一般而言，如果EtherCAT总线通讯时的同步模式不是DC模式，那么就是SM同步模式了，<br> 2、SM(Sync Manager同步管理器)指的是同步管理器的同步，它的触发方式是通过SM Event，也就是我们的数据帧在到达对应的从站的时候，会触发一个叫做同步管理器事件的信号(即SM Event)，当从站接受到这个信号的时候，会进入到对应的中断服务例程(即中断保存当期任务，去执行插入的中断例程，这里指线程中断处理相关数据，这也是SM Event和 Free Run的不同之处)，即SM是通过中断服务例程来处理对应的数据。<br> 3、从站检测到SM Event事件信号的时候会进入到中断服务例程去处理相应的数据(比如把输出数据有效，然后把输入数据放到同步管理器的通道上让主站取走)<br> 4、由于SM同步模式是根据数据帧到达特定从站的时候来触发SM Event事件信号来进行同步，那么对于一个特地给的帧来说，它到达每一个从站的时间必然是不同的，当系统很庞大的时候，每个从站接收到数据帧的时间就会相差很大，越在后边的从站接收到数据帧的时间就越晚，它的同步效果就越差。<br> 5、手表举例：10个人10个表，10个人开始对表，从0开始计时，当上一个人完成了对表计时之后，才通知到下一个人进行对表计时，依次传递，那么到最后的第10个人它开始计时的时间是最晚的。完成对时之后，如果公司要求是10点上班，每个人按照自己手表上的10点到达，那么第10个人一定是最晚的。</p> 
<h5><a id="323_DCSynchronous__95"></a>3.2.3 DC-Synchronous 简单</h5> 
<p>从站的过程数据处理，由基于分布时钟和系统时间的硬件中断触发</p> 
<p><img src="https://images2.imgbox.com/4e/b5/hJmk2ePl_o.png" alt="在这里插入图片描述"><br> 1、Sync0 Event和SM Event事件信号是类似的，他们都是一个中断事件信号，对于一个从站而言，如果中断信号触发了而且中断屏蔽寄存器没有屏蔽掉该中断信号，那么从站就会进入到中断服务例程<br> 2、中断服务例程就是说从站从主循环中跳出，暂停并保留主程序状态，然后执行中断服务例程这一部分内容，比如说周期性数据的输出,周期性数据的实时性比较强，那么中断信号可以满足这种比较强的实时性需求，不会因为其他信号来耽误它的操作，其它的中断信号会进入等待状态直到前一个中断信号被恢复，即进入到恢复现场阶段.<br> 3、不同于SM Event的地方是Sync0 Event是根据我们自己设定的延时时间触发而不是帧到达时候才触发<br> 4、注意，虽然简单DC同步机制中没有用到SM Event事件信号，但是它依旧是存在的，因为只要当Frame帧到达从站的时候就会触发SM Event事件信号，这里只是不用到该信号来进行触发而已，（但是应该明白不管是哪一种同步机制，SM Event都是存在的，当从站接受到数据帧的时候都会产生SM Event事件信号）</p> 
<h5><a id="324_DCSynchronous__103"></a>3.2.4 DC-Synchronous 优化</h5> 
<p><img src="https://images2.imgbox.com/fa/ca/cYkTWIWW_o.png" alt="在这里插入图片描述"><br> 1、优化的DC模式同时使用了SM Event事件信号和Sync0 Event事件信号，而简单DC同步机制只是使用Sync0 Event这一种事件信号进行同步，无论使用哪一种同步模式，只要当数据帧Frame到达从站的时候都会触发对应的SM Event事件信号。<br> 2、在这种优化的DC模式中，当对应的SM Event事件信号触发后，从站会进入到中断服务例程进行数据的处理,把数据帧Frame中对应的所需数据进行计算，然后复制到管理器通道对应的用户区域，等待Sync0 Event同步信号触发之后让从站取走，然后SM Event中断完成，恢复现场，然后等待Sync0 Event信号的触发到来，也就是同步信号的触发，可以看到由于之前SM Event中断中已经完成了前期数据的处理，当Sync0 Event同步信号触发时，程序进入到中断服务例程，就只需要很短的一段Output Delay Time，马上就进入到Output Valid(输出有效)状态。<br> 3、这种优化版的DC同步机制相对于之前的简单DC模式，优点就是Output Delay Time输出延时没有那么长了，主要是因为第二种优化的DC模式利用SM Event事件信号的触发完成了前期从数据帧中对应从站数据的计算和复制到管理器通道上，所以当Sync0 Event同步信号触发后，只需要从管理器通道取走已经计算并复制好了的数据，进入到输出有效Output Valid的延时时间自然就比较短了，而第一种简单的DC模式只是使用到了Sync0 Event同步信号，所以当Sync0 Event触发后，需要在Output Delay Time时间内完成数据的复制和计算，所以简单DC模式下的Output Delay Time延时时间就会比较长。<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-pYHXkibk-1666254718808)(/image/sync3.png)]<br> 1、当数据帧Frame依次到达每一个从站的时候，EtherCAT的机制会触发SM Event事件信号，（数据帧依次发送到各个从站的时间是一个慢慢变长的延时时间，这是硬件上必然发生无法改善的事情）。<br> 2、然后从站会把数据帧上从站需要的数据进行计算并复制到同步管理器通道上，然后会进行中断事件恢复，<br> 3、主程序等待一个DC Sync Signal同步事件中断信号（也就是Sync0 Event），这个Sync0 Event同步事件信号是所以从站同时触发的，就像规定的9点上班一样&lt;这里的前提是主站已经通过发送帧对各个从站完成了对表计时步骤，各个从站的时间是同步一致的&gt;。<br> 4、当Sync0 Event事件信号同步触发时候，由于之前已经完成了数据的计算和复制，那么此时的输出抖动会非常小，约为15ns，（输出抖动jitter和主站有关，在SM Event事件之前由主站触发），同时同步性能也会非常好（Output Delay time会很短，Output Valid输出有效很快触发）。<br> 5、在Output Valid输出有效触发之后，从站会等待一个Input Latch信号，它可以是Sync1 Event事件信号，也可以是Sync0 Event事件信号触发后一段固定的延时时间，这取决于我们在TwinCAT上的设置情况。</p> 
<h4><a id="33_DC_115"></a>3.3 DC同步丢帧</h4> 
<p>1、问题描述：在使用DC模式的时候会出现一种同步丢帧的情况，就是说数据帧在到达尾端从站之前，所有从站的Sync0 Event同步事件信号就已经触发了，也就是说数据帧传输的太慢，可能还来不及到达尾端从站，但是它的同步事件信号已经触发了，而此时从站却从管理器通道上获取不到数据帧中对应的数据，从站就会判断数据帧丢失了，这就是同步丢帧的问题。<br> 这种问题一般在考前的从站中发生较少，当一个系统较大时，尾端的从站接收到数据帧的时间也比较晚，因为存在物理传输时间，所以越后面的从站接收到的数据帧时间就越晚，虽然Sync0 Event事件信号在完成DC对时之后是同步触发的，但是数据帧的传递时间是依次递增的，如果我们刚开始留出的偏移时间(shift time)不够大的话就有可能在尾端从站发生同步丢帧的情况<br> 2、解决方案：把第一个从站和主站之间的偏移时间调大，可以在TwinCAT中对Shift Time进行调整。（由于Sync0 Event是同步触发的，只需要设置好第一个从站和主站之间的Shift time，后面的从站和主站的Shift Time也都是这个值）。</p> 
<h4><a id="34__120"></a>3.4 同步模式细分</h4> 
<p><img src="https://images2.imgbox.com/39/5c/P5bvr4kp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2b/1c/H8SfFDe0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7f/5c/3fqtH6Kq_o.png" alt=""><br> <img src="https://images2.imgbox.com/e4/b6/Cz5etzue_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="35_0x1c32_125"></a>3.5 对象0x1c32</h4> 
<p>![在这里插入图片描述](https://img-blog.csdnimg.cn/a300acefc7e3492990330d520b7e65fb.png#pic_cente<br> <img src="https://images2.imgbox.com/0d/14/vzk2cG2T_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/eb/b2/6SARqsZA_o.png" alt="在这里插入图片描述"></p> 
<p>同步管理器2 0x1c32<br> 0x1c32 output<br> ox1c33 input</p> 
<pre><code class="prism language-cpp"><span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">01</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//同步模式</span>
    rw
    <span class="token comment">//可读可写</span>
    uint16
    <span class="token comment">//类型</span>
    value<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span>
    <span class="token comment">//0:free run</span>
    <span class="token comment">//1:同步SM2事件</span>
    <span class="token comment">//2:DC模式,同步sync0事件</span>
    <span class="token comment">//3:DC模式，同步sync1事件</span>
<span class="token punctuation">}</span> 
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">02</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//周期时间</span>
    ro
    <span class="token comment">//只可读</span>
    uint32
    <span class="token comment">//类型</span>
    value<span class="token operator">:</span>ns
    <span class="token comment">//ns单位，带有SM2事件的本地计时器同步器的循环时间，主DC模式的循环时间，SYNC0/SYNC1 循环时间</span>
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">03</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//有效输出偏移，output shift time</span>
    ro<span class="token operator">/</span>rw
    uint32
    value：ns
    
    <span class="token comment">//sync0事件与输出有效之间的时间，单位ns，仅在DC模式下支持</span>
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">04</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//支持的同步类型</span>
    ro
    uint16 
    value
    <span class="token comment">//支持同步模式下有效</span>
    <span class="token comment">//bit0 = 1:支持free run</span>
    <span class="token comment">//bit1 = 1:支持SM2同步方式</span>
    <span class="token comment">//bit[2,3] = 01 支持DC模式</span>
    <span class="token comment">//bit4 = 1：支持DC同步sync0事件</span>
    <span class="token comment">//bit5 = 1：支持DC同步sync1事件</span>
    <span class="token comment">//bit14 = 1：动态时报，可以通过编写测量 Messen 0 x1c32:08</span>
    <span class="token comment">//其它bit保留</span>
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">05</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//最小周期时间</span>
    ro
    uint32
    value
    <span class="token comment">//每个从站为了完成所有内部任务需要的最小循环时间，包括过程数据的交换， 邮箱通讯， 状态机处理， 应用相关的功能等等， 最小循环时间取决于多个因素，比如应用的复杂程度以及要交换的过程数据量</span>
    <span class="token comment">//对于链接到 DC-Synchronous 从站的任务，</span>
    <span class="token comment">//应该确保 主站通讯周期（Communication Cycle Time ）≥ （从站最小循环时间）Minimum Cycle Time，</span>
    <span class="token comment">//否则从站应用就可能跟不上主站通讯的节拍。</span>
    <span class="token comment">//如果为了确保主站通讯周期大于所有从站的最小循环周期，</span>
    <span class="token comment">//不得不严重限制某些DC及非DC从站的通讯周期，</span>
    <span class="token comment">//以至于需要快速响应的任务不能执行，建议使用周期不同的多个任务，并把每个从站链接到适当周期的任务</span>
    <span class="token comment">//将数据从ESC拷贝到内存中占用的最小时间</span>
    <span class="token comment">//支持的最小循环时间，以ns为单位</span>
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span>：<span class="token number">06</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//计算和复制时间，output Calc and copy time</span>
    ro
    uint32
    <span class="token comment">//minimum time between trigger event(SM or sync0) and sync event(sync0 or sync1) </span>
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">07</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//最小硬件延迟</span>
    ro
    uint32
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">08</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//保留</span>
    ro
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">09</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//硬件延迟时间</span>
    ro
    uint32
<span class="token punctuation">}</span>
<span class="token number">0x1c32</span><span class="token operator">:</span><span class="token number">10</span>h
<span class="token punctuation">{<!-- --></span><span class="token comment">//sync0 周期时间</span>
    ro
    uint32
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="36_igh_ethercat_220"></a>3.6 igh ethercat官方例程的说明</h4> 
<ol><li> <p>dc_user<br> 以主站为参考时钟，实现方式是：<code>ecrt_master_sync_reference_clock</code>这个函数将最近一次从<code>ecrt_master_application_time</code>传入的时间戳发送给参考时钟</p> <p><code>ecrt_master_sync_slave_clocks</code>这个函数的作用是将参考时钟发送给所有从站，以实现dc时钟同步</p> </li><li> <p>rtai_rtdm_dc<br> 以从站为参考时钟</p> </li></ol> 
<h3><a id="_227"></a>二.以主站时钟为参考</h3> 
<pre><code class="prism language-cpp"><span class="token comment">//编译：g++ -o bk14 src/bk14.cpp ipipe_64.a -I/opt/etherlab/include -L./ -L/opt/etherlab/lib -Wl,--rpath=./ -Wl,--rpath=/opt/etherlab/lib -lethercat -lm -lrt -lipipe_64</span>
<span class="token comment">//运行：sudo ./bk14</span>
<span class="token comment">//taike电机   以主站作为参考时间</span>
<span class="token comment">//减小DC_FILTER_CNT, 可以降低dc_diff_ns，</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ecrt.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token comment">//#include &lt;sys/time.h&gt;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ipipe_64.h"</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pi</span> <span class="token expression"><span class="token number">3.14159265</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">1500</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M</span> <span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLOCK_TO_USE</span> <span class="token expression">CLOCK_MONOTONIC </span><span class="token comment">//CLOCK_REALTIME</span></span>
<span class="token comment">//#define NSEC_PER_SEC 1000000000</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cycle_ns <span class="token operator">=</span> <span class="token number">8000000</span><span class="token punctuation">;</span> <span class="token comment">/* 1 ms */</span>
<span class="token comment">//static int run = 1;</span>
<span class="token comment">/****************************************************************************/</span>
<span class="token comment">// EtherCAT</span>
<span class="token keyword">static</span> ec_master_t <span class="token operator">*</span>master <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_master_state_t master_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_domain_t <span class="token operator">*</span>domain1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_domain_state_t domain1_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_t <span class="token operator">*</span>sc<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_state_t sc_state<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_state_t sc_zero_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ec_slave_config_t <span class="token operator">*</span>sc_5 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>domain1_pd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_t <span class="token operator">*</span>sc_dig_out_01 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


<span class="token comment">/****************************************************************************/</span>

<span class="token comment">// EtherCAT distributed clock variables</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DC_FILTER_CNT</span>          <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYNC_MASTER_TO_REF</span>        <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> dc_start_time_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> dc_time_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
<span class="token keyword">static</span> <span class="token keyword">uint8_t</span>  dc_started <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int32_t</span>  dc_diff_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int32_t</span>  prev_dc_diff_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  dc_diff_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  dc_delta_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>      dc_filter_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  dc_adjust_ns<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  system_time_base <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> wakeup_time <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> overruns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token comment">// offsets for PDO entries</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> off_dig_out0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_6</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_5</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_4</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_3</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_2</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_1</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_0</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">num_</span> <span class="token expression"><span class="token number">7</span></span></span>
<span class="token keyword">uint16_t</span> a<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">uint16_t</span> p<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VID_PID</span>           <span class="token expression"><span class="token number">0x000000ab</span><span class="token punctuation">,</span><span class="token number">0x00001030</span>   </span><span class="token comment">/*Vendor ID, product code*/</span></span>
<span class="token keyword">float</span> t<span class="token punctuation">;</span>


<span class="token comment">/*Offsets for PDO entries*/</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> operation_mode<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ctrl_word<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_position<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> status_word<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_position<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> data_input<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> data_input1<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mode_operation<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> error_code<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> profile_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> profile_acceleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> profile_deccleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_turque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_turque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_acceleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_deccleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_taque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> dangqian_dianliu<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_dianliu<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_taque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//unsigned int follow_error;</span>
<span class="token punctuation">}</span>offset<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">static</span> ec_pdo_entry_reg_t domain1_regs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_0, VID_PID, 0x6077, 0, &amp;offset.current_taque[0]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_0, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[0]},</span>
    <span class="token comment">//{PANASONIC_0, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[0]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_1, VID_PID, 0x6077, 0, &amp;offset.current_taque[1]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_1, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[1]},</span>
    <span class="token comment">//{PANASONIC_1, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[1]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_2, VID_PID, 0x6077, 0, &amp;offset.current_taque[2]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_2, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[2]},</span>
    <span class="token comment">//{PANASONIC_2, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[2]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_3, VID_PID, 0x6077, 0, &amp;offset.current_taque[3]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_3, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[3]},</span>
    <span class="token comment">//{PANASONIC_3, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[3]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_4, VID_PID, 0x6077, 0, &amp;offset.current_taque[4]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_4, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[4]},</span>
    <span class="token comment">//{PANASONIC_4, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[4]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">//slave 5</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//ANASONIC_5, VID_PID, 0x6077, 0, &amp;offset.current_taque[5]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_5, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[5]},</span>
    <span class="token comment">//{PANASONIC_5, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[5]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_6, VID_PID, 0x6077, 0, &amp;offset.current_taque[6]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_6, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[6]},</span>
    <span class="token comment">//{PANASONIC_6, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[6]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/***************************************************************************/</span>
<span class="token comment">/*Config PDOs*/</span>
<span class="token keyword">static</span> ec_pdo_entry_info_t device_pdo_entries<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*RxPdo 0x1600*/</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token comment">//{0x6071, 0x00, 16},</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{0x60FF, 0x00, 32},</span>
    <span class="token comment">/*TxPdo 0x1A00*/</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{0x6077, 0x00, 16},</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{0x221C, 0x00, 16},</span>
    <span class="token comment">//{0x6078, 0x00, 16},</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{<!-- --></span><span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ec_pdo_info_t device_pdos<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//RxPdo</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1600</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> device_pdo_entries <span class="token operator">+</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//TxPdo</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1A00</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> device_pdo_entries <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ec_sync_info_t device_syncs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> EC_DIR_OUTPUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> EC_DIR_INPUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">2</span><span class="token punctuation">,</span> EC_DIR_OUTPUT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> device_pdos <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">3</span><span class="token punctuation">,</span> EC_DIR_INPUT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> device_pdos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">0xFF</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*****************************************************************************
 * Realtime task
 ****************************************************************************/</span>

<span class="token comment">/** Get the time in ns for the current cpu, adjusted by system_time_base.
 *
 * \attention Rather than calling rt_get_time_ns() directly, all application
 * time calls should use this method instead.
 *
 * \ret The time in ns.
 */</span>

<span class="token keyword">uint64_t</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    RTIME time <span class="token operator">=</span> <span class="token function">rt_get_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>system_time_base <span class="token operator">&gt;</span> time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*rt_printk("%s() error: system_time_base greater than"
                " system time (system_time_base: %lld, time: %llu\n",
                __func__, system_time_base, time);*/</span>
        <span class="token keyword">return</span> time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> time <span class="token operator">-</span> system_time_base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token comment">/** Convert system time to RTAI time in counts (via the system_time_base).
 */</span>
RTIME <span class="token function">system2count</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    RTIME ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>system_time_base <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span>system_time_base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*rt_printk("%s() error: system_time_base less than"
                " system time (system_time_base: %lld, time: %llu\n",
                __func__, system_time_base, time);*/</span>
        ret <span class="token operator">=</span> time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> time <span class="token operator">+</span> system_time_base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">nano2count</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*****************************************************************************/</span>
<span class="token comment">/****************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FREQUENCY</span> <span class="token expression"><span class="token number">125</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NSEC_PER_SEC</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1000000000L</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIOD_NS</span> <span class="token expression"><span class="token punctuation">(</span>NSEC_PER_SEC <span class="token operator">/</span> FREQUENCY<span class="token punctuation">)</span></span></span>
<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> cycletime <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> PERIOD_NS<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sync_ref_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DIFF_NS</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_sec <span class="token operator">-</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span> <span class="token operator">*</span> NSEC_PER_SEC <span class="token operator">+</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_nsec <span class="token operator">-</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TIMESPEC2NS</span><span class="token expression"><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> NSEC_PER_SEC <span class="token operator">+</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token function">timespec_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">timespec</span> time1<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> time2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> result<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time1<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> NSEC_PER_SEC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_nsec <span class="token operator">-</span> NSEC_PER_SEC<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>
<span class="token comment">/** Synchronise the distributed clocks
 */</span>
<span class="token keyword">void</span> <span class="token function">sync_distributed_clocks</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
    <span class="token keyword">uint32_t</span> ref_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> prev_app_time <span class="token operator">=</span> dc_time_ns<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    dc_time_ns <span class="token operator">=</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
    <span class="token comment">// get reference clock time to synchronize master cycle</span>
    <span class="token function">ecrt_master_reference_clock_time</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ref_time<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取参考时钟的低32位</span>
    dc_diff_ns <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span> prev_app_time <span class="token operator">-</span> ref_time<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">// sync reference clock to master</span>
    <span class="token function">ecrt_master_sync_reference_clock_to</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> dc_time_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">// call to sync slaves to ref slave</span>
    <span class="token function">ecrt_master_sync_slave_clocks</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token comment">/** Return the sign of a number
 *
 * ie -1 for -ve value, 0 for 0, +1 for +ve value
 *
 * \retval the sign of the value
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">sign</span><span class="token expression"><span class="token punctuation">(</span>val<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token function">typeof</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> _val <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>_val <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>_val <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token comment">/** Update the master time based on ref slaves time diff
 *
 * called after the ethercat frame is sent to avoid time jitter in
 * sync_distributed_clocks()
 */</span>
<span class="token keyword">void</span> <span class="token function">update_master_clock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
    <span class="token comment">// calc drift (via un-normalised time diff)</span>
    <span class="token keyword">int32_t</span> delta <span class="token operator">=</span> dc_diff_ns <span class="token operator">-</span> prev_dc_diff_ns<span class="token punctuation">;</span>
    prev_dc_diff_ns <span class="token operator">=</span> dc_diff_ns<span class="token punctuation">;</span>

    <span class="token comment">// normalise the time diff</span>
    dc_diff_ns <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>dc_diff_ns <span class="token operator">+</span> <span class="token punctuation">(</span>cycle_ns <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> cycle_ns<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>cycle_ns <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// only update if primary master</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// add to totals</span>
        dc_diff_total_ns <span class="token operator">+=</span> dc_diff_ns<span class="token punctuation">;</span>
        dc_delta_total_ns <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
        dc_filter_idx<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_filter_idx <span class="token operator">&gt;=</span> DC_FILTER_CNT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// add rounded delta average</span>
            dc_adjust_ns <span class="token operator">+=</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>dc_delta_total_ns <span class="token operator">+</span> <span class="token punctuation">(</span>DC_FILTER_CNT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> DC_FILTER_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// and add adjustment for general diff (to pull in drift)</span>
            dc_adjust_ns <span class="token operator">+=</span> <span class="token function">sign</span><span class="token punctuation">(</span>dc_diff_total_ns <span class="token operator">/</span> DC_FILTER_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// limit crazy numbers (0.1% of std cycle time)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_adjust_ns <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dc_adjust_ns <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_adjust_ns <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dc_adjust_ns <span class="token operator">=</span>  <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// reset</span>
            dc_diff_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
            dc_delta_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
            dc_filter_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// add cycles adjustment to time base (including a spot adjustment)</span>
        system_time_base <span class="token operator">+=</span> dc_adjust_ns <span class="token operator">+</span> <span class="token function">sign</span><span class="token punctuation">(</span>dc_diff_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        dc_started <span class="token operator">=</span> <span class="token punctuation">(</span>dc_diff_ns <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// output first diff</span>
            <span class="token comment">//rt_printk("First master diff: %d.\n", dc_diff_ns);</span>

            <span class="token comment">// record the time of this initial cycle</span>
            dc_start_time_ns <span class="token operator">=</span> dc_time_ns<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">rt_check_domain_state</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ec_domain_state_t ds <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">ecrt_domain_state</span><span class="token punctuation">(</span>domain1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ds<span class="token punctuation">.</span>working_counter <span class="token operator">!=</span> domain1_state<span class="token punctuation">.</span>working_counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Domain1: WC %u.\n"</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span>working_counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ds<span class="token punctuation">.</span>wc_state <span class="token operator">!=</span> domain1_state<span class="token punctuation">.</span>wc_state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Domain1: State %u.\n"</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span>wc_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    domain1_state <span class="token operator">=</span> ds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">rt_check_master_state</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ec_master_state_t ms<span class="token punctuation">;</span>

    <span class="token function">ecrt_master_state</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u slave(s).\n"</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>slaves_responding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"master AL states: 0x%02X.\n"</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>al_states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Link is %s.\n"</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>link_up <span class="token operator">?</span> <span class="token string">"up"</span> <span class="token operator">:</span> <span class="token string">"down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if (ms.slaves_responding != master_state.slaves_responding) {<!-- --></span>
    <span class="token comment">//     printf("%u slave(s).\n", ms.slaves_responding);</span>
    <span class="token comment">// }</span>

    <span class="token comment">// if (ms.al_states != master_state.al_states) {<!-- --></span>
    <span class="token comment">//     printf("AL states: 0x%02X.\n", ms.al_states);</span>
    <span class="token comment">// }</span>

    <span class="token comment">// if (ms.link_up != master_state.link_up) {<!-- --></span>
    <span class="token comment">//     printf("Link is %s.\n", ms.link_up ? "up" : "down");</span>
    <span class="token comment">// }</span>

    master_state <span class="token operator">=</span> ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">check_slave_config_states</span><span class="token punctuation">(</span>ec_slave_config_t <span class="token operator">*</span>sc<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ec_slave_config_state_t s<span class="token punctuation">;</span>
    <span class="token function">ecrt_slave_config_state</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"slave[%d]: State 0x%02X.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">.</span>al_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"slave[%d]: %s.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">.</span>online <span class="token operator">?</span> <span class="token string">"online"</span> <span class="token operator">:</span> <span class="token string">"offline"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"slave[%d]: %soperational.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">.</span>operational <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">"Not "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if (s.al_state != sc_state[i].al_state)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printf("slave[%d]: State 0x%02X.\n", i, s.al_state);</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if (s.online != sc_state[i].online)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printf("slave[%d]: %s.\n", i, s.online ? "online" : "offline");</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if (s.operational != sc_state[i].operational)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printf("slave[%d]: %soperational.\n", i, s.operational ? "" : "Not ");</span>
    <span class="token comment">// }</span>
    
    sc_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token comment">/** Wait for the next period
 */</span>
<span class="token keyword">void</span> <span class="token function">wait_period</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        RTIME wakeup_count <span class="token operator">=</span> <span class="token function">system2count</span><span class="token punctuation">(</span>wakeup_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        RTIME current_count <span class="token operator">=</span> <span class="token function">rt_get_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wakeup_count <span class="token operator">&lt;</span> current_count<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token punctuation">(</span>wakeup_count <span class="token operator">&gt;</span> current_count <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//rt_printk("%s(): unexpected wake time!\n", __func__);</span>
        <span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">timespec</span> wakeupTime<span class="token punctuation">;</span>
	<span class="token comment">/*wakeupTime.tv_sec= wakeup_time / NSEC_PER_SEC;
	wakeupTime.tv_nsec= wakeup_time % NSEC_PER_SEC;
	
        int s =clock_nanosleep(CLOCK_TO_USE, TIMER_ABSTIME, &amp;wakeupTime, NULL);*/</span>

	wakeupTime<span class="token punctuation">.</span>tv_sec<span class="token operator">=</span> cycle_ns <span class="token operator">/</span> NSEC_PER_SEC<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span> <span class="token string">"wakeupTime.tv_sec:  "</span> <span class="token operator">&lt;&lt;</span>wakeupTime<span class="token punctuation">.</span>tv_sec<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
	wakeupTime<span class="token punctuation">.</span>tv_nsec<span class="token operator">=</span> cycle_ns <span class="token operator">%</span> NSEC_PER_SEC<span class="token punctuation">;</span>
	
        <span class="token keyword">int</span> s <span class="token operator">=</span><span class="token function">clock_nanosleep</span><span class="token punctuation">(</span>CLOCK_TO_USE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wakeupTime<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//避免过度睡眠</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
               <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Interrupted by signal handler\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
               <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"clock_nanosleep:errno=%d\n"</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// done if we got to here</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// set master time in nano-seconds</span>
    <span class="token function">ecrt_master_application_time</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> wakeup_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// calc next wake time (in sys time)</span>
    wakeup_time <span class="token operator">+=</span> cycle_ns<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/****************************************************************************/</span>
<span class="token keyword">int32_t</span> current_pos<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target_pos<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int16_t</span> error_co<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int32_t</span> follow_err<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">bool</span> clear_err_zero <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> _release_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">int32_t</span> current_pos_5<span class="token punctuation">,</span> target_pos_5<span class="token punctuation">;</span>
<span class="token keyword">int16_t</span> error_co_5<span class="token punctuation">;</span>
<span class="token keyword">int32_t</span> follow_err_5<span class="token punctuation">;</span>
<span class="token keyword">bool</span> state_ok <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> slave_op_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">my_cyclic</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">uint16_t</span> command<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//用来帮助判断状态字的值</span>
    <span class="token keyword">int</span> cycle_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> blink <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   
    <span class="token comment">//signed long temp[8]={};</span>
    <span class="token keyword">uint16_t</span>    status<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//读取伺服状态</span>
    <span class="token keyword">uint32_t</span> target_position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> once<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> positions<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span>dir<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// oneshot mode to allow adjustable wake time</span>
    <span class="token comment">//rt_set_oneshot_mode();</span>

    <span class="token comment">// set first wake time in a few cycles</span>
    wakeup_time <span class="token operator">=</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">;</span>

    <span class="token comment">// start the timer</span>
    <span class="token comment">//start_rt_timer(nano2count(cycle_ns));</span>

    <span class="token comment">//rt_make_hard_real_time();</span>
    <span class="token keyword">bool</span> kk<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> k1 <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

    <span class="token comment">// get current time</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> wakeupTime<span class="token punctuation">,</span> time<span class="token punctuation">;</span>
    <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_TO_USE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wakeupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        wakeupTime <span class="token operator">=</span> <span class="token function">timespec_add</span><span class="token punctuation">(</span>wakeupTime<span class="token punctuation">,</span> cycletime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">clock_nanosleep</span><span class="token punctuation">(</span>CLOCK_TO_USE<span class="token punctuation">,</span> TIMER_ABSTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wakeupTime<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Write application time to master</span>
        <span class="token comment">//</span>
        <span class="token comment">// It is a good idea to use the target time (not the measured time) as</span>
        <span class="token comment">// application time, because it is more stable.</span>
        <span class="token comment">//</span>
        <span class="token function">ecrt_master_application_time</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> <span class="token function">TIMESPEC2NS</span><span class="token punctuation">(</span>wakeupTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// receive EtherCAT</span>
        <span class="token function">ecrt_master_receive</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ecrt_domain_process</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        cycle_counter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cycle_counter <span class="token operator">%</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cycle_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">rt_check_domain_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查数据域</span>
            <span class="token function">rt_check_master_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查主站</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//检查从站</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">check_slave_config_states</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"*****```*****\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>master_state<span class="token punctuation">.</span>al_states <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span>
            <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span>
            <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span>
            <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token comment">//检测从站激活进度</span>
        <span class="token punctuation">{<!-- --></span>
            state_ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


	    <span class="token comment">//taike control</span>
	    <span class="token comment">/*Read state*/</span>

    
        <span class="token keyword">if</span><span class="token punctuation">(</span>state_ok <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EC_READ_S32</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
                status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EC_READ_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取状态字</span>
                error_co<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EC_READ_S16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// printf("-------------------------------\n");</span>
                <span class="token comment">// printf("status[%d]:%x\n", i, status[i]);</span>
                <span class="token comment">// printf("current_position[%d]:%d\n", i, current_pos[i]);</span>
                <span class="token comment">// printf("target_position[%d]:%d\n", i, target_pos[i]);</span>
                <span class="token comment">// printf("error_code[%d]:%x\n", i, error_co[i]);</span>
                <span class="token comment">// printf("mode[%d]:%d\n", i, EC_READ_S8(domain1_pd + offset.mode_operation[i]));</span>
                <span class="token comment">// printf("kk = %d\n", kk);</span>
                <span class="token comment">// printf("-------------------------------\n");</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// init slave</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0040</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">EC_WRITE_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0006</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">EC_READ_S32</span><span class="token punctuation">(</span>domain1_pd<span class="token operator">+</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">EC_WRITE_S32</span><span class="token punctuation">(</span>domain1_pd<span class="token operator">+</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    target_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">EC_WRITE_S8</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    command<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x006F</span><span class="token punctuation">;</span>
                    <span class="token comment">//printf("command[%d] = 0x0006", i);</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0021</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">EC_WRITE_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0007</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">EC_WRITE_S32</span><span class="token punctuation">(</span>domain1_pd<span class="token operator">+</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    command<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x006F</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"command[%d] = 0x0007"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0023</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">EC_WRITE_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x000f</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    command<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x006F</span><span class="token punctuation">;</span>
                    <span class="token comment">//printf("command[%d] = 0x000f", i);</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//write process data</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>    <span class="token comment">//operation enabled</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0027</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>        
                    <span class="token comment">// current_pos[i]=EC_READ_S32(domain1_pd+offset.current_position[i]);</span>
                    <span class="token comment">// EC_WRITE_S32(domain1_pd+offset.target_position[i],current_pos[i]);</span>
                    <span class="token comment">//printf("\n slave[%d] is enabled\n", i);</span>
                    
                    <span class="token comment">// if (!_release_)</span>
                    <span class="token comment">// {<!-- --></span>
                    <span class="token comment">//     // target_pos = target_pos + 100 * sin(t);</span>
                    <span class="token comment">//     // t = t + 0.01;</span>
                    <span class="token comment">//     if (kk == 0)</span>
                    <span class="token comment">//     {<!-- --></span>
                    <span class="token comment">//         kk = 1;</span>
                    <span class="token comment">//         target_pos = EC_READ_S32(domain1_pd+offset.current_position) + 100;</span>
                    <span class="token comment">//     }</span>
                    <span class="token comment">//     else</span>
                    <span class="token comment">//         target_pos = target_pos + 100;</span>
                    <span class="token comment">//     EC_WRITE_S32(domain1_pd + offset.target_position, target_pos);</span>
                            
                    <span class="token comment">// }</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>    

        <span class="token keyword">if</span><span class="token punctuation">(</span>_release_<span class="token punctuation">)</span><span class="token comment">//释放使能</span>
        <span class="token punctuation">{<!-- --></span>
            k1<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Release time k1 = %d\n"</span><span class="token punctuation">,</span> k1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>k1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span><span class="token comment">// Prevent endless circulation </span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
        
        <span class="token comment">//同步开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_ref_counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sync_ref_counter<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            sync_ref_counter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// sync every cycle</span>

            <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_TO_USE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前时间</span>
            <span class="token function">ecrt_master_sync_reference_clock_to</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> <span class="token function">TIMESPEC2NS</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将主站时钟同步到参考时钟</span>
        <span class="token punctuation">}</span>
        <span class="token function">ecrt_master_sync_slave_clocks</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将参考时钟发送给所有的从站，以实现dc同步</span>

        <span class="token comment">// clock_gettime(CLOCK_TO_USE, &amp;time);//获取当前时间</span>
        <span class="token comment">// ecrt_master_application_time(master, TIMESPEC2NS(time));</span>
        <span class="token comment">// ecrt_master_sync_reference_clock(master);//将主站时钟同步到参考时钟</span>
        <span class="token comment">// ecrt_master_sync_slave_clocks(master);//将参考时钟发送给所有的从站，以实现dc同步</span>

        <span class="token comment">// queue process data</span>
        <span class="token function">ecrt_domain_queue</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// send EtherCAT data</span>
        <span class="token function">ecrt_master_send</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************
 * Signal handler
 ***************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">signal_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get the ctrl-c signal : %d\n\n"</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _release_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//wait for thread down</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************
 * Main function
 ***************************************************************************/</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//ec_slave_config_t *sc_ek1100;</span>
    <span class="token comment">//ec_slave_config_t *sc_zero;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mlockall</span><span class="token punctuation">(</span>MCL_CURRENT <span class="token operator">|</span> MCL_FUTURE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mlockall failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Requesting master...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    master <span class="token operator">=</span> <span class="token function">ecrt_request_master</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>master<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    domain1 <span class="token operator">=</span> <span class="token function">ecrt_master_create_domain</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>domain1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Creating slave configurations...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span>num_<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ecrt_master_slave_config</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> VID_PID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
	        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to get slave %d configuration.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ecrt_slave_config_pdos</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> EC_END<span class="token punctuation">,</span> device_syncs<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to configure slave %d PDOs.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ecrt_domain_reg_pdo_entry_list</span><span class="token punctuation">(</span>domain1<span class="token punctuation">,</span> domain1_regs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"slave PDO entry registration failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
    dc_start_time_ns <span class="token operator">=</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dc_time_ns <span class="token operator">=</span> dc_start_time_ns<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ecrt_slave_config_sdo16</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x1c32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ecrt_slave_config_sdo16</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x1c33</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token function">ecrt_slave_config_dc</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0300</span><span class="token punctuation">,</span> cycle_ns<span class="token punctuation">,</span> cycle_ns<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//8ms</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Activating master...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ecrt_master_activate</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">=</span> <span class="token function">ecrt_domain_data</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to get domain data pointer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Create cyclic RT-thread */</span>
    <span class="token keyword">struct</span> <span class="token class-name">sched_param</span> param<span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">98</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using priority %i.\n"</span><span class="token punctuation">,</span> param<span class="token punctuation">.</span>sched_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sched_setscheduler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ERROR IN SETTING THE SCHEDULER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"errno"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">my_cyclic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"End of Program\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ecrt_release_master</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以主站为参考时钟，会出现</p> 
<pre><code class="prism language-bash">lm:~<span class="token variable">$sudo</span> <span class="token function">dmesg</span>
<span class="token punctuation">[</span><span class="token number">280374.468550</span><span class="token punctuation">]</span> r8169 0000:04:00.1 enp4s0f1: Link is Down
<span class="token punctuation">[</span><span class="token number">280374.468991</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Link state of ecm0 changed to DOWN.
<span class="token punctuation">[</span><span class="token number">281905.622543</span><span class="token punctuation">]</span> r8169 0000:04:00.1 enp4s0f1: Link is Up - 100Mbps/Full - flow control rx/tx
<span class="token punctuation">[</span><span class="token number">281905.624451</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Link state of ecm0 changed to UP.
<span class="token punctuation">[</span><span class="token number">281905.626454</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: <span class="token number">7</span> slave<span class="token punctuation">(</span>s<span class="token punctuation">)</span> responding on main device.
<span class="token punctuation">[</span><span class="token number">281905.626458</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Slave states on main device: PREOP.
<span class="token punctuation">[</span><span class="token number">281905.626611</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Scanning bus.
<span class="token punctuation">[</span><span class="token number">281905.736375</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">27</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281905.736380</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">199</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281906.004788</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Bus scanning completed <span class="token keyword">in</span> <span class="token number">378</span> ms.
<span class="token punctuation">[</span><span class="token number">281906.004792</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Using slave <span class="token number">0</span> as DC reference clock.
<span class="token punctuation">[</span><span class="token number">281907.460478</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">7</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281907.460483</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">7</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281908.828153</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">3</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281908.828158</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">3</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281912.095492</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281912.095496</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281916.932601</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281916.932615</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281920.965582</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281920.965596</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281922.539623</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">1</span> datagram TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281922.539637</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">1</span> datagram UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281923.890630</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">6</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281923.890644</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">6</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281927.266652</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281927.266657</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281936.043685</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281936.043690</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281936.670449</span><span class="token punctuation">]</span> EtherCAT: Requesting master <span class="token number">0</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token number">281936.670452</span><span class="token punctuation">]</span> EtherCAT: Successfully requested master <span class="token number">0</span>.
<span class="token punctuation">[</span><span class="token number">281936.670729</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain0: Logical address 0x00000000, <span class="token number">140</span> byte, expected working counter <span class="token number">21</span>.
<span class="token punctuation">[</span><span class="token number">281936.670732</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>:   Datagram domain0-0-main: Logical offset 0x00000000, <span class="token number">140</span> byte, <span class="token builtin class-name">type</span> LRW at 00000000d781fa5f.
<span class="token punctuation">[</span><span class="token number">281936.670772</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Master thread exited.
<span class="token punctuation">[</span><span class="token number">281936.670775</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Starting EtherCAT-OP thread.
<span class="token punctuation">[</span><span class="token number">281937.043712</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">1</span> datagram TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281937.043717</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281942.822919</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>-0: Slave did not <span class="token function">sync</span> after <span class="token number">5008</span> ms.
<span class="token punctuation">[</span><span class="token number">281942.878914</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">2</span>/21.
<span class="token punctuation">[</span><span class="token number">281943.886923</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: <span class="token number">3</span> working counter changes - now <span class="token number">6</span>/21.
<span class="token punctuation">[</span><span class="token number">281949.630973</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>-2: Slave did not <span class="token function">sync</span> after <span class="token number">5000</span> ms.
<span class="token punctuation">[</span><span class="token number">281949.670970</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">8</span>/21.
<span class="token punctuation">[</span><span class="token number">281950.678980</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">9</span>/21.
<span class="token punctuation">[</span><span class="token number">281952.717962</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">0</span>/21.
<span class="token punctuation">[</span><span class="token number">281952.806997</span><span class="token punctuation">]</span> EtherCAT WARNING: Datagram 00000000d781fa5f <span class="token punctuation">(</span>domain0-0-main<span class="token punctuation">)</span> was SKIPPED <span class="token number">7</span> times.
<span class="token punctuation">[</span><span class="token number">281953.046809</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">17</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">281953.719003</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">9</span>/21.
<span class="token punctuation">[</span><span class="token number">281955.359033</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>-3: Slave did not <span class="token function">sync</span> after <span class="token number">5000</span> ms.
<span class="token punctuation">[</span><span class="token number">281955.399037</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">11</span>/21.
<span class="token punctuation">[</span><span class="token number">281956.407019</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">12</span>/21.
<span class="token punctuation">[</span><span class="token number">281961.495061</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>-4: Slave did not <span class="token function">sync</span> after <span class="token number">5000</span> ms.
<span class="token punctuation">[</span><span class="token number">281961.551058</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">15</span>/21.
<span class="token punctuation">[</span><span class="token number">281962.559076</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">18</span>/21.
<span class="token punctuation">[</span><span class="token number">281968.271133</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>-6: Slave did not <span class="token function">sync</span> after <span class="token number">5000</span> ms.
<span class="token punctuation">[</span><span class="token number">281968.311135</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">21</span>/21.
<span class="token punctuation">[</span><span class="token number">281968.337007</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Slave states on main device: OP.
</code></pre> 
<p>超时5000ms,即从站同步较慢<br> 后续没有出现同步错误的提示<br> 该方法的主要内容：</p> 
<ol><li>配置从站的dc方式，0x0300是从站DC的激活字，可以从电机厂家给的XML文件的<code>&lt;dc&gt;</code>标签得到<br> <code>ecrt_slave_config_dc(sc[i], 0x0300, cycle_ns, cycle_ns/4, 0, 0);//8ms</code><br> 激活字对应的是从站的0x980和0x981寄存器的内容<br> <img src="https://images2.imgbox.com/dd/b7/OGA3rjpu_o.png" alt="在这里插入图片描述"></li></ol> 
<p>0x0300对应寄存器0x980 = 0x00，0x981 = 0x03，即SYNC输出单元控制和激活sync0.<br> 0x0700对应寄存器0x980 = 0x00，0x981 = 0x07,即SYNC输出单元控制和激活sync0、sync1.<br> 这里需要根据从站来决定<br> 2. 将主站时钟同步到参考时钟，该函数将主站的时钟同步到参考时钟(注意，此时参考时钟依然是默认的第一个带dc的slave，但是该时钟的数值被主站修改了，这样间接的实现以主站为参考时钟)<br> <code>ecrt_master_sync_reference_clock_to(master, TIMESPEC2NS(time));//将主站时钟同步到参考时钟</code><br> <code>ecrt_master_sync_slave_clocks(master);//将参考时钟发送给所有的从站，以实现dc同步</code></p> 
<h3><a id="_1124"></a>三.以从站为参考时钟</h3> 
<pre><code class="prism language-cpp"><span class="token comment">//编译：g++ -o bk14 src/bk14.cpp ipipe_64.a -I/opt/etherlab/include -L./ -L/opt/etherlab/lib -Wl,--rpath=./ -Wl,--rpath=/opt/etherlab/lib -lethercat -lm -lrt -lipipe_64</span>
<span class="token comment">//运行：sudo ./bk14</span>
<span class="token comment">//7电机 以从站作为参考时间</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ecrt.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token comment">//#include &lt;sys/time.h&gt;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ipipe_64.h"</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pi</span> <span class="token expression"><span class="token number">3.14159265</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">1500</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M</span> <span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLOCK_TO_USE</span> <span class="token expression">CLOCK_MONOTONIC </span><span class="token comment">//CLOCK_REALTIME</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NSEC_PER_SEC</span> <span class="token expression"><span class="token number">1000000000</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cycle_ns <span class="token operator">=</span> <span class="token number">8000000</span><span class="token punctuation">;</span> <span class="token comment">/* 1 ms */</span>
<span class="token comment">//static int run = 1;</span>
<span class="token comment">/****************************************************************************/</span>
<span class="token comment">// EtherCAT</span>
<span class="token keyword">static</span> ec_master_t <span class="token operator">*</span>master <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_master_state_t master_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_domain_t <span class="token operator">*</span>domain1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_domain_state_t domain1_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_t <span class="token operator">*</span>sc<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_state_t sc_state<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_state_t sc_zero_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ec_slave_config_t <span class="token operator">*</span>sc_5 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span>domain1_pd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ec_slave_config_t <span class="token operator">*</span>sc_dig_out_01 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


<span class="token comment">/****************************************************************************/</span>

<span class="token comment">// EtherCAT distributed clock variables</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DC_FILTER_CNT</span>          <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYNC_MASTER_TO_REF</span>        <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> dc_start_time_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> dc_time_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
<span class="token keyword">static</span> <span class="token keyword">uint8_t</span>  dc_started <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int32_t</span>  dc_diff_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int32_t</span>  prev_dc_diff_ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  dc_diff_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  dc_delta_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>      dc_filter_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  dc_adjust_ns<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token keyword">static</span> <span class="token keyword">int64_t</span>  system_time_base <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> wakeup_time <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">uint64_t</span> overruns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token comment">// offsets for PDO entries</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> off_dig_out0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_6</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_5</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_4</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_3</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_2</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_1</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PANASONIC_0</span>        <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>                        </span><span class="token comment">/*EtherCAT address on the bus*/</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">num_</span> <span class="token expression"><span class="token number">7</span></span></span>
<span class="token keyword">uint16_t</span> a<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">uint16_t</span> p<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VID_PID</span>           <span class="token expression"><span class="token number">0x000000ab</span><span class="token punctuation">,</span><span class="token number">0x00001030</span>   </span><span class="token comment">/*Vendor ID, product code*/</span></span>
<span class="token keyword">float</span> t<span class="token punctuation">;</span>
<span class="token comment">/*Offsets for PDO entries*/</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> operation_mode<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ctrl_word<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_position<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> status_word<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_position<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> data_input<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> data_input1<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mode_operation<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> error_code<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> profile_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> profile_acceleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> profile_deccleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_turque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_turque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_acceleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_deccleration<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_velocity<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_taque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> dangqian_dianliu<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_dianliu<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> target_taque<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//unsigned int follow_error;</span>
<span class="token punctuation">}</span>offset<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">static</span> ec_pdo_entry_reg_t domain1_regs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_0, VID_PID, 0x6077, 0, &amp;offset.current_taque[0]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_0, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[0]},</span>
    <span class="token comment">//{PANASONIC_0, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[0]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_0<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_1, VID_PID, 0x6077, 0, &amp;offset.current_taque[1]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_1, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[1]},</span>
    <span class="token comment">//{PANASONIC_1, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[1]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_1<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_2, VID_PID, 0x6077, 0, &amp;offset.current_taque[2]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_2, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[2]},</span>
    <span class="token comment">//{PANASONIC_2, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[2]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_2<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_3, VID_PID, 0x6077, 0, &amp;offset.current_taque[3]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_3, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[3]},</span>
    <span class="token comment">//{PANASONIC_3, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[3]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_3<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_4, VID_PID, 0x6077, 0, &amp;offset.current_taque[4]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_4, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[4]},</span>
    <span class="token comment">//{PANASONIC_4, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[4]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_4<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">//slave 5</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//ANASONIC_5, VID_PID, 0x6077, 0, &amp;offset.current_taque[5]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_5, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[5]},</span>
    <span class="token comment">//{PANASONIC_5, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[5]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_5<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">//"RX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//"TX"</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_6, VID_PID, 0x6077, 0, &amp;offset.current_taque[6]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{PANASONIC_6, VID_PID, 0x221C, 0, &amp;offset.current_dianliu[6]},</span>
    <span class="token comment">//{PANASONIC_6, VID_PID, 0x6078, 0, &amp;offset.dangqian_dianliu[6]},</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>current_velocity<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>PANASONIC_6<span class="token punctuation">,</span> VID_PID<span class="token punctuation">,</span> <span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/***************************************************************************/</span>
<span class="token comment">/*Config PDOs*/</span>
<span class="token keyword">static</span> ec_pdo_entry_info_t device_pdo_entries<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*RxPdo 0x1600*/</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6040</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6060</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token comment">//{0x6071, 0x00, 16},</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x607A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{0x60FF, 0x00, 32},</span>
    <span class="token comment">/*TxPdo 0x1A00*/</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6041</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{0x6077, 0x00, 16},</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6064</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//{0x221C, 0x00, 16},</span>
    <span class="token comment">//{0x6078, 0x00, 16},</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x606C</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x6061</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{<!-- --></span><span class="token number">0x603F</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ec_pdo_info_t device_pdos<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//RxPdo</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1600</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> device_pdo_entries <span class="token operator">+</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//TxPdo</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0x1A00</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> device_pdo_entries <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> ec_sync_info_t device_syncs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> EC_DIR_OUTPUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> EC_DIR_INPUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">2</span><span class="token punctuation">,</span> EC_DIR_OUTPUT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> device_pdos <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">3</span><span class="token punctuation">,</span> EC_DIR_INPUT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> device_pdos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> EC_WD_DISABLE <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token number">0xFF</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*****************************************************************************
 * Realtime task
 ****************************************************************************/</span>

<span class="token comment">/** Get the time in ns for the current cpu, adjusted by system_time_base.
 *
 * \attention Rather than calling rt_get_time_ns() directly, all application
 * time calls should use this method instead.
 *
 * \ret The time in ns.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TIMESPEC2NS</span><span class="token expression"><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> NSEC_PER_SEC <span class="token operator">+</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span></span></span>
<span class="token keyword">uint64_t</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//RTIME time = rt_get_time_ns();</span>
    
    <span class="token comment">//更换时钟</span>
    RTIME time<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> time_spc<span class="token punctuation">;</span>
    <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_TO_USE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>time_spc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    time <span class="token operator">=</span> <span class="token function">TIMESPEC2NS</span><span class="token punctuation">(</span>time_spc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//printf("time:%lld\n", time);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>system_time_base <span class="token operator">&gt;</span> time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*rt_printk("%s() error: system_time_base greater than"
                " system time (system_time_base: %lld, time: %llu\n",
                __func__, system_time_base, time);*/</span>
        <span class="token keyword">return</span> time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> time <span class="token operator">-</span> system_time_base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token comment">/** Convert system time to RTAI time in counts (via the system_time_base).
 */</span>
RTIME <span class="token function">system2count</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    RTIME ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>system_time_base <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span>system_time_base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*rt_printk("%s() error: system_time_base less than"
                " system time (system_time_base: %lld, time: %llu\n",
                __func__, system_time_base, time);*/</span>
        ret <span class="token operator">=</span> time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> time <span class="token operator">+</span> system_time_base<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nret:%lld\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">nano2count</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
RTIME <span class="token function">system2count_change</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    RTIME ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>system_time_base <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span>system_time_base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*rt_printk("%s() error: system_time_base less than"
                " system time (system_time_base: %lld, time: %llu\n",
                __func__, system_time_base, time);*/</span>
        ret <span class="token operator">=</span> time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> time <span class="token operator">+</span> system_time_base<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nret:%lld\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token comment">/** Synchronise the distributed clocks
 */</span>
<span class="token keyword">void</span> <span class="token function">sync_distributed_clocks</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
    <span class="token keyword">uint32_t</span> ref_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> prev_app_time <span class="token operator">=</span> dc_time_ns<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    dc_time_ns <span class="token operator">=</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
    <span class="token comment">// get reference clock time to synchronize master cycle</span>
    <span class="token function">ecrt_master_reference_clock_time</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ref_time<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取参考时钟的低32位</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ref_time:%d\n"</span><span class="token punctuation">,</span> ref_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dc_diff_ns <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span> prev_app_time <span class="token operator">-</span> ref_time<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"dc_diff_ns:%d\n"</span><span class="token punctuation">,</span>dc_diff_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">// sync reference clock to master</span>
    <span class="token function">ecrt_master_sync_reference_clock_to</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> dc_time_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">// call to sync slaves to ref slave</span>
    <span class="token function">ecrt_master_sync_slave_clocks</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token comment">/** Return the sign of a number
 *
 * ie -1 for -ve value, 0 for 0, +1 for +ve value
 *
 * \retval the sign of the value
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">sign</span><span class="token expression"><span class="token punctuation">(</span>val<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token function">typeof</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> _val <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>_val <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>_val <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*****************************************************************************/</span>

<span class="token comment">/** Update the master time based on ref slaves time diff
 *
 * called after the ethercat frame is sent to avoid time jitter in
 * sync_distributed_clocks()
 */</span>
<span class="token keyword">void</span> <span class="token function">update_master_clock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SYNC_MASTER_TO_REF</span></span>
    <span class="token comment">// calc drift (via un-normalised time diff)</span>
    <span class="token keyword">int32_t</span> delta <span class="token operator">=</span> dc_diff_ns <span class="token operator">-</span> prev_dc_diff_ns<span class="token punctuation">;</span>
    prev_dc_diff_ns <span class="token operator">=</span> dc_diff_ns<span class="token punctuation">;</span>

    <span class="token comment">// normalise the time diff</span>
    dc_diff_ns <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>dc_diff_ns <span class="token operator">+</span> <span class="token punctuation">(</span>cycle_ns <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> cycle_ns<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>cycle_ns <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// only update if primary master</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// add to totals</span>
        dc_diff_total_ns <span class="token operator">+=</span> dc_diff_ns<span class="token punctuation">;</span>
        dc_delta_total_ns <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
        dc_filter_idx<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_filter_idx <span class="token operator">&gt;=</span> DC_FILTER_CNT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// add rounded delta average</span>
            dc_adjust_ns <span class="token operator">+=</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>dc_delta_total_ns <span class="token operator">+</span> <span class="token punctuation">(</span>DC_FILTER_CNT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> DC_FILTER_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// and add adjustment for general diff (to pull in drift)</span>
            dc_adjust_ns <span class="token operator">+=</span> <span class="token function">sign</span><span class="token punctuation">(</span>dc_diff_total_ns <span class="token operator">/</span> DC_FILTER_CNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// limit crazy numbers (0.1% of std cycle time)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dc_adjust_ns</span> <span class="token generic class-name"><span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">0.001</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dc_adjust_ns <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.001</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_adjust_ns <span class="token operator">&gt;</span></span></span> <span class="token punctuation">(</span><span class="token number">0.001</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dc_adjust_ns <span class="token operator">=</span>  <span class="token number">0.001</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// reset</span>
            dc_diff_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
            dc_delta_total_ns <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
            dc_filter_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// add cycles adjustment to time base (including a spot adjustment)</span>
        system_time_base <span class="token operator">+=</span> dc_adjust_ns <span class="token operator">+</span> <span class="token function">sign</span><span class="token punctuation">(</span>dc_diff_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        dc_started <span class="token operator">=</span> <span class="token punctuation">(</span>dc_diff_ns <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dc_started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// output first diff</span>
            <span class="token comment">//rt_printk("First master diff: %d.\n", dc_diff_ns);</span>

            <span class="token comment">// record the time of this initial cycle</span>
            dc_start_time_ns <span class="token operator">=</span> dc_time_ns<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">rt_check_domain_state</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ec_domain_state_t ds <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">ecrt_domain_state</span><span class="token punctuation">(</span>domain1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ds<span class="token punctuation">.</span>working_counter <span class="token operator">!=</span> domain1_state<span class="token punctuation">.</span>working_counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Domain1: WC %u.\n"</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span>working_counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ds<span class="token punctuation">.</span>wc_state <span class="token operator">!=</span> domain1_state<span class="token punctuation">.</span>wc_state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Domain1: State %u.\n"</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span>wc_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    domain1_state <span class="token operator">=</span> ds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">rt_check_master_state</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ec_master_state_t ms<span class="token punctuation">;</span>

    <span class="token function">ecrt_master_state</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span>slaves_responding <span class="token operator">!=</span> master_state<span class="token punctuation">.</span>slaves_responding<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%u slave(s).\n"</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>slaves_responding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span>al_states <span class="token operator">!=</span> master_state<span class="token punctuation">.</span>al_states<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"AL states: 0x%02X.\n"</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>al_states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span>link_up <span class="token operator">!=</span> master_state<span class="token punctuation">.</span>link_up<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Link is %s.\n"</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>link_up <span class="token operator">?</span> <span class="token string">"up"</span> <span class="token operator">:</span> <span class="token string">"down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    master_state <span class="token operator">=</span> ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">check_slave_config_states</span><span class="token punctuation">(</span>ec_slave_config_t <span class="token operator">*</span>sc<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ec_slave_config_state_t s<span class="token punctuation">;</span>
    <span class="token function">ecrt_slave_config_state</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"slave[%d]: State 0x%02X.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">.</span>al_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"slave[%d]: %s.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">.</span>online <span class="token operator">?</span> <span class="token string">"online"</span> <span class="token operator">:</span> <span class="token string">"offline"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"slave[%d]: %soperational.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">.</span>operational <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">"Not "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if (s.al_state != sc_state[i].al_state)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printf("slave[%d]: State 0x%02X.\n", i, s.al_state);</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if (s.online != sc_state[i].online)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printf("slave[%d]: %s.\n", i, s.online ? "online" : "offline");</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if (s.operational != sc_state[i].operational)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printf("slave[%d]: %soperational.\n", i, s.operational ? "" : "Not ");</span>
    <span class="token comment">// }</span>
    
    sc_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/****************************************************************************/</span>

<span class="token comment">/** Wait for the next period
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token function">timespec_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">timespec</span> time1<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> time2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> result<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time1<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> NSEC_PER_SEC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_nsec <span class="token operator">-</span> NSEC_PER_SEC<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> time1<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> time2<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">wait_period</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//RTIME wakeup_count = system2count(wakeup_time);</span>
        <span class="token comment">// RTIME current_count = rt_get_time();</span>

        <span class="token comment">// if ((wakeup_count &lt; current_count)</span>
        <span class="token comment">//         || (wakeup_count &gt; current_count + (50 * cycle_ns))) {<!-- --></span>
        <span class="token comment">//     //rt_printk("%s(): unexpected wake time!\n", __func__);</span>
        <span class="token comment">// }</span>

        <span class="token comment">//原来的唤醒时间加补偿</span>
        RTIME wakeup_time_change <span class="token operator">=</span> <span class="token function">system2count_change</span><span class="token punctuation">(</span>wakeup_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">struct</span> <span class="token class-name">timespec</span> wakeupTime<span class="token punctuation">;</span>
        wakeupTime<span class="token punctuation">.</span>tv_sec<span class="token operator">=</span> wakeup_time_change <span class="token operator">/</span> NSEC_PER_SEC<span class="token punctuation">;</span>
        wakeupTime<span class="token punctuation">.</span>tv_nsec<span class="token operator">=</span> wakeup_time_change <span class="token operator">%</span> NSEC_PER_SEC<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nwakeupTime is :%lds,%ldns\n"</span><span class="token punctuation">,</span> wakeupTime<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> wakeupTime<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">clock_nanosleep</span><span class="token punctuation">(</span>CLOCK_TO_USE<span class="token punctuation">,</span> TIMER_ABSTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wakeupTime<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n s is :%d\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 	wakeupTime.tv_sec= cycle_ns / NSEC_PER_SEC;</span>
    <span class="token comment">//     std::cout&lt;&lt; "wakeupTime.tv_sec:  " &lt;&lt;wakeupTime.tv_sec&lt;&lt;std::endl;</span>
    <span class="token comment">// 	wakeupTime.tv_nsec= cycle_ns % NSEC_PER_SEC;	</span>
    <span class="token comment">//     std::cout&lt;&lt; "wakeupTime.tv_nsec:  " &lt;&lt;wakeupTime.tv_nsec&lt;&lt;std::endl;</span>
    <span class="token comment">//    int s = clock_nanosleep(CLOCK_TO_USE, 0, &amp;wakeupTime, NULL);</span>
        

        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//避免过度睡眠</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Interrupted by signal handler\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"clock_nanosleep:errno=%d\n"</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

            <span class="token comment">// done if we got to here</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">// set master time in nano-seconds</span>
    <span class="token function">ecrt_master_application_time</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> wakeup_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// calc next wake time (in sys time)</span>
    wakeup_time <span class="token operator">+=</span> cycle_ns<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/****************************************************************************/</span>
<span class="token keyword">int32_t</span> current_pos<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target_pos<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int16_t</span> error_co<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int32_t</span> follow_err<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">bool</span> clear_err_zero <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">bool</span> _release_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">int32_t</span> current_pos_5<span class="token punctuation">,</span> target_pos_5<span class="token punctuation">;</span>
<span class="token keyword">int16_t</span> error_co_5<span class="token punctuation">;</span>
<span class="token keyword">int32_t</span> follow_err_5<span class="token punctuation">;</span>
<span class="token keyword">bool</span> state_ok <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">my_cyclic</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">uint16_t</span> command<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">,</span><span class="token number">0x004F</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//用来帮助判断状态字的值</span>
    <span class="token keyword">int</span> cycle_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> blink <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   
    <span class="token comment">//signed long temp[8]={};</span>
    <span class="token keyword">uint16_t</span>    status<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//读取伺服状态</span>
    <span class="token keyword">uint32_t</span> target_position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> once<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint32_t</span> positions<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span>dir<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// oneshot mode to allow adjustable wake time</span>
    <span class="token comment">//rt_set_oneshot_mode();</span>
    
    <span class="token comment">// set first wake time in a few cycles</span>
    wakeup_time <span class="token operator">=</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> cycle_ns<span class="token punctuation">;</span>

    
    <span class="token comment">// start the timer</span>
    <span class="token comment">//start_rt_timer(nano2count(cycle_ns));</span>

    <span class="token comment">//rt_make_hard_real_time();</span>
    <span class="token keyword">bool</span> kk<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> k1 <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// wait for next period (using adjustable system time)</span>
        <span class="token function">wait_period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cycle_counter<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">// receive EtherCAT</span>
        <span class="token function">ecrt_master_receive</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ecrt_domain_process</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cycle_counter <span class="token operator">%</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cycle_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">rt_check_domain_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查数据域</span>
            <span class="token function">rt_check_master_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查主站</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//检查从站</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">check_slave_config_states</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"*****```*****\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>master_state<span class="token punctuation">.</span>al_states <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span>
            <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span>
            <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span>
            <span class="token operator">&amp;&amp;</span> sc_state<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>al_state <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token comment">//检测从站激活进度</span>
        <span class="token punctuation">{<!-- --></span>
            state_ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	    <span class="token comment">//taike control</span>
	    <span class="token comment">/*Read state*/</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>state_ok <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EC_READ_S32</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
                status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EC_READ_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>status_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取状态字</span>
                error_co<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EC_READ_S16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>error_code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"status[%d]:%x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> status<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current_position[%d]:%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"target_position[%d]:%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> target_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error_code[%d]:%x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> error_co<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"mode[%d]:%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">EC_READ_S8</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>mode_operation<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"kk = %d\n"</span><span class="token punctuation">,</span> kk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// init slave</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0040</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">EC_WRITE_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0006</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">EC_READ_S32</span><span class="token punctuation">(</span>domain1_pd<span class="token operator">+</span>offset<span class="token punctuation">.</span>current_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">EC_WRITE_S32</span><span class="token punctuation">(</span>domain1_pd<span class="token operator">+</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    target_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">EC_WRITE_S8</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>operation_mode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    command<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x006F</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"command[%d] = 0x0006"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0021</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">EC_WRITE_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0007</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">EC_WRITE_S32</span><span class="token punctuation">(</span>domain1_pd<span class="token operator">+</span>offset<span class="token punctuation">.</span>target_position<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>current_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    command<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x006F</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"command[%d] = 0x0007"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0023</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">EC_WRITE_U16</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">+</span> offset<span class="token punctuation">.</span>ctrl_word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x000f</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    command<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x006F</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"command[%d] = 0x000f"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//write process data</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>    <span class="token comment">//operation enabled</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> command<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0027</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>        
                    <span class="token comment">// current_pos[i]=EC_READ_S32(domain1_pd+offset.current_position[i]);</span>
                    <span class="token comment">// EC_WRITE_S32(domain1_pd+offset.target_position[i],current_pos[i]);</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n slave[%d] is enabled\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token comment">// if (!_release_)</span>
                    <span class="token comment">// {<!-- --></span>
                    <span class="token comment">//     // target_pos = target_pos + 100 * sin(t);</span>
                    <span class="token comment">//     // t = t + 0.01;</span>
                    <span class="token comment">//     if (kk == 0)</span>
                    <span class="token comment">//     {<!-- --></span>
                    <span class="token comment">//         kk = 1;</span>
                    <span class="token comment">//         target_pos = EC_READ_S32(domain1_pd+offset.current_position) + 100;</span>
                    <span class="token comment">//     }</span>
                    <span class="token comment">//     else</span>
                    <span class="token comment">//         target_pos = target_pos + 100;</span>
                    <span class="token comment">//     EC_WRITE_S32(domain1_pd + offset.target_position, target_pos);</span>
                            
                    <span class="token comment">// }</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>_release_<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            k1<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Release time k1 = %d\n"</span><span class="token punctuation">,</span> k1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>k1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span><span class="token comment">// Prevent endless circulation </span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
        <span class="token comment">// queue process data</span>
        <span class="token function">ecrt_domain_queue</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// sync distributed clock just before master_send to set</span>
        <span class="token comment">// most accurate master clock time</span>
        <span class="token function">sync_distributed_clocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// send EtherCAT data</span>
        <span class="token function">ecrt_master_send</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// update the master clock</span>
        <span class="token comment">// Note: called after ecrt_master_send() to reduce time</span>
        <span class="token comment">// jitter in the sync_distributed_clocks() call</span>
        <span class="token function">update_master_clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//rt_make_soft_real_time();</span>
    <span class="token comment">//stop_rt_timer();</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************
 * Signal handler
 ***************************************************************************/</span>

<span class="token keyword">void</span> <span class="token function">signal_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get the ctrl-c signal : %d\n\n"</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _release_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//wait for thread down</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************************************************
 * Main function
 ***************************************************************************/</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//ec_slave_config_t *sc_ek1100;</span>
    <span class="token comment">//ec_slave_config_t *sc_zero;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mlockall</span><span class="token punctuation">(</span>MCL_CURRENT <span class="token operator">|</span> MCL_FUTURE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mlockall failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Requesting master...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    master <span class="token operator">=</span> <span class="token function">ecrt_request_master</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>master<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    domain1 <span class="token operator">=</span> <span class="token function">ecrt_master_create_domain</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>domain1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Creating slave configurations...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span>num_<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ecrt_master_slave_config</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> VID_PID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
	        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to get slave %d configuration.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ecrt_slave_config_pdos</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> EC_END<span class="token punctuation">,</span> device_syncs<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to configure slave %d PDOs.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ecrt_domain_reg_pdo_entry_list</span><span class="token punctuation">(</span>domain1<span class="token punctuation">,</span> domain1_regs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"slave PDO entry registration failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	

    <span class="token comment">/* Set the initial master time and select a slave to use as the DC
     * reference clock, otherwise pass NULL to auto select the first capable
     * slave. Note: This can be used whether the master or the ref slave will
     * be used as the systems master DC clock.
     */</span>
    dc_start_time_ns <span class="token operator">=</span> <span class="token function">system_time_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dc_time_ns <span class="token operator">=</span> dc_start_time_ns<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1.dc_time_ns:%ld\n"</span><span class="token punctuation">,</span> dc_time_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ecrt_slave_config_sdo16</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x1c32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ecrt_slave_config_sdo16</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x1c33</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token function">ecrt_slave_config_dc</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0300</span><span class="token punctuation">,</span> cycle_ns<span class="token punctuation">,</span> cycle_ns<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//8ms</span>
    <span class="token punctuation">}</span>
 
    ret <span class="token operator">=</span> <span class="token function">ecrt_master_select_reference_clock</span><span class="token punctuation">(</span>master<span class="token punctuation">,</span> sc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to select reference clock: %s\n"</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Activating master...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ecrt_master_activate</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//usleep(1000000);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>domain1_pd <span class="token operator">=</span> <span class="token function">ecrt_domain_data</span><span class="token punctuation">(</span>domain1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to get domain data pointer.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// /* Create cyclic RT-thread */</span>
    <span class="token comment">// struct sched_param param;</span>
    <span class="token comment">// param.sched_priority = 98;</span>
    <span class="token comment">// printf("Using priority %i.", param.sched_priority);</span>
    <span class="token comment">// if (sched_setscheduler(0, SCHED_FIFO, &amp;param) == -1) {<!-- --></span>
    <span class="token comment">//     puts("ERROR IN SETTING THE SCHEDULER");</span>
    <span class="token comment">//     perror("errno");</span>
    <span class="token comment">//     return -1;</span>
    <span class="token comment">// }</span>
    <span class="token comment">// my_cyclic();</span>

    <span class="token comment">/* Set priority */</span>

    <span class="token keyword">struct</span> <span class="token class-name">sched_param</span> param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    pthread_attr_t attr<span class="token punctuation">;</span>
    pthread_t thread<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret_<span class="token punctuation">;</span>

    <span class="token comment">/* Initialize pthread attributes (default values) */</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"init pthread attributes failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set a specific stack size  */</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_attr_setstacksize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> PTHREAD_STACK_MIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread setstacksize failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set scheduler policy and priority of pthread */</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_attr_setschedpolicy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread setschedpolicy failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    param<span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">98</span><span class="token punctuation">;</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_attr_setschedparam</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread setschedparam failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Use scheduling parameters of attr */</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_attr_setinheritsched</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> PTHREAD_EXPLICIT_SCHED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread setinheritsched failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* Create a pthread with specified attributes */</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token operator">/</span><span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> my_cyclic<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create pthread failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Join the thread and wait until it is done */</span>
    ret_ <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"End of Program\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ecrt_release_master</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>更改睡眠时钟，例程的是rt相关，这里作了修改<br> 即<br> <code>system2count_change()</code>返回值修改为ns时间，原例是有计数时钟所以返回计数<br> <code>system_time_ns()</code>修改，clock_gettime获取时间</li><li>以从站为参考<br> <code>ret = ecrt_master_select_reference_clock(master, sc[0]);</code></li><li>获取参考时钟的时间<br> <code> ecrt_master_reference_clock_time(master, &amp;ref_time);//获取参考时钟的低32位</code></li><li>计算主站时钟与参考时钟的偏差，即主站的时钟偏移<br> <code>dc_diff_ns = (uint32_t) prev_app_time - ref_time;</code></li><li>使从站同步参考时钟<br> <code>ecrt_master_sync_slave_clocks(master);</code></li><li>计算时钟漂移<br> <code>int32_t delta = dc_diff_ns - prev_dc_diff_ns;</code></li><li>归一化处理，因为是为保证相位同步<br> <code>dc_diff_ns = ((dc_diff_ns + (cycle_ns / 2)) % cycle_ns) - (cycle_ns / 2); </code></li><li>后续对偏移进行滤波操作，最后将偏差添加到基时间</li></ul> 
<p>结果如下</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span><span class="token number">285162.618427</span><span class="token punctuation">]</span> EtherCAT: Requesting master <span class="token number">0</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token number">285162.618433</span><span class="token punctuation">]</span> EtherCAT: Successfully requested master <span class="token number">0</span>.
<span class="token punctuation">[</span><span class="token number">285162.618828</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Application selected DC reference clock config <span class="token punctuation">(</span><span class="token number">0</span>-0<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> by application.
<span class="token punctuation">[</span><span class="token number">285162.618834</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Using slave <span class="token number">0</span> as application selected DC reference clock.
<span class="token punctuation">[</span><span class="token number">285162.618836</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Using slave <span class="token number">0</span> as DC reference clock.
<span class="token punctuation">[</span><span class="token number">285162.618866</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain0: Logical address 0x00000000, <span class="token number">140</span> byte, expected working counter <span class="token number">21</span>.
<span class="token punctuation">[</span><span class="token number">285162.618870</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>:   Datagram domain0-0-main: Logical offset 0x00000000, <span class="token number">140</span> byte, <span class="token builtin class-name">type</span> LRW at 000000001de6bb29.
<span class="token punctuation">[</span><span class="token number">285162.618899</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Master thread exited.
<span class="token punctuation">[</span><span class="token number">285162.618902</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Starting EtherCAT-OP thread.
<span class="token punctuation">[</span><span class="token number">285162.619003</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">1</span> datagram TIMED OUT<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">285162.619007</span><span class="token punctuation">]</span> EtherCAT WARNING <span class="token number">0</span>: <span class="token number">2</span> datagrams UNMATCHED<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">285163.907391</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">2</span>/21.
<span class="token punctuation">[</span><span class="token number">285164.915418</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: <span class="token number">3</span> working counter changes - now <span class="token number">6</span>/21.
<span class="token punctuation">[</span><span class="token number">285165.923446</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: <span class="token number">2</span> working counter changes - now <span class="token number">9</span>/21.
<span class="token punctuation">[</span><span class="token number">285171.011438</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">11</span>/21.
<span class="token punctuation">[</span><span class="token number">285172.018424</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">12</span>/21.
<span class="token punctuation">[</span><span class="token number">285173.025458</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">15</span>/21.
<span class="token punctuation">[</span><span class="token number">285174.032442</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">18</span>/21.
<span class="token punctuation">[</span><span class="token number">285174.433663</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Slave states on main device: OP.
<span class="token punctuation">[</span><span class="token number">285175.039456</span><span class="token punctuation">]</span> EtherCAT <span class="token number">0</span>: Domain <span class="token number">0</span>: Working counter changed to <span class="token number">21</span>/21.
</code></pre> 
<p>解决了超时问题，未出现同步错误</p> 
<pre><code class="prism language-c"><span class="token comment">//ipipe_64.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">long</span> RTIME<span class="token punctuation">;</span>
RTIME <span class="token function">rt_get_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
RTIME <span class="token function">rt_get_time_ns</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
RTIME <span class="token function">count2nano</span><span class="token punctuation">(</span>RTIME counts<span class="token punctuation">)</span><span class="token punctuation">;</span>
RTIME <span class="token function">nano2count</span><span class="token punctuation">(</span>RTIME ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*no more*/</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//ipipe_64.c</span>
<span class="token comment">//针对c包含.c生成的.so链接库，需要以下操作</span>
<span class="token comment">/*1,gcc -c -fPIC ipipe_64.c
 *2,gcc -shared -fPIC -o libipipe_64.so ipipe_64.o
 */</span>
<span class="token comment">//针对c++包含c生成的.a链接库</span>
<span class="token comment">//1,gcc -c ipipe_64.c</span>
<span class="token comment">//2,ar -rc ipipe_64.a ipipe_64.o</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ipipe_64.h"</span></span>

<span class="token keyword">double</span> cpu_mhz<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> clock_freq<span class="token punctuation">;</span>

<span class="token comment">/*x86_64*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ipipe_read_tsc</span><span class="token expression"><span class="token punctuation">(</span>t<span class="token punctuation">)</span>  <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>         </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> __a<span class="token punctuation">,</span>__d<span class="token punctuation">;</span>                   </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span></span><span class="token string">"rdtsc"</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"=a"</span> <span class="token expression"><span class="token punctuation">(</span>__a<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token string">"=d"</span> <span class="token expression"><span class="token punctuation">(</span>__d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>__a<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>__d<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">rtai_rdtsc</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> t<span class="token punctuation">;</span> <span class="token function">ipipe_read_tsc</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> t<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">long</span> <span class="token function">rtai_imuldiv</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i<span class="token punctuation">,</span> <span class="token keyword">long</span> mult<span class="token punctuation">,</span> <span class="token keyword">long</span> div<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/* Returns (int)i = (int)i*(int)(mult)/(int)div. */</span>
    
    <span class="token keyword">int</span> dummy<span class="token punctuation">;</span>

    __asm__ <span class="token function">__volatile__</span> <span class="token punctuation">(</span> \
	<span class="token string">"mulq %%rdx\t\n"</span> \
	<span class="token string">"divq %%rcx\t\n"</span> \
	<span class="token operator">:</span> <span class="token string">"=a"</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=d"</span> <span class="token punctuation">(</span>dummy<span class="token punctuation">)</span>
       	<span class="token operator">:</span> <span class="token string">"a"</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"d"</span> <span class="token punctuation">(</span>mult<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"c"</span> <span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">rtai_llimd</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> ll<span class="token punctuation">,</span> <span class="token keyword">long</span> mult<span class="token punctuation">,</span> <span class="token keyword">long</span> div<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">rtai_imuldiv</span><span class="token punctuation">(</span>ll<span class="token punctuation">,</span> mult<span class="token punctuation">,</span> div<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">get_cpu_freq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
   <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">81</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   fp<span class="token operator">=</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">"cat /proc/cpuinfo|grep cpu\\ MHz|sed -e 's/.*:[^0-9]//'"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>fp<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read CPU freq failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token function">atof</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

RTIME <span class="token function">rt_get_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">rtai_rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RTIME <span class="token function">rt_get_time_ns</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">rtai_llimd</span><span class="token punctuation">(</span><span class="token function">rtai_rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000000000</span><span class="token punctuation">,</span> clock_freq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ++++++++++++++++++++++++++ TIME CONVERSIONS +++++++++++++++++++++++++++++ */</span>

RTIME <span class="token function">count2nano</span><span class="token punctuation">(</span>RTIME counts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>counts <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">rtai_llimd</span><span class="token punctuation">(</span>counts<span class="token punctuation">,</span> <span class="token number">1000000000</span><span class="token punctuation">,</span> clock_freq<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token function">rtai_llimd</span><span class="token punctuation">(</span><span class="token operator">-</span>counts<span class="token punctuation">,</span> <span class="token number">1000000000</span><span class="token punctuation">,</span> clock_freq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

RTIME <span class="token function">nano2count</span><span class="token punctuation">(</span>RTIME ns<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>ns <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">rtai_llimd</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> clock_freq<span class="token punctuation">,</span> <span class="token number">1000000000</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token function">rtai_llimd</span><span class="token punctuation">(</span><span class="token operator">-</span>ns<span class="token punctuation">,</span> clock_freq<span class="token punctuation">,</span> <span class="token number">1000000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*initialize the library*/</span>
<span class="token keyword">void</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">my_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   cpu_mhz <span class="token operator">=</span> <span class="token function">get_cpu_freq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   clock_freq <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>cpu_mhz <span class="token operator">*</span> <span class="token number">1000000l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*finitialize the library*/</span>
<span class="token keyword">void</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>destructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">my_fini</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token comment">/*no more*/</span>

</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6c244646566171d95224c3d0a4f2584d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Could not resolve placeholder ‘jdbc.driver‘ in string value “${jdbc.driver}“</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/18a8457afeb910a13d2b9ad41cf3db16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python量化初学者入门必备，如何入门Python量化交易？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>