<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android内存泄漏&amp;leakcanary2.7 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android内存泄漏&amp;leakcanary2.7" />
<meta property="og:description" content="一、内存泄漏 1.1 内存泄漏简介 内存泄漏，是指一些对象已经不再需要，但是无法成功被gc回收，导致这部分内存无法释放，造成资源的浪费。当大量的内存泄漏堆积时，严重时还容易间接引发OOM。
例如：当Activity被销毁后，理论上activity已经不再需要，内存空间理应被释放，但是如果有个静态变量持有了这个activity的引用，就会导致gc无法回收activity，造成内存泄漏。
以下代码模拟了上述场景：MainActivity启动了TestActivity，然后再从TestActivity后退到MainActivity，理论上从TestActivity退出后执行了onDestroy()，就不再需要TestActivity，但是因为Utils的静态对象持有了TestActivity，导致TestActivity无法被gc回收，造成内存泄漏。实际开发中应该避免这种写法。
package com.bc.example; public class Utils { public static Context cacheContext; } pulic class MainActivity extends Activity { public void onButtonClick() { Intent intent = new Intent(this, SecondActivity.class); startActivity(intent); } } pulic class SecondActivity extends Activity { @Override public void onCreate() { Utils.cacheContext = this; super.onCreate(); } } 1.2 常见内存泄漏原因 内存泄漏发生的原因：长生命周期对象持有短生命周期对象，导致短生命周期对象在不再需要时无法被gc回收。一般是由于代码bug引起，常见的内存泄漏原因有：
1.2.1 静态变量或单例导致的内存泄漏
例子如1.1中所示。
解决办法：静态变量或单例不要持有activity或view等对象的引用，如果必须持有引用可以改为WeakReference。
1.2.2 内部类导致的内存泄漏
内部类会持有外部类对象的引用，例如：
public class MainActivity extends Activity { /** * 内部类 */ public class InnerClass { } } 上述代码在编译后，生成的内部类MainActivity$InnerClass." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/d8d9a44b137cb32527a1b9d00745da95/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-16T16:58:04+08:00" />
<meta property="article:modified_time" content="2023-05-16T16:58:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android内存泄漏&amp;leakcanary2.7</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、内存泄漏</h2> 
<h3><a id="11__1"></a>1.1 内存泄漏简介</h3> 
<p>  内存泄漏，是指一些对象已经不再需要，但是无法成功被gc回收，导致这部分内存无法释放，造成资源的浪费。当大量的内存泄漏堆积时，严重时还容易间接引发OOM。<br><br>   例如：当Activity被销毁后，理论上activity已经不再需要，内存空间理应被释放，但是如果有个静态变量持有了这个activity的引用，就会导致gc无法回收activity，造成内存泄漏。<br><br>   以下代码模拟了上述场景：MainActivity启动了TestActivity，然后再从TestActivity后退到MainActivity，理论上从TestActivity退出后执行了onDestroy()，就不再需要TestActivity，但是因为Utils的静态对象持有了TestActivity，导致TestActivity无法被gc回收，造成内存泄漏。实际开发中应该避免这种写法。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>example</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Utils</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> cacheContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

pulic <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onButtonClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">SecondActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

pulic <span class="token keyword">class</span> <span class="token class-name">SecondActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Utils</span><span class="token punctuation">.</span>cacheContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="12__27"></a>1.2 常见内存泄漏原因</h3> 
<p>  内存泄漏发生的原因：长生命周期对象持有短生命周期对象，导致短生命周期对象在不再需要时无法被gc回收。一般是由于代码bug引起，常见的内存泄漏原因有：<br></p> 
<h4><a id="121_br_29"></a>1.2.1 静态变量或单例导致的内存泄漏<br></h4> 
<p>例子如1.1中所示。<br><br> 解决办法：静态变量或单例不要持有activity或view等对象的引用，如果必须持有引用可以改为WeakReference。<br></p> 
<h4><a id="122_br_32"></a>1.2.2 内部类导致的内存泄漏<br></h4> 
<p>内部类会持有外部类对象的引用，例如：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
    * 内部类
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerClass</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码在编译后，生成的内部类MainActivity$InnerClass.class文件如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span>$<span class="token class-name">InnerClass</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">MainActivity</span>$<span class="token class-name">InnerClass</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span> <span class="token keyword">this</span>$<span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">this</span>$<span class="token number">0</span> <span class="token operator">=</span> <span class="token keyword">this</span>$<span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可见，内部类持有外部类的引用，所以对于内部类的使用需要注意内部类的对象是否被持久引用，导致外部类无法被释放。<br><br> 解决办法：考虑是否可以使用静态内部类实现，静态内部类相当于普通类，不会持有外部类的引用。</p> 
<h4><a id="123_br_53"></a>1.2.3 匿名内部类导致的内存泄漏<br></h4> 
<p>匿名内部类同样会持有外部类对象的引用，以下面匿名内部Handler类为例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Handler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码在编译后，会生成匿名内部类MainActivity$1.class文件如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">MainActivity</span>$<span class="token number">1</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">MainActivity</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span> <span class="token keyword">this</span>$<span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">this</span>$<span class="token number">0</span> <span class="token operator">=</span> <span class="token keyword">this</span>$<span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  可见，匿名内部handler类持有了外部Activity的引用，这样，当Activity销毁后，如果该Handler仍有message在队列中，因为message.target指向该handler，而handler又持有了activity，导致activity无法被gc回收，发生内存泄漏。<br><br>   解决办法：在销毁activity时调用handler.removeCallbacksAndMessages()；考虑是否可以使用静态内部类实现，静态内部类相当于普通类，不会持有外部类的引用；当业务确实需要调用activity内的方法时，以WeakReference的方式进行调用。</p> 
<h4><a id="124__83"></a>1.2.4 动画导致的内存泄漏</h4> 
<p>首先，分析Animator动画启动的源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValueAnimator</span> <span class="token keyword">extends</span> <span class="token class-name">Animator</span> <span class="token keyword">implements</span> <span class="token class-name">AnimationHandler<span class="token punctuation">.</span>AnimationFrameCallback</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> playBackwards<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...省略部分代码</span>
        <span class="token comment">// 重点代码</span>
        <span class="token function">addAnimationCallback</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addAnimationCallback</span><span class="token punctuation">(</span><span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将自己添加到单例AnimationHandler的FrameCallback中</span>
        <span class="token function">getAnimationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAnimationFrameCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...省略</span>
        <span class="token function">endAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...省略</span>
        <span class="token function">endAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">endAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...省略</span>
        <span class="token function">removeAnimationCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeAnimationCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将自己从AnimationHandler的FrameCallback中移除</span>
        <span class="token function">getAnimationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
* AnimationHandler是单例实现，用来接收Choreographer.FrameCallback回调完成动画
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnimationHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationHandler</span><span class="token punctuation">&gt;</span></span> sAnimatorHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationFrameCallback</span><span class="token punctuation">&gt;</span></span> mAnimationCallbacks <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AnimationHandler</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sAnimatorHandler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sAnimatorHandler<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnimationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sAnimatorHandler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addAnimationFrameCallback</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AnimationFrameCallback</span> callback<span class="token punctuation">,</span> <span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAnimationCallbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postFrameCallback</span><span class="token punctuation">(</span>mFrameCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAnimationCallbacks<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mAnimationCallbacks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mDelayedCallbackStartTime<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  由以上代码分析可知，Animator在start()后会被一个单例类持有，在动画end或cancel后从callback列表中移除。<br><br>   在开发过程中，如果Animator定义的匿名内部类listener又持有了activity，而动画是无限循行ValueAnimator.INFINITE，就导致动画start后如果不cancel，会发生内存泄漏。<br></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">TextView</span> textView<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ValueAnimator</span> animator <span class="token operator">=</span> <span class="token class-name">ValueAnimator</span><span class="token punctuation">.</span><span class="token function">ofFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
        textView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TextView</span><span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>text_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        animator<span class="token punctuation">.</span><span class="token function">setDuration</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        animator<span class="token punctuation">.</span><span class="token function">setRepeatMode</span><span class="token punctuation">(</span><span class="token class-name">ValueAnimator</span><span class="token punctuation">.</span>REVERSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        animator<span class="token punctuation">.</span><span class="token function">setRepeatCount</span><span class="token punctuation">(</span><span class="token class-name">ValueAnimator</span><span class="token punctuation">.</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 匿名内部类listener会持有外部类的引用</span>
        animator<span class="token punctuation">.</span><span class="token function">addUpdateListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueAnimator<span class="token punctuation">.</span>AnimatorUpdateListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAnimationUpdate</span><span class="token punctuation">(</span><span class="token class-name">ValueAnimator</span> animator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Float</span> alpha <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Float</span><span class="token punctuation">)</span> animator<span class="token punctuation">.</span><span class="token function">getAnimatedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                textView<span class="token punctuation">.</span><span class="token function">setAlpha</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        animator<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>解决方案：在activity销毁时，调用动画的cancel方法。</p> 
<h4><a id="125__184"></a>1.2.5 资源未关闭导致的内存泄露</h4> 
<p>资源性对象（例如InputStream/OutputStream，Cursor，File文件等）未及时close，也会导致gc无法回收这部分内存。<br></p> 
<h4><a id="126_Eventbus_186"></a>1.2.6 Eventbus未取消注册导致内存泄漏</h4> 
<p>Eventbus的实现原理是一个单例中的map持有已注册的对象（详见：<a href="https://juejin.cn/post/6962516892556722184" rel="nofollow">Eventbus原理分析</a>），所以如果不取消注册（EventBus.getDefault().unregister(this)）就会造成内存泄漏。<br></p> 
<h4><a id="127__188"></a>1.2.7 其他</h4> 
<p>此外，还有注册了BroadcastReceiver、listener、RxJava subscription但是未取消注册等，也会造成内存泄漏。在开发中可能造成内存泄漏的bug很多，对于listener、receiver、observer、callback等对象，开发者应该仔细检查引用关系是否必要或合理，是否可能造成内存泄漏。</p> 
<h3><a id="13__190"></a>1.3 四种引用类型</h3> 
<p>（1）强引用(StrongReference)：在GC时，不会被回收；<br><br> （2）软引用(SoftReference)：内存不足时，如果一个对象只有软引用，才会被回收；<br><br> （3）弱引用(WeakReference)：在GC时，如果一个对象只有弱引用，则会被回收；<br><br> （4）虚引用(PhantomReference)：任何时候都有可能被回收；<br></p> 
<h2><a id="hprof_195"></a>二、hprof文件</h2> 
<h3><a id="21_hprof_196"></a>2.1 hprof文件获取方式</h3> 
<p><a href="http://hg.openjdk.java.net/jdk6/jdk6/jdk/raw-file/tip/src/share/demo/jvmti/hprof/manual.html" rel="nofollow">hprof</a>即heap profile文件，表示当前堆的内存快照。通过分析hprof文件，可以当前哪些对象存在泄漏。<br><br> 获取hprof文件的方式有三种：<br><br> （1）AS的Profiler工具<br><br> Android studio的<a href="https://developer.android.com/studio/profile/memory-profiler" rel="nofollow">Profiler工具</a>，在memory工具栏点击Dump Java heap即可捕捉当前堆内存快照。也可以导入hprof文件展示。<br><br> <img src="https://images2.imgbox.com/82/27/9hEFd78L_o.png" alt="image.png"><br> （2）adb命令行获取<br></p> 
<pre><code class="prism language-shell">adb shell am dumpheap <span class="token operator">&lt;</span>processname<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span>
</code></pre> 
<p>（3）代码获取<br></p> 
<pre><code class="prism language-java"><span class="token comment">// 下面代码会暂时挂起所有线程,并将当前堆快照保存到指定的fileName文件</span>
<span class="token class-name">Debug</span><span class="token punctuation">.</span><span class="token function">dumpHprofData</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="22_hprof_211"></a>2.2 hprof文件分析工具</h3> 
<h4><a id="221_ASProfiler_212"></a>2.2.1 AS的Profiler工具</h4> 
<p>以1.1中的代码为例，先启动SecondActivity，然后再返回到MainActivity；先点击profiler中的强制垃圾回收，再点击dump后，profiler工具会列出当前堆快照，并列出存在内存泄漏对象，如下所示：：<br><br> <img src="https://images2.imgbox.com/8b/7e/E3GVizcY_o.png" alt="image.png"><br> 在点击leak后，可看到泄漏的SecondActivity对象的引用链如下：<br> <img src="https://images2.imgbox.com/19/5a/cVJpGadG_o.png" alt="image.png"><br> 可根据GC root引用链修复内存泄漏。</p> 
<h4><a id="222_Shark_218"></a>2.2.2 Shark</h4> 
<p><a href="https://github.com/square/leakcanary/blob/main/docs/shark.md">Shark</a>是leakcanary2中用到的堆内存分析工具。运行速度快，占用内存少，适用于在客户端上分析hprof。<br><br> 如果项目中需要在app运行过程中分析hprof，可考虑使用，暂不深入研究。leakcanary1.x的Haha使用已经较少使用，不再介绍。</p> 
<h4><a id="223_eclipseMAT_221"></a>2.2.3 eclipse的MAT工具</h4> 
<p>eclipse的<a href="https://www.eclipse.org/mat/downloads.php" rel="nofollow">MAT</a>工具的使用方式与AS的Profiler工具的使用方式类似，也可以强制垃圾回收，导出当前堆快照hprof文件，分析hprof后展示引用链。暂不详细介绍。</p> 
<h2><a id="leakcanary_223"></a>三、leakcanary简介</h2> 
<p>  综上所述，比较原始的修复内存泄漏的办法是：在Activity退出后，导出当前堆快照hprof，然后使用分析工具打开hprof文件，分析是否存在内存泄漏，并切断引用链来修复内存泄漏。<br><br>   在实际开发中，这种做法很繁琐，需要每次Activity销毁后由开发者导出hprof并分析，我们希望有一个工具可以在发生内存泄漏的时候自动导出hprof文件并分析，将内存泄漏的引用链展示出来，leakcanary就提供了这样的功能。<br><br>   <a href="https://square.github.io/leakcanary/" rel="nofollow">leakcanary</a>是一个安卓内存泄漏检测库，用来帮助开发者检测Activity、FragmentAndViewModel、RootView、Service四种对象是否存在内存泄漏。</p> 
<h3><a id="31__227"></a>3.1 基础用法</h3> 
<p>leakcanary用法很简单，只需要在app的build.gradle中加入如下依赖</p> 
<pre><code class="prism language-gradle">dependencies { 
    // debugImplementation because LeakCanary should only run in debug builds. 
    // 可以看出，只有在编译debug包时，才会将leakcanary的代码打入包内
    debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.7' 
}
</code></pre> 
<p>至此，leakcanary就可以正常工作了。在app启动后，可以看到leakcanary输出的log表示leakcanary正在运行：</p> 
<pre><code class="prism language-log">D LeakCanary: LeakCanary is running and ready to detect leaks
</code></pre> 
<h3><a id="32__240"></a>3.2 使用方法</h3> 
<p>  在安装app后，桌面除了开发者的app图标外，还会多出一个leak的图标可以打开leakcanary的activity。在发生内存泄漏时，leakcanary会在合适的时机（泄漏的对象数量达到默认的阈值5或Application不可见，详见第四小节）自动dump当前堆快照hprof，然后分析是否有内存泄漏，并在leakcanary的activity中展示出来。开发者也可以自己点击’Dump Heap Now’来主动触发内存泄漏检测。<br><br>   仍然以1.1中例子为例，在从SecondActivity返回后，点击’Dump Heap Now’可看到leakcanary给出了内存泄漏的引用链，如下：<br> <img src="https://images2.imgbox.com/5c/ec/MV2cXJAJ_o.png" alt="image.png"><br>   可见，是因为Utils引用了SecondActivity对象，导致SecondActivity无法被回收，可考虑删掉该引用，或者改用WeakReference来修复内存泄漏。</p> 
<h2><a id="leakcanary_245"></a>四、leakcanary原理</h2> 
<p>在build.gradle中依赖<code>debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.7'</code>后，可以看到引入了以下aar：<br> <img src="https://images2.imgbox.com/e9/43/nKgOlqtT_o.png" alt="image.png"><br> leakcanary自动检测内存泄漏，主要分为四步：<br><br> （1）自动监测Activity、FragmentAndViewModel、RootView、Service的销毁，判断是否存在内存泄漏；<br><br> （2）在发生内存泄漏时，捕捉内存快照hprof文件；<br><br> （3）在HeapAnalyzerService使用<a href="https://github.com/square/leakcanary/blob/main/docs/shark.md">Shark</a>分析hprof文件；<br><br> （4）将分析出的内存泄漏结果进行归类并展示。<br></p> 
<h3><a id="41_Activity_253"></a>4.1 自动监测Activity等</h3> 
<h4><a id="411_leackcanary_254"></a>4.1.1 leackcanary初始化</h4> 
<p>在leakcanary1.x中，需要开发者在代码中调用leakcanary的初始化方法才能实现自动监测：</p> 
<pre><code class="prism language-java">pulib <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// leakcanary1.x需要开发者调用后才能实现自动监测</span>
        <span class="token class-name">LeakCanary</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  而在leakcanary2.x中，只需要在build.gradle中添加依赖即可，原因是因为leakcanary2.x中利用了ContentProverder在Application创建后就开始创建的原理（源码分析见第五节），在自定义的ContentProverder调用类似的manualInstall方法实现app启动后自动初始化并监测object。<br><br>   leakcanary2.x中实现自动监测的ContentProverder是AppWatcherInstaller，声明见leakcanary-object-watcher-android-2.7.aar的mainfest中：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.squareup.leakcanary.objectwatcher<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-sdk</span> <span class="token attr-name"><span class="token namespace">android:</span>minSdkVersion</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>14<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provider</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>leakcanary.internal.AppWatcherInstaller$MainProcess<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>authorities</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${applicationId}.leakcanary-installer<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@bool/leak_canary_watcher_auto_install<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  leakcanary2.x的AppWatcherInstaller源码如下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> AppWatcherInstaller <span class="token operator">:</span> <span class="token function">ContentProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">internal</span> <span class="token keyword">class</span> MainProcess <span class="token operator">:</span> <span class="token function">AppWatcherInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> application <span class="token operator">=</span> context<span class="token operator">!!</span><span class="token punctuation">.</span>applicationContext <span class="token keyword">as</span> Application
    <span class="token comment">// ContentProvider会在Application创建后就执行创建并执行onCreate()</span>
    <span class="token comment">// 在onCreate()里调用单例AppWatcher的manualInstall方法</span>
    AppWatcher<span class="token punctuation">.</span><span class="token function">manualInstall</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
* 单例AppWatcher
*/</span>
<span class="token keyword">object</span> AppWatcher <span class="token punctuation">{<!-- --></span>

  <span class="token comment">/**
  * @param watchersToInstall 默认值为appDefaultWatchers(application)
  */</span>
  <span class="token annotation builtin">@JvmOverloads</span>
  <span class="token keyword">fun</span> <span class="token function">manualInstall</span><span class="token punctuation">(</span>
    application<span class="token operator">:</span> Application<span class="token punctuation">,</span>
    retainedDelayMillis<span class="token operator">:</span> Long <span class="token operator">=</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    watchersToInstall<span class="token operator">:</span> List<span class="token operator">&lt;</span>InstallableWatcher<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">appDefaultWatchers</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    watchersToInstall<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span>
      it<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  * 默认的Watcher，有四类：ActivityWatcher、FragmentAndViewModelWatcher、RootViewWatcher、ServiceWatcher
  */</span>
  <span class="token keyword">fun</span> <span class="token function">appDefaultWatchers</span><span class="token punctuation">(</span>
    application<span class="token operator">:</span> Application<span class="token punctuation">,</span>
    reachabilityWatcher<span class="token operator">:</span> ReachabilityWatcher <span class="token operator">=</span> objectWatcher
    <span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>InstallableWatcher<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
      <span class="token function">ActivityWatcher</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> reachabilityWatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">FragmentAndViewModelWatcher</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> reachabilityWatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">RootViewWatcher</span><span class="token punctuation">(</span>reachabilityWatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">ServiceWatcher</span><span class="token punctuation">(</span>reachabilityWatcher<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  根据上面源码分析可知，leakcanary2.x是在application创建后就调用AppWatcher的manualInstall方法，方法里默认实现了四种watcher（ActivityWatcher、FragmentAndViewModelWatcher、RootViewWatcher、ServiceWatcher）来分别监测Activity、FragmentAndViewModel、RootView、Service的引用，来监测这四种对象是否存在内存泄漏。<br><br>   此外，PlumberInstaller也是通过ContentProvider的方式在Application启动后就初始化，来增加对一些比较少见的对象的内存泄漏检测，这里不深入分析。</p> 
<h4><a id="412_ObjectWatcher_334"></a>4.1.2 ObjectWatcher自动监测</h4> 
<p>  接下来，主要分析AppWatcher默认提供的四种watcher的实现方式，实际上四种Watcher主要负责在Activity、FragmentAndViewModel、RootView、Service销毁时传递引用，objectWatcher以弱引用的形式间隔一段时间分析当前对象是否被回收，如果已经被回收则不存在内存泄漏，否则说明<strong>可能</strong>存在内存泄漏。以下是源码分析：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">object</span> AppWatcher <span class="token punctuation">{<!-- --></span>

  <span class="token comment">/**
   * objectWatcher用来检测当前正在监测的对象是否可能存在内存泄漏
   */</span>
  <span class="token keyword">val</span> objectWatcher <span class="token operator">=</span> <span class="token function">ObjectWatcher</span><span class="token punctuation">(</span>
    clock <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    checkRetainedExecutor <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// retainedDelayMillis默认为5s</span>
      mainHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> retainedDelayMillis<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    isEnabled <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">fun</span> <span class="token function">appDefaultWatchers</span><span class="token punctuation">(</span>
    application<span class="token operator">:</span> Application<span class="token punctuation">,</span>
    reachabilityWatcher<span class="token operator">:</span> ReachabilityWatcher <span class="token operator">=</span> objectWatcher
  <span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>InstallableWatcher<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
      <span class="token comment">// 重点，四种Watcher都将objectWatcher作为参数传递</span>
      <span class="token function">ActivityWatcher</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> reachabilityWatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">FragmentAndViewModelWatcher</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> reachabilityWatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">RootViewWatcher</span><span class="token punctuation">(</span>reachabilityWatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">ServiceWatcher</span><span class="token punctuation">(</span>reachabilityWatcher<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  以ActivityWatcher为例，初始化时时通过注册ActivityLifecycleCallback实现Activity销毁时收到回调，收到回调后将引用传递给objectWatcher，objectWatcher持有该Activity的弱引用，并在一定时间后（默认5s）分析是否被回收。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">ActivityWatcher</span><span class="token punctuation">(</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> application<span class="token operator">:</span> Application<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> reachabilityWatcher<span class="token operator">:</span> ReachabilityWatcher
<span class="token punctuation">)</span> <span class="token operator">:</span> InstallableWatcher <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">private</span> <span class="token keyword">val</span> lifecycleCallbacks <span class="token operator">=</span>
    <span class="token keyword">object</span> <span class="token operator">:</span> Application<span class="token punctuation">.</span>ActivityLifecycleCallbacks <span class="token keyword">by</span> <span class="token function">noOpDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span>activity<span class="token operator">:</span> Activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 由ObjectWatcher分析expectWeaklyReachable，判断Activity在destroy后是否可能存在内存泄漏</span>
        reachabilityWatcher<span class="token punctuation">.</span><span class="token function">expectWeaklyReachable</span><span class="token punctuation">(</span>
          activity<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">activity<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> received Activity#onDestroy() callback"</span></span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    application<span class="token punctuation">.</span><span class="token function">registerActivityLifecycleCallbacks</span><span class="token punctuation">(</span>lifecycleCallbacks<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">uninstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    application<span class="token punctuation">.</span><span class="token function">unregisterActivityLifecycleCallbacks</span><span class="token punctuation">(</span>lifecycleCallbacks<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  类似的，FragmentAndViewModelWatcher、RootViewWatcher、ServiceWatcher主要负责在对象销毁时将引用传递给objectWatcher，由objectWatcher判断是否被回收，主要区别是判断销毁的时机有所区别，Activty、Fragment、RootView通过注册系统回调，Service通过Proxy.newProxyInstance()代理方式实现。<br><br>   接下来，主要分析ObjectWatcher收到expectWeaklyReachable()回调时如何判断对象是否被回收。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> ObjectWatcher <span class="token keyword">constructor</span><span class="token punctuation">(</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> clock<span class="token operator">:</span> Clock<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> checkRetainedExecutor<span class="token operator">:</span> Executor<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> isEnabled<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Boolean <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> ReachabilityWatcher <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * 以弱引用形式保存当前正在观察的对象
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> watchedObjects <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> KeyedWeakReference<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * 所有弱引用对象注册到的ReferenceQueue，用来判断弱引用所指向的对象是否被回收
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> queue <span class="token operator">=</span> ReferenceQueue<span class="token operator">&lt;</span>Any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * 当检测到对象可能发生内存泄漏时的listener,4.2小节再做分析
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> onObjectRetainedListeners <span class="token operator">=</span> mutableSetOf<span class="token operator">&lt;</span>OnObjectRetainedListener<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/**
  * 在Activity销毁后，以弱引用方式持有其引用，用于后续判断是否被回收
  */</span>
  <span class="token annotation builtin">@Synchronized</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">expectWeaklyReachable</span><span class="token punctuation">(</span>
    watchedObject<span class="token operator">:</span> Any<span class="token punctuation">,</span>
    description<span class="token operator">:</span> String
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">removeWeaklyReachableObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> key <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> watchUptimeMillis <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 弱引用持有Activity</span>
    <span class="token keyword">val</span> reference <span class="token operator">=</span> <span class="token function">KeyedWeakReference</span><span class="token punctuation">(</span>watchedObject<span class="token punctuation">,</span> key<span class="token punctuation">,</span> description<span class="token punctuation">,</span> watchUptimeMillis<span class="token punctuation">,</span> queue<span class="token punctuation">)</span>
    <span class="token comment">// 将Activity的弱引用添加到观察列表里</span>
    watchedObjects<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> reference
    <span class="token comment">// 由checkRetainedExecutor间隔5s在主线程判断对象是否被回收,checkRetainedExecutor的创建方法在AppWatcher里，不再分析</span>
    checkRetainedExecutor<span class="token punctuation">.</span><span class="token function">execute</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">moveToRetained</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  * 在当前观察的对象列表中，将已经被回收的对象移除，剩余的其他对象就是可能发生泄漏的对象
  */</span>
  <span class="token annotation builtin">@Synchronized</span> <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">moveToRetained</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 移除掉已经被回收的对象</span>
    <span class="token function">removeWeaklyReachableObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> retainedRef <span class="token operator">=</span> watchedObjects<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retainedRef <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      retainedRef<span class="token punctuation">.</span>retainedUptimeMillis <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 剩余可能发生泄漏的对象，则会调Listener的方法做进一步分析(4.2小节分析源码)</span>
      onObjectRetainedListeners<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span> it<span class="token punctuation">.</span><span class="token function">onObjectRetained</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">removeWeaklyReachableObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> ref<span class="token operator">:</span> KeyedWeakReference<span class="token operator">?</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// ReferenceQueue中有该WeakReference，则说明该WeakReference指向的对象已经被回收</span>
      ref <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> KeyedWeakReference<span class="token operator">?</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        watchedObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ref <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="413_KeyedWeakReference_459"></a>4.1.3 KeyedWeakReference</h4> 
<p>  上面提到，在Activity执行onDestroy()时，Activity对象以KeyedWeakReference弱引用的形式被ObjectWatcher持有，KeyedWeakReference本质上是WeakReference：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">KeyedWeakReference</span><span class="token punctuation">(</span>referent<span class="token operator">:</span> Any<span class="token punctuation">,</span> <span class="token keyword">val</span> key<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> description<span class="token operator">:</span> String<span class="token punctuation">,</span> 
    <span class="token keyword">val</span> watchUptimeMillis<span class="token operator">:</span> Long<span class="token punctuation">,</span>referenceQueue<span class="token operator">:</span> ReferenceQueue<span class="token operator">&lt;</span>Any<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> WeakReference<span class="token operator">&lt;</span>Any<span class="token operator">&gt;</span><span class="token punctuation">(</span>referent<span class="token punctuation">,</span> referenceQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  如何判断一个对象是否被回收，是通过WeakReference与ReferenceQueue的关系实现的：在创建WeakReference对象时可以指定一个ReferenceQueue对象，当该WeakReference指向的对象被GC标记可以回收后，该WeakReference会被加入到ReferenceQueue的末尾。WeakReference有两个构造函数，源码如下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">class</span> WeakReference<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> extends Reference<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 创建一个指向传入对象的弱引用
     */</span>
    <span class="token keyword">public</span> <span class="token function">WeakReference</span><span class="token punctuation">(</span>T referent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>referent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建一个指向传入对象的弱引用，并且将该弱引用注册到指定ReferenceQueue
     * 当弱引用所指向的对象被GC标记可以回收后，该弱引用会被放到ReferenceQueue的末尾
     */</span>
    <span class="token keyword">public</span> <span class="token function">WeakReference</span><span class="token punctuation">(</span>T referent<span class="token punctuation">,</span> ReferenceQueue<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">&gt;</span> q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>referent<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="414__486"></a>4.1.4 总结</h4> 
<p>  leakcanary2.x利用ContentProvider在Application创建后就创建的原理，在ContentProvider创建时即完成leakcanary初始化，方便开发者使用。<br><br>   leakcanary通过ActivityWatcher、FragmentAndViewModelWatcher、RootViewWatcher、ServiceWatcher在对象销毁时将引用传递给objectWatcher，由objectWatcher判断对象是否可能存在内存泄漏。<br><br>   objectWatcher在Activity、FragmentAndViewModel、RootView、Service销毁5s后，在主线程判断对象是否只被GC标记回收，如果没有则认为<strong>可能</strong>存在内存泄漏，接着触发HeapDumpTrigger（在4.2小节分析）在工作线程再次检查是否存在内存泄漏，是则导出hpfo文件并分析内存泄漏的引用链。<br><br>   objectWatcher判断观察的对象是否被回收的原理是：在创建WeakReference对象时可以指定一个ReferenceQueue对象，当该WeakReference指向的对象被GC标记可以回收后，该WeakReference会被加入到ReferenceQueue的末尾。</p> 
<h3><a id="42__491"></a>4.2 确认内存泄漏</h3> 
<p>  上面讲到，objectWatcher在认为可能发生内存泄漏后会回调OnObjectRetainedListener的onObjectRetained()方法：</p> 
<pre><code class="prism language-kotlin">onObjectRetainedListeners<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span> it<span class="token punctuation">.</span><span class="token function">onObjectRetained</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="421_addOnObjectRetainedListener_496"></a>4.2.1 addOnObjectRetainedListener的时机</h4> 
<p>  那么，接下来继续分析AppWatcher.objectWatcher.addOnObjectRetainedListener(this)是在什么时机添加的，添加的时机也是在AppWatcher的manualInstall方法里：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">object</span> AppWatcher <span class="token punctuation">{<!-- --></span>
  <span class="token annotation builtin">@JvmOverloads</span>
  <span class="token keyword">fun</span> <span class="token function">manualInstall</span><span class="token punctuation">(</span>
    application<span class="token operator">:</span> Application<span class="token punctuation">,</span>
    retainedDelayMillis<span class="token operator">:</span> Long <span class="token operator">=</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    watchersToInstall<span class="token operator">:</span> List<span class="token operator">&lt;</span>InstallableWatcher<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">appDefaultWatchers</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 重点分析</span>
    LeakCanaryDelegate<span class="token punctuation">.</span><span class="token function">loadLeakCanary</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
    watchersToInstall<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span>
      it<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">object</span> LeakCanaryDelegate <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">val</span> loadLeakCanary <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 实现类是InternalLeakCanary</span>
      <span class="token keyword">val</span> leakCanaryListener <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"leakcanary.internal.InternalLeakCanary"</span></span><span class="token punctuation">)</span>
      leakCanaryListener<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"INSTANCE"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>Application<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ignored<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      NoLeakCanary
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>收到可能存在内存泄漏的回调后，主要逻辑是在InternalLeakCanary中完成，源码如下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">object</span> InternalLeakCanary <span class="token operator">:</span> <span class="token punctuation">(</span>Application<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">,</span> OnObjectRetainedListener <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">private</span> <span class="token keyword">var</span> _application<span class="token operator">:</span> Application<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>application<span class="token operator">:</span> Application<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _application <span class="token operator">=</span> application
    <span class="token comment">// 这里就是objectWatcher.addOnObjectRetainedListener的时机，可见是在初始化时就添加好的</span>
    AppWatcher<span class="token punctuation">.</span>objectWatcher<span class="token punctuation">.</span><span class="token function">addOnObjectRetainedListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> heapDumper <span class="token operator">=</span> <span class="token function">AndroidHeapDumper</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> <span class="token function">createLeakDirectoryProvider</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 触发GC的实现</span>
    <span class="token keyword">val</span> gcTrigger <span class="token operator">=</span> GcTrigger<span class="token punctuation">.</span>Default
    <span class="token keyword">val</span> configProvider <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> LeakCanary<span class="token punctuation">.</span>config <span class="token punctuation">}</span>
    <span class="token comment">// 工作线程</span>
    <span class="token keyword">val</span> handlerThread <span class="token operator">=</span> <span class="token function">HandlerThread</span><span class="token punctuation">(</span>LEAK_CANARY_THREAD_NAME<span class="token punctuation">)</span>
    handlerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> backgroundHandler <span class="token operator">=</span> <span class="token function">Handler</span><span class="token punctuation">(</span>handlerThread<span class="token punctuation">.</span>looper<span class="token punctuation">)</span>
    <span class="token comment">// heapDump的触发器，在工作线程</span>
    heapDumpTrigger <span class="token operator">=</span> <span class="token function">HeapDumpTrigger</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> backgroundHandler<span class="token punctuation">,</span> AppWatcher<span class="token punctuation">.</span>objectWatcher<span class="token punctuation">,</span> gcTrigger<span class="token punctuation">,</span> heapDumper<span class="token punctuation">,</span>configProvider<span class="token punctuation">)</span>
    application<span class="token punctuation">.</span><span class="token function">registerVisibilityListener</span> <span class="token punctuation">{<!-- --></span> applicationVisible <span class="token operator">-&gt;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>applicationVisible <span class="token operator">=</span> applicationVisible
      heapDumpTrigger<span class="token punctuation">.</span><span class="token function">onApplicationVisibilityChanged</span><span class="token punctuation">(</span>applicationVisible<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">registerResumedActivityListener</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
    <span class="token comment">// 添加桌面快捷方式</span>
    <span class="token function">addDynamicShortcut</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>

    <span class="token comment">// logcat相关 We post so that the log happens after Application.onCreate()</span>
    mainHandler<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{<!-- --></span>
      backgroundHandler<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{<!-- --></span>
        SharkLog<span class="token punctuation">.</span><span class="token function">d</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">val</span> iCanHasHeap <span class="token operator">=</span> HeapDumpControl<span class="token punctuation">.</span><span class="token function">iCanHasHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">is</span> Yup <span class="token operator">-&gt;</span> application<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>leak_canary_heap_dump_enabled_text<span class="token punctuation">)</span>
            <span class="token keyword">is</span> Nope <span class="token operator">-&gt;</span> application<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>leak_canary_heap_dump_disabled_text<span class="token punctuation">,</span> iCanHasHeap<span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="422_onObjectRetained_571"></a>4.2.2 onObjectRetained</h4> 
<p>  根据以上分析，收到可能存在内存泄漏的回调后，接下来主要逻辑是在InternalLeakCanary中完成，接着分析收到回调后做了哪些工作，源码如下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">object</span> InternalLeakCanary <span class="token operator">:</span> <span class="token punctuation">(</span>Application<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">,</span> OnObjectRetainedListener <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onObjectRetained</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">scheduleRetainedObjectCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">fun</span> <span class="token function">scheduleRetainedObjectCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span>heapDumpTrigger<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// heapDumpTrigger是在上述InternalLeakCanary.invoke方法里创建的</span>
      heapDumpTrigger<span class="token punctuation">.</span><span class="token function">scheduleRetainedObjectCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="423_HeapDumpTrigger_585"></a>4.2.3 HeapDumpTrigger</h4> 
<p>  HeapDumpTrigger会在工作线程再次校验一次是否存在内存泄漏，检验方式是触发一次gc，然后检查是否仍有对象未被GC标记回收，如果是则进行dump heap，然后调用HeapAnalyzerService对hprof文件做进一步分析：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token function">HeapDumpTrigger</span><span class="token punctuation">(</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> application<span class="token operator">:</span> Application<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> backgroundHandler<span class="token operator">:</span> Handler<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> objectWatcher<span class="token operator">:</span> ObjectWatcher<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> gcTrigger<span class="token operator">:</span> GcTrigger<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> heapDumper<span class="token operator">:</span> HeapDumper<span class="token punctuation">,</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> configProvider<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Config
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">/**
   * 在工作线程调度再次校验是否存在内存泄漏
   * 是则dump heap并做进一步分析
   * */</span>
  <span class="token keyword">fun</span> <span class="token function">scheduleRetainedObjectCheck</span><span class="token punctuation">(</span>
    delayMillis<span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token number">0L</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> checkCurrentlyScheduledAt <span class="token operator">=</span> checkScheduledAt
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkCurrentlyScheduledAt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    checkScheduledAt <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delayMillis
    <span class="token comment">// 工作线程调度</span>
    backgroundHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      checkScheduledAt <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token comment">// 主要方法，下面分析</span>
      <span class="token function">checkRetainedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayMillis<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 触发gc再次确认是否存在内存泄漏，是则执行dump heap
   * */</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkRetainedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> config <span class="token operator">=</span> <span class="token function">configProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 1.查看当前objectWatcher持有的对象</span>
    <span class="token keyword">var</span> retainedReferenceCount <span class="token operator">=</span> objectWatcher<span class="token punctuation">.</span>retainedObjectCount
    <span class="token comment">// 2.objectWatcher持有对象时，先触发一次gc</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retainedReferenceCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gcTrigger<span class="token punctuation">.</span><span class="token function">runGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      retainedReferenceCount <span class="token operator">=</span> objectWatcher<span class="token punctuation">.</span>retainedObjectCount
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.gc后，如果objectWatcher持有的引用数小于5，则return</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkRetainedCount</span><span class="token punctuation">(</span>retainedReferenceCount<span class="token punctuation">,</span> config<span class="token punctuation">.</span>retainedVisibleThreshold<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 4.gc后，如果objectWatcher持有的引用数大于5，则dump heap做进一步分析</span>
    <span class="token comment">// 每次dump heap之间的间隔需要&gt;=60s，小于60s则return，并延迟到间隔满足60s再执行</span>
      <span class="token keyword">val</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> elapsedSinceLastDumpMillis <span class="token operator">=</span> now <span class="token operator">-</span> lastHeapDumpUptimeMillis
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsedSinceLastDumpMillis <span class="token operator">&lt;</span> WAIT_BETWEEN_HEAP_DUMPS_MILLIS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      onRetainInstanceListener<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>DumpHappenedRecently<span class="token punctuation">)</span>
      <span class="token function">showRetainedCountNotification</span><span class="token punctuation">(</span>
        objectCount <span class="token operator">=</span> retainedReferenceCount<span class="token punctuation">,</span>
        contentText <span class="token operator">=</span> application<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>leak_canary_notification_retained_dump_wait<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token comment">// 间隔小于60s，则延迟一段时间后再执行heap dump</span>
      <span class="token function">scheduleRetainedObjectCheck</span><span class="token punctuation">(</span>
        delayMillis <span class="token operator">=</span> WAIT_BETWEEN_HEAP_DUMPS_MILLIS <span class="token operator">-</span> elapsedSinceLastDumpMillis
        <span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token function">dismissRetainedCountNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> visibility <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationVisible<span class="token punctuation">)</span> <span class="token string-literal singleline"><span class="token string">"visible"</span></span> <span class="token keyword">else</span> <span class="token string-literal singleline"><span class="token string">"not visible"</span></span>
    <span class="token comment">// 5.执行dump heap</span>
    <span class="token function">dumpHeap</span><span class="token punctuation">(</span>
      retainedReferenceCount <span class="token operator">=</span> retainedReferenceCount<span class="token punctuation">,</span>
      retry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      reason <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">retainedReferenceCount</span></span><span class="token string"> retained objects, app is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">visibility</span></span><span class="token string">"</span></span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 首先Debug.dumpHprofData，然后调用HeapAnalyzerService对hprof文件做进一步分析
   * */</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">dumpHeap</span><span class="token punctuation">(</span>
    retainedReferenceCount<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    retry<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    reason<span class="token operator">:</span> String
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">saveResourceIdNamesToMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> heapDumpUptimeMillis <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    KeyedWeakReference<span class="token punctuation">.</span>heapDumpUptimeMillis <span class="token operator">=</span> heapDumpUptimeMillis
      <span class="token comment">// 1.heapDumper.dumpHeap()里面执行了Debug.dumpHprofData(heapDumpFile.absolutePath)来dump heap</span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">val</span> heapDumpResult <span class="token operator">=</span> heapDumper<span class="token punctuation">.</span><span class="token function">dumpHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">is</span> HeapDump <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        lastDisplayedRetainedObjectCount <span class="token operator">=</span> <span class="token number">0</span>
        lastHeapDumpUptimeMillis <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        objectWatcher<span class="token punctuation">.</span><span class="token function">clearObjectsWatchedBefore</span><span class="token punctuation">(</span>heapDumpUptimeMillis<span class="token punctuation">)</span>
          <span class="token comment">// 2.调用HeapAnalyzerService对hprof文件做进一步分析</span>
        HeapAnalyzerService<span class="token punctuation">.</span><span class="token function">runAnalysis</span><span class="token punctuation">(</span>
          context <span class="token operator">=</span> application<span class="token punctuation">,</span>
          heapDumpFile <span class="token operator">=</span> heapDumpResult<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
          heapDumpDurationMillis <span class="token operator">=</span> heapDumpResult<span class="token punctuation">.</span>durationMillis<span class="token punctuation">,</span>
          heapDumpReason <span class="token operator">=</span> reason
          <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="424_GcTrigger_687"></a>4.2.4 GcTrigger</h4> 
<p>  HeapDumpTrigger中触发垃圾回收是由GcTrigger实现的，源码单独分析如下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">interface</span> GcTrigger <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">fun</span> <span class="token function">runGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * GcTrigger的默认实现
   */</span>
  <span class="token keyword">object</span> Default <span class="token operator">:</span> GcTrigger <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">runGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 调用gc()并不保证一定会执行gc,所以这里gc后线程暂停了100ms，然后又再次触发了gc</span>
      Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">enqueueReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      System<span class="token punctuation">.</span><span class="token function">runFinalization</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">enqueueReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Hack. We don't have a programmatic way to wait for the reference queue daemon to move</span>
      <span class="token comment">// references to the appropriate queues.</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> InterruptedException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="425__716"></a>4.2.5 总结</h4> 
<p>  ObjectWatcher只能检测到当前有对象可能存在内存泄漏，在HeapDumpTrigger会在工作线程再次校验一次是否存在内存泄漏，检验方式是触发一次gc，然后检查是否有对象未被GC标记回收，如果是则表示发生了内存泄漏，接着进行dump heap，然后调用HeapAnalyzerService对hprof文件做进一步分析。<br><br>   每次HeapDumpTrigger进行dump heap有60s时间间隔限制，因为dump heap会暂时挂起当前进程中的所有java线程。</p> 
<h3><a id="43_hprof_719"></a>4.3 分析hprof文件</h3> 
<h4><a id="431_HeapAnalyzerService_720"></a>4.3.1 HeapAnalyzerService</h4> 
<p>  在HeapDumpTrigger把hprof文件输出后，会调用HeapAnalyzerService启动服务去分析hprof文件，得到最终的内存泄漏分析结果。源码如下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">class</span> HeapAnalyzerService <span class="token operator">:</span> <span class="token function">ForegroundService</span><span class="token punctuation">(</span>
  HeapAnalyzerService<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>simpleName<span class="token punctuation">,</span>
  R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>leak_canary_notification_analysing<span class="token punctuation">,</span>
  R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>leak_canary_notification_analyzing_heap
<span class="token punctuation">)</span><span class="token punctuation">,</span> OnAnalysisProgressListener <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">fun</span> <span class="token function">runAnalysis</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span>heapDumpFile<span class="token operator">:</span> File<span class="token punctuation">,</span>heapDumpDurationMillis<span class="token operator">:</span> heapDumpReason<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Unknown"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> HeapAnalyzerService<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
      <span class="token comment">// 将heapDumpFile封装到intent，传给HeapAnalyzerService分析</span>
      intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>HEAPDUMP_FILE_EXTRA<span class="token punctuation">,</span> heapDumpFile<span class="token punctuation">)</span>
      <span class="token function">startForegroundService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> intent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onHandleIntentInForeground</span><span class="token punctuation">(</span>intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span>
    <span class="token comment">// 1.获取hprof文件路径</span>
    <span class="token keyword">val</span> heapDumpFile <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getSerializableExtra</span><span class="token punctuation">(</span>HEAPDUMP_FILE_EXTRA<span class="token punctuation">)</span> <span class="token keyword">as</span> File
    <span class="token keyword">val</span> config <span class="token operator">=</span> LeakCanary<span class="token punctuation">.</span>config
    <span class="token keyword">val</span> heapAnalysis <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>heapDumpFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 2.分析hprof文件</span>
      <span class="token function">analyzeHeap</span><span class="token punctuation">(</span>heapDumpFile<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">missingFileFailure</span><span class="token punctuation">(</span>heapDumpFile<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> fullHeapAnalysis <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>heapAnalysis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 3.分析结果被封装成HeapAnalysisSuccess对象</span>
      <span class="token keyword">is</span> HeapAnalysisSuccess <span class="token operator">-&gt;</span> heapAnalysis<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
        dumpDurationMillis <span class="token operator">=</span> heapDumpDurationMillis<span class="token punctuation">,</span>
        metadata <span class="token operator">=</span> heapAnalysis<span class="token punctuation">.</span>metadata <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Heap dump reason"</span></span> <span class="token keyword">to</span> heapDumpReason<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">is</span> HeapAnalysisFailure <span class="token operator">-&gt;</span> heapAnalysis<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dumpDurationMillis <span class="token operator">=</span> heapDumpDurationMillis<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">onAnalysisProgress</span><span class="token punctuation">(</span>REPORTING_HEAP_ANALYSIS<span class="token punctuation">)</span>
    <span class="token comment">// 4.将分析结果回调给listern，更新UI将分析结果展示给开发者</span>
    config<span class="token punctuation">.</span>onHeapAnalyzedListener<span class="token punctuation">.</span><span class="token function">onHeapAnalyzed</span><span class="token punctuation">(</span>fullHeapAnalysis<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="432_HeapAnalysisSuccess_764"></a>4.3.2 HeapAnalysisSuccess</h4> 
<p>  对于<a href="https://github.com/square/leakcanary/blob/main/docs/shark.md">Shark</a>分析hprof文件的代码暂不深入研究，下面给出了分析结果的封装类HeapAnalysisSuccess：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">HeapAnalysisSuccess</span><span class="token punctuation">(</span>
  <span class="token keyword">override</span> <span class="token keyword">val</span> heapDumpFile<span class="token operator">:</span> File<span class="token punctuation">,</span>
  <span class="token keyword">override</span> <span class="token keyword">val</span> createdAtTimeMillis<span class="token operator">:</span> Long<span class="token punctuation">,</span>
  <span class="token keyword">override</span> <span class="token keyword">val</span> dumpDurationMillis<span class="token operator">:</span> Long <span class="token operator">=</span> DUMP_DURATION_UNKNOWN<span class="token punctuation">,</span>
  <span class="token keyword">override</span> <span class="token keyword">val</span> analysisDurationMillis<span class="token operator">:</span> Long<span class="token punctuation">,</span>
  <span class="token keyword">val</span> metadata<span class="token operator">:</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token comment">/**
   * 当前APP内泄漏的对象列表，开发者主要关注
   */</span>
  <span class="token keyword">val</span> applicationLeaks<span class="token operator">:</span> List<span class="token operator">&lt;</span>ApplicationLeak<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token comment">/**
   * 当前APP内第三方库内泄漏的对象列表，开发者不一定可以修复
   */</span>
  <span class="token keyword">val</span> libraryLeaks<span class="token operator">:</span> List<span class="token operator">&lt;</span>LibraryLeak<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token keyword">val</span> unreachableObjects<span class="token operator">:</span> List<span class="token operator">&lt;</span>LeakTraceObject<span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">HeapAnalysis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * 所有泄漏的对象
   */</span>
  <span class="token keyword">val</span> allLeaks<span class="token operator">:</span> Sequence<span class="token operator">&lt;</span>Leak<span class="token operator">&gt;</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> applicationLeaks<span class="token punctuation">.</span><span class="token function">asSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> libraryLeaks<span class="token punctuation">.</span><span class="token function">asSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_791"></a>五、其他</h2> 
<h3><a id="51_ContentProvider_792"></a>5.1 ContentProvider创建时机分析</h3> 
<p>  在4.1中介绍过，ContentProvider是在Application创建后就创建的，且ContentProvider的onCreate时机在Application的onCreate时机之前。<br><br>   下面从Android-30源码分析，在AMS启动Application后，会执行到ActivityThread.H类中，源码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1.启动Application</span>
                <span class="token keyword">case</span> BIND_APPLICATION<span class="token operator">:</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">"bindApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AppBindData</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token comment">// 下面分析</span>
                    <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment">// 退出Application</span>
                <span class="token keyword">case</span> EXIT_APPLICATION<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mInitialApplication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        mInitialApplication<span class="token punctuation">.</span><span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment">// ...省略</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.设置进程的一些信息</span>
        <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">registerSensitiveThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setStartTimes</span><span class="token punctuation">(</span><span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span></span>DdmHandleAppName</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
            data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
            <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">setProcessPackageName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">setProcessDataDirectory</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>dataDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.创建AppContext和Instrumentation</span>
        <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">LoadedApk</span> pi <span class="token operator">=</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>instrApp<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">,</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instrumentation</span><span class="token punctuation">)</span>cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ComponentName</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>ii<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> ii<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> instrContext<span class="token punctuation">,</span> appContext<span class="token punctuation">,</span> component<span class="token punctuation">,</span>
            data<span class="token punctuation">.</span>instrumentationWatcher<span class="token punctuation">,</span> data<span class="token punctuation">.</span>instrumentationUiAutomationConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.创建Application</span>
        <span class="token class-name">Application</span> app<span class="token punctuation">;</span>
        app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInitialApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>
        
        <span class="token comment">// 4.创建ContentProvider</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 下面分析</span>
                <span class="token function">installContentProviders</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> data<span class="token punctuation">.</span>providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 5.执行Application的onCreate()方法</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installContentProviders</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProviderInfo</span><span class="token punctuation">&gt;</span></span> providers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ContentProviderHolder</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProviderInfo</span> cpi <span class="token operator">:</span> providers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 实例化ContentProviders，下面分析</span>
            <span class="token class-name">ContentProviderHolder</span> cph <span class="token operator">=</span> <span class="token function">installProvider</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> cpi<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cph <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cph<span class="token punctuation">.</span>noReleaseNeeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cph<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishContentProviders</span><span class="token punctuation">(</span>
            <span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ContentProviderHolder</span> <span class="token function">installProvider</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span>
        <span class="token class-name">ContentProviderHolder</span> holder<span class="token punctuation">,</span> <span class="token class-name">ProviderInfo</span> info<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> noisy<span class="token punctuation">,</span> <span class="token keyword">boolean</span> noReleaseNeeded<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ContentProvider</span> localProvider <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lLoadedApk packageInfo <span class="token operator">=</span> <span class="token function">peekPackageInfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            packageInfo <span class="token operator">=</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1.实例化ContentProvider</span>
        localProvider <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiateProvider</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.调用ContentProvider对象的attachInfo，里面会调用ContentProvider的onCreate()方法</span>
        localProvider<span class="token punctuation">.</span><span class="token function">attachInfo</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="THE_END_888"></a>THE END</h2> 
<p>欢迎关注我，一起解锁更多技能：<a href="https://juejin.cn/user/3307764180850952" rel="nofollow">BC的掘金主页</a>～💐 <a href="https://blog.csdn.net/weixin_55626853?type=blog">BC的CSDN主页</a>～💐💐<br> <img src="https://images2.imgbox.com/c6/3e/RblgkhwN_o.png" alt="请添加图片描述"></p> 
<blockquote> 
 <p>leakcanary官方文档：https://square.github.io/leakcanary/<br> hprof简介：http://hg.openjdk.java.net/jdk6/jdk6/jdk/raw-file/tip/src/share/demo/jvmti/hprof/manual.html</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f32ee725704e69bfecbefbd51cc166c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">osg-3D世界到屏幕</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f0c80fd337b2cf9d111f425de1c955d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux 下如何配置JDK呢？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>