<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s部署微服务 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s部署微服务" />
<meta property="og:description" content="一、安装nfs服务 由于资源有限，以master节点所在虚拟机作为nfs服务器
1、确认是否安装nfs
rpm -qa nfs-utils rpcbind
如果未安装，则安装
nfs服务器上安装2个模块：yum install -y nfs-utils rpcbind
nfs客户端机器（这里是所有node节点）安装yum install -y nfs-utils
2、nfs服务器创建共享文件夹/data/nfs和mysql各数据库文件的挂载目录，当然你可以自己选择位置
nfs:为nfs共享文件的目录
auth_center_mysql为认证中心mysql数据文件目录
user_center_mysql为用户中心mysql数据文件目录
log_center_mysql为日志中心mysql数据文件目录
nacos_mysql为nacos的mysql数据文件目录
3、配置vim /etc/exports文件，在此文件中写入如下内容（不支持共享子目录no_hide）
/data/nfs *(insecure,rw,async,no_root_squash)
/data/auth_center_mysql *(insecure,rw,async,no_root_squash)
/data/user_center_mysql *(insecure,rw,async,no_root_squash)
/data/log_center_mysql *(insecure,rw,async,no_root_squash)
/data/nacos_mysql *(insecure,rw,async,no_root_squash)
具体含义如下：
配置完成后需要使其马上生效：exportfs –r
4、启动 RPC 服务
service rpcbind start
5、查看 NFS 服务项 rpc 服务器注册的端口列表
rpcinfo -p localhost
6、启动 NFS 服务
service nfs start（重启service nfs restart）
7、查看是否加载了/etc/exports中的配置
showmount -e localhost
8、k8s中部署nfs
1）下载nacos
在master节点上root目录下执行
git clone https://github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/406a353560218b2ae0e827c6aa597d02/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-24T20:04:36+08:00" />
<meta property="article:modified_time" content="2021-08-24T20:04:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s部署微服务</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="margin-left:0px;text-align:justify;">一、安装nfs服务</h2> 
<p style="margin-left:.0001pt;text-align:justify;">由于资源有限，以master节点所在虚拟机作为nfs服务器</p> 
<p style="margin-left:.0001pt;text-align:justify;">1、确认是否安装nfs</p> 
<p style="margin-left:.0001pt;text-align:justify;">rpm -qa nfs-utils rpcbind</p> 
<p style="margin-left:.0001pt;text-align:justify;">如果未安装，则安装</p> 
<p style="margin-left:.0001pt;text-align:justify;">nfs服务器上安装2个模块：yum install -y nfs-utils rpcbind</p> 
<p style="margin-left:.0001pt;text-align:justify;">nfs客户端机器（这里是所有node节点）安装yum install -y nfs-utils</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;">2、nfs服务器创建共享文件夹/data/nfs和mysql各数据库文件的挂载目录，当然你可以自己选择位置</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">nfs:为nfs共享文件的目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">auth_center_mysql为认证中心mysql数据文件目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">user_center_mysql为用户中心mysql数据文件目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">log_center_mysql为日志中心mysql数据文件目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">nacos_mysql为nacos的mysql数据文件目录</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;">3、配置vim /etc/exports文件，在此文件中写入如下内容（不支持共享子目录no_hide）</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">/data/nfs *(insecure,rw,async,no_root_squash)</p> 
<p style="margin-left:.0001pt;text-align:justify;">/data/auth_center_mysql *(insecure,rw,async,no_root_squash)</p> 
<p style="margin-left:.0001pt;text-align:justify;">/data/user_center_mysql *(insecure,rw,async,no_root_squash)</p> 
<p style="margin-left:.0001pt;text-align:justify;">/data/log_center_mysql *(insecure,rw,async,no_root_squash)</p> 
<p style="margin-left:.0001pt;text-align:justify;">/data/nacos_mysql *(insecure,rw,async,no_root_squash)</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">具体含义如下：</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="278" src="https://images2.imgbox.com/8e/e7/GQCNH3zm_o.png" width="558"></p> 
<p> 配置完成后需要使其马上生效：<span style="background-color:#fafafa;"><span style="color:#000000;">exportfs –r</span></span></p> 
<p> <span style="background-color:#ffffff;"><span style="background-color:#fafafa;"><span style="color:#000000;">4</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">、</span></span>启动 RPC 服务</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">service rpcbind start</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#fafafa;"><span style="color:#000000;">5</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">、</span></span>查看 NFS 服务项 rpc 服务器注册的端口列表</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">rpcinfo -p localhost</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#fafafa;"><span style="color:#000000;">6</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">、</span></span>启动 NFS 服务</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">service nfs start</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">（重启</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">service nfs restart</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">）</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">7</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">、查看是否加载了</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">/etc/exports</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">中的配置</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">showmount -e localhost</p> 
<p style="margin-left:.0001pt;text-align:justify;">8、k8s中部署nfs</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）下载nacos</p> 
<p style="margin-left:.0001pt;text-align:justify;">在master节点上root目录下执行</p> 
<p style="margin-left:.0001pt;text-align:justify;">git clone <a href="https://github.com/nacos-group/nacos-k8s.git">https://github.com/nacos-group/nacos-k8s.git</a></p> 
<p style="margin-left:.0001pt;text-align:justify;">2）下载完成后进入nacos-k8s</p> 
<p style="margin-left:.0001pt;text-align:justify;">3）创建角色（注意名称空间，下面2种根据自己需要选择）</p> 
<ul><li style="text-align:justify;">创建到默认名称空间default中</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl create -f deploy/nfs/rbac.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">如果</span><span style="color:#ff0000;">K8S</span><span style="color:#ff0000;">命名空间不是</span><span style="color:#ff0000;">default,</span><span style="color:#ff0000;">请在部署</span><span style="color:#ff0000;">RBAC</span><span style="color:#ff0000;">之前执行以下脚本（就不要执行上面的脚本了）</span><span style="color:#ff0000;">:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">NS=$(kubectl config get-contexts|grep -e "^\*" |awk '{print $5}')</p> 
<p style="margin-left:.0001pt;text-align:justify;">NAMESPACE=${NS:-default}</p> 
<p style="margin-left:.0001pt;text-align:justify;">sed -i'' "s/namespace:.*/namespace: $NAMESPACE/g" ./deploy/nfs/rbac.yaml</p> 
<ul><li style="text-align:justify;">创建到指定名称空间中，我这里是msp</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">修改rbac.yaml中出现namespace:default的所有地方为namespace:msp</p> 
<p>yaml文件内容</p> 
<pre><code>kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
- apiGroups: [""]
  resources: ["persistentvolumes"]
  verbs: ["get", "list", "watch", "create", "delete"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "update"]
- apiGroups: [""]
  resources: ["endpoints"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "update", "patch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
- kind: ServiceAccount
  name: nfs-client-provisioner
  namespace: msp
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
rules:
- apiGroups: [""]
  resources: ["endpoints"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
subjects:
- kind: ServiceAccount
  name: nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: msp
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io</code></pre> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;">4）创建 ServiceAccount 和部署 NFS-Client Provisioner</span></p> 
<p>修改yaml文件中nfs的server地址及共享目录,指定名称空间为msp，可指定nfs-client-provisioner镜像，这里使用默认的镜像，nfs服务器地址为<span style="color:#ff0000;">192.168.126.128，共享目录为/data/nfs</span></p> 
<p>./deploy/nfs/deployment.yaml内容：</p> 
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  namespace: msp
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: nfs-client-provisioner
  namespace: msp
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccount: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: quay.io/external_storage/nfs-client-provisioner:latest
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: fuseim.pri/ifs
            - name: NFS_SERVER
              value: 192.168.126.128
            - name: NFS_PATH
              value: /data/nfs
      volumes:
        - name: nfs-client-root
          nfs:
            server: 192.168.126.128
            path: /data/nfs</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">执行yaml文件：</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl create -f deploy/nfs/deployment.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">5）创建<span style="background-color:#ffffff;">NFS StorageClass</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">kubectl create -f deploy/nfs/class.yaml</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">yaml</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">文件内容指定名称空间</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">apiVersion: storage.k8s.io/v1</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">kind: StorageClass</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">metadata:</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">  name: managed-nfs-storage</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="background-color:#fafafa;"><span style="color:#ff0000;">namespace: msp</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">provisioner: fuseim.pri/ifs</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">parameters:</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">  archiveOnDelete: "false"</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#fafafa;"><span style="color:#000000;">6</span></span><span style="background-color:#fafafa;"><span style="color:#000000;">）</span></span>验证NFS部署成功</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#fafafa;"><span style="color:#000000;">kubectl get pod -l app</span></span><span style="color:#a67f59;">=</span><span style="background-color:#fafafa;"><span style="color:#000000;">nfs-client-provisioner -n msp</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="46" src="https://images2.imgbox.com/d6/fa/LKW0KWzh_o.png" width="615"></p> 
<p style="margin-left:.0001pt;text-align:justify;">7）如果安装错误可以根据部署的yaml执行删除再创建</p> 
<p style="margin-left:.0001pt;text-align:justify;">进入nacos-k8s目录执行</p> 
<p style="margin-left:.0001pt;text-align:justify;">#角色信息</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl delete -f deploy/nfs/rbac.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl create -f deploy/nfs/rbac.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">#存储类信息</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl delete -f deploy/nfs/class.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl create -f deploy/nfs/class.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">#账号和nfs客户端信息</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl delete -f deploy/nfs/deployment.yaml</p> 
<p>kubectl create -f deploy/nfs/deployment.yaml</p> 
<h2> 二、部署单机mysql</h2> 
<p style="margin-left:.0001pt;text-align:justify;">使用kuboard部署三个数据库db-auth-center、db-user-center、db-log-center、db-nacos数据库</p> 
<p style="margin-left:.0001pt;text-align:justify;">1、制作mysql（mysql 版本 5.7）镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）将对应的sql文件传到master节点上</p> 
<p style="margin-left:.0001pt;text-align:justify;">创建sql目录，将对应的初始化数据库执行的sql脚本文件上传到sql目录</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="52" src="https://images2.imgbox.com/55/26/7EFuQEgl_o.png" width="503">  </p> 
<p style="margin-left:.0001pt;text-align:justify;">2）在当前目录下创建对应的mysql配置文件，用来解决mysql使用时的乱码问题</p> 
<p>vim user-center-my.cnf，配置如下 </p> 
<pre><code>[mysqld]

init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
</code></pre> 
<p> 3）创建docker文件</p> 
<p style="margin-left:.0001pt;text-align:justify;">vim dockerfile_user-center，配置文件内容如下：</p> 
<pre><code>FROM mysql:5.7.26
ADD user-center-my.cnf /etc/mysql/conf.d/my.cnf
ADD 01.user-center.sql /docker-entrypoint-initdb.d/01.user-center.sql
EXPOSE 3306</code></pre> 
<p> 4）创建镜像（注意镜像是要存放在私有的harbor镜像仓库的msp，且最后以空格+英文点号结尾）</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#f7f7f7;"><span style="color:#525252;">docker build -f dockerfile_user-center -t 192.168.126.131:80/msp/user-center-mysql:V1</span></span><span style="background-color:#f7f7f7;"><span style="color:#ff0000;"> .</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">稍等片刻下载依赖的mysql镜像比较慢.</p> 
<p style="margin-left:.0001pt;text-align:justify;">推送镜像到仓库</p> 
<p style="margin-left:.0001pt;text-align:justify;">docker push 192.168.126.131:80/msp/user-center-mysql:V1</p> 
<p style="margin-left:.0001pt;text-align:justify;">5）依次按照第2）、3）、4）步分别完成auth-center-mysql、log-center-mysql镜像制作</p> 
<p style="margin-left:.0001pt;text-align:justify;">登录harbor查看镜像仓库中的镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="314" src="https://images2.imgbox.com/b6/c9/HjSTpBEo_o.png" width="1062"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2、使用kuboard部署mysql数据库</p> 
<p style="margin-left:.0001pt;text-align:justify;">注意集群中各个service的端口不能冲突。</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）登录kuboard，进入集群及名称空间</p> 
<p style="margin-left:.0001pt;text-align:justify;">2）从常用操作中选择创建工作负载，以下以创建auth-center为例</p> 
<table border="1" cellspacing="0" style="margin-left:6.65pt;width:631px;"><tbody><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">字段名称</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">填写内容</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">说明</span></strong></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载类型</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">StatefulSet</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载分层</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">持久层</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载名称</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">auth-center-mysql</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务描述</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">认证中心数据库</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">副本数量</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">1</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">请填写</span><span style="color:#525252;">1</span><span style="color:#525252;">，如果是</span><span style="color:#525252;">2</span><span style="color:#525252;">，他们挂载到的</span><span style="color:#525252;">nfs</span><span style="color:#525252;">是同一路径会导致错误</span><span style="background-color:#ffffff;"><span style="color:#333333;">[ERROR] InnoDB: Unable to lock ./ibdata1 error: 11</span></span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器名称</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">auth-center-mysql</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">镜像</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">msp/auth-center-mysql:V1</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">创建镜像仓库密码后并选择，再输入镜像路径和标签</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">抓取策略</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">IfNotPresent</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">环境变量</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_ROOT_PASSWORD=root</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器端口</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Tcp/3306</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">containerPort</span><span style="color:#525252;">，</span><span style="color:#525252;">Pod</span><span style="color:#525252;">内部</span><span style="color:#525252;">mysql</span><span style="color:#525252;">容器的端口，不一定与</span><span style="color:#525252;">dockerfile</span><span style="color:#525252;">文件中</span><span style="color:#525252;">EXPOSE</span><span style="color:#525252;">命令声明的端口一致，但与</span><span style="color:#525252;">springboot</span><span style="color:#525252;">应用指定的端口一致</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span><span style="color:#525252;">名称</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">db-auth-center</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">默认与工作负载名称一致无法修改，可以单独创建服务来指定服务名称</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span></p> </td><td style="background-color:#ffffff;width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">ClusterIP</span><span style="color:#525252;">（集群内访问）</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">service</span><span style="color:#525252;">服务端口</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">port:</span><span style="color:#ff0000;">3306</span></p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">targetPort:3306</span></p> </td><td style="width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">port</span><span style="color:#525252;">，</span><span style="color:#525252;">service</span><span style="color:#525252;">提供给集群内部的访问端口，</span><span style="color:#525252;">targetPort</span><span style="color:#525252;">是</span><span style="color:#525252;">service</span><span style="color:#525252;">所映射的容器组</span><span style="color:#525252;">pod</span><span style="color:#525252;">暴露的端口</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载名称</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">auth-center-mysql-nfs</span></p> </td><td style="width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">注意不能使用下划线，只能使用数字字母和短横线</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载类型</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS SERVER</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">192.168.126.128</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS PATH</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/data/auth_center_mysql</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">权限</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">读写</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器内的路径（挂载点）</span></p> </td><td style="width:354px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/var/lib/mysql</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">挂载数据卷中的子路径</span></p> </td><td style="width:354px;"></td><td style="width:175px;"></td></tr></tbody></table> 
<p> 基本信息配置如下图：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="697" src="https://images2.imgbox.com/cd/7f/vFsDtK6u_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">容器(工作容器)信息配置如下图：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="599" src="https://images2.imgbox.com/0e/4d/INjCevzA_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">存储挂载信息如下图</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="646" src="https://images2.imgbox.com/d3/f4/mxFBYOwe_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">高级信息</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="563" src="https://images2.imgbox.com/ae/d1/9gRK8kuT_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">服务/应用路由，名称默认和工作负载名称一样，单独创建服务service可能指定服务名称，选择器选择指定标签的容器</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="420" src="https://images2.imgbox.com/4d/20/HZ4bpqGO_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">保存，点击应用成功。</p> 
<p style="margin-left:.0001pt;text-align:justify;">3）验证数据库是否创建成功</p> 
<p>点击容器下方的Bash，进入终端界面，执行如下命令</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#525252;">mysql </span><span style="color:#9a6e3a;">-</span><span style="color:#525252;">uroot </span><span style="color:#9a6e3a;">-</span><span style="color:#525252;">proot</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#9a6e3a;">&gt;</span><span style="color:#525252;"> show databases</span><span style="color:#999999;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#9a6e3a;">&gt;</span><span style="color:#525252;"> use oauth</span><span style="color:#9a6e3a;">-</span><span style="color:#525252;">center</span><span style="color:#999999;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#9a6e3a;">&gt;</span><span style="color:#525252;"> show tables</span><span style="color:#999999;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#f7f7f7;">不知道为什么只有这个容器bash进去后<span style="color:#525252;">mysql </span><span style="color:#9a6e3a;">-</span><span style="color:#525252;">uroot </span><span style="color:#9a6e3a;">–</span><span style="color:#525252;">proot</span>登录会提示不安全，不使用密码就可以登录</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#f7f7f7;"><span style="color:#525252;">mysql: [Warning] Using a password on the command line interface can be insecure.</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#525252;">ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="797" src="https://images2.imgbox.com/6c/86/94sew02P_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="740" src="https://images2.imgbox.com/d8/91/eWw6td8M_o.png" width="1200"></p> 
<p>4）按照上面的步骤创建用户中心和日志中心的工作负载</p> 
<table border="1" cellspacing="0" style="margin-left:6.65pt;width:642px;"><tbody><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">字段名称</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">填写内容</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:249px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">说明</span></strong></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载类型</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">StatefulSet</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载分层</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">持久层</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载名称</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">user-center-mysql</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务描述</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">用户中心数据库</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">副本数量</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">1</span></p> </td><td style="background-color:#ffffff;width:249px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">请填写</span><span style="color:#525252;">1</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器名称</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">user-center-mysql</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">镜像</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">msp/user-center-mysql:V1</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">抓取策略</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">IfNotPresent</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">环境变量</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_ROOT_PASSWORD=root</span></p> </td><td style="background-color:#ffffff;width:249px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器端口</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">tcp/3306</span></p> </td><td style="background-color:#ffffff;width:249px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">containerPort</span><span style="color:#525252;">，</span><span style="color:#525252;">Pod</span><span style="color:#525252;">内部</span><span style="color:#525252;">mysql</span><span style="color:#525252;">容器的端口，不一定与</span><span style="color:#525252;">dockerfile</span><span style="color:#525252;">文件中</span><span style="color:#525252;">EXPOSE</span><span style="color:#525252;">命令声明的端口一致，但与</span><span style="color:#525252;">springboot</span><span style="color:#525252;">应用指定的端口一致</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span><span style="color:#525252;">名称</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">db-user-center</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span></p> </td><td style="background-color:#ffffff;width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">ClusterIP</span><span style="color:#525252;">（集群内访问）</span></p> </td><td style="background-color:#ffffff;width:249px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">service</span><span style="color:#525252;">服务端口</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">port:3106</span></p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">targetPort:3306</span></p> </td><td style="width:249px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">port</span><span style="color:#525252;">，</span><span style="color:#525252;">service</span><span style="color:#525252;">提供给集群内部的访问端口，</span><span style="color:#525252;">targetPort</span><span style="color:#525252;">是</span><span style="color:#525252;">service</span><span style="color:#525252;">所映射的容器组</span><span style="color:#525252;">pod</span><span style="color:#525252;">暴露的端口</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载名称</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">user-center-mysql-nfs</span></p> </td><td style="width:249px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">注意不能使用下划线，只能使用数字字母和短横线</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载类型</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS</span></p> </td><td style="width:249px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS SERVER</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">192.168.126.128</span></p> </td><td style="width:249px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS PATH</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/data/user_center_mysql</span></p> </td><td style="width:249px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">权限</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">读写</span></p> </td><td style="width:249px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器内的路径（挂载点）</span></p> </td><td style="width:283px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/var/lib/mysql</span></p> </td><td style="width:249px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">挂载数据卷中的子路径</span></p> </td><td style="width:283px;"></td><td style="width:249px;"></td></tr></tbody></table> 
<p> 日志中心</p> 
<table border="1" cellspacing="0" style="margin-left:6.65pt;width:636px;"><tbody><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">字段名称</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">填写内容</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:240px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">说明</span></strong></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载类型</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">StatefulSet</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载分层</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">持久层</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">工作负载名称</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">log-center-mysql</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务描述</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">日志中心数据库</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">副本数量</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">1</span></p> </td><td style="background-color:#ffffff;width:240px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">请填写</span><span style="color:#525252;">1</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器名称</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">log-center-mysql</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">镜像</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">msp/log-center-mysql:V1</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">抓取策略</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">IfNotPresent</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">环境变量</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_ROOT_PASSWORD=root</span></p> </td><td style="background-color:#ffffff;width:240px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器端口</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Tcp/3306</span></p> </td><td style="background-color:#ffffff;width:240px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">containerPort</span><span style="color:#525252;">，</span><span style="color:#525252;">Pod</span><span style="color:#525252;">内部</span><span style="color:#525252;">mysql</span><span style="color:#525252;">容器的端口，不一定与</span><span style="color:#525252;">dockerfile</span><span style="color:#525252;">文件中</span><span style="color:#525252;">EXPOSE</span><span style="color:#525252;">命令声明的端口一致，但与</span><span style="color:#525252;">springboot</span><span style="color:#525252;">应用指定的端口一致</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span><span style="color:#525252;">名称</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">db-log-center</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span></p> </td><td style="background-color:#ffffff;width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">ClusterIP</span><span style="color:#525252;">（集群内访问）</span></p> </td><td style="background-color:#ffffff;width:240px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">service</span><span style="color:#525252;">服务端口</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">port:3206</span></p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">targetPort:3306</span></p> </td><td style="width:240px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">port</span><span style="color:#525252;">，</span><span style="color:#525252;">service</span><span style="color:#525252;">提供给集群内部的访问端口，</span><span style="color:#525252;">targetPort</span><span style="color:#525252;">是</span><span style="color:#525252;">service</span><span style="color:#525252;">所映射的容器组</span><span style="color:#525252;">pod</span><span style="color:#525252;">暴露的端口</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载名称</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">log-center-mysql-nfs</span></p> </td><td style="width:240px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">注意不能使用下划线，只能使用数字字母和短横线</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载类型</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS</span></p> </td><td style="width:240px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS SERVER</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">192.168.126.128</span></p> </td><td style="width:240px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS PATH</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/data/log_center_mysql</span></p> </td><td style="width:240px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">权限</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">读写</span></p> </td><td style="width:240px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器内的路径（挂载点）</span></p> </td><td style="width:286px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/var/lib/mysql</span></p> </td><td style="width:240px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">挂载数据卷中的子路径</span></p> </td><td style="width:286px;"></td><td style="width:240px;"></td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:justify;">5)nacos数据库工作负载创建</p> 
<ul><li style="text-align:justify;">创建脚本文件</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">下载官方的mysql脚本文件内容创建vim nacos-mysql.sql</p> 
<p style="margin-left:.0001pt;text-align:justify;"> <a href="https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql"><span style="background-color:#ffffff;">https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql</span></a></p> 
<p>创建配置文件vim nacos-mysql-my.cnf，内容如下</p> 
<pre><code>[mysqld]

init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
</code></pre> 
<ul><li style="text-align:justify;">创建dockerfile构建文件，vim dockerfile_nacos_mysql</li></ul> 
<pre><code>FROM mysql:5.7.26
ADD nacos-mysql-my.cnf /etc/mysql/conf.d/my.cnf
ADD nacos-mysql.sql /docker-entrypoint-initdb.d/nacos-mysql.sql
EXPOSE 3306
</code></pre> 
<ul><li style="text-align:justify;">创建镜像</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#f7f7f7;"><span style="color:#525252;">docker build -f dockerfile_nacos_mysql -t 192.168.126.131:80/msp/nacos_mysql:5.7.26</span></span><span style="background-color:#f7f7f7;"><span style="color:#ff0000;"> .</span></span></p> 
<ul><li style="text-align:justify;">推送镜像</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">docker push 192.168.126.131:80/msp/nacos_mysql:5.7.26</p> 
<ul><li style="text-align:justify;">kuboard上创建nacos-mysql的工作负载</li></ul> 
<p></p> 
<table border="1" cellspacing="0" style="margin-left:6.65pt;width:619px;"><tbody><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">字段名称</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">填写内容</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">说明</span></strong></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务类型</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">StatefulSet</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务分层</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">持久层</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务名称</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">nacos-mysql</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务描述</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">nacos</span><span style="color:#525252;">的数据库</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">副本数量</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">1</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">请填写</span><span style="color:#525252;">1</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器名称</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">nacos-mysql</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">镜像</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">msp/nacos_mysql:5.7.26</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">抓取策略</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">IfNotPresent</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">环境变量</span><span style="color:#525252;">root</span><span style="color:#525252;">用户的密码</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_ROOT_PASSWORD=root</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">启动时创建的数据库名称</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_DATABASE=nacos_config</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">启动时创建的用户</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_USER=nacos</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">启动时创建的用户密码</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">MYSQL_PASSWORD=nacos</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">参考</span><a href="https://hub.docker.com/_/mysql" rel="nofollow"><span style="color:#4183c4;">mysql</span><span style="color:#4183c4;">官方镜像</span></a></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器端口</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Tcp/3306</span></p> </td><td style="background-color:#ffffff;width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">containerPort</span><span style="color:#525252;">，</span><span style="color:#525252;">Pod</span><span style="color:#525252;">内部</span><span style="color:#525252;">mysql</span><span style="color:#525252;">容器的端口，相当于</span><span style="color:#525252;">dockerfile</span><span style="color:#525252;">文件中</span><span style="color:#525252;">EXPOSE</span><span style="color:#525252;">指定的端口</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span></p> </td><td style="background-color:#ffffff;width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">ClusterIP</span><span style="color:#525252;">（集群内访问）</span></p> </td><td style="background-color:#ffffff;width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">service</span><span style="color:#525252;">服务端口</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">port:3406</span></p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">targetPort:3306</span></p> </td><td style="width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">port</span><span style="color:#525252;">，</span><span style="color:#525252;">service</span><span style="color:#525252;">提供给集群内部的访问端口，</span><span style="color:#525252;">targetPort</span><span style="color:#525252;">是</span><span style="color:#525252;">service</span><span style="color:#525252;">所映射的容器组</span><span style="color:#525252;">pod</span><span style="color:#525252;">的端口</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载名称</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">nacos-mysql-nfs</span></p> </td><td style="width:175px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">注意不能使用下划线，只能使用数字字母和短横线</span></p> </td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">存储挂载类型</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS SERVER</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">192.168.126.128</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">NFS PATH</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/data/nacos_mysql</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">权限</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">读写</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器内的路径（挂载点）</span></p> </td><td style="width:335px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">/var/lib/mysql</span></p> </td><td style="width:175px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">挂载数据卷中的子路径</span></p> </td><td style="width:335px;"></td><td style="width:175px;"></td></tr></tbody></table> 
<h2>三、部署redis </h2> 
<p>创建工作负载redis</p> 
<table border="1" cellspacing="0" style="margin-left:6.65pt;width:621px;"><tbody><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">字段名称</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">填写内容</span></strong></p> </td><td style="background-color:#ffffff;border-color:#000000;width:178px;"> <p style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#525252;">说明</span></strong></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务类型</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">StatefulSet</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务分层</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">中间层</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务名称</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">redis</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">服务描述</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">redis</span><span style="color:#525252;">缓存</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">副本数量</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">1</span></p> </td><td style="background-color:#ffffff;width:178px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">请填写</span><span style="color:#525252;">1</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器名称</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">redis</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">镜像</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">redis:</span> <span style="color:#525252;">4.0.14</span></p> </td><td style="background-color:#ffffff;width:178px;"> <p style="margin-left:.0001pt;text-align:justify;"></p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">从</span><span style="color:#525252;">hub.docker.com </span><span style="color:#525252;">加载镜像</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">抓取策略</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">IfNotPresent</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">容器端口</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Tcp/6379</span></p> </td><td style="background-color:#ffffff;width:178px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">containerPort</span><span style="color:#525252;">，</span><span style="color:#525252;">Pod</span><span style="color:#525252;">内部</span><span style="color:#525252;">redis</span><span style="color:#525252;">容器的端口，相当于</span><span style="color:#525252;">dockerfile</span><span style="color:#525252;">文件中</span><span style="color:#525252;">EXPOSE</span><span style="color:#525252;">指定的端口</span></p> </td></tr><tr><td style="background-color:#ffffff;border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">Service</span></p> </td><td style="background-color:#ffffff;width:329px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">ClusterIP</span><span style="color:#525252;">（集群内访问）</span></p> </td><td style="background-color:#ffffff;width:178px;"></td></tr><tr><td style="border-color:#000000;width:3cm;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">service</span><span style="color:#525252;">服务端口</span></p> </td><td style="width:329px;"> <p style="margin-left:.0001pt;text-align:justify;">port: 6379</p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">targetPort:</span> 6379</p> </td><td style="width:178px;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#525252;">port</span><span style="color:#525252;">，</span><span style="color:#525252;">service</span><span style="color:#525252;">提供给集群内部的访问端口，</span><span style="color:#525252;">targetPort</span><span style="color:#525252;">是</span><span style="color:#525252;">service</span><span style="color:#525252;">所映射的容器组</span><span style="color:#525252;">pod</span><span style="color:#525252;">的端口</span></p> </td></tr></tbody></table> 
<h2> 四、部署nacos集群</h2> 
<p style="margin-left:.0001pt;text-align:justify;">1、制作私有的nacos-peer-finder-plugin镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）构建本地镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">根据官方的提供的nacos-k8s部署包，解压后进入/nacos-k8s/plugin目录，执行构建命令</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="background-color:#f7f7f7;"><span style="color:#525252;">docker build -f Dockerfile -t 192.168.126.131:80/msp/nacos-peer-finder-plugin:V1.0</span></span><span style="background-color:#f7f7f7;"><span style="color:#ff0000;"> .</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">2）推送镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">docker push 192.168.126.131:80/msp/nacos-peer-finder-plugin:V1.0</p> 
<p style="margin-left:.0001pt;text-align:justify;">2、制作nacos镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">参考https://www.pianshen.com/article/71541656180/</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）下载nacos的构建镜像源码</p> 
<ul><li style="text-align:justify;">下载镜像源码</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">git clone <a href="https://github.com/nacos-group/nacos-docker.git">https://github.com/nacos-group/nacos-docker.git</a></p> 
<ul><li style="text-align:justify;">查看使用的nacos-server默认版本</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">进入/nacos-docker/build目录，cat Dockerfile，可以看到是2.0.2</p> 
<p> <img alt="" height="287" src="https://images2.imgbox.com/1f/3e/oOhg8CKA_o.png" width="558"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2）制作nacos镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">进入/nacos-docker/build目录，执行</p> 
<p style="margin-left:.0001pt;text-align:justify;">docker build -f Dockerfile -t 192.168.126.131:80/msp/nacos-server:V2.0.2 .</p> 
<p style="margin-left:.0001pt;text-align:justify;">此过程要安装很多模块，可以下载nacos-server相应tar包到本地，减少构建时间，需要修改Dockerfile文件，如下图：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="751" src="https://images2.imgbox.com/1b/7d/2WzGv3tK_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3)推送镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">docker push 192.168.126.131:80/msp/nacos-server:V2.0.2</p> 
<p style="margin-left:.0001pt;text-align:justify;">3、部署Nacos</p> 
<p style="margin-left:.0001pt;text-align:justify;">kuboard部署，service类型使用headless方式，可以让每个容器组（pod）都向CoreDNS注册，外部通过CoreDNS可以得到每个pod的地址信息(域名信息)，而不会解析成service的ip(此方式再通过iptables或者ipvs进行请求路由)，这样外部可以使用自定义的路由规则进行负载均衡。通过部署nginx-ingress-controller可以针对多个节点进行负载均衡。</p> 
<p style="margin-left:.0001pt;text-align:justify;">使用nacos-k8s包下的nacos-pvc-nfs.yaml进行部署，注意里面没有指定数据库的host配置，即<span style="color:#ff0000;">MYSQL_SERVICE_HOST</span>，我没有配置这项，启动时报No DataSource set，注意端口也要使用前面配置的mysql服务service所暴露的端口。</p> 
<p style="margin-left:.0001pt;text-align:justify;">查看<span style="color:#ff0000;">MYSQL_SERVICE_HOST</span>使用的地方（构建nacos镜像的/nacos-docker/build/conf/application.properties）</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="540" src="https://images2.imgbox.com/77/18/bihhLf03_o.png" width="1200"></p> 
<p>名称空间也使用自定义的msp。下面是将nacos-pvc-nfs.yaml的内容拷贝到kuboard中进行部署的，最后生成的yaml如下（nacos副本数量是2，机器资源不足，没办法了），注意环境变量SERVICE_NAME的取值必须与服务Service的名称一样，不是指的工作负载的配置属性</p> 
<pre><code>serviceName：
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    k8s.kuboard.cn/displayName: nacos集群
  creationTimestamp: '2021-07-02T14:19:03Z'
  generation: 15
  labels:
    k8s.kuboard.cn/layer: cloud
    k8s.kuboard.cn/name: nacos
  name: nacos
  namespace: msp
  resourceVersion: '620141'
  selfLink: /apis/apps/v1/namespaces/msp/statefulsets/nacos
  uid: ec40757f-6689-4e88-97a1-b88b7d8fea35
spec:
  podManagementPolicy: OrderedReady
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nacos
  serviceName: nacos-headless
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/restartedAt: '2021-07-05T12:15:45+08:00'
        pod.alpha.kubernetes.io/initialized: 'true'
      labels:
        app: nacos
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - nacos
              topologyKey: kubernetes.io/hostname
      containers:
        - env:
            - name: NACOS_REPLICAS
              value: '2'
            - name: SERVICE_NAME
              value: nacos-headless
            - name: DOMAIN_NAME
              value: cluster.local
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: MYSQL_SERVICE_DB_NAME
              valueFrom:
                configMapKeyRef:
                  key: mysql.db.name
                  name: nacos-cm
            - name: MYSQL_SERVICE_PORT
              valueFrom:
                configMapKeyRef:
                  key: mysql.port
                  name: nacos-cm
            - name: MYSQL_SERVICE_USER
              valueFrom:
                configMapKeyRef:
                  key: mysql.user
                  name: nacos-cm
            - name: MYSQL_SERVICE_PASSWORD
              valueFrom:
                configMapKeyRef:
                  key: mysql.password
                  name: nacos-cm
            - name: NACOS_SERVER_PORT
              value: '8848'
            - name: NACOS_APPLICATION_PORT
              value: '8848'
            - name: PREFER_HOST_MODE
              value: hostname
            - name: MYSQL_SERVICE_HOST
              valueFrom:
                configMapKeyRef:
                  key: mysql.host
                  name: nacos-cm
          image: '192.168.126.131:80/msp/nacos-server:V2.0.2'
          imagePullPolicy: IfNotPresent
          name: nacos
          ports:
            - containerPort: 8848
              name: client-port
              protocol: TCP
            - containerPort: 9848
              name: client-rpc
              protocol: TCP
            - containerPort: 9849
              name: raft-rpc
              protocol: TCP
            - containerPort: 7848
              name: old-raft-rpc
              protocol: TCP
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /home/nacos/plugins/peer-finder
              name: data
              subPath: peer-finder
            - mountPath: /home/nacos/data
              name: data
              subPath: data
            - mountPath: /home/nacos/logs
              name: data
              subPath: logs
      dnsPolicy: ClusterFirst
      initContainers:
        - image: '192.168.126.131:80/msp/nacos-peer-finder-plugin:V1.0'
          imagePullPolicy: IfNotPresent
          name: peer-finder-plugin-install
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /home/nacos/plugins/peer-finder
              name: data
              subPath: peer-finder
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: nfs-client-provisioner
      serviceAccountName: nfs-client-provisioner
      terminationGracePeriodSeconds: 30
  updateStrategy:
    rollingUpdate:
      partition: 0
    type: RollingUpdate
  volumeClaimTemplates:
    - metadata:
        annotations:
          volume.beta.kubernetes.io/storage-class: managed-nfs-storage
        name: data
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: 20Gi
        volumeMode: Filesystem
      status:
        phase: Pending
status:
  collisionCount: 0
  currentReplicas: 2
  currentRevision: nacos-8d5c8996f
  observedGeneration: 15
  readyReplicas: 2
  replicas: 2
  updateRevision: nacos-8d5c8996f
  updatedReplicas: 2

---
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: '2021-07-02T15:06:32Z'
  labels:
    k8s.kuboard.cn/layer: cloud
    k8s.kuboard.cn/name: nacos-headless
  name: nacos-headless
  namespace: msp
  resourceVersion: '504739'
  selfLink: /api/v1/namespaces/msp/services/nacos-headless
  uid: 9dada13c-6565-494c-b0c4-7ea50182aeca
spec:
  clusterIP: None
  ports:
    - name: server
      port: 8848
      protocol: TCP
      targetPort: 8848
    - name: client-rpc
      port: 9848
      protocol: TCP
      targetPort: 9848
    - name: raft-rpc
      port: 9849
      protocol: TCP
      targetPort: 9849
    - name: old-raft-rpc
      port: 7848
      protocol: TCP
      targetPort: 7848
  selector:
    app: nacos
  sessionAffinity: None
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  creationTimestamp: '2021-07-03T05:50:23Z'
  generation: 5
  labels:
    k8s.kuboard.cn/layer: cloud
    k8s.kuboard.cn/name: nacos
  name: nacos
  namespace: msp
  resourceVersion: '598033'
  selfLink: /apis/networking.k8s.io/v1beta1/namespaces/msp/ingresses/nacos
  uid: 4c10562d-4da9-4420-9a63-714fd3004f51
spec:
  rules:
    - host: www.nacos1.com
      http:
        paths:
          - backend:
              serviceName: nacos-headless
              servicePort: 8848
            path: /nacos
</code></pre> 
<p>引用的数据字典配置，<span style="color:#ff0000;">nacos-mysql</span>是mysql的service名称</p> 
<pre><code>---
apiVersion: v1
data:
  mysql.db.name: nacos_config
  mysql.host: nacos-mysql
  mysql.password: nacos
  mysql.port: '3406'
  mysql.user: nacos
kind: ConfigMap
metadata:
  creationTimestamp: '2021-06-30T14:34:07Z'
  name: nacos-cm
  namespace: msp
  resourceVersion: '382833'
  selfLink: /api/v1/namespaces/msp/configmaps/nacos-cm
  uid: 9ce8685b-4529-47c9-b066-d7b1aef432ae
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">nacos启动报错，无数据源问题</p> 
<p style="margin-left:.0001pt;text-align:justify;">Invocation of init method failed; nested exception is ErrCode:500, ErrMsg:Nacos Server did not start because dumpservice bean construction failure :</p> 
<p style="margin-left:.0001pt;text-align:justify;">No DataSource set</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="182" src="https://images2.imgbox.com/a0/65/up6Ulg8m_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">1）通过kuboard以bash进入pod确保能ping通数据库的service ip或者服务名</p> 
<p style="margin-left:.0001pt;text-align:justify;">如果不能ping需要kube-proxy开启ipvs，参考进行查看设置</p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="https://www.cnblogs.com/deny/p/13880589.html?ivk_sa=1024320u" rel="nofollow">https://www.cnblogs.com/deny/p/13880589.html?ivk_sa=1024320u</a></p> 
<ul><li style="text-align:justify;">修改kube-proxy</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">再master上执行：kubectl edit cm kube-proxy -n kube-system   （如果是高可用，在第一个master上执行）</p> 
<p style="margin-left:.0001pt;text-align:justify;">mode “ipvs”   （找到kind: KubeProxyConfiguration这一项。。。他下面的第二行就是这个mode）</p> 
<ul><li style="text-align:justify;">2、添加ipvs模块（每个节点上执行）</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</p> 
<p style="margin-left:.0001pt;text-align:justify;">#!/bin/bash</p> 
<p style="margin-left:.0001pt;text-align:justify;">modprobe -- ip_vs</p> 
<p style="margin-left:.0001pt;text-align:justify;">modprobe -- ip_vs_rr</p> 
<p style="margin-left:.0001pt;text-align:justify;">modprobe -- ip_vs_wrr</p> 
<p style="margin-left:.0001pt;text-align:justify;">modprobe -- ip_vs_sh</p> 
<p style="margin-left:.0001pt;text-align:justify;">modprobe -- nf_conntrack_ipv4</p> 
<p style="margin-left:.0001pt;text-align:justify;">EOF</p> 
<ul><li style="text-align:justify;">3、添加权限并生效（每个节点上执行）</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</p> 
<ul><li style="text-align:justify;">4、重启kube-proxy（master上执行）</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl get pod -n kube-system | grep kube-proxy |awk '{system("kubectl delete pod "$1" -n kube-system")}'</p> 
<ul><li style="text-align:justify;">5、查看kube-proxy启动日志，确认是否为ipvs</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl logs -n kube-system kube-proxy-ff74q  （这个pod名称使用命令kubectl get pod -n kube-system查出来）</p> 
<ul><li style="text-align:justify;">6、验证是否可以pod访问service</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2）bash进入pod使用printenv查看环境变量MYSQL_SERVICE_HOST=nacos-mysql</p> 
<p style="margin-left:.0001pt;text-align:justify;">3）数据库的端口配置未使用正确，应该是数据库容器组服务上的port</p> 
<p style="margin-left:.0001pt;text-align:justify;">4）出现异常com.alibaba.nacos.api.exception.NacosException: java.net.UnknownHostException: jmenv.tbsite.net解决办法，参考：<a href="https://github.com/nacos-group/nacos-k8s/issues/144">https://github.com/nacos-group/nacos-k8s/issues/144</a></p> 
<p style="margin-left:.0001pt;text-align:justify;">原因是启动nacos的容器时无法创建/home/nacos/conf/cluster.conf文件，初始化容器无法生成cluster.conf文件，按照上面的解释是要修改注解k8s在1.13以后请使用publishNotReadyAddresses代替tolerate-unready-endpoints注解，publishNotReadyAddresses: true，但我这样设置没有效，脑袋一热将 nfs目录下的所有文件都清空了，这时报找不到对应容器的挂载生成的持久化文件了，后面在kuboard的存储页面找到对应的资源全部删除掉，再重新启动nacos的工作负载，再次进入对应的pod，查看启动日志，终于不报错了。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">4、给nacos集群添加ingress-nginx代理，供集群外部访问</p> 
<p style="margin-left:.0001pt;text-align:justify;">参考：<a href="https://www.cnblogs.com/caibao666/p/11600224.html" rel="nofollow">https://www.cnblogs.com/caibao666/p/11600224.html</a>，我这里采用NodePort方式。</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）部署nginx-ingress-controller</p> 
<ul><li style="text-align:justify;">下载mandatory.yaml文件（无法下载参考：https://www.cnblogs.com/xiluhua/p/14772367.html）：</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml" rel="nofollow">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</a></p> 
<ul><li style="text-align:justify;">修改mandatory.yaml中关于nginx-ingress-controller的配置</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">镜像可改为</p> 
<p style="margin-left:.0001pt;text-align:justify;">registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:0.25.1</p> 
<p style="margin-left:.0001pt;text-align:justify;">nginx-ingress-controller:0.25.1版本注意要与k8s的版本保持兼容，我的是v.1.15.1。</p> 
<p style="margin-left:.0001pt;text-align:justify;">可以给yaml文件中所有资源添加自定义的所属名称空间，默认是ingress-nginx</p> 
<p style="margin-left:.0001pt;text-align:justify;">，<span style="color:#ff0000;">注意：</span><span style="color:#ff0000;">deamonset</span><span style="color:#ff0000;">方式，还有</span><span style="color:#ff0000;">3</span><span style="color:#ff0000;">处修改：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">Kind</span><span style="color:#ff0000;">值修改成</span><span style="color:#ff0000;">DaemonSet</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">删除</span><span style="color:#ff0000;">replicas</span><span style="color:#ff0000;">配置</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">添加</span><span style="color:#ff0000;">hostNetwork: true</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="432" src="https://images2.imgbox.com/33/85/4eGzgb75_o.png" width="828"></p> 
<ul><li style="text-align:justify;">部署nginx-ingress-controller</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl apply -f mandatory.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<ul><li style="text-align:justify;">查看nginx-ingress-controller是否正常</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl get pod -n msp</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="45" src="https://images2.imgbox.com/6d/2a/zO72H2HJ_o.png" width="558"></p> 
<ul><li style="text-align:justify;">不正常查看pod日志</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl describe pod nginx-ingress-controller-5gpls -n ingress-nginx</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl logs nginx-ingress-controller-5gpls -n ingress-nginx</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="230" src="https://images2.imgbox.com/9a/45/Lvrct1Dq_o.png" width="1200"></p> 
<ul><li style="text-align:justify;">删除nginx-ingress-controller</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl delete from mandatory.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">执行时间长，稍等一段时间</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="175" src="https://images2.imgbox.com/83/bd/3UcpNS6I_o.png" width="775"></p> 
<ul><li style="text-align:justify;">修改mandatory.yaml中runAsUser的用户id</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">网上说修改为33，不知道在哪能找到这个33，通过id或者cat /etc/passwd都没找到。</p> 
<p style="margin-left:.0001pt;text-align:justify;">改为root用户的0还是无权限。</p> 
<ul><li style="text-align:justify;">重新部署nginx-ingress-controller</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl apply -f mandatory.yaml</p> 
<ul><li style="text-align:justify;">再次检查是否正常</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl get pod -n ingress-nginx</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="43" src="https://images2.imgbox.com/4e/4c/VfKQOBmL_o.png" width="536"></p> 
<ul><li style="text-align:justify;">修改service-nodeport.yaml</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">指定固定nodeport（80对应32080，443对应32443），默认是自动分配的，名称空间可以改成自定义的</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="351" src="https://images2.imgbox.com/94/56/vu539NbM_o.png" width="354"></p> 
<ul><li style="text-align:justify;">部署service-nodeport.yaml</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl apply -f service-nodeport.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">查看是否创建成功</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl get svc -n msp</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="134" src="https://images2.imgbox.com/a9/1a/WTrrD4VU_o.png" width="837"></p> 
<p style="margin-left:.0001pt;text-align:justify;">这种方式通过k8s的物理节点的端口（32080）进行访问，它与nginx-ingress-controller容器组的service绑定。nginx-ingress-controller内部启动了nginx服务，当前创建了Ingress后，会将其配置的路由规则应用到nginx-ingress-controller容器组内的nginx.conf中，如下图：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="408" src="https://images2.imgbox.com/7f/66/DORNoyI2_o.png" width="410"></p> 
<p style="margin-left:.0001pt;text-align:justify;">5、外部浏览器访问nacos的请求处理流程</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）修改本地windows的hosts文件，添加192.168.126.130 www.nacos1.com，www.nacos1.com这个是配置Ingress资源对象时指定的host，192.168.126.130是k8s的节点地址，当然windows系统所在机器能够访问节点192.168.126.130。这里必须配置www.nacos1.com是因为配置Ingress时，nginx-ingress-controller容器组pod内部的nginx服务的配置为相应添加与之对应的服务名，同时该配置文件中还有默认的服务名，它们监听相同的80和443端口，所以请求时要指定服务名即域名。默认的nginx服务配置(无法处理/nacos，导致报404)</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="439" src="https://images2.imgbox.com/c8/13/3uFM7zwj_o.png" width="911"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">如果使用ip访问会报如下404错误：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="245" src="https://images2.imgbox.com/93/1d/EbXdY95d_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">成功访问如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="536" src="https://images2.imgbox.com/fd/26/CRfNrPpq_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2）请求处理大概流程</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="743" src="https://images2.imgbox.com/ef/ff/nDzR93UO_o.png" width="992"></p> 
<h2 style="margin-left:0px;text-align:justify;">五、部署Sentinel</h2> 
<p style="margin-left:.0001pt;text-align:justify;">1、制作Sentinel镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">1)获取jar包</p> 
<p style="margin-left:.0001pt;text-align:justify;">wget https://github.com/alibaba/Sentinel/releases/download/1.8.1/sentinel-dashboard-1.8.1.jar</p> 
<p style="margin-left:.0001pt;text-align:justify;">2）创建Dockerfile文件</p> 
<p style="margin-left:.0001pt;text-align:justify;">内容如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;">#基础镜像，如果本地没有，会从远程仓库拉取</p> 
<p style="margin-left:.0001pt;text-align:justify;">FROM openjdk:8-jdk-alpine</p> 
<p style="margin-left:.0001pt;text-align:justify;">#镜像制作人</p> 
<p style="margin-left:.0001pt;text-align:justify;">MAINTAINER chenhj</p> 
<p style="margin-left:.0001pt;text-align:justify;">#在容器中创建挂载点，可以多个VOLUME["/tmp"]</p> 
<p style="margin-left:.0001pt;text-align:justify;">VOLUME /tmp</p> 
<p style="margin-left:.0001pt;text-align:justify;">#将主机下的jar拷贝到镜像中</p> 
<p style="margin-left:.0001pt;text-align:justify;">ADD sentinel-dashboard-1.8.1.jar sentinel-dashboard.jar</p> 
<p style="margin-left:.0001pt;text-align:justify;">#声明了容器应该打开的端口并没有实际上将它打开</p> 
<p style="margin-left:.0001pt;text-align:justify;">EXPOSE 8380</p> 
<p style="margin-left:.0001pt;text-align:justify;">#执行java命令，启动应用</p> 
<p style="margin-left:.0001pt;text-align:justify;">CMD java ${JAVA_OPTS} -jar sentinel-dashboard.jar</p> 
<p style="margin-left:.0001pt;text-align:justify;">3）构建镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">docker build -f Dockerfile -t 192.168.126.131:80/msp/sentinel:1.8.1 .</p> 
<p style="margin-left:.0001pt;text-align:justify;">4）推送镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">docker push 192.168.126.131:80/msp/sentinel:1.8.1</p> 
<p style="margin-left:.0001pt;text-align:justify;">2、编写sentinel.yaml</p> 
<p></p> 
<pre><code>---
apiVersion: v1
kind: Service
metadata:
  name: sentinel
  namespace: msp
  labels:
    app: sentinel
spec:
  publishNotReadyAddresses: true
  ports:
    - port: 8380
      name: server
      targetPort: 8380
  clusterIP: None
  selector:
    app: sentinel
---
# 外部访问服务
apiVersion: v1
kind: Service
metadata:
  name: sentinel-svc
  namespace: msp
  labels:
    app: sentinel
spec:
  publishNotReadyAddresses: true
  ports:
  - name: http
    protocol: "TCP"
    port: 8380
    targetPort: 8380
    nodePort: 31380
  type: NodePort
  selector:
app: sentinel
</code></pre> 
<p>3、编写sentinel-statefulset.yaml</p> 
<pre><code>---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sentinel
  namespace: msp
spec:
  serviceName: sentinel
  replicas: 1
  template:
    metadata:
      namespace: msp
      labels:
        app: sentinel
      annotations:
        pod.alpha.kubernetes.io/initialized: "true"
    spec:
      containers:
        - name: sentinel
          imagePullPolicy: IfNotPresent
          image: 192.168.126.131:80/msp/sentinel:1.8.1
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
          ports:
            - containerPort: 8380
              name: client
          env:
            - name: TZ
              value: Asia/Shanghai
            - name: JAVA_OPTS
              value: "-Dserver.port=8380 -Dcsp.sentinel.dashboard.server=localhost:8380 -Dproject.name=sentinel-dashboard -Djava.security.egd=file:/dev/./urandom -Dcsp.sentinel.api.port=8700"
  selector:
    matchLabels:
      app: sentinel
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">4、部署</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl apply -f sentinel.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl apply -f sentinel-statefulset.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">查看pod发现拉取镜像失败</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl get pod -n msp -o wide</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="115" src="https://images2.imgbox.com/0a/ae/oLBjmM4h_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl describe pod sentinel-0 -n msp</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="159" src="https://images2.imgbox.com/c2/f3/Y8Mvy9T7_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">需要登录，解决办法：</p> 
<p style="margin-left:.0001pt;text-align:justify;">创建一个密钥：</p> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl create secret docker-registry -n msp registry-key --docker-server=192.168.126.131:80 --docker-username=admin --docker-password=Harbor12345</p> 
<p style="margin-left:.0001pt;text-align:justify;">删除部署kubectl delete -f sentinel-statefulset.yaml</p> 
<p style="margin-left:.0001pt;text-align:justify;">修改sentinel-statefulset.yaml，添加拉取时使用的密钥</p> 
<p style="margin-left:.0001pt;text-align:justify;">imagePullSecrets:</p> 
<ul><li style="text-align:justify;">name: registrykey</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="351" src="https://images2.imgbox.com/2f/ec/QmacNHs2_o.png" width="538"></p> 
<p style="margin-left:.0001pt;text-align:justify;">重新部署后访问任意k8s节点,如http://k8s-master:31380即可访问成功，31380是service绑定的宿主机的物理端口，用户名密码是sentinel</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="507" src="https://images2.imgbox.com/b9/9e/37lcC1b4_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="571" src="https://images2.imgbox.com/63/d6/ory0dYak_o.png" width="945"></p> 
<h2>六、部署用户中心 </h2> 
<p style="margin-left:.0001pt;text-align:justify;">无状态服务，使用Deployment部署</p> 
<p style="margin-left:.0001pt;text-align:justify;">1、配置bootstrap.yml</p> 
<p>主要指定公共配置，应用配置扩展名，流控sentinel控制台地址，监控指标，应用名</p> 
<pre><code>spring:
  cloud:
    nacos:
      config:
        # 共享配置的DataId，多个使用,分隔
        # 越靠后，优先级越高；
        # .yaml后缀不能少，只支持yaml/properties
        shared-dataids: common.yaml         ### 共享配置
        refreshable-dataids: common.yaml    ### 可刷新共享配置
        server-addr: nacos-0.nacos-headless.msp.svc.cluster.local:8848    ### nacos server地址
        file-extension: yaml                ### dataId扩展名
        namespace: 6594ff18-07f3-4bb8-8add-72a35235e3ac  #命名空间 代指某个环境
    sentinel:
      transport:
        # 指定sentinel 控制台的地址
        dashboard: sentinel:8380
      eager: true              
  application:
    name: user-center
    
#metrics
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    chaosmonkey:
      enabled: true
    health:
      show-details: always
</code></pre> 
<p> 2、配置公共配置common.yaml</p> 
<pre><code>spring:
  cloud:
    nacos:
      # 注册中心
      discovery:
        server-addr: nacos-0.nacos-headless.msp.svc.cluster.local:8848
        namespace: 6594ff18-07f3-4bb8-8add-72a35235e3ac  #命名空间 代指某个环境
      # 配置中心
      config:
        # 共享配置的DataId，多个使用,分隔
        # 越靠后，优先级越高；
        # .yaml后缀不能少，只支持yaml/properties
        shared-dataids: common.yaml         ### 共享配置
        refreshable-dataids: common.yaml    ### 可刷新共享配置
        server-addr: nacos-0.nacos-headless.msp.svc.cluster.local:8848    ### nacos server配置中心地址
        file-extension: yaml                ### dataId扩展名
        namespace: 6594ff18-07f3-4bb8-8add-72a35235e3ac  #命名空间 代指某个环境  
  sentinel:
      transport:
        # 指定sentinel 控制台的地址
        dashboard: sentinel:8380
      eager: true         
  jackson:
        mapper:
            ALLOW_EXPLICIT_PROPERTY_RENAMING: true
        deserialization:
            READ_DATE_TIMESTAMPS_AS_NANOSECONDS: false
        serialization:
            WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS: false
            WRITE_DATES_AS_TIMESTAMPS: true
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">3、应用配置user-center.yaml</p> 
<pre><code>#端口配置
server:
  port: 7000   #固定端口
#  port: ${randomServerPort.value[7000,7005]}  #随机端口


spring:
  datasource:
      # JDBC 配置(驱动类自动从url的mysql识别,数据源类型自动识别)
	  url: jdbc:mysql://db-user-center:3106/user-center?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false
      username: root
      password: root
      driver-class-name:  com.mysql.cj.jdbc.Driver
      #连接池配置(通常来说，只需要修改initialSize、minIdle、maxActive
      initial-size: 1
      max-active: 20
      min-idle: 1
      # 配置获取连接等待超时的时间
      max-wait: 60000
      #打开PSCache，并且指定每个连接上PSCache的大小
      pool-prepared-statements: true
      max-pool-prepared-statement-per-connection-size: 20
      validation-query: SELECT 'x'
      test-on-borrow: false
      test-on-return: false 
      test-while-idle: true      
      #配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
      time-between-eviction-runs-millis: 60000
      #配置一个连接在池中最小生存的时间，单位是毫秒
      min-evictable-idle-time-millis: 300000
      filters: stat,wall
      # WebStatFilter配置，说明请参考Druid Wiki，配置_配置WebStatFilter
      #是否启用StatFilter默认值true
      web-stat-filter.enabled: true
      web-stat-filter.url-pattern:  /*
      web-stat-filter.exclusions: "*.js , *.gif ,*.jpg ,*.png ,*.css ,*.ico , /druid/*"
      web-stat-filter.session-stat-max-count: 1000
      web-stat-filter.profile-enable: true
      # StatViewServlet配置
      #展示Druid的统计信息,StatViewServlet的用途包括：1.提供监控信息展示的html页面2.提供监控信息的JSON API
      #是否启用StatViewServlet默认值true
      stat-view-servlet.enabled: true
      #根据配置中的url-pattern来访问内置监控页面，如果是上面的配置，内置监控页面的首页是/druid/index.html例如：
      #http://110.76.43.235:9000/druid/index.html
      #http://110.76.43.235:8080/mini-web/druid/index.html
      stat-view-servlet.url-pattern:  /druid/*
      #允许清空统计数据
      stat-view-servlet.reset-enable:  true
      stat-view-servlet.login-username: admin
      stat-view-servlet.login-password: admin
      #StatViewSerlvet展示出来的监控信息比较敏感，是系统运行的内部情况，如果你需要做访问控制，可以配置allow和deny这两个参数
      #deny优先于allow，如果在deny列表中，就算在allow列表中，也会被拒绝。如果allow没有配置或者为空，则允许所有访问
      #配置的格式
      #&lt;IP&gt;
      #或者&lt;IP&gt;/&lt;SUB_NET_MASK_size&gt;其中128.242.127.1/24
      #24表示，前面24位是子网掩码，比对的时候，前面24位相同就匹配,不支持IPV6。
      #stat-view-servlet.allow=
      #stat-view-servlet.deny=128.242.127.1/24,128.242.128.1
      # Spring监控配置，说明请参考Druid Github Wiki，配置_Druid和Spring关联监控配置
      #aop-patterns= # Spring监控AOP切入点，如x.y.z.service.*,配置多个英文逗号分隔
  redis:
    ################### redis 单机版 start ##########################
    host: redis
    port: 6379
    timeout: 6000
    database: 8
    lettuce:
      pool:
        max-active: 10 # 连接池最大连接数（使用负值表示没有限制）,如果赋值为-1，则表示不限制；如果pool已经分配了maxActive个jedis实例，则此时pool的状态为exhausted(耗尽)
        max-idle: 8   # 连接池中的最大空闲连接 ，默认值也是8
        max-wait: 100 # # 等待可用连接的最大时间，单位毫秒，默认值为-1，表示永不超时。如果超过等待时间，则直接抛出JedisConnectionException
        min-idle: 2    # 连接池中的最小空闲连接 ，默认值也是0
      shutdown-timeout: 100ms
mybatis-plus:     
  global-config:
    banner: false   
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl 
  mapper-locations: classpath*:com/open/**/dao/*.xml  

security:
  oauth2:
    ignored: /users-anon/**  , /doc.html   ,/document.html ,/users/save
    token:
      store:
        type: redis

#设置最大超时时间
ribbon:  
  ServerListRefreshInterval: 10  #刷新服务列表源的间隔时间
  OkToRetryOnAllOperations: true
  MaxAutoRetries: 1
  MaxAutoRetriesNextServer: 1
  ReadTimeout: 16000  
  ConnectTimeout: 16000 

#设置最大容错超时时间
hystrix:
  command:
    default:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 16000 
    
logging:
  level:
    com.open.capacity: INFO 
    org.hibernate: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.type.descriptor.sql.BasicExtractor: TRACE
#    com.neusoft: DEBUG     
#    com.netflix: DEBUG                    #用于心跳检测输出的日志
</code></pre> 
<p>4、构建user-center镜像</p> 
<p style="margin-left:.0001pt;text-align:justify;">1)Dockerfile文件配置</p> 
<pre><code>#基础镜像，如果本地没有，会从远程仓库拉取
FROM openjdk:8-jdk-alpine
#镜像制作人
MAINTAINER chenhj
#在容器中创建挂载点，可以多个VOLUME["/tmp"]
VOLUME /tmp
#声明了容器应该打开的端口并没有实际上将它打开
EXPOSE 8080
#定义参数
ARG JAR_FILE
#拷贝本地文件到镜像中
COPY ${JAR_FILE} app.jar
#指定容器启动时要执行的命令，但如果存在CMD命令，cmd中的参数会被附加到ENTRYPOINT指令的后面
ENTRYPOINT [ "java", "-Djava.security.egd=file:/dev/./urandom", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom", "-jar", "/app.jar" ]
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">/dev/./urandom</span><span style="color:#ff0000;">或者</span><span style="color:#ff0000;">/dev/urandom</span><span style="color:#ff0000;">都报类似于下面的错误，不知道怎么回事儿，</span><span style="color:#ff0000;">Error: Could not find or load main class java $JAVA_OPTS -Djava.security.egd=file:.dev.urandom</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">2)mvn clean</p> 
<p style="margin-left:.0001pt;text-align:justify;">3)mvn package</p> 
<p style="margin-left:.0001pt;text-align:justify;">4)docker build</p> 
<p style="margin-left:.0001pt;text-align:justify;">5)docker push</p> 
<p style="margin-left:.0001pt;text-align:justify;">5、在nacos中配置yaml</p> 
<p>common.yaml、user-center.yaml</p> 
<p>6、用户中心部署yaml</p> 
<pre><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: '3'
    k8s.kuboard.cn/displayName: 用户中心
  creationTimestamp: '2021-07-12T07:33:02Z'
  generation: 4
  labels:
    k8s.kuboard.cn/layer: svc
    k8s.kuboard.cn/name: user-center
  name: user-center
  namespace: msp
  resourceVersion: '62194'
  selfLink: /apis/apps/v1/namespaces/msp/deployments/user-center
  uid: 2b651e82-506e-4e2f-8435-67b643ddc23e
spec:
  progressDeadlineSeconds: 600
  replicas: 0
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s.kuboard.cn/layer: svc
      k8s.kuboard.cn/name: user-center
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/restartedAt: '2021-07-12T15:54:38+08:00'
      labels:
        k8s.kuboard.cn/layer: svc
        k8s.kuboard.cn/name: user-center
    spec:
      containers:
        - env:
            - name: spring.datasource.druid.core.url
              value: &gt;-
                jdbc:mysql://db-user-center:3106/user-center?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false
            - name: spring.datasource.druid.log.url
              value: &gt;-
                jdbc:mysql://db-log-center:3206/log-center?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false
            - name: spring.redis.host
              value: redis
          image: '192.168.126.131:80/msp/user-center:v1.0.3'
          imagePullPolicy: IfNotPresent
          name: user-center
          ports:
            - containerPort: 7000
              protocol: TCP
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      imagePullSecrets:
        - name: harbor-msp
      restartPolicy: Always
      schedulerName: default-scheduler
      terminationGracePeriodSeconds: 30
status:
  conditions:
    - lastTransitionTime: '2021-07-12T07:34:04Z'
      lastUpdateTime: '2021-07-12T07:34:04Z'
      message: Deployment has minimum availability.
      reason: MinimumReplicasAvailable
      status: 'True'
      type: Available
    - lastTransitionTime: '2021-07-12T07:33:02Z'
      lastUpdateTime: '2021-07-12T07:54:41Z'
      message: ReplicaSet "user-center-6bbfc58bd7" has successfully progressed.
      reason: NewReplicaSetAvailable
      status: 'True'
      type: Progressing
  observedGeneration: 4

---
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: '2021-07-12T07:33:02Z'
  labels:
    k8s.kuboard.cn/layer: svc
    k8s.kuboard.cn/name: user-center
  name: user-center
  namespace: msp
  resourceVersion: '58819'
  selfLink: /api/v1/namespaces/msp/services/user-center
  uid: a0ee37a4-8629-4d64-b517-b151daf54e19
spec:
  clusterIP: 10.100.21.141
  ports:
    - name: ww7t3p
      port: 7000
      protocol: TCP
      targetPort: 7000
  selector:
    k8s.kuboard.cn/layer: svc
    k8s.kuboard.cn/name: user-center
  sessionAffinity: None
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  creationTimestamp: '2021-07-12T07:33:02Z'
  generation: 1
  labels:
    k8s.kuboard.cn/layer: svc
    k8s.kuboard.cn/name: user-center
  name: user-center
  namespace: msp
  resourceVersion: '58821'
  selfLink: /apis/networking.k8s.io/v1beta1/namespaces/msp/ingresses/user-center
  uid: 496accf0-f13c-4e95-8b30-69b4b5063cc1
spec:
  rules:
    - host: svc.user-center.msp.cluster.kuboard.cn
      http:
        paths:
          - backend:
              serviceName: user-center
              servicePort: ww7t3p
            path: /
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">7启动报错</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）Ignore the empty nacos configuration and get it based on dataId[user-center] &amp; group[DEFAULT_GROUP]</p> 
<p style="margin-left:.0001pt;text-align:justify;">启动时报找不到配置文件，原因是在nacos创建的配置common.yaml、user-center.yaml没在应用的bootstrap.yml文件指定的命名空间下。将nacos中的配置文件克隆到指定的命名空间下。</p> 
<p style="margin-left:.0001pt;text-align:justify;">2）向nacos注册中心发送心跳包时，nacos返回<span style="color:#ff0000;">Distro protocol is not initialized</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">[user-center:10.244.2.180:7000] [,] 2021-07-07 12:01:43.666 ERROR 1 [main] com.alibaba.nacos.client.naming request: /nacos/v1/ns/instance failed, servers: [nacos-0.nacos-headless.msp.svc.cluster.local:8848], code: 503, msg: server is DOWNnow, detailed error message: Optional[<span style="color:#ff0000;">Distro protocol is not initialized</span>]</p> 
<p style="margin-left:.0001pt;text-align:justify;">这表明nacos的注册中心使用的Distro模块未成功初始化，到nacos的挂载目录查看日志文件，即</p> 
<p style="margin-left:.0001pt;text-align:justify;">/data/nfs/msp-data-nacos-0-pvc-094ae124-4f0c-4296-879e-b1b9bd1b37ca/logs/protocol-distro.log。日志中会出现很多关键的异常信息如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;">2021-07-09 09:12:22,110 ERROR [DISTRO-INIT] load snapshot com.alibaba.nacos.naming.iplist. from nacos-1.nacos-headless.msp.svc.cluster.local:8848 failed.</p> 
<p style="margin-left:.0001pt;text-align:justify;">com.alibaba.nacos.core.distributed.distro.exception.DistroException: [DISTRO-EXCEPTION]Get snapshot from nacos-1.nacos-headless.msp.svc.cluster.local:8848 failed.</p> 
<p style="margin-left:.0001pt;text-align:justify;">Caused by: java.io.IOException: failed to req API: http://nacos-1.nacos-headless.msp.svc.cluster.local:8848/nacos/v1/ns/distro/datums. code: 500 msg: org.apache.http.conn.HttpHostConnectException: Connect to nacos-1.nacos-headless.msp.svc.cluster.local:8848 [nacos-1.nacos-headless.msp.svc.cluster.local/10.244.2.205] failed: Connection refused (Connection refused)</p> 
<p style="margin-left:.0001pt;text-align:justify;">com.alibaba.nacos.core.distributed.distro.exception.DistroException: [DISTRO-EXCEPTION][DISTRO-FAILED] Get distro snapshot failed!</p> 
<p style="margin-left:.0001pt;text-align:justify;">Caused by: com.alibaba.nacos.api.exception.NacosException: No rpc client related to member: Member{ip='nacos-1.nacos-headless.msp.svc.cluster.local', port=8848, state=UP, extendInfo={raftPort=7848}}</p> 
<p style="margin-left:.0001pt;text-align:justify;">WARN data storage DistroDataStorageImpl has not finished initial step, do not send verify data</p> 
<p style="margin-left:.0001pt;text-align:justify;">但是nacos的pod日志报了nacos Have not found myself in list yet.度娘了一番发现出现类似于“pod数量为110个，所有node都达到110个时无法再调度”的相关问题，比如：https://blog.csdn.net/warrah/article/details/106488733</p> 
<p style="margin-left:.0001pt;text-align:justify;">由此想到了是不是k8s节点的资源耗得差不了，因为我的k8s节点内存只有4个G左右，但部署的东西太多了导致的，接下了我就关了很多与nacos无关的容器，查看k8s的节点资源占用情况，果然发现了惊喜，下图已经是停了很多容器之后的情况，可怜的内存啊：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="144" src="https://images2.imgbox.com/89/32/cIE7Uwkz_o.png" width="651"></p> 
<p style="margin-left:.0001pt;text-align:justify;">看看当前集群状况（已经关了很多，想来当前的电脑配置无法完成整个平台的搭建工作了，服务监控相关也没法弄了，VM太吃资源了，电脑的内存还得整到32G）：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="829" src="https://images2.imgbox.com/40/02/YIYkwVWD_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="265" src="https://images2.imgbox.com/41/df/QXYdJ6j0_o.png" width="946"></p> 
<p style="margin-left:.0001pt;text-align:justify;">重启nacos最后正常了：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="192" src="https://images2.imgbox.com/14/15/M7PzCkO3_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3)发送心跳报400</p> 
<p style="margin-left:.0001pt;text-align:justify;">failed to req API:/api//nacos/v1/ns/instance/beat code:400</p> 
<p style="margin-left:.0001pt;text-align:justify;">重启用户中心应用又可以了注册上了</p> 
<p style="margin-left:.0001pt;text-align:justify;">4)登录访问时，用户中心无法连接数据库</p> 
<p style="margin-left:.0001pt;text-align:justify;">因为数据库不支持用户名密码登录导致，暂将用户中心数据库脚本文件在认证中心数据库中执行，具体步骤：</p> 
<ul><li style="text-align:justify;">将用户中心sql脚本传入认证中心数据库pod容器组中</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl cp user-center.sql auth-center-mysql-0:/ -n msp</p> 
<ul><li style="text-align:justify;">进入认证中心数据库pod</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">kubectl exec -it auth-center-mysql-0 -n msp -- /bin/bash</p> 
<ul><li style="text-align:justify;">登录连接认证中心数据库</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">mysql -uroot –proot</p> 
<ul><li style="text-align:justify;">执行用户中心脚本文件（此方式可解决中文在客户端无法插入数据库的问题）</li></ul> 
<p style="margin-left:.0001pt;text-align:justify;">\. user-center.sql</p> 
<h2 style="margin-left:0px;text-align:justify;">七、部署认证中心</h2> 
<p> 部署与用户中心类似</p> 
<h2 style="margin-left:0px;text-align:justify;">八、部署网关</h2> 
<p> 部署与用户中心类似</p> 
<h2 style="margin-left:0px;text-align:justify;">九、部署后台应用</h2> 
<p style="margin-left:.0001pt;text-align:justify;">后台应用主要是静态文件</p> 
<p style="margin-left:.0001pt;text-align:justify;">在工程/src/main/view/static目录下，以nginx作为服务器进行部署，所以需要以nginx作为基础镜像进行构建。</p> 
<p style="margin-left:.0001pt;text-align:justify;">工程目录结构：</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">1、在Dockerfile文件同级目录下构建脚本文件entry-point.sh</p> 
<pre><code>#!/bin/sh
echo "GATEWAY_API_URL =&gt; ${GATEWAY_API_URL}"
sed -i "s#base_server.*#base_server: '${GATEWAY_API_URL}',$g" /usr/share/nginx/html/module/config.js
sed -i "s#user.*nginx;#user root;#g" /etc/nginx/nginx.conf
echo "args fllows:"
cat /usr/share/nginx/html/module/config.js
cat /etc/nginx/nginx.conf
echo "start nginx"
nginx -g "daemon off;"
</code></pre> 
<p> 2、构建Dockerfile文件</p> 
<pre><code>FROM nginx:1.17.1
LABEL maintainer="kuboard.cn"
ADD ./entry-point.sh /entry-point.sh
RUN chmod +x /entry-point.sh &amp;&amp; rm -rf /usr/share/nginx/html
# 创建环境变量的默认内容，防止 sed 脚本出错
ENV GATEWAY_API_URL http://gateway_api_url_not_set/
ENV CLOUD_EUREKA_URL http://cloud_eureka_url_not_set/
ADD ./src/main/view/static /usr/share/nginx/html
EXPOSE 80
CMD ["/entry-point.sh"]
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">问题</p> 
<p style="margin-left:.0001pt;text-align:justify;">1、启动时报standard_init_linux.go:211: exec user process caused "no such file or directory"</p> 
<p style="margin-left:.0001pt;text-align:justify;">使用docker run -it -p 8080:80 192.168.126.131:5000/msp/back-center:v1.0.2 /bin/bash进入容器，执行sh entry-point.sh后，输出错误如下：</p> 
<pre><code>GATEWAY_API_URL   http://gateway_api_url_not_set/
CLOUD_EUREKA_URL  http://cloud_eureka_url_not_set/
: No such file or directorynginx/html/module/config.js
: No such file or directorynginx/html/module/config.js

cat: '/usr/share/nginx/html/module/config.js'$'\r': No such file or directory

New state of 'nil' is invalid.
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">但文件确实在目录下。</p> 
<p style="margin-left:.0001pt;text-align:justify;">最后在linux环境下重建文件entry-point.sh后，重新构建镜像就可以了，确认是在windows下构建时，内容中带有特殊的字符，可能是带有windows的换行符\r\n，在容器环境中无法识别，而linux下的换行符是\n</p> 
<p style="margin-left:.0001pt;text-align:justify;">2、访问时报403</p> 
<p style="margin-left:.0001pt;text-align:justify;">查看nginx容器，日志报错如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;">2021/07/13 05:25:49 [error] 12#12: *11 open() "/usr/share/nginx/html/assets/libs/v5.3.0/ol.js" failed (13: Permission denied), client: 10.244.1.76, server: localhost, request: "GET /assets/libs/v5.3.0/ol.js HTTP/1.1", host: "back-center.msp.cluster.com:32080", referrer: "http://back-center.msp.cluster.com:32080/"</p> 
<p style="margin-left:.0001pt;text-align:justify;">10.244.1.76 - - [13/Jul/2021:05:25:49 +0000] "GET /assets/libs/v5.3.0/ol.js HTTP/1.1" 403 555 "http://back-center.msp.cluster.com:32080/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36" "10.244.1.1"</p> 
<p style="margin-left:.0001pt;text-align:justify;">发现是启动用户是root，而nginx.conf中指定的nginx</p> 
<p style="margin-left:.0001pt;text-align:justify;">https://blog.csdn.net/onlysunnyboy/article/details/75270533</p> 
<p style="margin-left:.0001pt;text-align:justify;">解决办法：nginx容器启动后执行entry-point.sh脚本，脚本中将/etc/nginx/nginx.conf中的user nginx;替换成user root;</p> 
<pre><code>#!/bin/sh
echo "GATEWAY_API_URL =&gt; ${GATEWAY_API_URL}"
echo "CLOUD_EUREKA_URL -&gt; ${CLOUD_EUREAKA_URL}"
sed -i "s#base_server.*#base_server: '${GATEWAY_API_URL}',$g" /usr/share/nginx/html/module/config.js
sed -i "s#eureka_server.*#eureka_server: '${CLOUD_EUREKA_URL}',#g" /usr/share/nginx/html/module/config.js
sed -i "s#user.*nginx;#user root;#g" /etc/nginx/nginx.conf
echo "args fllows:"
cat /usr/share/nginx/html/module/config.js
cat /etc/nginx/nginx.conf
echo "start nginx"
nginx -g "daemon off;"
</code></pre> 
<h2 style="margin-left:0px;text-align:justify;">附：k8s使用中的问题</h2> 
<p style="margin-left:.0001pt;text-align:justify;">1、电脑非正常关机导致安装在VM上的k8s节点无法正常使用。</p> 
<p style="margin-left:.0001pt;text-align:justify;">1）kubectl get pod</p> 
<pre><code>The connection to the server 192.168.126.128:6443 was refused - did you specify the right host or port?</code></pre> 
<p>systemctl status kubelet</p> 
<pre><code>7月 09 16:58:35 k8s-master kubelet[21332]: E0709 16:58:35.679351   21332 kubelet.go:2248] node "k8s-master" not found</code></pre> 
<p>docker ps  -a</p> 
<pre><code>CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS                          PORTS     NAMES
37b2c619ec03   2c4adeb21b4f           "etcd --advertise-cl…"   About a minute ago   Exited (2) About a minute ago             k8s_etcd_etcd-k8s-master_kube-system_d4ce83c21891db7e73e807ef995ca360_129
2536430e10b3   68c3eb07bfc3           "kube-apiserver --ad…"   4 minutes ago        Exited (255) 4 minutes ago                k8s_kube-apiserver_kube-apiserver-k8s-master_kube-system_4d8a5ffa907226d52ec5ad126ef212fb_137
7e259c79f9a6   b0b3c4c404da           "kube-scheduler --bi…"   39 minutes ago       Up 39 minutes                             k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_ecae9d12d3610192347be3d1aa5aa552_119
2f22d8c90df4   d75082f1d121           "kube-controller-man…"   39 minutes ago       Up 39 minutes                             k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_5a1fa432561d9745fe013857ccb566c1_119
5d501d1d078d   k8s.gcr.io/pause:3.1   "/pause"                 39 minutes ago       Up 39 minutes                             k8s_POD_kube-controller-manager-k8s-master_kube-system_5a1fa432561d9745fe013857ccb566c1_105
cfb01af4e5e8   k8s.gcr.io/pause:3.1   "/pause"                 39 minutes ago       Up 39 minutes                             k8s_POD_kube-scheduler-k8s-master_kube-system_ecae9d12d3610192347be3d1aa5aa552_88
83bdb7cba419   k8s.gcr.io/pause:3.1   "/pause"                 39 minutes ago       Up 39 minutes                             k8s_POD_kube-apiserver-k8s-master_kube-system_4d8a5ffa907226d52ec5ad126ef212fb_86
c5f742d2064e   k8s.gcr.io/pause:3.1   "/pause"                 39 minutes ago       Up 39 minutes                             k8s_POD_etcd-k8s-master_kube-system_d4ce83c21891db7e73e807ef995ca360_72
2628f7f03f85   d75082f1d121           "kube-controller-man…"   41 minutes ago       Exited (2) 41 minutes ago                 k8s_kube-controller-manager_kube-controller-manager-k8s-master_kube-system_5a1fa432561d9745fe013857ccb566c1_118
4b5bf17b2663   b0b3c4c404da           "kube-scheduler --bi…"   41 minutes ago       Exited (2) 41 minutes ago                 k8s_kube-scheduler_kube-scheduler-k8s-master_kube-system_ecae9d12d3610192347be3d1aa5aa552_118
0cc77025e7d9   k8s.gcr.io/pause:3.1   "/pause"                 41 minutes ago       Exited (0) 40 minutes ago                 k8s_POD_kube-scheduler-k8s-master_kube-system_ecae9d12d3610192347be3d1aa5aa552_87
</code></pre> 
<p>docker start $(docker ps -a | awk '{ print $1}' | tail -n +2)</p> 
<pre><code>425af1d425ac
37b2c619ec03
7e259c79f9a6
2f22d8c90df4
5d501d1d078d
cfb01af4e5e8
83bdb7cba419
c5f742d2064e
Error response from daemon: cannot join network of a non running container: 124351d81c42b393ea7cda5b859cb3c971f5dcf020ef7b1834b06777fda1a0ab
Error response from daemon: cannot join network of a non running container: 0cc77025e7d954264a4a27c5be58e43a434de5dc850c0ec59b6616e8ed91fae0
0cc77025e7d9
124351d81c42
Error response from daemon: cannot join network of a non running container: bfe9cb4f37a1df6d413b1458c2105f5f8e76a711c0ac613b5a698641247cd390
Error response from daemon: cannot join network of a non running container: b3792df16c18a5f5f6ad6aece0c9e92b4a277c9d7a2f9e8e45d0aaf6e82c169e
Error response from daemon: cannot join network of a non running container: b48f01632705e20548d4b83d283323a69aa9770e31dcde56c480dc0bd63ceb3b
b3792df16c18
bfe9cb4f37a1
b48f01632705
Error response from daemon: cannot join network of a non running container: 1402ff8e40bf602e96cf28b74b0fb4d80a3d1f272076260be211eee07324cbaf
Error response from daemon: cannot join network of a non running container: 1402ff8e40bf602e96cf28b74b0fb4d80a3d1f272076260be211eee07324cbaf
Error response from daemon: cannot join network of a non running container: d9b5c42c62ca11fbf1c5a80035ef508f5e33ea3320b8a5eb3b91b48a887ed60e
1402ff8e40bf
d9b5c42c62ca
348e331bb616
63032652160b
Error: failed to start containers: 2628f7f03f85, 4b5bf17b2663, 62ef0183bbdf, d2f5aa7e04de, 594be1b1fa38, 17373fd45907, 6c84555eda5d, 567b4db33d92
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">最后按照https://ghostwritten.blog.csdn.net/article/details/111186072的前四种方法都不行，只有按方法5 重新部署集群了，之前部署的很多应用都没了。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ddb41a50bb8a0cf07c83379540804060/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电脑一键重装系统按F几进u盘启动</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/224f47e99230285a0927aeee55c792c1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第22天---Python爬虫---BeautifulSoup库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>