<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>V8å¼•æ“Promiseæºç å…¨é¢è§£è¯»ï¼ˆæ·±åº¦å¥½æ–‡ï¼‰ - ç¼–ç¨‹éšæƒ³</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="V8å¼•æ“Promiseæºç å…¨é¢è§£è¯»ï¼ˆæ·±åº¦å¥½æ–‡ï¼‰" />
<meta property="og:description" content="ä½œè€…ï¼šæœˆå¤•
åŸæ–‡ï¼šhttps://juejin.cn/post/7055202073511460895
å†™åœ¨å‰é¢çš„è¯ é˜…è¯»æœ¬æ–‡ä½ å°†æ”¶è·ä»€ä¹ˆï¼Ÿ
äº†è§£ V8 Promise æºç å…¨è¿‡ç¨‹ï¼Œä¸–ç•Œä¸Šä¸å†æœ‰èƒ½å›°ä½ä½ çš„ Promise é¢˜ç›®ï¼Œæˆ‘å°±æ˜¯è¿™ä¹ˆè‚¯å®šè¿™ç¯‡æ–‡ç« çš„å¹²è´§
ä»…ä»…äº†è§£æˆ–è€…å®ç°äº† Promise/A&#43; è§„èŒƒï¼Œè¿™ä¸ JavaScript çš„ Promise ä¸­é—´è¿˜æœ‰å¾ˆå¤§çš„å·®è·
å¦‚æœä½ åœ¨é¢è¯•æ—¶å°† Promise å›ç­”åˆ°æœ¬æ–‡çš„æ·±åº¦ï¼Œä¸€å®šæ˜¯æ”¶è· SP æˆ–è€… SSP offer çš„åˆ©å™¨ï¼Œå› ä¸ºé¢è¯•å®˜å¤§æ¦‚ç‡ä¹Ÿä¸çŸ¥é“è¿™äº›çŸ¥è¯†ã€‚
ä½ çŸ¥é“ æµè§ˆå™¨ &amp; Node ä¸­çœŸæ­£çš„ Promise æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„å—ï¼Œå¦‚æœä½ åªæ˜¯çœ‹è¿‡ Promise/A&#43; è§„èŒƒçš„ Promise å®ç°ï¼Œé‚£ä¹ˆæˆ‘è‚¯å®šçš„å‘Šè¯‰ä½ ï¼Œä½ å¯¹ Promise æ‰§è¡Œé¡ºåºçš„è®¤çŸ¥æ˜¯é”™è¯¯çš„ã€‚ä¸ä¿¡çš„è¯ä½ å°±çœ‹çœ‹ä¸‹é¢è¿™ä¸¤é“é¢˜ã€‚
Promise.resolve().then(()Â =&gt;Â { console.log(0); returnÂ Promise.resolve(4) }).then(resÂ =&gt;Â { console.log(res); }) Promise.resolve().then(()Â =&gt;Â { console.log(1); }).then(()Â =&gt;Â { console.log(2); }).then(()Â =&gt;Â { console.log(3); }).then(()Â =&gt;Â { console.log(5); }).then(()Â =&gt;Â { console.log(6); }) //Â 0Â 1Â 2Â 3Â 4Â 5Â 6 newÂ Promise((resolve,Â reject)Â =&gt;Â { Promise." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2d3923be6986004dcafe1b00904633c8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-02T07:47:10+08:00" />
<meta property="article:modified_time" content="2023-08-02T07:47:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹éšæƒ³" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹éšæƒ³</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">V8å¼•æ“Promiseæºç å…¨é¢è§£è¯»ï¼ˆæ·±åº¦å¥½æ–‡ï¼‰</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="js_content"> 
 <blockquote> 
  <p>ä½œè€…ï¼šæœˆå¤•</p> 
  <p>åŸæ–‡ï¼šhttps://juejin.cn/post/7055202073511460895</p> 
 </blockquote> 
 <h3>å†™åœ¨å‰é¢çš„è¯</h3> 
 <p><strong>é˜…è¯»æœ¬æ–‡ä½ å°†æ”¶è·ä»€ä¹ˆï¼Ÿ</strong></p> 
 <ul><li><p>äº†è§£ V8 Promise æºç å…¨è¿‡ç¨‹ï¼Œä¸–ç•Œä¸Šä¸å†æœ‰èƒ½å›°ä½ä½ çš„ Promise é¢˜ç›®ï¼Œæˆ‘å°±æ˜¯è¿™ä¹ˆè‚¯å®šè¿™ç¯‡æ–‡ç« çš„å¹²è´§</p></li><li><p>ä»…ä»…äº†è§£æˆ–è€…å®ç°äº† Promise/A+ è§„èŒƒï¼Œè¿™ä¸ JavaScript çš„ Promise ä¸­é—´è¿˜æœ‰å¾ˆå¤§çš„å·®è·</p></li><li><p>å¦‚æœä½ åœ¨é¢è¯•æ—¶å°† Promise å›ç­”åˆ°æœ¬æ–‡çš„æ·±åº¦ï¼Œä¸€å®šæ˜¯æ”¶è· SP æˆ–è€… SSP offer çš„åˆ©å™¨ï¼Œå› ä¸ºé¢è¯•å®˜å¤§æ¦‚ç‡ä¹Ÿä¸çŸ¥é“è¿™äº›çŸ¥è¯†ã€‚</p></li></ul> 
 <p>ä½ çŸ¥é“ æµè§ˆå™¨ &amp; Node ä¸­çœŸæ­£çš„ <code>Promise</code> æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„å—ï¼Œå¦‚æœä½ åªæ˜¯çœ‹è¿‡ <code>Promise/A+</code> è§„èŒƒçš„ <code>Promise</code> å®ç°ï¼Œé‚£ä¹ˆæˆ‘è‚¯å®šçš„å‘Šè¯‰ä½ ï¼Œä½ å¯¹ <code>Promise</code> æ‰§è¡Œé¡ºåºçš„è®¤çŸ¥æ˜¯é”™è¯¯çš„ã€‚ä¸ä¿¡çš„è¯ä½ å°±çœ‹çœ‹ä¸‹é¢è¿™ä¸¤é“é¢˜ã€‚</p> 
 <pre class="has"><code class="language-go">Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â console.log(0);
Â Â Â Â returnÂ Promise.resolve(4)
}).then(resÂ =&gt;Â {
Â Â Â Â console.log(res);
})

Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â console.log(1);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(2);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(3);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(5);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(6);
})
//Â 0Â 1Â 2Â 3Â 4Â 5Â 6


newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â Â Â Â Â resolve({
Â Â Â Â Â Â Â Â Â Â Â Â then:Â (resolve,Â reject)Â =&gt;Â resolve(1)
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Promise.resolve().then(()Â =&gt;Â console.log(2));
Â Â Â Â });
}).then(vÂ =&gt;Â console.log(v));
//Â 2Â 1</code></pre> 
 <p>æŒ‰ç…§ <code>Promise/A+</code> è§„èŒƒæ¥è¯´ï¼Œä¸Šé¢çš„ä»£ç æ‰“å°çš„ç»“æœåº”è¯¥æ˜¯ 0 1 2 4 3 5 6ï¼Œå› ä¸ºå½“ <code>then</code> è¿”å›ä¸€ä¸ª <code>Promise</code> çš„æ—¶å€™éœ€è¦ç­‰å¾…è¿™ä¸ª <code>Promise</code> å®Œæˆåå†åŒæ­¥çŠ¶æ€å’Œå€¼ç»™ <code>then</code> çš„ç»“æœã€‚</p> 
 <p>ä½†æ˜¯åœ¨ <code>V8</code> ç”šè‡³ å„å¤§æ”¯æŒ <code>Promise</code> çš„ä¸»æµæµè§ˆå™¨ä¸­çš„æ‰§è¡Œç»“æœéƒ½æ˜¯ 0 1 2 3 4 5 6</p> 
 <blockquote> 
  <p>ä»–ä»¬æ˜¯å¦‚ä½•åšåˆ°ä¸ <code>Promise/A+</code> è§„èŒƒä¸ä¸€æ ·ï¼ˆä¹Ÿä¸èƒ½è¯´ä¸€æ ·ï¼Œå› ä¸º <code>Promise</code> æ²¡æœ‰æ˜ç¡®æè¿°ä»–ä»¬çš„æ‰§è¡Œé€»è¾‘ï¼Œåªæ˜¯ç»™å‡ºä¸€äº›è§„èŒƒï¼‰ä¸”ä¿æŒä¸€è‡´çš„ï¼Ÿ</p> 
 </blockquote> 
 <p>è¦çŸ¥é“ï¼Œ <code>Promise</code> å±äº <code>JavaScript</code> ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œ è€Œ <code>JavaScript</code> ä¸­ <code>Promise</code> çš„å®ç°è§„èŒƒå¹¶éæ¥æºäº <code>Promise/A+</code>ï¼Œè€Œæ˜¯æ¥è‡ª <code>ECMAScript</code> è§„èŒƒã€‚</p> 
 <p>æ‰€ä»¥è¦çŸ¥é“è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…çœ‹ <code>Promise/A+</code> ï¼Œå¯¹äºä»£ç çš„æ‰§è¡Œè¿‡ç¨‹å’Œé¡ºåºæˆ‘ä»¬çš„å…³æ³¨ç‚¹åº”è¯¥æ˜¯åœ¨ <code>ECMAScript</code> æˆ–è€… <code>V8</code> ä¸Šã€‚</p> 
 <p>æ¥ä¸‹æ¥æˆ‘å°±ç»“åˆ <code>ECMAScript</code> è§„èŒƒæ¥å¯¹ <code>V8</code> ä¸­ <code>Promise</code> æºç è¿›è¡Œå…¨é¢çš„è§£è¯»ã€‚</p> 
 <p><strong>è¿˜æœ‰ä¸‰ä»¶äº‹éœ€è¦æå‰è¯´ä¸€ä¸‹:</strong></p> 
 <ol><li><p>æœ¬æ–‡æ›´åŠ é€‚åˆæœ‰ä¸€å®š Promise åŸºç¡€çš„åŒå­¦é˜…è¯»ï¼Œå¦‚æœå¯¹ Promise ä¸äº†è§£çš„åŒå­¦å¯ä»¥å…ˆçœ‹çœ‹è¿™äº›æ–‡ç« </p></li></ol> 
 <ul><li><p>ã€ç¿»è¯‘ã€‘promise<sup>[1]</sup></p></li><li><p>Promiseä¸ä¼šï¼Ÿï¼Ÿçœ‹è¿™é‡Œï¼ï¼ï¼å²ä¸Šæœ€é€šä¿—æ˜“æ‡‚çš„Promiseï¼ï¼ï¼<sup>[2]</sup></p></li></ul> 
 <p>å¯¹äºåç»­è´´å‡ºçš„ c++ ä»£ç å¤§å®¶åªéœ€è¦ç€é‡çœ‹å¸¦æœ‰ä¸­æ–‡æ³¨é‡Šçš„åœ°æ–¹å³å¯</p> 
 <p>å› ä¸ºä»£ç å—ä¸ä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæ‰€ä»¥å»ºè®® PC ç«¯é˜…è¯»å¯ä»¥æœ‰æ›´å¥½çš„é˜…è¯»ä½“éªŒ</p> 
 <p>æ–‡ç« å¾ˆé•¿ï¼Œå¯ä»¥æ”¶è—ï¼Œæœ‰æ—¶é—´é™ä¸‹å¿ƒæ¥æ…¢æ…¢çœ‹ä¹Ÿå¯ä»¥ã€‚</p> 
 <p>ç‚¹èµğŸ‘ğŸ»ã€ç‚¹èµğŸ‘ğŸ»ã€ç‚¹èµğŸ‘ğŸ»</p> 
 <p>è¿›å…¥æ­£é¢˜</p> 
 <h3>PromiseState</h3> 
 <p>Promise çš„ 3 ç§çŠ¶æ€ï¼Œ<code>pending</code>ã€ <code>fulfilled</code> å’Œ <code>rejected</code> ï¼Œæºç å¦‚ä¸‹<sup>[3]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">//Â PromiseÂ constants
externÂ enumÂ PromiseStateÂ extendsÂ int31Â constexprÂ 'Promise::PromiseState'Â {
Â Â kPending,//Â ç­‰å¾…çŠ¶æ€
Â Â kFulfilled,//Â æˆåŠŸçŠ¶æ€
Â Â kRejected//Â å¤±è´¥çŠ¶æ€
}</code></pre> 
 <p>ä¸€ä¸ªæ–°åˆ›å»ºçš„ <code>Promise</code> å¤„äº <code>pending</code> çŠ¶æ€ã€‚å½“è°ƒç”¨ <code>resolve</code> æˆ– <code>reject</code> å‡½æ•°åï¼Œ<code>Promise</code> å¤„äº <code>fulfilled</code> æˆ– <code>rejected</code> çŠ¶æ€ï¼Œæ­¤å <code>Promise</code> çš„çŠ¶æ€ä¿æŒä¸å˜ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>Promise</code> çš„çŠ¶æ€æ”¹å˜æ˜¯ä¸å¯é€†çš„ï¼Œå¦‚æœå†æ¬¡è°ƒç”¨ <code>resolve</code> æˆ–è€… <code>reject</code> å°†ä¸ä¼šå‘ç”Ÿä»»ä½•äº‹ï¼Œ<code>Promise</code> æºç ä¸­å‡ºç°äº†å¤šå¤„çŠ¶æ€ç›¸å…³çš„ assertï¼ˆæ–­è¨€ï¼‰ï¼Œè¿™ä¸ªå°±ä¸èµ˜è¿°äº†ï¼Œæƒ³å¿…å¯¹äº <code>Promise</code> çš„ä¸‰ç§çŠ¶æ€å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰äº†ã€‚</p> 
 <h4>JSPromise</h4> 
 <p>JSPromise æè¿° <code>Promise</code> çš„åŸºæœ¬ä¿¡æ¯ï¼Œæºç å¦‚ä¸‹<sup>[4]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">bitfieldÂ structÂ JSPromiseFlagsÂ extendsÂ uint31Â {
Â Â //Â PromiseÂ çš„çŠ¶æ€ï¼ŒkPending/kFulfilled/kRejected
Â Â status:Â PromiseState:Â 2Â bit;Â 
Â Â //Â æ˜¯å¦æœ‰onFulfilled/onRejectedå¤„ç†å‡½æ•°ï¼Œ
Â Â //Â æ²¡æœ‰è°ƒç”¨è¿‡Â thenÂ æ–¹æ³•çš„Â PromiseÂ æ²¡æœ‰å¤„ç†å‡½æ•°
Â Â //ï¼ˆcatchæ–¹æ³•çš„æœ¬è´¨æ˜¯thenæ–¹æ³•ï¼Œåé¢ä¼šä»‹ç»ï¼‰
Â Â has_handler:Â bool:Â 1Â bit;Â 
Â Â handled_hint:Â bool:Â 1Â bit;Â 
Â Â async_task_id:Â int32:Â 22Â bit;
}

@generateCppClass
externÂ classÂ JSPromiseÂ extendsÂ JSObjectÂ {
Â Â macroÂ Status():Â PromiseStateÂ {
Â Â Â Â //Â è·å–Â PromiseÂ çš„çŠ¶æ€ï¼Œè¿”å›Â 
Â Â Â Â //Â kPending/kFulfilled/kRejectedÂ ä¸­çš„ä¸€ä¸ª
Â Â Â Â returnÂ this.flags.status;
Â Â }

Â Â macroÂ SetStatus(status:Â constexprÂ PromiseState):Â voidÂ {
Â Â Â Â //Â åªæœ‰Â pendingÂ çŠ¶æ€çš„Â PromiseÂ æ‰å¯ä»¥è¢«æ”¹å˜çŠ¶æ€
Â Â Â Â assert(this.Status()Â ==Â PromiseState::kPending);
Â Â Â Â //Â PromiseÂ åˆ›å»ºæˆåŠŸåï¼Œä¸å¯å°†Â PromiseÂ è®¾ç½®ä¸ºÂ pendingÂ çŠ¶æ€
Â Â Â Â assert(statusÂ !=Â PromiseState::kPending);
Â Â Â Â this.flags.statusÂ =Â status;
Â Â }

Â Â macroÂ HasHandler():Â boolÂ {
Â Â Â Â //Â åˆ¤æ–­Â PromiseÂ æ˜¯å¦æœ‰å¤„ç†å‡½æ•°
Â Â Â Â returnÂ this.flags.has_handler;
Â Â }

Â Â macroÂ SetHasHandler():Â voidÂ {
Â Â Â Â this.flags.has_handlerÂ =Â true;
Â Â }

Â Â //Â promiseÂ å¤„ç†å‡½æ•°æˆ–ç»“æœï¼Œå¯ä»¥æ˜¯:
Â Â //Â ç©º
Â Â //Â onFulfilled/onRejectedæ„æˆçš„é“¾è¡¨
Â Â //Â promiseçš„ç¡®è®¤å€¼ï¼ˆresolveçš„å‚æ•°ï¼‰
Â Â reactions_or_result:Â Zero|PromiseReaction|JSAny;
Â Â flags:Â SmiTagged&lt;JSPromiseFlags&gt;;
}</code></pre> 
 <p>å½“ <code>Promise</code> çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ¯”å¦‚è°ƒç”¨äº† <code>resolve/reject</code> å‡½æ•°ï¼Œ<code>SetStatus</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼›<code>Javascript</code> å±‚è°ƒç”¨ <code>resolve</code> æ–¹æ³•æ—¶ï¼Œ<code>reactions_or_result</code> å­—æ®µä¼šè¢«èµ‹å€¼ä¸º <code>resolve</code> ä¼ å…¥çš„å‚æ•°ï¼›<code>Javascript</code> å±‚è°ƒç”¨ <code>then</code> æ–¹æ³•æ—¶ï¼Œè¯´æ˜å·²ç»æœ‰äº†å¤„ç†å‡½æ•°ï¼Œ<code>SetHasHandler()</code> ä¼šè¢«è°ƒç”¨ã€‚<code>Status/SetStatus</code> è¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªè·å– <code>Promise</code> çŠ¶æ€ï¼Œä¸€ä¸ªè®¾ç½® <code>Promise</code> çŠ¶æ€ï¼›</p> 
 <h4>å…¶å®ƒ</h4> 
 <ul><li><p>executorï¼šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ<code>Promise</code> æ„é€ å‡½æ•°æ¥æ”¶çš„å‚æ•°ï¼Œè°ƒç”¨ <code>executor</code> æ—¶ä¼ å…¥çš„å‚æ•°åˆ†åˆ«æ˜¯ <code>resolve</code> å’Œ <code>reject</code>ã€‚</p></li><li><p>PromiseReactionï¼šæ˜¯å¯¹è±¡ï¼Œè¡¨ç¤º <code>Promise</code> çš„å¤„ç†å‡½æ•°ï¼Œå› ä¸ºä¸€ä¸ª <code>Promise</code> å¤šæ¬¡è°ƒç”¨ <code>then </code>æ–¹æ³•å°±ä¼šæœ‰å¤šä¸ªå¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸ªé“¾è¡¨ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨ç€ <code>onFulfilled</code> å’Œ <code>onRejected</code> å‡½æ•°ã€‚</p></li></ul> 
 <pre class="has"><code class="language-go">letÂ pÂ =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â resolve(123)
Â Â //Â ä¼šå°†Â reactions_or_resultÂ è®¾ç½®ä¸ºÂ 123
Â Â //Â ä¼šè°ƒç”¨Â SetHasHandler
Â Â resolve(234)//Â ä¸ä¼šå‘ç”Ÿä»»ä½•äº‹ï¼Œç›¸å½“äºæ²¡å†™
Â Â reject(234)//Â ä¹Ÿä¸ä¼šå‘ç”Ÿä»»ä½•äº‹ï¼Œç›¸å½“äºæ²¡å†™
})</code></pre> 
 <h3>æ„é€ å‡½æ•°</h3> 
 <p>æ„é€ å‡½æ•°æºç å¦‚ä¸‹<sup>[5]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">PromiseConstructor(
Â Â Â Â js-implicitÂ context:Â NativeContext,Â receiver:Â JSAny,
Â Â Â Â newTarget:Â JSAny)(executor:Â JSAny):Â JSAnyÂ {
Â Â //Â 1.Â å¦‚æœä¸å­˜åœ¨Â newÂ å…³é”®å­—,Â throwÂ aÂ TypeErrorÂ exception.
Â Â ifÂ (newTargetÂ ==Â Undefined)Â {
Â Â Â Â ThrowTypeError(MessageTemplate::kNotAPromise,Â newTarget);
Â Â }

Â Â //Â 2.Â å¦‚æœä¼ å…¥çš„å‚æ•°ä¸æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°,Â throwÂ aÂ TypeErrorÂ exception.
Â Â ifÂ (!Is&lt;Callable&gt;(executor))Â {
Â Â Â Â ThrowTypeError(MessageTemplate::kResolverNotAFunction,Â executor);
Â Â }

Â Â letÂ result:Â JSPromise;
Â Â //Â æ„é€ ä¸€ä¸ªÂ PromiseÂ å¯¹è±¡
Â Â resultÂ =Â NewJSPromise();
Â Â //Â ä»Â PromiseÂ å¯¹è±¡èº«ä¸Šï¼Œè·å–å®ƒçš„Â resolveÂ å’ŒÂ rejectÂ å‡½æ•°
Â Â constÂ funcsÂ =Â CreatePromiseResolvingFunctions(result,Â True,Â context);
Â Â constÂ resolveÂ =Â funcs.resolve;
Â Â constÂ rejectÂ =Â funcs.reject;
Â Â tryÂ {
Â Â Â Â //Â ç›´æ¥åŒæ­¥è°ƒç”¨Â executorÂ å‡½æ•°ï¼ŒresolveÂ å’ŒÂ rejectÂ åšä¸ºå‚æ•°
Â Â Â Â Call(context,Â UnsafeCast&lt;Callable&gt;(executor),Â Undefined,Â resolve,Â reject);
Â Â }Â catchÂ (e)Â {
Â Â Â Â //Â å¦‚æœå‡ºç°å¼‚å¸¸åˆ™è°ƒç”¨Â rejectÂ å‡½æ•°
Â Â Â Â Call(context,Â reject,Â Undefined,Â e);
Â Â }
Â Â returnÂ result;
}</code></pre> 
 <p>é¦–å…ˆåˆ†æä¸¤ä¸ª <code>ThrowTypeError</code>ï¼Œä»¥ä¸‹ä»£ç å¯è§¦å‘ç¬¬ä¸€ä¸ª <code>ThrowTypeError</code>ã€‚</p> 
 <pre class="has"><code class="language-go">Promise()Â Â //Â UncaughtÂ TypeError:Â undefinedÂ isÂ notÂ aÂ promise</code></pre> 
 <p>åŸå› æ˜¯æ²¡æœ‰ä½¿ç”¨ <code>new</code> æ“ä½œç¬¦è°ƒç”¨ <code>Promise</code> æ„é€ å‡½æ•°ï¼Œæ­¤æ—¶ <code>newTarget</code> ç­‰äº <code>Undefined</code>ï¼Œè§¦å‘äº† <code>ThrowTypeError(MessageTemplate::kNotAPromise, newTarget)</code>ã€‚</p> 
 <p>ä»¥ä¸‹ä»£ç å¯è§¦å‘ç¬¬äºŒä¸ª <code>ThrowTypeError</code>ã€‚</p> 
 <pre class="has"><code class="language-go">newÂ Promise()Â //Â UncaughtÂ TypeError:Â PromiseÂ resolverÂ undefinedÂ isÂ notÂ aÂ function</code></pre> 
 <p>æ­¤æ—¶ <code>newTarget</code> ä¸ç­‰äº <code>Undefined</code>ï¼Œä¸ä¼šè§¦å‘ç¬¬ä¸€ä¸ª <code>ThrowTypeError</code>ã€‚ä½†è°ƒç”¨ <code>Promise</code> æ„é€ å‡½æ•°æ—¶æ²¡ä¼ å‚æ•° <code>executor</code>ï¼Œè§¦å‘äº†ç¬¬äºŒä¸ª <code>ThrowTypeError</code>ã€‚</p> 
 <p><code>executor</code> çš„ç±»å‹æ˜¯å‡½æ•°ï¼Œåœ¨ JavaScript çš„ä¸–ç•Œé‡Œï¼Œå›è°ƒå‡½æ•°é€šå¸¸æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä½† <code>executor</code> æ˜¯åŒæ­¥è°ƒç”¨ã€‚åœ¨ <code>Call(context, UnsafeCast(executor), Undefined, resolve, reject)</code> è¿™ä¸€è¡Œï¼ŒåŒæ­¥è°ƒç”¨äº† <code>executor</code>ã€‚</p> 
 <pre class="has"><code class="language-go">console.log('åŒæ­¥æ‰§è¡Œå¼€å§‹')
newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â resolve()
Â Â console.log('executorÂ åŒæ­¥æ‰§è¡Œ')
})

console.log('åŒæ­¥æ‰§è¡Œç»“æŸ')
//Â æœ¬æ®µä»£ç çš„æ‰“å°é¡ºåºæ˜¯:
//Â åŒæ­¥æ‰§è¡Œå¼€å§‹
//Â executorÂ åŒæ­¥æ‰§è¡Œ
//Â åŒæ­¥æ‰§è¡Œç»“æŸ</code></pre> 
 <blockquote> 
  <p>Promise æ„é€ å‡½æ•°æ¥æ”¶çš„å‚æ•° <code>executor</code>ï¼Œæ˜¯è¢«åŒæ­¥è°ƒç”¨çš„</p> 
 </blockquote> 
 <h3>then</h3> 
 <p>ECMAScript è§„èŒƒ<sup>[6]</sup></p> 
 <h4>PromisePrototypeThen</h4> 
 <p><code>Promise</code> çš„ <code>then</code> æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå›è°ƒå‡½æ•° <code>onFulfilled</code> å’Œ <code>onRejected</code>ï¼Œåˆ†åˆ«ç”¨äºå¤„ç† <code>fulfilled</code> å’Œ <code>rejected</code> çŠ¶æ€ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ <code>Promise</code>ã€‚</p> 
 <p>JavaScript å±‚çš„ <code>then</code> å‡½æ•°å®é™…ä¸Šæ˜¯ <code>V8</code> ä¸­çš„ <code>PromisePrototypeThen</code> å‡½æ•°ï¼Œæºç å¦‚ä¸‹<sup>[7]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">PromisePrototypeThen(js-implicitÂ context:Â NativeContext,Â receiver:Â JSAny)(
Â Â Â Â onFulfilled:Â JSAny,Â onRejected:Â JSAny):Â JSAnyÂ {
Â Â constÂ promiseÂ =Â Cast&lt;JSPromise&gt;(receiver)Â otherwiseÂ ThrowTypeError(
Â Â Â Â Â Â MessageTemplate::kIncompatibleMethodReceiver,Â 'Promise.prototype.then',
Â Â Â Â Â Â receiver);

Â Â constÂ promiseFunÂ =Â UnsafeCast&lt;JSFunction&gt;(
Â Â Â Â Â Â context[NativeContextSlot::PROMISE_FUNCTION_INDEX]);

Â Â letÂ resultPromiseOrCapability:Â JSPromise|PromiseCapability;
Â Â letÂ resultPromise:Â JSAny;
Â Â labelÂ AllocateAndInitÂ {
Â Â Â Â //Â åˆ›å»ºä¸€ä¸ªæ–°çš„Â promiseÂ ç”¨äºå½“åšæœ¬æ¬¡Â thenÂ çš„è°ƒç”¨ç»“æœè¿”å›
Â Â Â Â //ï¼ˆä¸Šé¢æœ‰æåˆ°thençš„è¿”å›å€¼æ˜¯ä¸€ä¸ªpromiseï¼‰
Â Â Â Â constÂ resultJSPromiseÂ =Â NewJSPromise(promise);
Â Â Â Â resultPromiseOrCapabilityÂ =Â resultJSPromise;
Â Â Â Â resultPromiseÂ =Â resultJSPromise;
Â Â }
Â Â //Â onFulfilledÂ å’ŒÂ onRejectedÂ æ˜¯Â thenÂ æ¥æ”¶çš„ä¸¤ä¸ªå‚æ•°
Â Â //Â å¦‚æœä¸ä¼ åˆ™é»˜è®¤å€¼ä¸ºÂ Undefined
Â Â constÂ onFulfilledÂ =Â CastOrDefault&lt;Callable&gt;(onFulfilled,Â Undefined);
Â Â constÂ onRejectedÂ =Â CastOrDefault&lt;Callable&gt;(onRejected,Â Undefined);

Â Â //Â è°ƒç”¨Â PerformPromiseThenImplÂ å‡½æ•°
Â Â PerformPromiseThenImpl(
Â Â Â Â Â Â promise,Â onFulfilled,Â onRejected,Â resultPromiseOrCapability);
Â Â //Â è¿”å›ä¸€ä¸ªæ–°çš„Â Promise
Â Â returnÂ resultPromise;
}</code></pre> 
 <p><code>PromisePrototypeThen</code> å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ <code>Promise</code> å¯¹è±¡ï¼Œè·å– <code>then</code> æ¥æ”¶åˆ°çš„ä¸¤ä¸ªå‚æ•°ï¼Œè°ƒç”¨ <code>PerformPromiseThenImpl</code> å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œã€‚è¿™é‡Œæœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œ<code>then</code> æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ <code>Promise</code>ã€‚</p> 
 <pre class="has"><code class="language-go">constÂ myPromise2Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â resolve('foo')
})

constÂ myPromise3Â =Â myPromise2.then(console.log)

//Â myPromise2Â å’ŒÂ myPromise3Â æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡
//Â æœ‰ä¸åŒçš„çŠ¶æ€å’Œä¸åŒçš„å¤„ç†å‡½æ•°
console.log(myPromise2Â ===Â myPromise3)Â //Â æ‰“å°Â false</code></pre> 
 <blockquote> 
  <p>then æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ Promise</p> 
 </blockquote> 
 <h4>PerformPromiseThenImpl</h4> 
 <p>ECMAScript è§„èŒƒ<sup>[8]</sup></p> 
 <p><code>PerformPromiseThenImpl</code> æœ‰4ä¸ªå‚æ•°ï¼Œå› ä¸º <code>PerformPromiseThenImpl</code> æ˜¯åœ¨è°ƒç”¨ <code>then</code> è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒçš„å‰ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯è¢«è°ƒç”¨ <code>then</code> æ–¹æ³•çš„ <code>Promise</code> å¯¹è±¡ï¼Œä»¥åŠè¿™ä¸ª <code>Promise</code> å¯¹è±¡å³å°†è¢«ç»‘å®šçš„ä¸¤ä¸ªå¤„ç†å‡½æ•° <code>onFulfilled</code> å’Œ <code>onRejected</code>ï¼ˆå€¼å°±æ˜¯è°ƒç”¨ <code>then(onFulfilled, onRejected)</code> æ—¶ä¼ é€’çš„ä¸¤ä¸ªå‚æ•°ï¼‰ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºè°ƒç”¨è¿™ä¸ª <code>then</code> è¿”å›çš„æ–° <code>Promise</code> å¯¹è±¡ <code>resultPromiseOrCapability</code>ã€‚</p> 
 <p>PerformPromiseThenImpl æºç å¦‚ä¸‹<sup>[9]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">transitioningÂ macroÂ PerformPromiseThenImpl(implicitÂ context:Â Context)(
Â Â Â Â promise:Â JSPromise,Â 
Â Â Â onFulfilled:Â Callable|Undefined,
Â Â Â Â onRejected:Â Callable|Undefined,
Â Â Â Â resultPromiseOrCapability:Â JSPromise|PromiseCapability|Undefined):Â voidÂ {
Â Â ifÂ (promise.Status()Â ==Â PromiseState::kPending)Â {
Â Â Â Â //Â pendingÂ çŠ¶æ€çš„åˆ†æ”¯
Â Â Â Â //Â å¦‚æœå½“å‰Â PromiseÂ è¿˜æ˜¯Â pendingÂ çŠ¶æ€
Â Â Â Â //Â é‚£ä¹ˆåªéœ€è¦å°†æœ¬æ¬¡Â thenÂ ç»‘å®šçš„å¤„ç†å‡½æ•°å­˜å‚¨èµ·æ¥å³å¯
Â Â Â Â constÂ handlerContextÂ =Â ExtractHandlerContext(onFulfilled,Â onRejected);
Â Â Â Â //Â æ‹¿åˆ°Â PromiseÂ çš„Â reactions_or_resultÂ å­—æ®µ
Â Â Â Â constÂ promiseReactionsÂ =
Â Â Â Â Â Â Â Â UnsafeCast&lt;(ZeroÂ |Â PromiseReaction)&gt;(promise.reactions_or_result);
Â Â Â Â //Â è€ƒè™‘ä¸€ä¸ªÂ PromiseÂ å¯èƒ½ä¼šæœ‰å¤šä¸ªÂ thenÂ çš„æƒ…å†µ
Â Â Â Â //Â reactionÂ æ˜¯ä¸ªé“¾è¡¨ï¼Œæ¯æ¬¡ç»‘å®šå¤„ç†å‡½æ•°éƒ½åœ¨é“¾è¡¨çš„å¤´éƒ¨æ’å…¥
Â Â Â Â //Â å­˜Â PromiseÂ çš„æ‰€æœ‰å¤„ç†å‡½æ•°
Â Â Â Â constÂ reactionÂ =Â NewPromiseReaction(
Â Â Â Â Â Â Â Â handlerContext,Â promiseReactions,Â resultPromiseOrCapability,
Â Â Â Â Â Â Â Â onFulfilled,Â onRejected);
Â Â Â Â //Â reactions_or_resultÂ å¯ä»¥å­˜Â PromiseÂ çš„å¤„ç†å‡½æ•°çš„é“¾è¡¨ï¼Œä¹Ÿå¯ä»¥å­˜
Â Â Â Â //Â PromiseÂ çš„æœ€ç»ˆç»“æœï¼Œå› ä¸ºç°åœ¨Â PromiseÂ å¤„äºÂ pendingÂ çŠ¶æ€ï¼Œ
Â Â Â Â //Â æ‰€ä»¥å­˜çš„æ˜¯å¤„ç†å‡½æ•°Â reactionÂ æ„æˆçš„é“¾è¡¨
Â Â Â Â promise.reactions_or_resultÂ =Â reaction;
Â Â }Â elseÂ {
Â Â Â Â //Â fulfilledÂ å’ŒÂ rejectedÂ çŠ¶æ€çš„åˆ†æ”¯
Â Â Â Â constÂ reactionsOrResultÂ =Â promise.reactions_or_result;
Â Â Â Â letÂ microtask:Â PromiseReactionJobTask;
Â Â Â Â letÂ handlerContext:Â Context;
Â Â Â Â //Â fulfilledÂ åˆ†æ”¯
Â Â Â Â ifÂ (promise.Status()Â ==Â PromiseState::kFulfilled)Â {
Â Â Â Â Â Â handlerContextÂ =Â ExtractHandlerContext(onFulfilled,Â onRejected);
Â Â Â Â Â Â //Â ç”ŸæˆÂ microtaskÂ ä»»åŠ¡
Â Â Â Â Â Â microtaskÂ =Â NewPromiseFulfillReactionJobTask(
Â Â Â Â Â Â Â Â Â Â handlerContext,Â reactionsOrResult,Â onFulfilled,
Â Â Â Â Â Â Â Â Â Â resultPromiseOrCapability);
Â Â Â Â }Â elseÂ //Â rejectedÂ åˆ†æ”¯
Â Â Â Â Â Â deferredÂ {
Â Â Â Â Â Â Â Â assert(promise.Status()Â ==Â PromiseState::kRejected);
Â Â Â Â Â Â Â Â handlerContextÂ =Â ExtractHandlerContext(onRejected,Â onFulfilled);
Â Â Â Â Â Â Â //Â ç”ŸæˆÂ microtaskÂ ä»»åŠ¡
Â Â Â Â Â Â Â Â microtaskÂ =Â NewPromiseRejectReactionJobTask(
Â Â Â Â Â Â Â Â Â Â Â Â handlerContext,Â reactionsOrResult,Â onRejected,
Â Â Â Â Â Â Â Â Â Â Â Â resultPromiseOrCapability);
Â Â Â Â Â Â Â //Â å¦‚æœå½“å‰Â promiseÂ è¿˜æœªç»‘å®šè¿‡å¤„ç†å‡½æ•°
Â Â Â Â Â Â Â Â ifÂ (!promise.HasHandler())Â {
Â Â Â Â Â Â Â Â Â Â //Â è§„èŒƒä¸­çš„Â HostPromiseRejectionTracker(promise,Â "reject")ï¼Œ
Â Â Â Â Â Â Â Â Â Â //Â ä½œç”¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ£€æµ‹çš„Â microtaskÂ ä»»åŠ¡ï¼Œåé¢ä¼šå•ç‹¬ä»‹ç»ã€‚
Â Â Â Â Â Â Â Â Â Â runtime::PromiseRevokeReject(promise);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â //Â å³ä½¿è°ƒç”¨Â thenÂ æ–¹æ³•æ—¶Â promiseÂ å·²ç»å¤„äºÂ fulfilledÂ æˆ–Â rejectedÂ çŠ¶æ€ï¼Œ
Â Â Â Â //Â thenÂ æ–¹æ³•çš„Â onFulfilledÂ æˆ–Â onRejectedÂ å‚æ•°ä¹Ÿä¸ä¼šç«‹åˆ»æ‰§è¡Œï¼Œ
Â Â Â Â //Â è€Œæ˜¯è¿›å…¥Â microtaskÂ é˜Ÿåˆ—åæ‰§è¡Œ
Â Â Â Â EnqueueMicrotask(handlerContext,Â microtask);
Â Â }
Â Â promise.SetHasHandler();
}</code></pre> 
 <h4>PerformPromiseThenImpl å‡½æ•°çš„ pending åˆ†æ”¯</h4> 
 <p>PerformPromiseThenImpl æœ‰ä¸‰ä¸ªåˆ†æ”¯ï¼Œåˆ†åˆ«å¯¹åº” Promise çš„ä¸‰ä¸ªçŠ¶æ€ï¼Œå½“è¢«è°ƒç”¨ then æ–¹æ³•çš„ Promise å¤„äº pending çŠ¶æ€æ—¶åˆ™è¿›å…¥ pendingåˆ†æ”¯ã€‚pending åˆ†æ”¯è°ƒç”¨ <code>NewPromiseReaction</code> å‡½æ•°ï¼Œåœ¨æ¥æ”¶åˆ°çš„ onFulfilled å’Œ onRejected å‚æ•°çš„åŸºç¡€ä¸Šï¼Œç”Ÿæˆ <code>PromiseReaction</code> å¯¹è±¡ï¼Œå­˜å‚¨ Promise çš„å¤„ç†å‡½æ•°ï¼Œå¹¶èµ‹å€¼ç»™ <code>JSPromise</code> çš„ <code>reactions_or_result</code> å­—æ®µï¼Œç„¶åè°ƒç”¨ <code>promise.SetHasHandler()</code> å°† <code>has_handler</code> è®¾ç½®ä¸º <code>true</code>ï¼ˆè¡¨ç¤ºè¿™ä¸ª Promise å¯¹è±¡å·²ç»ç»‘å®šäº†å¤„ç†å‡½æ•°ï¼‰</p> 
 <p>è€ƒè™‘ä¸€ä¸ª Promise å¯ä»¥ä¼šè¿ç»­è°ƒç”¨å¤šä¸ª then çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š</p> 
 <pre class="has"><code class="language-go">constÂ pÂ =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â setTimeout(_Â =&gt;Â {
Â Â Â Â resolve('myÂ codeÂ delayÂ 2000Â ms')Â 
Â Â },Â 2000)
})

p.then(resultÂ =&gt;Â {
Â Â console.log('ç¬¬Â 1Â ä¸ªÂ then')
})

p.then(resultÂ =&gt;Â {
Â Â console.log('ç¬¬Â 2Â ä¸ªÂ then')
})</code></pre> 
 <p>p è°ƒç”¨äº†ä¸¤æ¬¡ then æ–¹æ³•ï¼Œæ¯ä¸ª then æ–¹æ³•éƒ½ä¼šç”Ÿæˆä¸€ä¸ª <code>PromiseReaction</code> å¯¹è±¡ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ then æ–¹æ³•æ—¶ç”Ÿæˆå¯¹è±¡ PromiseReaction1ï¼Œæ­¤æ—¶ p çš„ <code>reactions_or_result</code> å­˜çš„æ˜¯ PromiseReaction1ã€‚</p> 
 <p>ç¬¬äºŒæ¬¡è°ƒç”¨ then æ–¹æ³•æ—¶ç”Ÿæˆå¯¹è±¡ PromiseReaction2ï¼Œè°ƒç”¨ <code>NewPromiseReaction</code> å‡½æ•°æ—¶ï¼Œ<code>PromiseReaction2.next = PromiseReaction1</code>ï¼ŒPromiseReaction1 å˜æˆäº† PromiseReaction2 çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæœ€å p çš„ <code>reactions_or_result</code> å­˜çš„æ˜¯ PromiseReaction2ã€‚PromiseReaction2 åè¿›å…¥ Promise å¤„ç†å‡½æ•°çš„é“¾è¡¨ï¼Œå´æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚<code>NewPromiseReaction</code> å‡½æ•°æºç å¦‚ä¸‹<sup>[10]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">macroÂ NewPromiseReaction(implicitÂ context:Â Context)(
Â Â Â Â handlerContext:Â Context,Â next:Â Zero|PromiseReaction,
Â Â Â Â promiseOrCapability:Â JSPromise|PromiseCapability|Undefined,
Â Â Â Â fulfillHandler:Â Callable|Undefined,
Â Â Â Â rejectHandler:Â Callable|Undefined):Â PromiseReactionÂ {
Â Â constÂ nativeContextÂ =Â LoadNativeContext(handlerContext);
Â Â returnÂ newÂ PromiseReaction{
Â Â Â Â map:Â PromiseReactionMapConstant(),
Â Â Â Â next:Â next,Â //Â nextÂ å­—æ®µå­˜çš„æ˜¯é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
Â Â Â Â reject_handler:Â rejectHandler,//Â å¤±è´¥å¤„ç†å‡½æ•°
Â Â Â Â fulfill_handler:Â fulfillHandler,//Â æˆåŠŸå¤„ç†å‡½æ•°
Â Â Â Â promise_or_capability:Â promiseOrCapability,//Â äº§ç”Ÿçš„æ–°Promiseå¯¹è±¡
Â Â Â Â continuation_preserved_embedder_data:Â nativeContext
Â Â Â Â Â Â Â Â [NativeContextSlot::CONTINUATION_PRESERVED_EMBEDDER_DATA_INDEX]
Â Â };
}</code></pre> 
 <p>åœ¨ p å¤„äº pending çŠ¶æ€æ—¶ï¼Œp çš„ reactions_or_result å­—æ®µå¤§è‡´å†…å®¹å¦‚ä¸‹å›¾ã€‚</p> 
 <blockquote> 
  <p><strong>ä¸‹å›¾ä¸æ˜¯ microtask é˜Ÿåˆ—ï¼Œä¸‹å›¾ä¸æ˜¯ microtask é˜Ÿåˆ—ï¼Œä¸‹å›¾ä¸æ˜¯ microtask é˜Ÿåˆ—ã€‚</strong></p> 
 </blockquote> 
 <img src="https://images2.imgbox.com/eb/70/eeDqk0Sb_o.jpg" alt="44e0232af84f84cb0fae8801cb5d6b05.jpeg"> 
 <figcaption>
   reactions 
 </figcaption> 
 <blockquote> 
  <p>å›¾ä¸­ä½¿ç”¨ onFulfilled ä»£æ›¿ fulfill_handler æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼ŒonRejectedä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸”åªåŒ…å«äºå½“å‰å†…å®¹ç›¸å…³çš„å­—æ®µï¼Œä¸ç”¨å¤ªè¿‡äºçº ç»“ã€‚</p> 
 </blockquote> 
 <h4>PerformPromiseThenImpl å‡½æ•°çš„ fulfilled åˆ†æ”¯</h4> 
 <p>fulfilled åˆ†æ”¯é€»è¾‘åˆ™ç®€å•çš„å¤šï¼Œå¤„ç†çš„æ˜¯å½“ Promise å¤„äº fulfilled çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ then æ–¹æ³•çš„é€»è¾‘ï¼š</p> 
 <p>å…ˆè°ƒç”¨ <code>NewPromiseFulfillReactionJobTask</code> ç”Ÿæˆ <code>microtask</code>ï¼Œç„¶å <code>EnqueueMicrotask(handlerContext, microtask)</code> å°†åˆšæ‰ç”Ÿæˆçš„ <code>microtask</code> æ”¾å…¥ <code>microtask é˜Ÿåˆ—</code>ï¼Œæœ€åè°ƒç”¨ <code>promise.SetHasHandler()</code> å°† <code>has_handler</code> è®¾ç½®ä¸º <code>true</code>ã€‚</p> 
 <pre class="has"><code class="language-go">newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â resolve()
}).then(resultÂ =&gt;Â {
Â Â console.log('è¿›å…¥Â microtaskÂ é˜Ÿåˆ—åæ‰§è¡Œ')
})

console.log('åŒæ­¥æ‰§è¡Œç»“æŸ')
//Â æœ¬æ®µä»£ç çš„æ‰“å°é¡ºåºæ˜¯:
//Â åŒæ­¥æ‰§è¡Œç»“æŸ
//Â è¿›å…¥Â microtaskÂ é˜Ÿåˆ—åæ‰§è¡Œ</code></pre> 
 <p>å°½ç®¡è°ƒç”¨ then æ–¹æ³•æ—¶ï¼ŒPromise å·²ç»å¤„äº fulfilled çŠ¶æ€ï¼Œä½† then æ–¹æ³•çš„ onFulfilled å›è°ƒå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿›å…¥ microtask é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œã€‚</p> 
 <h4>PerformPromiseThenImpl å‡½æ•°çš„ rejected åˆ†æ”¯</h4> 
 <p>rejected åˆ†æ”¯é€»è¾‘ä¸ fulfilled åˆ†æ”¯çš„é€»è¾‘å¤§è‡´ç›¸åŒï¼Œä½†æ˜¯ rejected åˆ†æ”¯ä¸­å°† onRejected å¤„ç†å‡½æ•°åŠ å…¥ microtask é˜Ÿåˆ—ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­å½“å‰ promise æ˜¯å¦å·²ç»å­˜åœ¨å¤„ç†å‡½æ•°ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™ä¼šå…ˆè°ƒç”¨ <code>runtime::PromiseRevokeReject(promise)</code>ï¼Œæœ€åè°ƒç”¨ <code>promise.SetHasHandler()</code> å°† <code>has_handler</code> è®¾ç½®ä¸º <code>true</code>ã€‚</p> 
 <pre class="has"><code class="language-go">ifÂ (!promise.HasHandler())Â {
Â Â Â Â Â Â Â runtime::PromiseRevokeReject(promise);
Â Â Â }</code></pre> 
 <p>è¿™é‡Œçš„<code>runtime::PromiseRevokeReject(promise)</code> å°±æ˜¯ ECMAScript è§„èŒƒ<sup>[11]</sup> ä¸­çš„ <code>HostPromiseRejectionTracker(promise, "handle")</code>ï¼Œ<code>HostPromiseRejectionTracker</code> æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¿™è¡¨ç¤ºæ²¡æœ‰è§„å®šå®ƒçš„å…·ä½“çš„é€»è¾‘ã€‚å¤§è‡´çš„ä½œç”¨æ˜¯æ ‡è®°ä¸€ä¸‹ <code>promise</code> å·²ç»ç»‘å®šäº† <code>rejected</code> çŠ¶æ€çš„å¤„ç†å‡½æ•°ã€‚ä¸ç”¨ç–‘æƒ‘ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œåé¢ä¼šå•ç‹¬é‡ç‚¹è¯´ã€‚</p> 
 <blockquote> 
  <p>æ³¨æ„ 1 HostPromiseRejectionTracker åœ¨ä¸¤ç§æƒ…å†µä¸‹è¢«è°ƒç”¨ï¼š</p> 
  <p>å½“ä¸€ä¸ª promise åœ¨æ²¡æœ‰ä»»ä½•å¤„ç†ç¨‹åºçš„æƒ…å†µä¸‹è¢«æ‹’ç»æ—¶ï¼Œå®ƒçš„æ“ä½œå‚æ•°è®¾ç½®ä¸ºâ€œrejectâ€ã€‚</p> 
  <p>å½“ç¬¬ä¸€æ¬¡å°†å¤„ç†ç¨‹åºæ·»åŠ åˆ°è¢«æ‹’ç»çš„ Promise ä¸­æ—¶ï¼Œå°†è°ƒç”¨å®ƒå¹¶å°†å…¶æ“ä½œå‚æ•°è®¾ç½®ä¸ºâ€œhandleâ€ã€‚</p> 
  <p>å¼•è‡³ â€”â€”ECMAScript è§„èŒƒ<sup>[12]</sup>(ä½œè€…ç¿»è¯‘)</p> 
 </blockquote> 
 <h4>å°ç»“</h4> 
 <ol><li><p>å½“ä¸€ä¸ª Promise è¢«è°ƒç”¨ then æ–¹æ³•æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ <code>resultPromise</code></p></li><li><p>ç„¶åæ ¹æ®å½“å‰ <code>promise</code> çš„ä¸åŒçŠ¶æ€æ‰§è¡Œä¸åŒçš„é€»è¾‘</p></li></ol> 
 <ul><li><p>pendingçŠ¶æ€ï¼šä¼šå°† <code>then</code> ä¼ é€’çš„ä¸¤ä¸ªå¤„ç†å‡½æ•°å˜æˆä¸€ä¸ª <code>PromiseReaction</code> èŠ‚ç‚¹æ’å…¥åˆ°<code>promise.reactions_or_result</code> å¤´éƒ¨ï¼ˆ<code>PromiseReaction</code>æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼‰ï¼Œè¿™ä¸ªæ­¥éª¤å°±æ˜¯åœ¨æœé›†ä¾èµ–ï¼Œç­‰å¾… <code>promise</code> çŠ¶æ€å®Œæˆæ—¶å†è§¦å‘ã€‚</p></li><li><p>fulfilledçŠ¶æ€ï¼šä¼šåˆ›å»ºä¸€ä¸ª microtask æ¥è°ƒç”¨ä¼ å…¥çš„ onFulfilled å¤„ç†å‡½æ•°ï¼Œå¹¶å°† reactions_or_result ä½œä¸ºè°ƒç”¨çš„å‚æ•°ï¼ˆæ­¤æ—¶ <code>reactions_or_result</code> æ˜¯ <code>promise</code> çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ <code>resolve</code> æ—¶ä¼ å…¥çš„å‚æ•° <code>value</code> ï¼‰ï¼Œå¹¶å°†å…¶æ’å…¥ microtask é˜Ÿåˆ—ã€‚</p></li><li><p>rejectedçŠ¶æ€ï¼šä¸ fulfilled çŠ¶æ€ç±»ä¼¼ï¼Œä¼šå°†åˆ›å»ºä¸€ä¸ª microtask æ¥è°ƒç”¨ä¼ å…¥çš„ <code>onRejected</code> å¤„ç†å‡½æ•°ï¼Œå¹¶å°† <code>reactions_or_result</code> ä½œä¸ºè°ƒç”¨çš„å‚æ•°ï¼Œå¦‚æœå½“å‰ Promise ä¸å­˜åœ¨å¤„ç†å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ fulfilled çŠ¶æ€çš„Promsie é¦–æ¬¡è¢«è°ƒç”¨ then æ–¹æ³•ï¼‰ï¼Œä¼šå°†å…¶æ ‡è®°ä¸ºå·²ç»ç»‘å®š <code>onRejected</code> å‡½æ•°ï¼Œç„¶åå°†å…¶ microtask æ’å…¥ microtask é˜Ÿåˆ—ã€‚</p></li></ul> 
 <p>è°ƒç”¨ <code>promise.SetHasHandler()</code> å°† Promise çš„ <code>has_handler</code> è®¾ç½®ä¸º <code>true</code>ï¼Œè¡¨ç¤ºå…¶è¢«è°ƒç”¨çš„ then æ–¹æ³•ç»‘å®šäº†å¤„ç†å‡½æ•°ã€‚</p> 
 <p>æœ€åè¿”å›æ–°çš„ Promise å¯¹è±¡ã€‚</p> 
 <blockquote> 
  <p>å†æ¥å›é¡¾ä¸€ä¸‹ <code>reactions_or_result</code> çš„3ä¸ªå€¼çŠ¶æ€ï¼ˆç©ºã€é“¾è¡¨ã€promiseçš„å€¼ï¼‰:</p> 
  <p>å½“ promise åˆšåˆšè¢«åˆ›å»ºæ—¶ï¼Œreactions_or_resultçš„å€¼çš„ç©ºï¼Œ</p> 
  <p>å½“promiseçš„çŠ¶æ€æ”¹å˜ä¸º <code>fulfilled</code>/<code>rejected</code> æ—¶ï¼Œå…¶å€¼æ˜¯è°ƒç”¨å¯¹åº” <code>resolve(value)</code>/<code>reject(value)</code> å‡½æ•°ä¼ å…¥çš„å‚æ•° <code>value</code>ï¼Œä¹Ÿå°±æ˜¯ <code>promise</code> çš„å€¼ã€‚</p> 
  <p>å½“ promise ä¸º pending çŠ¶æ€ä¸”è¢«è°ƒç”¨ <code>then</code> åï¼Œ<code>reactions_or_result</code> ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨çš„æ¯ä¸€é¡¹å­˜å‚¨çš„æ˜¯è°ƒç”¨ <code>then</code> æ—¶ä¼ å…¥çš„å¤„ç†å‡½æ•°ã€‚</p> 
 </blockquote> 
 <h3>reslove</h3> 
 <pre class="has"><code class="language-go">newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â setTimeout(_Â =&gt;Â resolve('fulfilled'),Â 5000)
}).then(valueÂ =&gt;Â {
Â Â console.log(value)
},Â reasonÂ =&gt;Â {
Â Â console.log('rejected')
})</code></pre> 
 <p>ä¸Šè¿°ä»£ç  5s åæ‰§è¡Œ resolve å‡½æ•°ï¼Œæ§åˆ¶å°æ‰“å° fulfilledã€‚</p> 
 <h4>FulfillPromise</h4> 
 <p>ECMAScript è§„èŒƒ<sup>[13]</sup></p> 
 <p><code>reslove(value)</code> å°±æ˜¯è§„èŒƒä¸­çš„ <code>FulfillPromise(promise, value)</code> å‡½æ•°ï¼Œä»–çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ª Promise çš„çŠ¶æ€ç”± pending æ”¹å˜ä¸º fulfilledï¼Œå¹¶ä¸”å°†è¿™ä¸ª Promise çš„æ‰€æœ‰å¤„ç†å‡½æ•°éƒ½å˜æˆ microtask åŠ å…¥åˆ° microtask é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚</p> 
 <p>resolve å‡½æ•°å½’æ ¹åˆ°åº•è°ƒç”¨äº† V8 çš„ FulfillPromise å‡½æ•°ï¼Œæºç å¦‚ä¸‹<sup>[14]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">//Â https://tc39.es/ecma262/#sec-fulfillpromise
transitioningÂ builtin
FulfillPromise(implicitÂ context:Â Context)(
Â Â Â Â promise:Â JSPromise,Â value:Â JSAny):Â UndefinedÂ {
Â Â //Â æ–­æ¡ˆå½“å‰promiseçŠ¶æ€ä¸€å®šæ˜¯Â pendingï¼Œå› ä¸ºpromiseÂ çš„çŠ¶æ€æ”¹å˜æ˜¯ä¸å¯é€†çš„
Â Â assert(promise.Status()Â ==Â PromiseState::kPending);

Â Â //Â å–Â PromiseÂ çš„å¤„ç†å‡½æ•°ï¼Œåœ¨è¿™ä¹‹å‰Â PromiseÂ çš„çŠ¶æ€è¿˜æ˜¯Â pending
Â Â //Â æ‰€ä»¥Â reactions_or_resultÂ ä¸­å­˜çš„æ˜¯Â reactionsÂ é“¾è¡¨ï¼Œ
Â Â //Â reactionsÂ èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯é‡Œå‡½æ•°
Â Â constÂ reactionsÂ =
Â Â Â Â Â Â UnsafeCast&lt;(ZeroÂ |Â PromiseReaction)&gt;(promise.reactions_or_result);

Â Â //Â PromiseÂ éœ€è¦ä¿®æ”¹ä¸ºÂ fulfilledÂ çŠ¶æ€ï¼Œæ‰€ä»¥Â reactions_or_resultÂ å­˜å‚¨çš„
Â Â //Â ä¸å†æ˜¯å¤„ç†å‡½æ•°ï¼Œè€Œæ˜¯Â PromiseÂ çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨Â resolveÂ æ—¶ä¼ å…¥çš„å‚æ•°
Â Â promise.reactions_or_resultÂ =Â value;

Â Â //Â è®¾ç½®Â PromiseÂ çš„çŠ¶æ€ä¸ºÂ fulfilled
Â Â promise.SetStatus(PromiseState::kFulfilled);

Â Â //Â PromiseÂ çš„å¤„ç†å‡½æ•°ï¼ŒPromiseÂ çš„ç»“æœéƒ½æ‹¿åˆ°äº†ï¼Œå¼€å§‹æ­£å¼å¤„ç†
Â Â TriggerPromiseReactions(reactions,Â value,Â kPromiseReactionFulfill);
Â Â returnÂ Undefined;
}</code></pre> 
 <p><code>FulfillPromise</code> çš„é€»è¾‘æ˜¯è·å– Promise çš„å¤„ç†å‡½æ•°åˆ° <code>reactions</code>ï¼Œ<code>reactions</code> çš„ç±»å‹æ˜¯ <code>PromiseReaction</code>ï¼Œæ˜¯ä¸ªé“¾è¡¨ï¼Œå¿˜è®°çš„åŒå­¦å¯ä»¥å›çœ‹ä¸Šé¢çš„é‚£å¼ é“¾è¡¨å›¾ç‰‡ï¼›è®¾ç½®<code> promise</code> çš„ <code>reactions_or_result</code> ä¸º <code>value</code>ï¼Œè¿™ä¸ª <code>value</code> å°±æ˜¯ JavaScript å±‚ä¼ ç»™ <code>resolve</code> çš„å‚æ•°ï¼›è°ƒç”¨ <code>promise.SetStatus(PromiseState::kFulfilled)</code> è®¾ç½® <code>promise</code> çš„çŠ¶æ€ä¸º <code>fulfilled</code>ï¼Œæœ€åè°ƒç”¨ <code>TriggerPromiseReactions</code> æ¥å°† <code>reactions</code> ä¸­çš„å¤„ç†å‡½æ•°æ·»åŠ åˆ° microtask é˜Ÿåˆ—ã€‚</p> 
 <h4>TriggerPromiseReactions</h4> 
 <p>æºç å¦‚ä¸‹<sup>[15]</sup>ï¼š</p> 
 <pre class="has"><code class="language-go">//Â https://tc39.es/ecma262/#sec-triggerpromisereactions
transitioningÂ macroÂ TriggerPromiseReactions(implicitÂ context:Â Context)(
Â Â Â Â reactions:Â Zero|PromiseReaction,Â argument:Â JSAny,
Â Â Â Â reactionType:Â constexprÂ PromiseReactionType):Â voidÂ {
Â Â //Â WeÂ needÂ toÂ reverseÂ theÂ {reactions}Â here,Â sinceÂ weÂ recordÂ themÂ onÂ the
Â Â //Â JSPromiseÂ inÂ theÂ reverseÂ order.
Â Â letÂ currentÂ =Â reactions;
Â Â letÂ reversed:Â Zero|PromiseReactionÂ =Â kZero;
Â Â //Â é“¾è¡¨åè½¬
Â Â whileÂ (true)Â {
Â Â Â Â typeswitchÂ (current)Â {
Â Â Â Â Â Â caseÂ (Zero):Â {
Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â }
Â Â Â Â Â Â caseÂ (currentReaction:Â PromiseReaction):Â {
Â Â Â Â Â Â Â Â currentÂ =Â currentReaction.next;
Â Â Â Â Â Â Â Â currentReaction.nextÂ =Â reversed;
Â Â Â Â Â Â Â Â reversedÂ =Â currentReaction;
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
Â Â currentÂ =Â reversed;
Â Â //Â é“¾è¡¨åè½¬åï¼Œè°ƒç”¨Â MorphAndEnqueuePromiseReaction
Â Â //Â æŠŠé“¾æ¥ä¸­çš„æ¯ä¸€é¡¹éƒ½è¿›å…¥Â microtaskÂ é˜Ÿåˆ—
Â Â whileÂ (true)Â {
Â Â Â Â typeswitchÂ (current)Â {
Â Â Â Â Â Â caseÂ (Zero):Â {
Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â }
Â Â Â Â Â Â caseÂ (currentReaction:Â PromiseReaction):Â {
Â Â Â Â Â Â Â Â currentÂ =Â currentReaction.next;
Â Â Â Â Â Â Â Â MorphAndEnqueuePromiseReaction(currentReaction,Â argument,Â reactionType);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}</code></pre> 
 <p><code>TriggerPromiseReactions</code> åšäº†ä¸¤ä»¶äº‹ï¼š</p> 
 <ul><li><p>åè½¬ <code>reactions</code> é“¾è¡¨ï¼Œå‰æ–‡æœ‰åˆ†æè¿‡ then æ–¹æ³•çš„å®ç°ï¼Œthen æ–¹æ³•çš„å‚æ•°æœ€ç»ˆå­˜åœ¨é“¾è¡¨ä¸­ã€‚æœ€åè¢«è°ƒç”¨çš„ then æ–¹æ³•ï¼Œå®ƒæ¥æ”¶çš„å‚æ•°è¢«åŒ…è£…åä¼šä½äºé“¾è¡¨çš„å¤´éƒ¨ï¼Œè¿™ä¸ç¬¦åˆè§„èŒƒï¼Œæ‰€ä»¥éœ€è¦åè½¬</p></li><li><p>éå† <code>reactions</code> å¯¹è±¡ï¼Œè°ƒç”¨ MorphAndEnqueuePromiseReaction å°†æ¯ä¸ªå…ƒç´ æ”¾å…¥ microtask é˜Ÿåˆ—</p></li></ul> 
 <h4>MorphAndEnqueuePromiseReaction</h4> 
 <p>MorphAndEnqueuePromiseReaction<sup>[16]</sup> å°† PromiseReaction è½¬ä¸º microtaskï¼Œæœ€ç»ˆæ’å…¥ microtask é˜Ÿåˆ—ï¼Œmorph æœ¬èº«æœ‰è½¬å˜/è½¬åŒ–çš„æ„æ€ï¼Œæ¯”å¦‚ Polymorphism (å¤šæ€)ã€‚</p> 
 <p>MorphAndEnqueuePromiseReaction æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼ŒPromiseReaction æ˜¯å‰é¢æåˆ°çš„åŒ…è£…äº† Promise å¤„ç†å‡½æ•°çš„é“¾è¡¨å¯¹è±¡ï¼Œargument æ˜¯ resolve/reject çš„å‚æ•°ï¼ŒreactionType è¡¨ç¤º Promise æœ€ç»ˆçš„çŠ¶æ€ï¼Œfulfilled çŠ¶æ€å¯¹åº”çš„å€¼æ˜¯ kPromiseReactionFulfillï¼Œrejected çŠ¶æ€å¯¹åº”çš„å€¼æ˜¯ kPromiseReactionRejectã€‚</p> 
 <p>MorphAndEnqueuePromiseReaction çš„é€»è¾‘å¾ˆç®€å•ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»çŸ¥é“äº† Promise çš„æœ€ç»ˆçŠ¶æ€ï¼Œæ‰€ä»¥å¯ä»¥ä» promiseReaction å¯¹è±¡å¾—åˆ° promiseReactionJobTask å¯¹è±¡ï¼ŒpromiseReactionJobTask çš„å˜é‡å‘½åä¸ ECMAScript è§„èŒƒç›¸å…³æè¿°ä¸€è„‰ç›¸æ‰¿ï¼Œå…¶å®å°±æ˜¯ä¼ è¯´ä¸­çš„ microtaskã€‚MorphAndEnqueuePromiseReaction æºç å¦‚ä¸‹ï¼Œä»…ä¿ç•™äº†å’Œæœ¬å°èŠ‚ç›¸å…³çš„å†…å®¹ã€‚</p> 
 <pre class="has"><code class="language-go">transitioningÂ macroÂ MorphAndEnqueuePromiseReaction(implicitÂ context:Â Context)(
Â Â Â Â promiseReaction:Â PromiseReaction,Â argument:Â JSAny,
Â Â Â Â reactionType:Â constexprÂ PromiseReactionType):Â voidÂ {
Â Â letÂ primaryHandler:Â Callable|Undefined;
Â Â letÂ secondaryHandler:Â Callable|Undefined;
Â Â //Â æ ¹æ®ä¸åŒçš„Â PromiseÂ çŠ¶æ€é€‰å–ä¸åŒçš„å›è°ƒæ‰§è¡Œ
Â Â ifÂ constexprÂ (reactionTypeÂ ==Â kPromiseReactionFulfill)Â {
Â Â Â Â primaryHandlerÂ =Â promiseReaction.fulfill_handler;
Â Â Â Â secondaryHandlerÂ =Â promiseReaction.reject_handler;
Â Â }Â elseÂ {
Â Â Â Â primaryHandlerÂ =Â promiseReaction.reject_handler;
Â Â Â Â secondaryHandlerÂ =Â promiseReaction.fulfill_handler;
Â Â }
Â Â constÂ handlerContext:Â ContextÂ =
Â Â Â Â Â Â ExtractHandlerContext(primaryHandler,Â secondaryHandler);
Â Â ifÂ constexprÂ (reactionTypeÂ ==Â kPromiseReactionFulfill)Â {//Â fulfilledÂ åˆ†æ”¯
Â Â Â Â *Â UnsafeConstCast(&amp;Â promiseReaction.map)Â =
Â Â Â Â Â Â Â Â PromiseFulfillReactionJobTaskMapConstant();
Â Â Â Â constÂ promiseReactionJobTaskÂ =
Â Â Â Â Â Â Â Â UnsafeCast&lt;PromiseFulfillReactionJobTask&gt;(promiseReaction);
Â Â Â Â //Â argumentÂ æ˜¯Â rejectÂ çš„å‚æ•°
Â Â Â Â promiseReactionJobTask.argumentÂ =Â argument;
Â Â Â Â //Â handlerÂ æ˜¯Â JSÂ å±‚é¢Â thenÂ æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ–Â catchÂ æ–¹æ³•çš„å‚æ•°
Â Â Â Â promiseReactionJobTask.contextÂ =Â handlerContext;
Â Â Â Â //Â promiseReactionJobTaskÂ å°±æ˜¯é‚£ä¸ªå·¥ä½œä¸­ç»å¸¸è¢«åå¤æèµ·çš„Â microtask
Â Â Â Â //Â EnqueueMicrotaskÂ å°†Â microtaskÂ æ’å…¥Â microtaskÂ é˜Ÿåˆ—
Â Â Â Â EnqueueMicrotask(handlerContext,Â promiseReactionJobTask);
Â Â Â Â //Â åˆ é™¤
Â Â }Â elseÂ {//Â rejectedÂ åˆ†æ”¯
Â Â Â Â Â Â //Â é€»è¾‘ä¸Â fulfilledÂ åˆ†æ”¯å‰é¢ä¸€è‡´
Â Â Â Â *Â UnsafeConstCast(&amp;Â promiseReaction.map)Â =
Â Â Â Â Â Â Â Â PromiseRejectReactionJobTaskMapConstant();
Â Â Â Â constÂ promiseReactionJobTaskÂ =
Â Â Â Â Â Â Â Â UnsafeCast&lt;PromiseRejectReactionJobTask&gt;(promiseReaction);
Â Â Â Â promiseReactionJobTask.argumentÂ =Â argument;
Â Â Â Â promiseReactionJobTask.contextÂ =Â handlerContext;
Â Â Â Â promiseReactionJobTask.handlerÂ =Â primaryHandler;
Â Â Â Â EnqueueMicrotask(handlerContext,Â promiseReactionJobTask);
Â Â }
}</code></pre> 
 <p>MorphAndEnqueuePromiseReaction çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ® Promise çš„çŠ¶æ€é€‰å– onFulfilled è¿˜æ˜¯ onRejected æ”¾åˆ° microtask é˜Ÿåˆ—å‡†å¤‡æ‰§è¡Œã€‚è¿™é‡Œèµ°çš„æ˜¯ fulfilled åˆ†æ”¯ï¼Œæ‰€ä»¥é€‰å–çš„æ˜¯ onFulfilledã€‚</p> 
 <pre class="has"><code class="language-go">constÂ myPromise4Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â setTimeout(_Â =&gt;Â {
Â Â Â Â resolve('myÂ codeÂ delayÂ 1000')Â 
Â Â },Â 1000)
})

myPromise4.then(resultÂ =&gt;Â {
Â Â console.log('ç¬¬Â 1Â ä¸ªÂ then')
})

myPromise4.then(resultÂ =&gt;Â {
Â Â console.log('ç¬¬Â 2Â ä¸ªÂ then')
})
//Â æ‰“å°é¡ºåºï¼š
//Â ç¬¬Â 1Â ä¸ªÂ then
//Â ç¬¬Â 2Â ä¸ªÂ then
//Â å¦‚æœæŠŠÂ TriggerPromiseReactionsÂ ä¸­é“¾è¡¨åè½¬çš„ä»£ç æ³¨é‡Šæ‰ï¼Œæ‰“å°é¡ºåºä¸º
//Â ç¬¬Â 2Â ä¸ªÂ then
//Â ç¬¬Â 1Â ä¸ªÂ then</code></pre> 
 <h4>å°ç»“</h4> 
 <p>resolve åªä¼šå¤„ç†çŠ¶æ€ä¸º pending çš„ Promiseï¼Œä¼šå°† Promise çš„ <code>reactions_or_result</code> è®¾ç½®ä¸ºä¼ å…¥çš„ <code>value</code>ï¼Œç”¨æ¥ä½œä¸º Promise çš„å€¼ï¼Œå¹¶ä¸”ä¼šå°† Promise çš„çŠ¶æ€ä¿®æ”¹ä¸º fulfilledã€‚</p> 
 <p>åœ¨è°ƒç”¨ resolve ä¹‹å‰ <code>reactions_or_result</code> å…¶å®æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå­˜å‚¨çš„æ˜¯å½“å‰ Promise çš„æ‰€æœ‰å¤„ç†å‡½æ•°ï¼Œå› ä¸º promise åœ¨ä½¿ç”¨ then æ”¶é›†ä¾èµ–æ—¶æ˜¯å°†æœ€æ–°çš„ä¾èµ–å­˜æ”¾åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦å…ˆå¯¹é“¾è¡¨è¿›è¡Œåè½¬ï¼Œç„¶åå°†å…¶æŒ¨ä¸ªæ”¾å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ</p> 
 <blockquote> 
  <p>resolve çš„ä¸»è¦å·¥ä½œæ˜¯éå†ä¸ŠèŠ‚è°ƒç”¨ then æ–¹æ³•æ—¶æ”¶é›†åˆ°çš„ä¾èµ–ï¼Œæ”¾å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚</p> 
 </blockquote> 
 <h3>reject</h3> 
 <p>reject ä¸ reslove æ²¡ä»€ä¹ˆå¤ªå¤§å·®åˆ«</p> 
 <p>ECMAScript è§„èŒƒ<sup>[17]</sup></p> 
 <pre class="has"><code class="language-go">newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â setTimeout(_Â =&gt;Â reject('rejected'),Â 5000)
}).then(_Â =&gt;Â {
Â Â console.log('fulfilled')
},Â reasonÂ =&gt;Â {
Â Â console.log(reason)
})</code></pre> 
 <p>ä¸Šè¿°ä»£ç  5s åæ‰§è¡Œ reject å‡½æ•°ï¼Œæ§åˆ¶å°æ‰“å° rejectedã€‚</p> 
 <h4>RejectPromise</h4> 
 <p>ECMAScript è§„èŒƒ<sup>[18]</sup></p> 
 <p><code>reject(season)</code> å‡½æ•°è°ƒç”¨äº† V8 çš„ <code>RejectPromise(promise, season)</code> å‡½æ•°ï¼Œæºç å¦‚ä¸‹<sup>[19]</sup> ï¼š</p> 
 <pre class="has"><code class="language-go">//Â https://tc39.es/ecma262/#sec-rejectpromise
transitioningÂ builtin
RejectPromise(implicitÂ context:Â Context)(
Â Â Â Â promise:Â JSPromise,Â reason:Â JSAny,Â debugEvent:Â Boolean):Â JSAnyÂ {
Â 
Â Â //Â å¦‚æœå½“å‰Â PromiseÂ æ²¡æœ‰ç»‘å®šå¤„ç†å‡½æ•°ï¼Œ
Â Â //Â åˆ™ä¼šè°ƒç”¨Â runtime::RejectPromise
Â Â ifÂ (IsPromiseHookEnabledOrDebugIsActiveOrHasAsyncEventDelegate()Â ||
Â Â Â Â Â Â !promise.HasHandler())Â {
Â Â Â Â returnÂ runtime::RejectPromise(promise,Â reason,Â debugEvent);
Â Â }
Â 
Â Â //Â å–å‡ºÂ PromiseÂ çš„å¤„ç†å¯¹è±¡Â PromiseReaction
Â Â constÂ reactionsÂ =
Â Â Â Â Â Â UnsafeCast&lt;(ZeroÂ |Â PromiseReaction)&gt;(promise.reactions_or_result);
Â Â //Â è¿™é‡Œçš„Â reasonÂ å°±æ˜¯Â rejectÂ å‡½æ•°çš„å‚æ•°
Â Â promise.reactions_or_resultÂ =Â reason;
Â Â //Â è®¾ç½®Â PromiseÂ çš„çŠ¶æ€ä¸ºÂ rejected
Â Â promise.SetStatus(PromiseState::kRejected);
Â Â //Â å°†Â PromiseÂ çš„å¤„ç†å‡½æ•°éƒ½æ·»åŠ åˆ°Â microtaskÂ é˜Ÿåˆ—
Â Â TriggerPromiseReactions(reactions,Â reason,Â kPromiseReactionReject);
Â Â returnÂ Undefined;
}</code></pre> 
 <h4>HostPromiseRejectionTracker</h4> 
 <p>ä¸ ReslovePromise ç›¸æ¯”ï¼ŒRejectPromise ä¸­å¤šå‡ºä¸€ä¸ªåˆ¤æ–­ Promsie æ˜¯å¦ç»‘å®šäº†å¤„ç†å‡½æ•°çš„åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰ç»‘å®šå¤„ç†å‡½æ•°åˆ™ä¼šå…ˆæ‰§è¡Œ <code>runtime::RejectPromise(promise, reason, debugEvent)</code>ï¼Œè¿™æ˜¯å…¶å®æ˜¯ ECMAScript è§„èŒƒä¸­çš„ <code>HostPromiseRejectionTracker(promise, "reject") </code>ï¼Œè¿™å·²ç»æ˜¯ç¬¬äºŒæ¬¡æåˆ° <code>HostPromiseRejectionTracker</code>äº†ã€‚</p> 
 <blockquote> 
  <p>åœ¨ <strong>PerformPromiseThenImpl å‡½æ•°çš„ rejected åˆ†æ”¯</strong> å¤„æœ‰æåˆ°è¿‡ä¸€æ¬¡ã€‚</p> 
 </blockquote> 
 <p>åœ¨ ECMAScript è§„èŒƒä¸­ HostPromiseRejectionTracker æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä»–ç”šè‡³æ²¡æœ‰æ˜ç¡®çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¥½åœ¨è§„èŒƒä¸­æè¿°äº†ä»–çš„ä½œç”¨ã€‚</p> 
 <p>HostPromiseRejectionTracker ç”¨äºè·Ÿè¸ª Promise çš„ rejectedï¼Œä¾‹å¦‚å…¨å±€çš„ <code>rejectionHandled</code> äº‹ä»¶å°±æ˜¯ç”±å®ƒå®ç°ã€‚</p> 
 <blockquote> 
  <p>æ³¨1 HostPromiseRejectionTracker åœ¨ä¸¤ç§æƒ…å†µä¸‹è¢«è°ƒç”¨ï¼š</p> 
  <p>å½“ä¸€ä¸ª Promise åœ¨æ²¡æœ‰ä»»ä½•å¤„ç†å‡½æ•°çš„æƒ…å†µä¸‹è¢«è°ƒç”¨ reject æ—¶ï¼Œè°ƒç”¨å®ƒå¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ â€œrejectâ€ã€‚</p> 
  <p>å½“ç¬¬ä¸€æ¬¡ä¸º rejected çŠ¶æ€çš„ Promise ç»‘å®šå¤„ç†å‡½æ•°æ—¶ï¼Œè°ƒç”¨å®ƒå¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ â€œhandleâ€ã€‚</p> 
 </blockquote> 
 <p>æ‰€ä»¥åœ¨è¿™é‡Œï¼Œå½“ä¼ é€’ <code>â€œhandleâ€</code> å°±ç›¸å¯¹äºä¸ºè¿™ä¸ª Promise å¯¹è±¡æ ‡è®°ä¸ºå·²ç»ç»‘å®šäº†å¤„ç†å‡½æ•°ï¼Œå½“ä¼ é€’ <code>â€œrejectâ€</code> ç›¸å¯¹äºæ ‡è®°è¿™ä¸ª Promise å¯¹è±¡è¿˜æ²¡æœ‰å¤„ç†å‡½æ•°ã€‚</p> 
 <p>æˆ‘ä»¬å…ˆæ¥çœ‹å‡ æ®µä»£ç çœ‹çœ‹ä»–çš„å®é™…ä½œç”¨</p> 
 <p>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ª Promise çš„çŠ¶æ€ä¸º reject ä¸”æœªä¸ºå…¶ç»‘å®š onRejected çš„å¤„ç†å‡½æ•°æ—¶ï¼Œ JavaScriptä¼šæŠ›å‡ºé”™è¯¯</p> 
 <pre class="has"><code class="language-go">constÂ myPromise1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject()
})
//Â æŠ¥é”™</code></pre> 
 <p>å¹¶ä¸”æ£€æµ‹æ˜¯å¦ç»‘å®šå¤„ç†å‡½æ•°æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹</p> 
 <pre class="has"><code class="language-go">console.log(1);
constÂ myPromise1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject()
})
console.log(2);
//Â 1
//Â 2
//Â æŠ¥é”™</code></pre> 
 <p>æˆ‘ä»¬å¯ä»¥ä¸ºå…¶ç»‘å®šä¸€ä¸ª onRejected å¤„ç†å‡½æ•°æ¥è§£å†³æˆ‘ä»¬æŠ¥é”™</p> 
 <pre class="has"><code class="language-go">constÂ myPromise1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject()
})//Â å¾—åˆ°ä¸€ä¸ªÂ rejectedÂ çŠ¶æ€çš„Â Promise
myPromise1.then(undefined,Â console.log)</code></pre> 
 <p>ä½ ä¸€å®šä¼šç–‘æƒ‘ï¼ŒPromise æ˜¯åœ¨ä½•æ—¶æ£€æµ‹å®ƒæ˜¯å¦ç»‘å®šäº† onRejected å¤„ç†å‡½æ•°ï¼Œå¦‚ä½•æ£€æµ‹çš„ï¼Ÿ</p> 
 <p>è¿™å°±æ˜¯ HostPromiseRejectionTracker çš„ä½œç”¨ï¼Œåœ¨ ECMAScript è§„èŒƒä¸­è¿˜æåˆ°ï¼Œå½“è°ƒç”¨ <code>HostPromiseRejectionTracker(promise, 'reject')</code> æ—¶ï¼Œ å¦‚æœ promsie ä¸å­˜åœ¨å¤„ç†å‡½æ•°ï¼Œåˆ™ä¼šä¸ºå…¶è®¾ç½®ä¸€ä¸ªå¤„ç†å‡½æ•°ã€‚</p> 
 <p>å›åˆ°ä¸Šé¢çš„é€»è¾‘ï¼Œå½“ä¸€ä¸ª Promise çš„ reject å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œ å¦‚æœæ²¡æœ‰ onRejected å¤„ç†å‡½æ•°ï¼Œåˆ™ä¼šè°ƒç”¨ <code>runtime::RejectPromise</code> æ¥ä¸ºå…¶æ·»åŠ ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œç„¶ååé¢ä¼šè°ƒç”¨ <code>TriggerPromiseReactions</code> å°†è¿™ä¸ªå¤„ç†å‡½æ•°åŠ å…¥åˆ° microtask é˜Ÿåˆ—ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°æ‰§è¡Œæ—¶åšçš„äº‹æƒ…å°±æ˜¯å†æ¬¡æ£€æµ‹ Promise æ˜¯å¦è¢«ç»‘å®šäº†æ–°çš„ onRejectedï¼ˆä¹Ÿå°±æ˜¯æœ‰æ²¡æœ‰åœ¨æ­¤æœŸé—´æ‰§è¡Œäº† <code>HostPromiseRejectionTracker(promise, 'handle')</code> ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœæœ‰åˆ™ä»€ä¹ˆä¹Ÿä¸å‘ç”Ÿã€‚</p> 
 <pre class="has"><code class="language-go">//Â ä¸å¯è¿è¡Œçš„jsä¼ªä»£ç 
functionÂ HostPromiseRejectionTracker(promise,Â status)Â {
Â Â ifÂ (statusÂ ===Â 'handle')Â {
Â Â Â Â promise.HasHandlerÂ =Â true
Â Â }Â elseÂ ifÂ (statusÂ ===Â 'reject'){
Â Â Â Â promise.catch(()Â =&gt;Â {
Â Â Â Â Â Â ifÂ (!promise.HasHandler)Â {
Â Â Â Â Â Â Â Â throwÂ newÂ Error('UncaughtÂ (inÂ promise)Â 'Â +Â promise.value)
Â Â Â Â Â Â }
Â Â Â Â })
Â Â }
}

RejectPromise(){
Â Â //...
Â Â ifÂ (!promise.HasHandler)Â {
Â Â Â Â HostPromiseRejectionTracker(promise,Â 'reject')
Â Â }
Â Â //...
}

FulfillPromise(){
Â Â //...
Â Â ifÂ (!promise.HasHandler)Â {
Â Â Â Â HostPromiseRejectionTracker(promise,Â 'handle')
Â Â }
Â Â //...
}</code></pre> 
 <p>æ‰€ä»¥åœ¨å¯¹ä¸€ä¸ª reject çŠ¶æ€çš„ Promise è°ƒç”¨ then æ–¹æ³•æ—¶éœ€è¦å¯¹å…¶è°ƒç”¨ <code>runtime::PromiseRevokeReject(promise)</code> æ¥è¡¨ç¤ºè¿™ä¸ª Promise ç»‘å®šäº†æ–°çš„ onRejectedï¼Œé˜²æ­¢é”™è¯¯è¢«æŠ›å‡ºã€‚</p> 
 <p>æ‰€ä»¥ä½ å¿…é¡»è¦èµ¶åœ¨è¿™ä¸ªæ£€æµ‹çš„ microtask æ‰§è¡Œä¹‹å‰ç»‘å®šå¤„ç†å‡½æ•°æ‰èƒ½é˜²æ­¢è¿™ä¸ªé”™è¯¯çš„æŠ›å‡ºã€‚</p> 
 <pre class="has"><code class="language-go">constÂ myPromise1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â //Â åŒæ­¥æ‰§è¡Œ
Â Â Â Â reject()
Â Â Â Â //Â ä¼šå‘Â microtaskÂ é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªæ£€æŸ¥Â myPromise1Â 
Â Â Â Â //Â æ˜¯å¦ç»‘å®šäº†æ–°çš„Â onRejectedÂ å¤„ç†å‡½æ•°çš„Â microtask
})

//Â macrotask
setTimeout(()Â =&gt;Â {
Â Â Â //Â æ­¤æ—¶Â microtaskÂ å·²ç»æ‰§è¡Œï¼Œé”™è¯¯å·²ç»æŠ›å‡ºï¼Œæ¥ä¸åŠäº†
Â Â Â Â myPromise1.then(undefined,Â console.log)
},Â 0)</code></pre> 
 <blockquote> 
  <p><strong>æ³¨æ„ï¼š</strong> Â æµè§ˆå™¨æ§åˆ¶å°æœ‰ä¸€ä¸ªéå¸¸å¥‡æ€ªçš„ç‰¹æ€§ï¼Œå¦‚æœåœ¨è¿™ä¸ªé”™è¯¯è¾“å‡ºååœ¨ä¸ºå…¶ç»‘å®š onrejected å¤„ç†å‡½æ•°ï¼Œæµè§ˆå™¨ä¼šå°†æ§åˆ¶å°çš„é”™è¯¯è¦†ç›–æ‰ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨æµè§ˆå™¨æ‰§è¡Œè¿™æ®µä»£ç ï¼Œ<strong>è¯·å°†setTimeoutçš„æ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹</strong>ï¼Œè¿™æ ·æ•ˆæœæ›´åŠ å®¹æ˜“è‚‰çœ¼å¯è§ï¼Œæˆ–è€…åˆ‡æ¢åˆ° node ç¯å¢ƒä¸­æ¥è¿è¡Œã€‚</p> 
 </blockquote> 
 <h4>å°ç»“</h4> 
 <p>reject å’Œ resolve çš„é€»è¾‘åŸºæœ¬ç›¸åŒï¼Œåˆ†ä¸º 4 æ­¥ï¼š</p> 
 <ul><li><p>è®¾ç½® Promise çš„ reasonï¼Œä¹Ÿå°±æ˜¯ reject çš„å‚æ•°</p></li><li><p>è®¾ç½® Promise çš„çŠ¶æ€ï¼šrejected</p></li><li><p>å¦‚æœ Promise æ²¡æœ‰ onRejected å¤„ç†å‡½æ•°ï¼Œåˆ™ä¼šä¸ºå…¶æ·»åŠ ä¸€ä¸ªå†æ¬¡æ£€æµ‹ Promise æ˜¯å¦ç»‘å®š onRejected çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°ä¼šè¢«æ”¾å…¥ microtask é˜Ÿåˆ—ï¼Œå¦‚æœå…¶æ‰§è¡Œæ—¶ Promise è¿˜æœªç»‘å®š onRejectedï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚</p></li><li><p>ç”±ä¹‹å‰è°ƒç”¨ then/catch æ–¹æ³•æ—¶æ”¶é›†åˆ°çš„ä¾èµ–å­˜å‚¨åˆ° <code>reactions_or_result</code> çš„å¤„ç†å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è®¸å¤š promiseReaction èŠ‚ç‚¹å¯¹è±¡ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ª microtaskï¼Œæœ€åå°†è¿™äº› microtask æ’å…¥ microtask é˜Ÿåˆ—</p></li></ul> 
 <h3>catch</h3> 
 <pre class="has"><code class="language-go">newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â setTimeout(reject,Â 2000)
}).catch(_Â =&gt;Â {
Â Â Â Â console.log('rejected')
})</code></pre> 
 <h4>PromisePrototypeCatch</h4> 
 <p>ä»¥ä¸Šé¢ä»£ç ä¸ºä¾‹ï¼Œå½“ catch æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨äº† V8 çš„ PromisePrototypeCatch<sup>[20]</sup> æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p> 
 <pre class="has"><code class="language-go">transitioningÂ javascriptÂ builtin
PromisePrototypeCatch(
Â Â Â Â js-implicitÂ context:Â Context,Â receiver:Â JSAny)(onRejected:Â JSAny):Â JSAnyÂ {
Â Â constÂ nativeContextÂ =Â LoadNativeContext(context);
Â Â returnÂ UnsafeCast&lt;JSAny&gt;(
Â Â Â Â Â Â InvokeThen(nativeContext,Â receiver,Â Undefined,Â onRejected));
}</code></pre> 
 <p>PromisePrototypeCatch çš„æºç ç¡®å®åªæœ‰å°±è¿™å‡ è¡Œï¼Œé™¤äº†è°ƒç”¨ InvokeThen æ–¹æ³•å†æ— å…¶å®ƒ ã€‚</p> 
 <h4>InvokeThen</h4> 
 <p>ä»åå­—å¯ä»¥æ¨æµ‹å‡ºï¼ŒInvokeThen è°ƒç”¨çš„æ˜¯ Promise çš„ then æ–¹æ³•ï¼ŒInvokeThen<sup>[21]</sup> æºç å¦‚ä¸‹ï¼š</p> 
 <pre class="has"><code class="language-go">transitioning
macroÂ InvokeThen&lt;F:Â type&gt;(implicitÂ context:Â Context)(
Â Â Â Â nativeContext:Â NativeContext,Â receiver:Â JSAny,Â arg1:Â JSAny,Â arg2:Â JSAny,
Â Â Â Â callFunctor:Â F):Â JSAnyÂ {
Â Â ifÂ (!Is&lt;Smi&gt;(receiver)Â &amp;&amp;
Â Â Â Â Â Â IsPromiseThenLookupChainIntact(
Â Â Â Â Â Â Â Â Â Â nativeContext,Â UnsafeCast&lt;HeapObject&gt;(receiver).map))Â {
Â Â Â Â constÂ thenÂ =
Â Â Â Â Â Â Â Â UnsafeCast&lt;JSAny&gt;(nativeContext[NativeContextSlot::PROMISE_THEN_INDEX]);
Â Â Â Â //Â é‡ç‚¹åœ¨ä¸‹é¢ä¸€è¡Œï¼Œè°ƒç”¨Â thenÂ æ–¹æ³•å¹¶è¿”å›ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½ä¸€æ ·
Â Â Â Â returnÂ callFunctor.Call(nativeContext,Â then,Â receiver,Â arg1,Â arg2);
Â Â }Â else
Â Â Â Â deferredÂ {
Â Â Â Â Â Â constÂ thenÂ =Â UnsafeCast&lt;JSAny&gt;(GetProperty(receiver,Â kThenString));
Â Â Â Â Â Â //Â é‡ç‚¹åœ¨ä¸‹é¢ä¸€è¡Œï¼Œè°ƒç”¨Â thenÂ æ–¹æ³•å¹¶è¿”å›ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½ä¸€æ ·
Â Â Â Â Â Â returnÂ callFunctor.Call(nativeContext,Â then,Â receiver,Â arg1,Â arg2);
Â Â Â Â }
}</code></pre> 
 <p>InvokeThen æ–¹æ³•æœ‰ if/else ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸¤ä¸ªåˆ†æ”¯çš„é€»è¾‘å·®ä¸å¤šï¼Œæœ¬å°èŠ‚çš„ JS ç¤ºä¾‹ä»£ç èµ°çš„æ˜¯ if åˆ†æ”¯ã€‚å…ˆæ˜¯æ‹¿åˆ° V8 åŸç”Ÿçš„ then æ–¹æ³•ï¼Œç„¶åé€šè¿‡ <code>callFunctor.Call(nativeContext, then, receiver, arg1, arg2)</code> è°ƒç”¨ then æ–¹æ³•ã€‚then æ–¹æ³•ä¹‹å‰æœ‰ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p> 
 <p>æ—¢ç„¶ catch æ–¹æ³•åº•å±‚è°ƒç”¨äº† then æ–¹æ³•ï¼Œé‚£ä¹ˆ catch æ–¹æ³•ä¹Ÿæœ‰å’Œ then æ–¹æ³•ä¸€æ ·çš„è¿”å›å€¼ï¼Œcatch æ–¹æ³•å¯ä»¥ç»§ç»­æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥ç»§ç»­é“¾å¼è°ƒç”¨ã€‚</p> 
 <pre class="has"><code class="language-go">newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â setTimeout(reject,Â 2000)
}).catch(_Â =&gt;Â {
Â Â Â Â throwÂ 'rejected'
}).catch(_Â =&gt;Â {
Â Â Â Â console.log('lastÂ catch')
})</code></pre> 
 <p>ä¸Šé¢çš„ä»£ç ç¬¬ 2 ä¸ª catch æ•è·ç¬¬ 1 ä¸ª catch æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€åæ‰“å° last catchã€‚</p> 
 <h4>å°ç»“</h4> 
 <p>catch æ–¹æ³•é€šè¿‡åº•å±‚è°ƒç”¨ then æ–¹æ³•æ¥å®ç° å‡å¦‚ obj æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼ŒJS å±‚é¢ obj.catch(onRejected) ç­‰ä»·äº obj.then(undefined, onRejected)</p> 
 <h3>then çš„é“¾å¼è°ƒç”¨ä¸ microtask é˜Ÿåˆ—ï¼ˆé‡è¦ï¼‰</h3> 
 <pre class="has"><code class="language-go">Promise.resolve('123')
Â Â Â Â .then(()Â =&gt;Â {throwÂ newÂ Error('456')})
Â Â Â Â .then(_Â =&gt;Â {
Â Â Â Â Â Â Â Â console.log('shouldnotÂ beÂ here')
Â Â Â Â })
Â Â Â Â .catch((e)Â =&gt;Â console.log(e))
Â Â Â Â .then((data)Â =&gt;Â console.log(data));</code></pre> 
 <p>ä»¥ä¸Šä»£ç è¿è¡Œåï¼Œæ‰“å° Error: 456 å’Œ undefinedã€‚ä¸ºäº†ä¾¿äºå™è¿°ï¼Œå°† then çš„é“¾å¼è°ƒç”¨å†™æ³•æ”¹ä¸ºå•°å—¦å†™æ³•ã€‚</p> 
 <pre class="has"><code class="language-go">constÂ p0Â =Â Promise.resolve('123')
constÂ p1Â =Â p0.then(()Â =&gt;Â {throwÂ newÂ Error('456')})
constÂ p2Â =Â p1.then(_Â =&gt;Â {
Â Â Â Â console.log('shouldnotÂ beÂ here')
})
constÂ p3Â =Â p2.catch((e)Â =&gt;Â console.log(e))
constÂ p4Â =Â p3.then((data)Â =&gt;Â console.log(data));</code></pre> 
 <p>then æ–¹æ³•è¿”å›æ–°çš„ Promiseï¼Œæ‰€ä»¥ p0ã€p1ã€p2ã€p3 å’Œ p4 è¿™ 5 ä¸ª Promise äº’ä¸ç›¸ç­‰ã€‚</p> 
 <blockquote> 
  <p>å½“ä¸€ä¸ª Promise å¤„äº rejected çŠ¶æ€æ—¶ï¼Œå¦‚æœæ‰¾ä¸åˆ° onRejected å¤„ç†å‡½æ•°åˆ™ä¼šå°† rejected çš„çŠ¶æ€å’Œå…¶å€¼å¾€ä¸‹ä¼ é€’ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚ï¼ˆresolveä¹Ÿæ˜¯ä¸€æ ·ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹åé¢ä¼šä»‹ç»</p> 
  <p>catch æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ç»‘å®š onRejected å‡½æ•°</p> 
 </blockquote> 
 <h4>microtask çš„æ‰§è¡Œ</h4> 
 <p>æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œå– microtask é˜Ÿåˆ—ä¸­çš„ microtask æ‰§è¡Œï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯ MicrotaskQueueBuiltinsAssembler::RunSingleMicrotask<sup>[22]</sup> ï¼Œç”±äº microtask çš„ç±»å‹ç”±å¾ˆå¤šç§ï¼Œæ‰€ä»¥ RunSingleMicrotask çš„åˆ†æ”¯æœ‰è®¸å¤šã€‚è¿™é‡Œå°±ä¸åˆ—å‡ºä»£ç äº†ã€‚</p> 
 <h4>PromiseReactionJob</h4> 
 <p>åœ¨æ‰§è¡Œ microtask çš„è¿‡ç¨‹ä¸­ï¼ŒMicrotaskQueueBuiltinsAssembler::RunSingleMicrotask ä¼šè°ƒç”¨ PromiseReactionJob<sup>[23]</sup>ï¼Œæºç å¦‚ä¸‹ï¼š</p> 
 <pre class="has"><code class="language-go">transitioning
macroÂ PromiseReactionJob(
Â Â Â Â context:Â Context,Â argument:Â JSAny,Â handler:Â Callable|Undefined,
Â Â Â Â promiseOrCapability:Â JSPromise|PromiseCapability|Undefined,
Â Â Â Â reactionType:Â constexprÂ PromiseReactionType):Â JSAnyÂ {
Â Â ifÂ (handlerÂ ==Â Undefined)Â {
Â Â Â Â //Â æ²¡æœ‰å¤„ç†å‡½æ•°çš„Â caseï¼Œé€ä¼ ä¸Šä¸€ä¸ªÂ PromiseÂ çš„Â argument
Â Â Â Â ifÂ constexprÂ (reactionTypeÂ ==Â kPromiseReactionFulfill)Â {
Â Â Â Â Â Â //Â åŸºæœ¬ç±»åŒÂ JSÂ å±‚çš„Â resolve
Â Â Â Â Â Â returnÂ FuflfillPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â argument,Â reactionType);
Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â //Â åŸºæœ¬ç±»åŒÂ JSÂ å±‚çš„Â reject
Â Â Â Â Â Â returnÂ RejectPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â argument,Â reactionType);
Â Â Â Â }
Â Â }Â elseÂ {
Â Â Â Â tryÂ {
Â Â Â Â Â Â //Â è¯•å›¾è°ƒç”¨Â PromiseÂ å¤„ç†å‡½æ•°ï¼Œç›¸å½“äºÂ handler(argument)
Â Â Â Â Â Â constÂ resultÂ =
Â Â Â Â Â Â Â Â Â Â Call(context,Â UnsafeCast&lt;Callable&gt;(handler),Â Undefined,Â argument);
Â Â Â Â Â Â Â Â //Â åŸºæœ¬ç±»åŒÂ JSÂ å±‚çš„Â resolve
Â Â Â Â Â Â Â Â returnÂ FuflfillPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â result,Â reactionType);
Â Â Â Â }Â catchÂ (e)Â {
Â Â Â Â Â Â //Â åŸºæœ¬ç±»åŒÂ JSÂ å±‚çš„Â rejectï¼Œå½“æ‰§è¡ŒÂ handlerÂ æ˜¯æŠ›å‡ºå¼‚å¸¸ä¼šè§¦å‘
Â Â Â Â Â Â returnÂ RejectPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â e,Â reactionType);
Â Â Â Â }
Â Â }
}</code></pre> 
 <p>PromiseReactionJob ä¸­ä¼šåˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦å­˜åœ¨éœ€è¦æ‰§è¡Œçš„å¤„ç†å‡½æ•°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥å°†ä¸Šä¸€ä¸ª Promise çš„å€¼ä½œä¸ºå‚æ•°è°ƒç”¨ FuflfillPromiseReactionJob ï¼Œå¦‚æœå­˜åœ¨åˆ™æ‰§è¡Œè¿™ä¸ªå¤„ç†å‡½æ•°ï¼Œå°†æ‰§è¡Œç»“æœå½“åšå‚æ•°è°ƒç”¨ FuflfillPromiseReactionJobã€‚</p> 
 <p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ª Promise çš„ onFulfilled æˆ–è€… onRejected åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åªè¦æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ª Promise å°±ä¼šæ‰§è¡Œ FuflfillPromiseReactionJob å°†çŠ¶æ€ä¿®æ”¹ä¸º fulfilledã€‚å¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™æ‰§è¡Œ RejectPromiseReactionJobã€‚</p> 
 <pre class="has"><code class="language-go">letÂ p0Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject(123)
})
//Â p1Â çš„çŠ¶æ€ä¸ºÂ reject

letÂ p1Â =Â p0.then(valueÂ =&gt;Â {
Â Â Â Â console.log(value);
},Â reasonÂ =&gt;Â {
Â Â Â Â console.log(reason);
Â Â Â returnÂ 2
})
//Â å°†Â reasonÂ =&gt;Â {console.log(reason)}Â åŠ å…¥Â microtaskÂ é˜Ÿåˆ—

p1.then(_Â =&gt;Â {
Â Â Â Â console.log('p1');
})
//Â ä¸ºÂ p1Â æ·»åŠ Â PromiseReaction

//Â å–Â Â microtaskÂ é˜Ÿåˆ—Â ç¬¬ä¸€ä¸ªæ‰§è¡Œï¼Œ
//Â handlerÂ ä¸ºÂ reasonÂ =&gt;Â {console.log(reason)}ï¼Œ

//Â æˆåŠŸæ‰§è¡ŒÂ handler,Â æ‰€ä»¥è°ƒç”¨Â FuflfillPromiseReactionJobÂ 
//Â æ‰§è¡ŒÂ p1Â çš„Â resolve</code></pre> 
 <blockquote> 
  <p>æ³¨æ„ï¼šFuflfillPromiseReactionJob åšçš„äº‹æƒ…å¾ˆå¤šï¼Œæ‰§è¡Œ resolve åªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªåˆ†æ”¯</p> 
 </blockquote> 
 <p>æˆ‘ä»¬æ¥çœ‹çœ‹ FuflfillPromiseReactionJob å…·ä½“åšäº†å“ªäº›äº‹æƒ…ã€‚</p> 
 <h4>FuflfillPromiseReactionJob</h4> 
 <p>æºç å¦‚ä¸‹ï¼š</p> 
 <pre class="has"><code class="language-go">transitioning
macroÂ FuflfillPromiseReactionJob(
Â Â Â Â context:Â Context,
Â Â Â Â promiseOrCapability:Â JSPromise|PromiseCapability|Undefined,Â result:Â JSAny,
Â Â Â Â reactionType:Â constexprÂ PromiseReactionType):Â JSAnyÂ {
Â Â typeswitchÂ (promiseOrCapability)Â {
Â Â Â Â caseÂ (promise:Â JSPromise):Â {
Â Â Â Â Â Â //Â è°ƒç”¨Â ResolvePromiseï¼Œä¹Ÿå°±æ˜¯Â promiseÂ çš„Â resolve(result)
Â Â Â Â Â Â returnÂ ResolvePromise(context,Â promise,Â result);
Â Â Â Â }
Â Â Â Â caseÂ (Undefined):Â {
Â Â Â Â Â Â returnÂ Undefined;
Â Â Â Â }
Â Â Â Â caseÂ (capability:Â PromiseCapability):Â {
Â Â Â Â Â Â constÂ resolveÂ =Â UnsafeCast&lt;Callable&gt;(capability.resolve);
Â Â Â Â Â Â tryÂ {
Â Â Â Â Â Â Â Â returnÂ Call(context,Â resolve,Â Undefined,Â result);
Â Â Â Â Â Â }Â catchÂ (e)Â {
Â Â Â Â Â Â Â Â returnÂ RejectPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â e,Â reactionType);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}</code></pre> 
 <p>FuflfillPromiseReactionJob æœ‰3ä¸ªåˆ†æ”¯ï¼Œè¿™é‡Œèµ°çš„æ˜¯ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼Œè°ƒç”¨ ResolvePromise<sup>[24]</sup>ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œä»–æ˜¯è§„èŒƒä¸­çš„ Promise Resolve Functions<sup>[25]</sup>ï¼Œä»–çš„ä½œç”¨æ˜¯åŒæ­¥å½“å‰å¤„ç†å‡½æ•°çš„ç»“æœï¼ˆå€¼å’ŒçŠ¶æ€ï¼‰ç»™å…¶äº§ç”Ÿçš„promsieã€‚promiseOrCapabilityã€‚</p> 
 <blockquote> 
  <p>ä¸Šé¢ä¾‹å­ä¸­ promiseOrCapability å°±æ˜¯ p1, å€¼æ˜¯ 2</p> 
 </blockquote> 
 <h4>ResolvePromiseï¼ˆé‡è¦ï¼‰</h4> 
 <p>è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€ä¸ª Promise çš„çŠ¶æ€éœ€è¦å˜æˆ fulfilled éƒ½ä¼šè°ƒç”¨å®ƒï¼ˆè°ƒç”¨resolve()æ—¶ä¹Ÿä¼šè°ƒç”¨ä»–ï¼‰ï¼Œå®ƒçš„é€»è¾‘ä¹Ÿäº§ç”Ÿäº†è®¸å¤š PromiseA+ ä¸­æ²¡æœ‰çš„ç‰¹æ€§ã€‚ ä¸‹é¢çš„ä»£ç æˆ‘åˆ é™¤äº†ä¸é‡è¦çš„éƒ¨åˆ†</p> 
 <pre class="has"><code class="language-go">//Â https://tc39.es/ecma262/#sec-promise-resolve-functions
transitioningÂ builtin
ResolvePromise(implicitÂ context:Â Context)(
Â Â Â Â promise:Â JSPromise,Â resolution:Â JSAny):Â JSAnyÂ {
Â //Â åˆ 
Â Â letÂ then:Â ObjectÂ =Â Undefined;
Â Â tryÂ {
Â Â Â Â //Â è°ƒç”¨Â FulfillPromise
Â Â Â Â constÂ heapResolutionÂ =Â UnsafeCast&lt;HeapObject&gt;(resolution);
Â Â Â Â constÂ resolutionMapÂ =Â heapResolution.map;
Â Â Â Â ifÂ (!IsJSReceiverMap(resolutionMap))Â {
Â Â Â Â Â Â returnÂ FulfillPromise(promise,Â resolution);
Â Â Â Â }
Â Â Â Â //Â åˆ 
Â Â Â Â constÂ promisePrototypeÂ =
Â Â Â Â Â Â Â Â *NativeContextSlot(ContextSlot::PROMISE_PROTOTYPE_INDEX);
Â Â Â Â //Â é‡è¦ï¼šå¦‚æœÂ resolutionÂ æ˜¯ä¸€ä¸ªÂ PromiseÂ å¯¹è±¡
Â Â Â Â ifÂ (resolutionMap.prototypeÂ ==Â promisePrototype)Â {
Â Â Â Â Â Â thenÂ =Â *NativeContextSlot(ContextSlot::PROMISE_THEN_INDEX);
Â Â Â Â Â Â static_assert(nativeContextÂ ==Â LoadNativeContext(context));
Â Â Â Â Â Â gotoÂ Enqueue;
Â Â Â Â }
Â Â Â Â gotoÂ Slow;
Â Â }Â labelÂ SlowÂ deferredÂ {
Â Â Â Â //Â å¦‚æœÂ resolutionÂ æ˜¯ä¸€ä¸ªåŒ…å«thenå±æ€§çš„å¯¹è±¡ï¼Œä¼šæ¥åˆ°è¿™
Â Â Â Â tryÂ {
Â Â Â Â Â Â //Â è·å–Â thenÂ å±æ€§
Â Â Â Â Â Â thenÂ =Â GetProperty(resolution,Â kThenString);
Â Â Â Â }Â catchÂ (e)Â {
Â Â Â Â Â Â returnÂ RejectPromise(promise,Â e,Â False);
Â Â Â Â }
Â Â Â Â //Â å¦‚æœÂ thenÂ å±æ€§ä¸æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„æ–¹æ³•
Â Â Â Â ifÂ (!Is&lt;Callable&gt;(then))Â {
Â Â Â Â Â Â //Â å°†æ‰§è¡Œç»“æœåŒæ­¥åˆ°Â promise
Â Â Â Â Â Â returnÂ FulfillPromise(promise,Â resolution);
Â Â Â Â }
Â Â Â Â gotoÂ Enqueue;
Â Â }Â labelÂ EnqueueÂ {
Â Â Â Â //Â é‡è¦ï¼šå¦‚æœÂ æ‰§è¡Œç»“æœæ˜¯ä¸€ä¸ªÂ PromiseÂ å¯¹è±¡
Â Â Â Â //Â æˆ–è€…åŒ…å«å¯æ‰§è¡Œçš„Â thenÂ æ–¹æ³•çš„å¯¹è±¡ï¼Œä¼šæ¥åˆ°è¿™
Â Â Â Â constÂ taskÂ =Â NewPromiseResolveThenableJobTask(
Â Â Â Â Â Â Â Â promise,Â UnsafeCast&lt;JSReceiver&gt;(resolution),
Â Â Â Â Â Â Â Â UnsafeCast&lt;Callable&gt;(then));
Â Â Â Â returnÂ EnqueueMicrotask(task.context,Â task);
Â Â }
}</code></pre> 
 <p>ResolvePromise æ–¹æ³•ä¸­æœ‰å‡ ä¸ªå¾ˆé‡è¦çš„é€»è¾‘ï¼Œä¸€ä¸ªæ˜¯è°ƒç”¨ FulfillPromiseï¼Œè¿™ä¸ªåœ¨resolveçš„æ—¶å€™å·²ç»ä»‹ç»è¿‡äº†ï¼Œä½œç”¨æ˜¯ä¿®æ”¹ promise çš„çŠ¶æ€ä¸º fulfilled å¹¶ä¸ºå…¶è®¾ç½®å€¼ï¼Œç„¶åå°† promise çš„å¤„ç†å‡½æ•°æ¨åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚</p> 
 <pre class="has"><code class="language-go">letÂ p0Â =Â Promise.resolve()
letÂ p1Â =Â p0.then(()Â =&gt;Â {
Â Â returnÂ 1;
})

p1.then(console.log)

//Â p0Â thenÂ ä¸­Â onFulfilledÂ å›è°ƒè¿›å…¥é˜Ÿåˆ—
//Â PromiseReactionJobÂ ä¸­è°ƒç”¨Â p0Â çš„Â onFulfilledÂ ï¼Œå¾—åˆ°ç»“æœä¸º1
//Â è°ƒç”¨Â FuflfillPromiseReactionJobÂ ï¼Œç„¶åè°ƒç”¨Â ResolvePromise
//Â ResolvePromiseÂ åšå¦‚ä¸‹æ“ä½œ
//Â å°†Â p1Â å˜æˆÂ fulfilled,Â å¹¶å°†Â p1Â çš„å¤„ç†å‡½æ•°Â console.logÂ åŠ åˆ°é˜Ÿåˆ—ï¼Œå‚æ•°ä¸ºÂ 1
//Â p1Â çš„Â onFulfilledÂ å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œè¾“å‡ºÂ 1</code></pre> 
 <p>è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ <strong>å½“ resolution çš„å€¼æ˜¯ä¸€ä¸ª Promise å¯¹è±¡æˆ–è€…æ˜¯ä¸€ä¸ªåŒ…å« then æ–¹æ³•çš„å¯¹è±¡æ—¶ã€‚ä¼šè°ƒç”¨ NewPromiseResolveThenableJobTask ç”Ÿæˆä¸€ä¸ª microtaskï¼Œç„¶åå°†å…¶åŠ å…¥ microtask é˜Ÿåˆ—ä¸­ã€‚</strong></p> 
 <pre class="has"><code class="language-go">letÂ p0Â =Â Promise.resolve()
//Â ä¸¤ç§ç‰¹æ®Šæƒ…å†µ
letÂ p1Â =Â p0.then(()Â =&gt;Â {
Â Â returnÂ Promise.resolve(1);//Â è¿”å›å€¼æ˜¯Â PromiseÂ å¯¹è±¡
})
letÂ p2Â =Â p0.then(()Â =&gt;Â {
Â Â returnÂ {then(resolve,Â reject){resolve(1)};//Â è¿”å›å€¼åŒ…å«Â thenÂ æ–¹æ³•
})

p1.then(console.log)</code></pre> 
 <h4>NewPromiseResolveThenableJobTaskï¼ˆé‡è¦ï¼‰</h4> 
 <p>NewPromiseResolveThenableJobTask çš„ç›®çš„æ˜¯è°ƒç”¨ resolution çš„ then æ–¹æ³•ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­åŒæ­¥çŠ¶æ€ç»™ promiseã€‚ è¿™å¯èƒ½ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œæˆ‘æŠŠä»–è½¬åŒ–ä¸ºjsæ¥å¤§è‡´å°±æ˜¯è¿™æ ·çš„ã€‚</p> 
 <pre class="has"><code class="language-go">microtask(()Â =&gt;Â {
Â Â resolution.then((value)Â =&gt;Â {
Â Â Â Â ReslovePromise(promise,Â value)Â 
Â Â })
})</code></pre> 
 <p>è¿™ä¸ªä»»åŠ¡ä¸­ä¼šè°ƒç”¨ resolution.then ï¼Œç„¶ååŒæ­¥åˆ° promsieã€‚ä½†æ˜¯è¿™ä¸ªæ•´ä½“çš„è¿‡ç¨‹éœ€è¦åŠ å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…è¿è¡Œï¼Œå½“è¿™ä¸ªä»»åŠ¡è¿è¡Œæ—¶ï¼Œå¦‚æœ resolution ä¹Ÿæ˜¯ä¸€ä¸ª Promise çš„è¯ï¼Œåˆ™ <code>(value) =&gt; {ReslovePromise(promise, value) }</code> åˆä¼šè¢«ä½œä¸ºä¸€ä¸ª microtask åŠ å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…è¿è¡Œã€‚</p> 
 <p>ä½ å¯ä»¥ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿä¸ºä»€ä¹ˆä¸åŒæ­¥è°ƒç”¨ <code>resolution.then((value) =&gt; {ReslovePromise(promise, value) })</code>ï¼Œè€Œæ˜¯æŠŠä»–å°è£…ä¸ºä¸€ä¸ª microtask å‘¢ï¼Ÿæˆ‘ä¸€å¼€å§‹ä¹Ÿæ„Ÿåˆ°ç–‘æƒ‘ï¼Œå¥½åœ¨è§„èŒƒä¸­ç»™å‡ºäº†ä¸€ä¸ªåŸå› ã€‚</p> 
 <blockquote> 
  <p>æ³¨æ„: æ­¤ä½œä¸šä½¿ç”¨æä¾›çš„ thenable åŠå…¶ then æ–¹æ³•æ¥è§£å†³ç»™å®šçš„ Promiseã€‚ æ­¤è¿‡ç¨‹å¿…é¡»ä½œä¸ºä½œä¸šè¿›è¡Œï¼Œä»¥ç¡®ä¿åœ¨å¯¹ä»»ä½•å‘¨å›´ä»£ç çš„è¯„ä¼°å®Œæˆåå¯¹ then æ–¹æ³•è¿›è¡Œè¯„ä¼°ã€‚</p> 
  <p>å¼•è‡³ ECMAScript NewPromiseResolveThenableJobTask è§„èŒƒ<sup>[26]</sup>(ä½œè€…ç¿»è¯‘)</p> 
 </blockquote> 
 <blockquote> 
  <p><strong>ä»€ä¹ˆæ˜¯ thenableï¼š</strong></p> 
  <p>Javascript ä¸ºäº†è¯†åˆ« Promise äº§ç”Ÿçš„ä¸€ä¸ªæ¦‚å¿µï¼Œç®€å•æ¥è¯´å°±æ˜¯æ‰€æœ‰åŒ…å« then æ–¹æ³•çš„å¯¹è±¡éƒ½æ˜¯ thenableã€‚</p> 
 </blockquote> 
 <p>ã€ä»¥ç¡®ä¿åœ¨å¯¹ä»»ä½•å‘¨å›´ä»£ç çš„è¯„ä¼°å®Œæˆåå¯¹ then æ–¹æ³•è¿›è¡Œè¯„ä¼°ã€æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘å”¯ä¸€èƒ½æƒ³åˆ°çš„å°±æ˜¯ä¸‹é¢è¿™ç§æƒ…å†µã€‚</p> 
 <pre class="has"><code class="language-go">constÂ p1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â constÂ p2Â =Â Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â Â Â Â Â resolve({
Â Â Â Â Â Â Â Â Â Â Â Â then:Â (resolve,Â reject)Â =&gt;Â resolve(1)
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â constÂ p3Â =Â Promise.resolve().then(()Â =&gt;Â console.log(2));
Â Â Â Â });
}).then(vÂ =&gt;Â console.log(v));
//Â 2Â 1</code></pre> 
 <p>ä¸Šé¢ p2 çš„ onFulfilledå›è°ƒ ä¼šå…ˆè¿›å…¥ microtask é˜Ÿåˆ—ï¼Œç­‰å¾…å…¶æ‰§è¡Œæ—¶ è°ƒç”¨ p1 çš„ resolveï¼Œä½†æ˜¯å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å« then æ–¹æ³•çš„å¯¹è±¡ã€‚è¿™æ—¶ p1 ä¸ä¼šç«‹å³æ”¹å˜ä¸º fulfilledï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª microtask æ¥æ‰§è¡Œè¿™ä¸ªthenæ–¹æ³•ï¼Œç„¶åå°† p2çš„ onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—ã€‚è¿™æ—¶ microtask é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ª microtaskï¼Œä¸€ä¸ªæ˜¯æ‰§è¡Œ resolve è¿”å›å€¼ä¸­çš„ thenå‡½æ•°ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ p3çš„ onFulfilled å‡½æ•°ã€‚</p> 
 <p>ç„¶åå–å‡ºç¬¬ä¸€ä¸ª microtask æ‰§è¡Œï¼ˆå–å‡ºå microtask é˜Ÿåˆ—ä¸­åªå‰©ä¸‹ p3çš„ onFulfilledï¼‰ï¼Œæ‰§è¡Œå p1 çš„çŠ¶æ€å˜ä¸º fulfilledï¼Œç„¶å p1 çš„ onFulfilled è¿›å…¥é˜Ÿåˆ—ã€‚åé¢å¯æƒ³è€ŒçŸ¥æ˜¯ç›¸ç»§è¾“å‡º 2å’Œ1ï¼ˆå› ä¸º p1 çš„ onFulfilled å‡½æ•°åœ¨ p3 çš„ onFulfilled å‡½æ•°ä¹‹åè¿›å…¥ microtask é˜Ÿåˆ—ï¼‰ã€‚</p> 
 <p>å¦‚æœæ²¡æœ‰å°† NewPromiseResolveThenableJobTask ä½œä¸ºä¸€ä¸ª microtaskã€‚ä¹Ÿå°±å˜æˆäº† p2.then ä¸­çš„å›è°ƒæ‰§è¡Œæ—¶åŒæ­¥è§¦å‘ resolve å‚æ•°ä¸­çš„ then æ–¹æ³•ï¼Œfulfilled çš„çŠ¶æ€ä¼šç«‹å³åŒæ­¥åˆ° p1,è¿™æ—¶ p1 çš„ onFulfilled å°±ä¼šå…ˆè¿›å…¥ microtaskï¼Œå¯¼è‡´ç»“æœå˜ä¸º 12ã€‚è¿™æ ·çš„æ‰§è¡Œç»“æœå¯ä»¥ä¼šè®©JavaScriptå¼€å‘è€…æ„Ÿåˆ°ç–‘æƒ‘ã€‚</p> 
 <p>æ‰€ä»¥ ECMAScript å°†å…¶ä½œä¸ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œã€‚</p> 
 <blockquote> 
  <p>ä¼¼ä¹ è¿”å› Promsie å¯¹è±¡ä¼šäº§ç”Ÿä¸¤ä¸ª microtask ä¼¼ä¹ä¼šæ›´è®©äººæ„Ÿåˆ°ç–‘æƒ‘ã€‚</p> 
 </blockquote> 
 <h4>RejectPromiseReactionJob</h4> 
 <p>PromiseReactionJob ä¸­å¦‚æœå¤„ç†å‡½æ•° handler æ‰§è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸åˆ™ä¼šæ‰§è¡Œ RejectPromiseReactionJobï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ç§æƒ…å†µ</p> 
 <pre class="has"><code class="language-go">letÂ p0Â =Â Promise.resolve()
letÂ p1Â =Â p0.then(()Â =&gt;Â {
Â Â Â Â throwÂ 'error';Â //Â handlerÂ æ‰§è¡Œæ—¶å‡ºé”™
})</code></pre> 
 <p>è¿™æ˜¯ä¼šè°ƒç”¨ RejectPromiseReactionJobï¼Œå…¶æºç å¦‚ä¸‹</p> 
 <pre class="has"><code class="language-go">macroÂ RejectPromiseReactionJob(
Â Â Â Â context:Â Context,
Â Â Â Â promiseOrCapability:Â JSPromise|PromiseCapability|Undefined,Â reason:Â JSAny,
Â Â Â Â reactionType:Â constexprÂ PromiseReactionType):Â JSAnyÂ {
Â Â ifÂ constexprÂ (reactionTypeÂ ==Â kPromiseReactionReject)Â {
Â Â Â Â typeswitchÂ (promiseOrCapability)Â {
Â Â Â Â Â Â caseÂ (promise:Â JSPromise):Â {
//Â promiseOrCapabilityÂ å°±æ˜¯Â p1ï¼Œæ˜¯ä¸€ä¸ªÂ PromiseÂ å¯¹è±¡
//Â æ‰§è¡ŒÂ RejectPromiseï¼Œè°ƒç”¨Â p1Â çš„Â rejectÂ æ–¹æ³•
Â Â Â Â Â Â Â Â returnÂ RejectPromise(promise,Â reason,Â False);
Â Â Â Â Â Â }
Â Â Â Â Â Â caseÂ (Undefined):Â {
Â Â Â Â Â Â Â Â returnÂ Undefined;
Â Â Â Â Â Â }
Â Â Â Â Â Â caseÂ (capability:Â PromiseCapability):Â {
Â Â Â Â Â Â Â Â constÂ rejectÂ =Â UnsafeCast&lt;Callable&gt;(capability.reject);
Â Â Â Â Â Â Â Â returnÂ Call(context,Â reject,Â Undefined,Â reason);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }Â elseÂ {
Â Â Â Â StaticAssert(reactionTypeÂ ==Â kPromiseReactionFulfill);
Â Â Â Â returnÂ PromiseRejectReactionJob(reason,Â Undefined,Â promiseOrCapability);
Â Â }
}</code></pre> 
 <p>RejectPromiseReactionJob ä¸ FuflfillPromiseReactionJob æ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯è°ƒç”¨ RejectPromise æ¥è°ƒç”¨ Promsie çš„ reject æ–¹æ³•ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢ reject çš„åœ°æ–¹ä»‹ç»è¿‡äº†ã€‚</p> 
 <h4>PromiseReactionJobçš„handler == Undefinedåˆ†æ”¯</h4> 
 <p>PromiseReactionJob ä¸­è¿˜æœ‰ä¸€ä¸ª handler == Undefined çš„åˆ†æ”¯ä¹Ÿå¾ˆé‡è¦ï¼Œå½“ä¸€ä¸ª task ä¸­çš„ handler ä¸º undefinedæ—¶ä¼šè¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹ä»£ç </p> 
 <pre class="has"><code class="language-go">transitioning
macroÂ PromiseReactionJob(
Â Â Â Â context:Â Context,Â argument:Â JSAny,Â handler:Â Callable|Undefined,
Â Â Â Â promiseOrCapability:Â JSPromise|PromiseCapability|Undefined,
Â Â Â Â reactionType:Â constexprÂ PromiseReactionType):Â JSAnyÂ {
Â Â ifÂ (handlerÂ ==Â Undefined)Â {
Â Â Â Â //Â æ²¡æœ‰å¤„ç†å‡½æ•°çš„Â caseï¼Œé€ä¼ ä¸Šä¸€ä¸ªÂ PromiseÂ çš„Â argument
Â Â Â Â ifÂ constexprÂ (reactionTypeÂ ==Â kPromiseReactionFulfill)Â {
Â Â Â Â Â Â //Â åŸºæœ¬ç±»åŒÂ JSÂ å±‚çš„Â resolve
Â Â Â Â Â Â returnÂ FuflfillPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â argument,Â reactionType);
Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â //Â åŸºæœ¬ç±»åŒÂ JSÂ å±‚çš„Â reject
Â Â Â Â Â Â returnÂ RejectPromiseReactionJob(
Â Â Â Â Â Â Â Â Â Â context,Â promiseOrCapability,Â argument,Â reactionType);
Â Â Â Â }
Â Â }Â elseÂ {
Â Â Â Â //Â åˆ é™¤
Â Â }
}</code></pre> 
 <p>è¿›å…¥åˆ†æ”¯åä¼šç›´æ¥è·å–ä¸Šä¸€ä¸ª Promise å¯¹è±¡çš„ value å’Œ çŠ¶æ€ åŒæ­¥åˆ°å½“å‰ promise æ¥ï¼Œæˆ‘ä»¬æ¥é€šè¿‡ä¸€æ®µjsäº†è§£ä»–</p> 
 <pre class="has"><code class="language-go">letÂ p0Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject(123)
})
//Â p0Â çš„çŠ¶æ€ä¸ºÂ rejected

letÂ p1Â =Â p0.then(_Â =&gt;Â {console.log('p0Â onFulfilled')})
//Â p0Â çš„Â onRejectedÂ ä½œä¸ºÂ handlerÂ è¿›å…¥Â microtaskÂ é˜Ÿåˆ—
//Â ä½†æ˜¯å› ä¸ºÂ thenÂ æ²¡æœ‰ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°
//Â æ‰€ä»¥Â onRejectedÂ æ˜¯Â undefinedï¼Œé‚£ä¹ˆÂ handlerÂ ä¹Ÿæ˜¯Â undefined

letÂ p2Â =Â p1.then(_Â =&gt;Â {console.log('p1Â onFulfilled')})
/*
ä¸ºp1ç»‘å®šÂ 
PromiseReaction{
Â Â onFulfilled:_Â =&gt;Â {console.log('p1Â onFulfilled')},Â 
Â Â onRejected:undefined
}
*/
letÂ p3Â =Â p2.then(_Â =&gt;Â {console.log('p2Â onFulfilled')},Â _Â =&gt;Â {console.log('p2Â onRejected')})
/*
ä¸ºp2ç»‘å®šÂ 
PromiseReaction{
Â Â onFulfilled:_Â =&gt;Â {console.log('p2Â onFulfilled')},Â 
Â Â onRejected:_Â =&gt;Â {console.log('p2Â onRejected')
}
*/
letÂ p4Â =Â p3.then(_Â =&gt;Â {console.log('p3Â onFulfilled')},Â _Â =&gt;Â {console.log('p3Â onRejected')})
/*
ä¸ºp3ç»‘å®šÂ 
PromiseReaction{
Â Â onFulfilled:_Â =&gt;Â {console.log('p3Â onFulfilled')},Â 
Â Â onRejected:_Â =&gt;Â {console.log('p3Â onRejected')
}
*/

//p2Â onRejected
//p3Â onFulfilled</code></pre> 
 <p>åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼ˆæ‰§è¡Œè¿‡ç¨‹å¤§è‡´å¦‚æ³¨é‡Šï¼‰,å¼€å¯å– microtask æ‰§è¡Œï¼Œæ­¤æ—¶ microtask é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ª handler ä¸º undefined çš„ä»»åŠ¡ã€‚è¿›å…¥ PromiseReactionJob çš„ handler == Undefined åˆ†æ”¯ã€‚</p> 
 <p>å› ä¸ºæ­¤æ—¶ p0 çŠ¶æ€ä¸º rejectedï¼Œæ‰€ä»¥æ‰§è¡Œ <code>RejectPromiseReactionJob(context, promiseOrCapability, argument, reactionType)</code>ï¼Œå…¶ä¸­ promiseOrCapability å°±æ˜¯p1, argument å°±æ˜¯ p0 çš„å€¼ 123ï¼ŒreactionType ä¸º rejectedã€‚</p> 
 <p>æ‰§è¡Œå p0 çš„çŠ¶æ€ä¹Ÿå˜ä¸º reactionType ä¹Ÿå°±æ˜¯ rejectedï¼Œp1 çš„å€¼ä¸º argumentï¼ˆç›¸å½“äºå§p0çš„çŠ¶æ€å’Œå€¼éƒ½è½¬ç§»åˆ°äº†p1ï¼‰ã€‚</p> 
 <p>ç„¶åæ‰§è¡Œ p1 çš„ reject å‡½æ•°ï¼ˆ<code>FulfillPromise(p1, 123)</code>ï¼‰ï¼Œä¼šå§ p1 ç»‘å®šçš„ PromiseReaction é“¾è¡¨ä¸­çš„ onRejectedï¼ˆè¿˜æ˜¯undefinedï¼‰ å½“åš handler è¿›å…¥microtask é˜Ÿåˆ—ï¼ˆå› ä¸º p1 çš„çŠ¶æ€æ˜¯ rejectedï¼Œæ‰€ä»¥æ˜¯onRejectedï¼‰</p> 
 <p>åŒæ ·è¿˜æ˜¯å– microtask ä»»åŠ¡æ‰§è¡Œï¼Œhandler è¿˜æ˜¯ undefinedï¼Œåé¢å°±å’Œä¸Šé¢ä¸€æ ·ï¼ŒæŠŠçŠ¶æ€ rejected å’Œå€¼ 123 ç»§ç»­åŒæ­¥ç»™ p2ï¼Œ..........</p> 
 <p>å†æ¬¡å– microtask æ‰§è¡Œï¼Œå› ä¸º p2 ç»‘å®šäº† onRejected å‡½æ•°ï¼Œæ‰€ä»¥ handler ä¸æ˜¯ undefinedï¼Œåˆ™ä¸èµ° handler == Undefined åˆ†æ”¯ï¼Œå¦ä¸€ä¸ªåˆ†æ”¯çš„é€»è¾‘åˆšåˆšå·²ç»æè¿°è¿‡äº†ã€‚å¤§æ¦‚å°±æ˜¯æ‰§è¡Œ onRejected(123)ï¼Œç„¶åå°†å…¶ç»“æœè®¾ç½®åˆ° p3 çš„valueï¼Œp3 å˜ä¸º fulfilled çŠ¶æ€ã€‚</p> 
 <blockquote> 
  <p>è¾“å‡º p2 onRejected</p> 
 </blockquote> 
 <p>å› ä¸º onRejected(123) çš„è¿”å›å€¼æ˜¯ undefinedï¼Œæ‰€ä»¥ p3 å˜ä¸º fulfilled çŠ¶æ€ï¼Œä¸”å€¼ä¸º undefined</p> 
 <p>åé¢è¿˜æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ handler å°±æ˜¯ onFulfilled äº†ï¼Œå› ä¸º p3 çš„çŠ¶æ€æ˜¯ fulfilledå˜›ï¼Œè¿™é‡Œå°±ç›¸å½“äº <code>onFulfilled(undefined)</code>(å› ä¸º p3 çš„å€¼çš„ undefined)ã€‚</p> 
 <blockquote> 
  <p>è¾“å‡º p3 onFulfilled</p> 
 </blockquote> 
 <p>è€Œå p4 çš„çŠ¶æ€ä¹Ÿå˜æˆäº† fulfilledï¼Œå€¼ä¹Ÿæ˜¯ undefinedï¼Œå› ä¸º p3 çš„ onFulfilled è¿”å›å€¼æ˜¯ undefined</p> 
 <p>ç„¶å p4 çš„ onFulfilled å˜æˆ handler é˜Ÿåˆ—ï¼Œå› ä¸º p4 æ²¡æœ‰è°ƒç”¨ then ç»‘å®šè¿‡ onFulfilled å¤„ç†å‡½æ•°ã€‚ä½†æ˜¯å› ä¸ºæ²¡æœ‰è°ƒç”¨ then æ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰äº§ç”Ÿæ–°çš„ Promsie å¯¹è±¡ï¼Œè¿™æ¬¡åœ¨æ‰§è¡Œ FuflfillPromiseReactionJob æ–¹æ³•çš„æ—¶å€™è¿›å…¥ promiseOrCapability ä¸º Undefined åˆ†æ”¯å°±ç»“æŸäº†</p> 
 <p>è‡³æ­¤æ‰€æœ‰ç›¸å…³çš„ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆ</p> 
 <p>å¦‚æœä¸Šé¢ä½ çœ‹æ‡‚äº†ï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ®µä»£ç æˆ‘æƒ³ä½ ä¹Ÿåº”è¯¥èƒ½çŸ¥é“ç»“æœ</p> 
 <pre class="has"><code class="language-go">Promise.resolve('123')
Â Â Â Â .then(()Â =&gt;Â {throwÂ newÂ Error('456')})
Â Â Â Â .then(_Â =&gt;Â {
Â Â Â Â Â Â Â Â console.log('shouldnotÂ beÂ here')
Â Â Â Â })
Â Â Â Â .catch((e)Â =&gt;Â console.log(e))
Â Â Â Â .then((data)Â =&gt;Â console.log(data));</code></pre> 
 <blockquote> 
  <p>catch(onRejected) çš„æœ¬è´¨æ˜¯ then(undefined, onRejected)</p> 
 </blockquote> 
 <p>è¿™å°±æ˜¯ Promise çš„ rejected ä¼ é€’æœºåˆ¶ï¼Œä¸æ–­å‘ä¸‹ä¼ é€’ç›´åˆ°é‡è§ onRejected å¤„ç†å‡½æ•°ä¸ºæ­¢</p> 
 <h3>Promise çš„å‡ ä¸ªé«˜éš¾åº¦é¢˜ç›®</h3> 
 <h4>é¢˜ç›®1</h4> 
 <pre class="has"><code class="language-go">Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â console.log(0);
Â Â Â Â returnÂ Promise.resolve(4);
}).then((res)Â =&gt;Â {
Â Â Â Â console.log(res)
})

Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â console.log(1);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(2);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(3);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(5);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(6);
})
//Â 0Â 1Â 2Â 3Â 4Â 5Â 6</code></pre> 
 <blockquote> 
  <p>ä¸»è¦è€ƒå¯Ÿ å½“ Promise çš„å€¼æ˜¯ promsie å¯¹è±¡æ—¶ä¼šå¦‚ä½•å¤„ç†ï¼Œåœ¨æœ¬æ–‡ çš„ <strong>then çš„é“¾å¼è°ƒç”¨ä¸ microtask é˜Ÿåˆ—</strong>&gt; <strong>ResolvePromise</strong> ç›®å½•æœ«å°¾å¤„å¼€å§‹ä»‹ç»</p> 
  <p>å…³é”®å­—ï¼š<strong>thenable</strong>ã€<strong>NewPromiseResolveThenableJobTask</strong></p> 
 </blockquote> 
 <p><strong>é¢˜è§£</strong></p> 
 <p>ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç è½¬åŒ–ä¸ºä¸‹é¢è¿™æ ·</p> 
 <pre class="has"><code class="language-go">letÂ p1Â =Â Promise.resolve()
letÂ p2Â =Â p1.then(()Â =&gt;Â {
Â Â Â Â console.log(0);
Â Â Â Â letÂ p3Â =Â Promise.resolve(4)
Â Â Â Â returnÂ p3;
})
letÂ p4Â =Â p2.then((res)Â =&gt;Â {
Â Â Â Â console.log(res)
})

letÂ p5Â =Â Promise.resolve()
letÂ p6Â =Â p5.then(()Â =&gt;Â {
Â Â Â Â console.log(1);
})
letÂ p7Â =Â p6.then(()Â =&gt;Â {
Â Â Â Â console.log(2);
})
letÂ p8Â =Â p7.then(()Â =&gt;Â {
Â Â Â Â console.log(3);
})
letÂ p9Â =Â p8.then(()Â =&gt;Â {
Â Â Â Â console.log(5);
})
letÂ p10Â =Â p9.then(()Â =&gt;Â {
Â Â Â Â console.log(6);
})</code></pre> 
 <p>å…ˆæ‰§è¡Œæ‰€æœ‰çš„åŒæ­¥ä»£ç ï¼Œæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹é¢çš„æ³¨é‡Š</p> 
 <pre class="has"><code class="language-go">letÂ p1Â =Â Promise.resolve()
//Â 1.Â p1Â çš„çŠ¶æ€ä¸ºÂ fulfilled

letÂ p2Â =Â p1.then(()Â =&gt;Â {
Â Â Â Â console.log(0);
Â Â Â Â letÂ p3Â =Â Promise.resolve(4)
Â Â Â Â returnÂ p3;
})
//Â 2.Â å› ä¸ºÂ p1Â çš„çŠ¶æ€å·²ç»æ˜¯Â fulfilledï¼Œæ‰€ä»¥è°ƒç”¨Â thenÂ åç«‹å³å°†Â onFulfilledÂ æ”¾å…¥Â microtaskÂ é˜Ÿåˆ—
//Â æ­¤æ—¶Â microtaskÂ åªæœ‰p1çš„Â onFulfilledï¼šÂ [p1.onFulfilled]

letÂ p4Â =Â p2.then((res)Â =&gt;Â {
Â Â Â Â console.log(res)
})
//Â 3.Â p2çš„çŠ¶æ€è¿˜æ˜¯Â pendingï¼Œæ‰€ä»¥è°ƒç”¨Â thenÂ åæ˜¯ä¸ºÂ p2Â æ”¶é›†ä¾èµ–ï¼Œæ­¤æ—¶Â p2Â çš„Â reactionsÂ å¦‚ä¸‹
/*{
Â Â Â Â onFulfilled:Â (res)Â =&gt;Â {console.log(res)},
Â Â Â Â onRejected:Â undefined
}*/


letÂ p5Â =Â Promise.resolve()
//Â 4.Â p5Â çš„çŠ¶æ€ä¸ºÂ fulfilled

letÂ p6Â =Â p5.then(()Â =&gt;Â {
Â Â Â Â console.log(1);
})
//Â 5.Â åŒç¬¬2æ­¥ï¼Œå°†Â onFulfilledÂ åŠ å…¥Â microtaskÂ é˜Ÿåˆ—
//Â æ­¤æ—¶Â microtaskÂ æ˜¯ï¼šÂ [p1.onFulfilled,Â p5.onFulfilled]

letÂ p7Â =Â p6.then(()Â =&gt;Â {
Â Â Â Â console.log(2);
})
//Â 6.Â åŒç¬¬3æ­¥ï¼Œæ˜¯ç»™Â p6Â æ·»åŠ Â reactions

letÂ p8Â =Â p7.then(()Â =&gt;Â {
Â Â Â Â console.log(3);
})
//Â 7.Â åŒä¸Šï¼Œæ˜¯ç»™Â p7Â æ·»åŠ Â reactions

letÂ p9Â =Â p8.then(()Â =&gt;Â {
Â Â Â Â console.log(5);
})
//Â 8.Â åŒä¸Šï¼Œæ˜¯ç»™Â p8Â æ·»åŠ Â reactions

letÂ p10Â =Â p9.then(()Â =&gt;Â {
Â Â Â Â console.log(6);
})
//Â 9.Â åŒä¸Šï¼Œæ˜¯ç»™Â p9Â æ·»åŠ Â reactions</code></pre> 
 <ol><li><p>å½“åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆåï¼Œmicrotask é˜Ÿåˆ—åªæœ‰</p></li></ol> 
 <pre class="has"><code class="language-go">[p1.onFulfilled,Â p5.onFulfilled]</code></pre> 
 <ol><li><p>ç„¶åå–å‡º p1.onFulfilled æ¥æ‰§è¡Œï¼Œæ­¤æ—¶è¾“å‡º <code>0</code>ï¼Œä½†æ˜¯å‘ç° p1.onFulfilled è¿”å›å€¼çš„ p3 æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚æ‰€ä»¥ä¼šæ‰§è¡Œ ResolvePromise çš„ Enqueue ä»£ç å—ï¼Œé‡Œé¢ä¼šè°ƒç”¨ NewPromiseResolveThenableJobTask äº§ç”Ÿä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œè¿™ä¸ªå¾®ä»»åŠ¡çš„è¦åšçš„äº‹æƒ…ä¸Šé¢å·²ç»ä»‹ç»è¿‡ï¼Œå¤§è‡´å°±æ˜¯ä¸‹é¢è¿™æ ·</p></li></ol> 
 <pre class="has"><code class="language-go">letÂ promiseResolveThenableJobTaskÂ =Â ()Â =&gt;Â {
Â Â Â Â p3.then((value)Â =&gt;Â {Â //Â p3çš„valueæ˜¯4
Â Â Â Â Â Â Â Â ReslovePromise(p2,Â value)Â 
Â Â Â Â })
}</code></pre> 
 <p>ç„¶åå°†å…¶åŠ å…¥ microtask é˜Ÿåˆ—ï¼Œ è¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆäº† :</p> 
 <pre class="has"><code class="language-go">[p5.onFulfilled,Â promiseResolveThenableJobTask]</code></pre> 
 <ol><li><p>ç»§ç»­å–å‡º p5.onFulfilled æ‰§è¡Œï¼Œæ­¤æ—¶è¾“å‡º <code>1</code>ï¼Œå› ä¸º p5.onFulfilled è¿”å›å€¼æ˜¯ undefinedï¼Œæ‰€ä»¥å°±å°† undefined ä½œä¸º p6 çš„å€¼ï¼Œç„¶åå°† p6 çš„çŠ¶æ€å˜ä¸º fulfilledã€‚</p></li></ol> 
 <p>å› ä¸º p6 çš„çŠ¶æ€è¢«æ”¹å˜ï¼Œæ‰€ä»¥å®ƒçš„ reactions ä¹Ÿä¼šåŠ å…¥ microtask é˜Ÿåˆ—ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š</p> 
 <pre class="has"><code class="language-go">[promiseResolveThenableJobTaskï¼Œp6.onFulfilled]</code></pre> 
 <ol><li><p>åŒæ ·æ˜¯å– promiseResolveThenableJobTask æ‰§è¡Œï¼Œå› ä¸º promiseResolveThenableJobTask çš„å†…å®¹æ˜¯ä¸‹é¢è¿™æ ·</p></li></ol> 
 <pre class="has"><code class="language-go">letÂ promiseResolveThenableJobTaskÂ =Â ()Â =&gt;Â {
Â Â Â Â p3.then((value)Â =&gt;Â {Â 
Â Â Â Â Â Â Â Â ReslovePromise(p2,Â value)Â //Â ReslovePromiseÂ çš„ä½œç”¨ä¸Šé¢æœ‰ä»‹ç»
Â Â Â Â })
}</code></pre> 
 <p>æ‰€ä»¥æ‰§è¡Œ promiseResolveThenableJobTask æ—¶å°±ç›¸å½“äºæ‰§è¡Œäº† <code>p3.then((value) =&gt; {ReslovePromise(p2, value)})</code></p> 
 <p>å› ä¸º p3 çš„çŠ¶æ€æ˜¯ fulfilled ï¼Œæ‰€ä»¥ä¼šå°†å…¶ onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—ï¼ˆvalueå‚æ•°å°±æ˜¯ p3 çš„å€¼ 4ï¼Œååºä»–å°†ä¼ é€’ç»™p2ï¼‰ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š</p> 
 <pre class="has"><code class="language-go">[p6.onFulfilledï¼Œp3.onFulfilled]</code></pre> 
 <ol><li><p>åŒæ ·æ˜¯å– p6.onFulfilled æ‰§è¡Œï¼Œç„¶åè¾“å‡º <code>2</code> å¹¶å°†å…¶è¿”å›å€¼ undefined è®¾ç½®ä¸º p7 çš„å€¼ï¼Œå¹¶å°† p7 å˜ä¸º fulfilled çŠ¶æ€ï¼Œæ‰€ä»¥ p7 çš„ reactions ä¹Ÿä¼šåŠ å…¥ microtask é˜Ÿåˆ—ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š</p></li></ol> 
 <pre class="has"><code class="language-go">[p3.onFulfilledï¼Œp7.onFulfilled]</code></pre> 
 <ol><li><p>p3.onFulfilled å‡ºé˜Ÿæ‰§è¡Œï¼Œp3.onFulfilled æ˜¯ <code>(value) =&gt; {ReslovePromise(p2, value)}</code>, å‚æ•° value æ˜¯ 4ï¼Œæ‰€ä»¥æ­¤æ—¶å°±æ‰§è¡Œ <code>ReslovePromise(p2, 4)</code>,è¿™å°±ç›¸å½“äºè°ƒç”¨äº† p2 çš„ resolveã€‚</p></li></ol> 
 <p>æ‰€ä»¥æ­¤æ—¶ p2 çš„ å€¼å˜ä¸º 4ï¼Œ çŠ¶æ€ä¸ºå˜ fulfilledï¼Œç„¶åå°†å…¶ reactions æŒ¨ä¸ªåŠ å…¥ microtask é˜Ÿåˆ—ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š</p> 
 <pre class="has"><code class="language-go">[p7.onFulfilledï¼Œp2.onFulfilled]</code></pre> 
 <ol><li><p>p7.onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œè¾“å‡º <code>3</code>ï¼Œp8 çŠ¶æ€å˜ä¸º fulfilleï¼Œå€¼å˜ä¸º undefinedï¼Œç„¶å p8.onFulfilled åŠ å…¥é˜Ÿåˆ—</p></li></ol> 
 <pre class="has"><code class="language-go">[p2.onFulfilledï¼Œp8.onFulfilled]</code></pre> 
 <ol><li><p>p2.onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œè¾“å‡º <code>4</code>ï¼Œå› ä¸º p2 æ²¡æœ‰è¢«åœ¨æ­¤è°ƒç”¨ then æ–¹æ³•ï¼Œæ‰€ä»¥å°±æ²¡æœ‰äº§ç”Ÿä¸‹ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰ååºäº†ã€‚</p></li></ol> 
 <pre class="has"><code class="language-go">[p8.onFulfilled]</code></pre> 
 <ol><li><p>åé¢å°±ä¸ç”¨è¯´äº†</p></li></ol> 
 <h4>é¢˜ç›®2</h4> 
 <pre class="has"><code class="language-go">Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â console.log(0);
Â Â Â Â returnÂ {then(resolve){resolve(4)}};
}).then((res)Â =&gt;Â {
Â Â Â Â console.log(res)
})

Promise.resolve().then(()Â =&gt;Â {
Â Â Â Â console.log(1);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(2);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(3);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(5);
}).then(()Â =&gt;Â {
Â Â Â Â console.log(6);
})
//Â 0Â 1Â 2Â 4Â 3Â 5Â 6</code></pre> 
 <blockquote> 
  <p>ä¸ä¸Šé¢˜çŸ¥è¯†ç‚¹ä¸€è‡´ï¼Œè€ƒå¯Ÿçš„æ˜¯ Promise çš„å€¼æ˜¯ä¸€ä¸ªåŒ…å« then æ–¹æ³•çš„å¯¹è±¡æ—¶å‘ç”Ÿçš„é€»è¾‘</p> 
  <p>å…³é”®å­—ï¼š<strong>thenable</strong>ã€<strong>NewPromiseResolveThenableJobTask</strong></p> 
 </blockquote> 
 <h4>é¢˜ç›®3</h4> 
 <pre class="has"><code class="language-go">constÂ p1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject(0)
})
console.log(1);
setTimeout(()Â =&gt;Â {
Â Â Â Â p1.then(undefined,Â console.log)
},Â 0)
console.log(2);
//Â 1
//Â 2
//Â è¾“å‡ºæŠ¥é”™Â UnhandledPromiseRejection:Â ThisÂ errorÂ originatedÂ either

constÂ p1Â =Â newÂ Promise((resolve,Â reject)Â =&gt;Â {
Â Â Â Â reject(0)
})
console.log(1);
p1.then(undefined,Â console.log)
console.log(2);
//Â 1
//Â 2
//Â 0</code></pre> 
 <blockquote> 
  <p>ä¸ºä»€ä¹ˆç¬¬ä¸€ç§æ–¹å¼ä¼šæŠ¥é”™ï¼Ÿ</p> 
  <p>è€ƒå¯Ÿçš„æ˜¯è§„èŒƒä¸­çš„ HostPromiseRejectionTrackerï¼Œå½“ä¸€ä¸ªæ²¡æœ‰ç»‘å®šå¤„ç†å‡½æ•°çš„ Promsie è¢«è°ƒç”¨ reject åˆ™ä¼šåˆ›å»ºä¸€ä¸ª å¾®ä»»åŠ¡æ¥å†æ¬¡æ£€æµ‹è¿™ä¸ª Promise æ˜¯å¦å­˜åœ¨å¤„ç†å‡½æ•°ï¼Œå¦‚æœæ­¤æ—¶è¿˜ä¸å­˜åœ¨åˆ™è¾“å‡ºæŠ¥é”™ï¼ŒsetTimeoutå›è°ƒæ‰§è¡Œåœ¨å¾®ä»»åŠ¡ä¹‹åã€‚</p> 
  <p>æœ¬æ–‡ <strong>reject</strong> &gt; <strong>HostPromiseRejectionTracker</strong> ç›®å½•å¤„æœ‰è¯¦ç»†ä»‹ç»ã€‚</p> 
 </blockquote> 
 <blockquote> 
  <p><strong>æ³¨æ„ï¼š</strong> æµè§ˆå™¨æ§åˆ¶å°æœ‰ä¸€ä¸ªéå¸¸å¥‡æ€ªçš„ç‰¹æ€§ï¼Œå¦‚æœåœ¨è¿™ä¸ªé”™è¯¯è¾“å‡ºååœ¨ä¸ºå…¶ç»‘å®š onrejected å¤„ç†å‡½æ•°ï¼Œæµè§ˆå™¨ä¼šå°†æ§åˆ¶å°çš„é”™è¯¯è¦†ç›–æ‰ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨æµè§ˆå™¨æ‰§è¡Œè¿™æ®µä»£ç ï¼Œè¯·å°†setTimeoutçš„æ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹ï¼Œè¿™æ ·æ•ˆæœæ›´åŠ å®¹æ˜“è‚‰çœ¼å¯è§ã€‚</p> 
 </blockquote> 
 <h4>é¢˜ç›®å››</h4> 
 <p>ä¸ºä»€ä¹ˆ async1 end è¾“å‡ºåœ¨ promise3 ä¹‹åï¼Ÿ</p> 
 <pre class="has"><code class="language-go">asyncÂ functionÂ async1()Â {Â 
Â Â Â Â console.log("async1Â start");Â 
Â Â Â Â awaitÂ async2();Â 
Â Â Â Â console.log("async1Â end");Â 
}Â 
asyncÂ functionÂ async2()Â {Â 
Â Â Â Â console.log("async2");Â 
Â Â Â Â returnÂ Promise.resolve().then(()Â =&gt;Â {Â 
Â Â Â Â Â Â Â Â console.log("async2-inner");Â 
Â Â Â Â });Â 
}Â 

console.log("scriptÂ start");Â 
setTimeout(functionÂ ()Â {Â 
Â Â Â Â console.log("settimeout");Â 
});Â 

async1();Â 
newÂ Promise(functionÂ (resolve)Â {Â 
Â Â Â Â console.log("promise1");Â 
Â Â Â Â resolve();Â 
})Â 
.then(functionÂ ()Â {Â 
Â Â Â Â console.log("promise2");Â 
})Â 
.then(functionÂ ()Â {Â 
Â Â Â Â console.log("promise3");Â 
})Â 
.then(functionÂ ()Â {Â 
Â Â Â Â console.log("promise4");Â 
});Â 
console.log("scriptÂ end");</code></pre> 
 <blockquote> 
  <p>æ„Ÿè°¢è¯„è®ºåŒºè´¡çŒ®çš„é¢˜ç›®</p> 
 </blockquote> 
 <p><strong>é¢˜è§£</strong></p> 
 <p>è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œé¢æ¶‰åŠ async ä¸­ä½¿ç”¨ await ä¼šäº§ç”Ÿå¤šä¸ªPromiseé“¾è·¯çš„é—®é¢˜ä»¥åŠ resolve å€¼ä¸º Promise å¯¹è±¡çš„é—®é¢˜ï¼Œé‡ç‚¹çœ‹ async2ï¼Œæˆ‘æŠŠä»–è½¬åŒ–ä¸ºè¿™æ ·ï¼ˆsetTimeoutå¯¹äºæœ¬é¢˜æ‚¬å¿µä¸å¤§ï¼Œå°±åˆ é™¤äº†ï¼‰ã€‚</p> 
 <pre class="has"><code class="language-go">asyncÂ functionÂ async1()Â {
Â Â Â Â console.log("async1Â start");
Â Â Â Â letÂ a2Â =Â async2();
Â Â Â Â awaitÂ a2
Â Â Â Â console.log("async1Â end");
}
asyncÂ functionÂ async2()Â {
Â Â Â Â console.log("async2");
Â Â Â Â letÂ p1Â =Â Promise.resolve()
Â Â Â Â letÂ p2Â =Â p1.then(()Â =&gt;Â {
Â Â Â Â Â Â Â Â console.log("async2-inner");
Â Â Â Â })
Â Â Â Â returnÂ p2;
}

letÂ a1Â =Â async1();

letÂ p3Â =Â newÂ Promise(functionÂ (resolve)Â {
Â Â Â Â console.log("promise1");
Â Â Â Â resolve();
})

letÂ p4Â =Â p3.then(functionÂ ()Â {
Â Â Â Â console.log("promise2");
})
//Â ä¸ºÂ p3Â æ·»åŠ Â reactions
letÂ p5Â =Â p4.then(functionÂ ()Â {
Â Â Â Â console.log("promise3");
})
//Â ä¸ºÂ p4Â æ·»åŠ Â reactions
letÂ p6Â =Â p5.then(functionÂ ()Â {
Â Â Â Â console.log("promise4");
});
//Â ä¸ºÂ p5Â æ·»åŠ Â reactions
console.log("scriptÂ end");</code></pre> 
 <p>æƒ³å¿…ä½ ä¹Ÿå‘ç°äº† async å‡½æ•°ä¸­ await è¯­å¥ä¹‹å‰çš„ä»£ç éƒ½æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼ˆç›¸å½“äºPromsieçš„executorï¼‰</p> 
 <ol><li><p>å…ˆè°ƒç”¨ async1ï¼Œè¾“å‡º <code>async1 start</code>ï¼Œ åŒæ­¥æ‰§è¡Œåˆ° <code>async2()</code> çš„ä½ç½®ï¼Œç„¶åå»åŒæ­¥æ‰§è¡Œ async2ã€‚</p></li></ol> 
 <p>ç„¶åè¾“å‡º <code>async2</code>ï¼Œé‡Œé¢åˆ›å»ºä¸€ä¸ª fulfilled çŠ¶æ€çš„ p1ï¼Œç„¶åä¸º p1 ç»‘å®š thenï¼Œå› ä¸º p1 æ˜¯ fulfilled çŠ¶æ€æ‰€ä»¥ p1.onFulfilled ä¼šç«‹å³è¿›å…¥ microtask é˜Ÿåˆ—ã€‚è¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š</p> 
 <pre class="has"><code class="language-go">[p1.onFulfilled]</code></pre> 
 <p>ç„¶åè¿”å› p2ï¼ˆresolve(p2)ï¼‰ï¼Œåˆå› ä¸º p2 æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„ promiseResolveThenableJobTask</p> 
 <pre class="has"><code class="language-go">letÂ promiseResolveThenableJobTaskÂ =Â ()Â =&gt;Â {
Â Â Â Â p2.then((value)Â =&gt;Â {Â 
Â Â Â Â Â Â Â Â ReslovePromise(a2,Â value)Â //Â ReslovePromiseÂ çš„ä½œç”¨ä¸Šé¢æœ‰ä»‹ç»
Â Â Â Â })
}</code></pre> 
 <pre class="has"><code class="language-go">[p1.onFulfilledï¼ŒpromiseResolveThenableJobTask]</code></pre> 
 <ol><li><p>ç„¶åæ‰§è¡Œ await a2ï¼Œè¿™é‡Œå¾ˆå…³é”®ï¼Œawait ä¼šç­‰å¾…ä¸€ä¸ª Promsie è¿›å…¥ fulfilled çŠ¶æ€åæ‰æ‰§è¡Œåé¢çš„ä»£ç ï¼Œå…¶å®å°±ç›¸å½“äºä¸‹é¢è¿™æ ·</p></li></ol> 
 <pre class="has"><code class="language-go">a2.then(_Â =&gt;Â {
Â //Â è¿™é‡Œæ˜¯Â async1Â ä¸­Â awaitÂ åçš„ä»£ç 
})
//Â ä¸ºÂ a2Â ç»‘å®šäº†Â reactionsï¼Œè¿™é‡Œçš„Â onFulfillÂ æš‚æ—¶å°±å«Â ã€async1ååŠæ®µã€å§
//Â å…¶å®è¿™é‡Œé¢åšçš„äº‹æƒ…å¾ˆå¤šï¼Œæˆ‘åé¢å¯èƒ½ä¼šå•ç‹¬è®²è§£Â async/awaitÂ çš„åŸç†</code></pre> 
 <p>æ³¨æ„æ­¤æ—¶ a2 è¿˜ä¸æ˜¯ fulfilled çŠ¶æ€ï¼Œå› ä¸ºä»–éœ€è¦ç­‰å¾… promiseResolveThenableJobTask æ‰§è¡Œæ—¶æ¥è°ƒç”¨ä»–çš„ resolve æ‰ä¼šå˜æˆ fulfilledã€‚</p> 
 <ol><li><p>è¿™æ—¶ async1() è§¦å‘çš„åŒæ­¥ä»£ç æ‰æ‰§è¡Œå®Œæ¯•ï¼Œç»§ç»­æ‰§è¡Œåé¢çš„ new Promise</p></li></ol> 
 <p>åŒæ­¥æ‰§è¡Œè¿™æ®µä»£ç </p> 
 <pre class="has"><code class="language-go">functionÂ (resolve)Â {
Â Â Â Â console.log("promise1");
Â Â Â Â resolve();
}</code></pre> 
 <p>è¾“å‡º <code>promise1</code>, æ‰§è¡Œ resolveï¼Œ ç„¶å p3 çŠ¶æ€å˜ä¸º fulfilledï¼Œp3.onFulfilled è¿›å…¥é˜Ÿåˆ—ï¼Œåé¢çš„ then éƒ½æ˜¯ç»™å¯¹åº”çš„ promsie ç»‘å®š reactions è¿™ä¸ªå°±ä¸è¯´äº†ï¼Œæœ€åè¾“å‡º <code>script end</code></p> 
 <p>åˆ°æ­¤æ—¶æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆï¼Œ microtask é˜Ÿåˆ—æ˜¯è¿™æ ·çš„ï¼š</p> 
 <pre class="has"><code class="language-go">[p1.onFulfilledï¼ŒpromiseResolveThenableJobTaskï¼Œp3.onFulfilled]</code></pre> 
 <ol><li><p>è‡³æ­¤æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆï¼Œå¼€å§‹å– microtask æ‰§è¡Œï¼Œé¦–å…ˆæ˜¯ p1.onFulfilleed ï¼Œæ‰§è¡Œè¾“å‡º <code>async2-inner</code>, ç„¶å å°†å…¶è¿”å›å€¼ undefined ä½œä¸º p2 çš„å€¼ï¼Œå¹¶å°† p2 å˜æˆ fulfilled çŠ¶æ€ã€‚å› ä¸º p2 æ­¤æ—¶æ²¡æœ‰ reactions ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«è°ƒç”¨è¿‡thenæ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…</p></li></ol> 
 <pre class="has"><code class="language-go">[promiseResolveThenableJobTaskï¼Œp3.onFulfilled]</code></pre> 
 <ol><li><p>promiseResolveThenableJobTask å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œ å…¶å†…å®¹å¦‚ä¸‹ï¼Œä¸Šé¢å·²ç»è¯´è¿‡äº†</p></li></ol> 
 <pre class="has"><code class="language-go">letÂ promiseResolveThenableJobTaskÂ =Â ()Â =&gt;Â {
Â Â Â Â p2.then((value)Â =&gt;Â {Â 
Â Â Â Â Â Â Â Â ReslovePromise(a2,Â value)Â //Â ReslovePromiseÂ çš„ä½œç”¨ä¸Šé¢æœ‰ä»‹ç»
Â Â Â Â })
}</code></pre> 
 <p>æ‰§è¡Œæ˜¯æ‰§è¡Œ p2 çš„ then æ–¹æ³•ä¸ºå…¶ç»‘å®š onFulfilled å¤„ç†å‡½æ•°ï¼Œä½†æ˜¯ p2 å·²ç»æ˜¯ fulfilled çŠ¶æ€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å°† p2.onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—ã€‚</p> 
 <pre class="has"><code class="language-go">[p3.onFulfilled,Â p2.onFulfilled]</code></pre> 
 <ol><li><p>p3.onFulfilled å‡ºé˜Ÿæ‰§è¡Œï¼Œè¾“å‡º <code>promise2</code> ï¼Œå°† p4 çš„çŠ¶æ€å˜ä¸º fulfilledï¼Œp4çš„å€¼ä¸ºå…¶1è¿”å›å€¼ä¹Ÿå°±æ˜¯undefinedï¼Œç„¶å p4 çš„ onFulfilled ä¹Ÿä¼šåŠ å…¥ microtask é˜Ÿåˆ—</p></li></ol> 
 <pre class="has"><code class="language-go">[p2.onFulfilled,Â p4.onFulfilled]</code></pre> 
 <ol><li><p>p2.onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œ p2.onFulfilled çš„å†…å®¹å¦‚ä¸‹ï¼Œè¿™ä¸ªä¸Šé¢è¯´è¿‡</p></li></ol> 
 <pre class="has"><code class="language-go">(value)Â =&gt;Â {Â 
Â Â Â Â ReslovePromise(a2,Â value)Â //Â ä¹Ÿå°±æ˜¯Â a2Â çš„Â resolve(value)
}</code></pre> 
 <p>æ‰€ä»¥æ‰§è¡Œ ReslovePromise åï¼Œa2 ä¼šå˜æˆ fulfilled çŠ¶æ€ï¼Œa2.onFulfilled ä¹Ÿå°±æ˜¯ ã€async1ååŠæ®µã€ ä¹Ÿç†æ‰€å½“ç„¶çš„è¿›å…¥ microtask é˜Ÿåˆ—</p> 
 <pre class="has"><code class="language-go">[p4.onFulfilled,Â async1ååŠæ®µ]</code></pre> 
 <ol><li><p>åé¢çš„ç»“æœå°±æ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹äº†ï¼Œp4.onFulfilled å‡ºé˜Ÿæ‰§è¡Œï¼Œè¾“å‡º <code>promise3</code>ï¼Œç„¶å p5.onFulfilled å…¥é˜Ÿ</p></li></ol> 
 <pre class="has"><code class="language-go">[async1ååŠæ®µ,p5.onFulfilled]</code></pre> 
 <ol><li><p>async1ååŠæ®µ å‡ºé˜Ÿæ‰§è¡Œï¼Œè¾“å‡º <code>async1 end</code>ï¼Œ ç„¶å a1 çŠ¶æ€å˜ä¸º fulfilledï¼Œä½†æ˜¯æ²¡æœ‰ç»‘å®šä»»ä½•å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥ a1 å°±æ²¡æœ‰åç»­äº†</p></li></ol> 
 <pre class="has"><code class="language-go">[p5.onFulfilled]</code></pre> 
 <ol><li><p>p5.onFulfilled å‡ºé˜Ÿæ‰§è¡Œè¾“å‡º <code>promise4</code>ï¼ŒåŒç† p6 æ²¡æœ‰ç»‘å®šä»»ä½•å¤„ç†å‡½æ•°ï¼Œè‡³æ­¤æ‰€æœ‰ä»£ç æ‰§è¡Œå®Œæˆ</p></li></ol> 
 <h4>æœ€åå‡ ä»¶äº‹</h4> 
 <ol><li><p>å¦‚æœå¯¹æœ¬æ–‡æœ‰ä»»ä½•é—®é¢˜è¯·è¯„è®ºç•™è¨€</p></li><li><p>å¦‚æœä½ å›é¡¾äº†æœ¬æ–‡è¿˜æ˜¯æ— æ³•å¾—åˆ°ä¸Šè¿°é¢˜ç›®çš„ç­”æ¡ˆï¼Œè¯·è¯„è®ºåŒºå‘ŠçŸ¥ï¼Œæˆ‘ååºä¼šç»™å‡ºè¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹ä»‹ç»</p></li><li><p>å¦‚æœä½ æœ‰ä»»ä½• Promise é—®é¢˜ï¼Œå¯è¯„è®ºï¼Œä½œè€…å…è´¹æ‰¿åŒ…æ‰€æœ‰ Promise é—®é¢˜</p></li><li><p>å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œå´è¿˜æ²¡æœ‰ç‚¹èµï¼Œè¯·ç‚¹èµï¼Œéå¸¸æ„Ÿè°¢ã€‚</p></li><li><p>v8 promise ç›¸å…³çš„ä»£ç å¯ä»¥å†è¿™é‡Œæœç´¢å’Œé˜…è¯» source.chromium.org/chromium/châ€¦<sup>[27]</sup></p></li></ol> 
 <h3>ç›¸å…³é“¾æ¥</h3> 
 <p>Promise V8 æºç åˆ†æ(ä¸€)â€”â€”å¾é¹è·ƒ<sup>[28]</sup></p> 
 <p>promise.then ä¸­ return Promise.resolve åï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ<sup>[29]</sup></p> 
 <p>Chromium Code Search<sup>[30]</sup></p> 
 <p>ECMA-262, 11th edition, June 2020<sup>[31]</sup></p> 
 <h4>å‚è€ƒèµ„æ–™</h4> 
 <p>[1] </p> 
 <p>https://juejin.cn/post/7054931900074295310#heading-7: https://juejin.cn/post/7054931900074295310#heading-7</p> 
 [2]  
 <p>https://juejin.cn/post/6844903607968481287: https://juejin.cn/post/6844903607968481287</p> 
 [3]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/base.tq#190: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fbase.tq%23190</p> 
 [4]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/js-promise.tq#13: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fobjects%2Fjs-promise.tq%2313</p> 
 [5]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-constructor.tq#47: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-constructor.tq%2347</p> 
 [6]  
 <p>https://262.ecma-international.org/11.0/#sec-promise.prototype.then: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-promise.prototype.then</p> 
 [7]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-then.tq#21: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-then.tq%2321</p> 
 [8]  
 <p>https://262.ecma-international.org/11.0/#sec-performpromisethen: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-performpromisethen</p> 
 [9]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-abstract-operations.tq#409: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%23409</p> 
 [10]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq#134: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-misc.tq%23134</p> 
 [11]  
 <p>https://262.ecma-international.org/11.0/#sec-performpromisethen: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-performpromisethen</p> 
 [12]  
 <p>https://262.ecma-international.org/11.0/#sec-host-promise-rejection-tracker: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-host-promise-rejection-tracker</p> 
 [13]  
 <p>https://262.ecma-international.org/11.0/#sec-fulfillpromise: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-fulfillpromise</p> 
 [14]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-abstract-operations.tq#182: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%23182</p> 
 [15]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-abstract-operations.tq#140: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%23140</p> 
 [16]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-abstract-operations.tq#84: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%2384</p> 
 [17]  
 <p>https://262.ecma-international.org/11.0/#sec-rejectpromise: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-rejectpromise</p> 
 [18]  
 <p>https://262.ecma-international.org/11.0/#sec-rejectpromise: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-rejectpromise</p> 
 [19]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-abstract-operations.tq#210: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%23210</p> 
 [20]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-constructor.tq#100: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-constructor.tq%23100</p> 
 [21]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-misc.tq#199: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-misc.tq%23199</p> 
 [22]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-microtask-queue-gen.cc#114: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fbuiltins-microtask-queue-gen.cc%23114</p> 
 [23]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/promise-reaction-job.tq#43: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2Fpromise-reaction-job.tq%2343</p> 
 [24]  
 <p>https://chromium.googlesource.com/v8/v8.git/+/refs/heads/9.0-lkgr/src/builtins/promise-resolve.tq#88: https://link.juejin.cn?target=https%3A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%2B%2Frefs%2Fheads%2F9.0-lkgr%2Fsrc%2Fbuiltins%2Fpromise-resolve.tq%2388</p> 
 [25]  
 <p>https://262.ecma-international.org/11.0/#sec-promise-resolve-functions: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-promise-resolve-functions</p> 
 [26]  
 <p>https://262.ecma-international.org/11.0/#sec-newpromisereactionjob: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-newpromisereactionjob</p> 
 [27]  
 <p>https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc%2F%2B%2Fmain%3Av8%2Fsrc%2Fbuiltins%2F</p> 
 [28]  
 <p>https://zhuanlan.zhihu.com/p/264944183: https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F264944183</p> 
 [29]  
 <p>https://www.zhihu.com/question/453677175/answer/1841325386: https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F453677175%2Fanswer%2F1841325386</p> 
 [30]  
 <p>https://source.chromium.org/chromium/chromium/src: https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc</p> 
 [31]  
 <p>https://262.ecma-international.org/11.0/: https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F</p> 
 <h4>æœ€å</h4> 
 <p>å¦‚æœä½ è§‰å¾—è¿™ç¯‡å†…å®¹å¯¹ä½ æŒºæœ‰å¯å‘ï¼Œæˆ‘æƒ³é‚€è¯·ä½ å¸®æˆ‘ä¸ªå°å¿™ï¼š<br></p> 
 <ol><li><p>ç‚¹ä¸ªã€Œ<strong>å–œæ¬¢</strong>ã€æˆ–ã€Œ<strong>åœ¨çœ‹</strong>ã€ï¼Œè®©æ›´å¤šçš„äººä¹Ÿèƒ½çœ‹åˆ°è¿™ç¯‡å†…å®¹</p></li><li><p>æˆ‘ç»„å»ºäº†ä¸ªæ°›å›´éå¸¸å¥½çš„å‰ç«¯ç¾¤ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå‰ç«¯å°ä¼™ä¼´ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡ã€Œ<strong>sherlocked_93</strong>ã€æ‹‰ä½ åŠ ç¾¤ï¼Œä¸€èµ·äº¤æµå’Œå­¦ä¹ </p></li><li><p>å…³æ³¨å…¬ä¼—å·ã€Œ<strong>å‰ç«¯ä¸‹åˆèŒ¶</strong>ã€ï¼ŒæŒç»­ä¸ºä½ æ¨é€ç²¾é€‰å¥½æ–‡ï¼Œä¹Ÿå¯ä»¥åŠ æˆ‘ä¸ºå¥½å‹ï¼Œéšæ—¶èŠéªšã€‚</p></li></ol> 
 <p style="text-align:center;"><img src="https://images2.imgbox.com/00/56/B5q9MPqA_o.png" alt="90620a37aeaa78957755ab2ea59ce74f.png"></p> 
 <p><img src="https://images2.imgbox.com/3e/ca/jh9XwKZZ_o.png" alt="57a681841912d3bf31ae86f5b71a7f5f.png"></p> 
 <p>ç‚¹ä¸ªå–œæ¬¢æ”¯æŒæˆ‘å§ï¼Œåœ¨çœ‹å°±æ›´å¥½äº†</p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f6b018d72a389f608ea31806d1d68602/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ã€Pythonã€‘PySpark æ•°æ®è®¡ç®— â‘¢ ( RDD#reduceByKey å‡½æ•°æ¦‚å¿µ | RDD#reduceByKey æ–¹æ³•å·¥ä½œæµç¨‹ | RDD#reduceByKey è¯­æ³• | ä»£ç ç¤ºä¾‹ )</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5d4a64bba0cdd2e64906d4477ae15bfd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Python&#43;Playwright(Nuitkaã€Pyinstalleræ‰“åŒ…)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 ç¼–ç¨‹éšæƒ³.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>